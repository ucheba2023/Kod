/*! For license information please see ceaf88a1a984a2d187750adb81afc3f6.e98c864d82213b145748.js.LICENSE.txt */
(self.webpackChunkvk=self.webpackChunkvk||[]).push([[54134],{378844:(t,e,s)=>{"use strict";s.d(e,{default:()=>i});const i={highlight:"CategoryGroup-module__highlight--Lukeh"}},810954:(t,e,s)=>{"use strict";s.d(e,{default:()=>i});const i={icon:"SkillItem-module__icon--ubBP6",skillImage:"SkillItem-module__skillImage--dwecA"}},163293:function(t){t.exports=function(){"use strict";var t=function(){return t=Object.assign||function(t){for(var e,s=1,i=arguments.length;s<i;s++)for(var a in e=arguments[s])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},t.apply(this,arguments)};function e(t,e){var s={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(t);a<i.length;a++)e.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(t,i[a])&&(s[i[a]]=t[i[a]])}return s}var s=function(){function t(t,e){this.ATT_FACTOR=4,this.GRAPH_X=2,this.AMPLITUDE_FACTOR=.6,this.ctrl=t,this.definition=e}return t.prototype.globalAttFn=function(t){return Math.pow(this.ATT_FACTOR/(this.ATT_FACTOR+Math.pow(t,this.ATT_FACTOR)),this.ATT_FACTOR)},t.prototype.xPos=function(t){return this.ctrl.width*((t+this.GRAPH_X)/(2*this.GRAPH_X))},t.prototype.yPos=function(t){return this.AMPLITUDE_FACTOR*(this.globalAttFn(t)*(this.ctrl.heightMax*this.ctrl.amplitude)*(1/this.definition.attenuation)*Math.sin(this.ctrl.opt.frequency*t-this.ctrl.phase))},t.prototype.draw=function(){var t=this.ctrl.ctx;t.moveTo(0,0),t.beginPath();var e=(this.definition.color||this.ctrl.color).replace(/rgb\(/g,"").replace(/\)/g,"");t.strokeStyle="rgba(".concat(e,",").concat(this.definition.opacity,")"),t.lineWidth=this.definition.lineWidth;for(var s=-this.GRAPH_X;s<=this.GRAPH_X;s+=this.ctrl.opt.pixelDepth)t.lineTo(this.xPos(s),this.ctrl.heightMax+this.yPos(s));t.stroke()},t.getDefinition=function(){return[{attenuation:-2,lineWidth:1,opacity:.1},{attenuation:-6,lineWidth:1,opacity:.2},{attenuation:4,lineWidth:1,opacity:.4},{attenuation:2,lineWidth:1,opacity:.6},{attenuation:1,lineWidth:1.5,opacity:1}]},t}(),i=function(){function t(t,e){this.GRAPH_X=25,this.AMPLITUDE_FACTOR=.8,this.SPEED_FACTOR=1,this.DEAD_PX=2,this.ATT_FACTOR=4,this.DESPAWN_FACTOR=.02,this.NOOFCURVES_RANGES=[2,5],this.AMPLITUDE_RANGES=[.3,1],this.OFFSET_RANGES=[-3,3],this.WIDTH_RANGES=[1,3],this.SPEED_RANGES=[.5,1],this.DESPAWN_TIMEOUT_RANGES=[500,2e3],this.ctrl=t,this.definition=e,this.noOfCurves=0,this.spawnAt=0,this.prevMaxY=0,this.phases=[],this.offsets=[],this.speeds=[],this.finalAmplitudes=[],this.widths=[],this.amplitudes=[],this.despawnTimeouts=[],this.verses=[]}return t.prototype.getRandomRange=function(t){return t[0]+Math.random()*(t[1]-t[0])},t.prototype.spawnSingle=function(t){this.phases[t]=0,this.amplitudes[t]=0,this.despawnTimeouts[t]=this.getRandomRange(this.DESPAWN_TIMEOUT_RANGES),this.offsets[t]=this.getRandomRange(this.OFFSET_RANGES),this.speeds[t]=this.getRandomRange(this.SPEED_RANGES),this.finalAmplitudes[t]=this.getRandomRange(this.AMPLITUDE_RANGES),this.widths[t]=this.getRandomRange(this.WIDTH_RANGES),this.verses[t]=this.getRandomRange([-1,1])},t.prototype.getEmptyArray=function(t){return new Array(t)},t.prototype.spawn=function(){this.spawnAt=Date.now(),this.noOfCurves=Math.floor(this.getRandomRange(this.NOOFCURVES_RANGES)),this.phases=this.getEmptyArray(this.noOfCurves),this.offsets=this.getEmptyArray(this.noOfCurves),this.speeds=this.getEmptyArray(this.noOfCurves),this.finalAmplitudes=this.getEmptyArray(this.noOfCurves),this.widths=this.getEmptyArray(this.noOfCurves),this.amplitudes=this.getEmptyArray(this.noOfCurves),this.despawnTimeouts=this.getEmptyArray(this.noOfCurves),this.verses=this.getEmptyArray(this.noOfCurves);for(var t=0;t<this.noOfCurves;t++)this.spawnSingle(t)},t.prototype.globalAttFn=function(t){return Math.pow(this.ATT_FACTOR/(this.ATT_FACTOR+Math.pow(t,2)),this.ATT_FACTOR)},t.prototype.sin=function(t,e){return Math.sin(t-e)},t.prototype.yRelativePos=function(t){for(var e=0,s=0;s<this.noOfCurves;s++){var i=4*(s/(this.noOfCurves-1)*2-1);i+=this.offsets[s];var a=t*(1/this.widths[s])-i;e+=Math.abs(this.amplitudes[s]*this.sin(this.verses[s]*a,this.phases[s])*this.globalAttFn(a))}return e/this.noOfCurves},t.prototype.yPos=function(t){return this.AMPLITUDE_FACTOR*this.ctrl.heightMax*this.ctrl.amplitude*this.yRelativePos(t)*this.globalAttFn(t/this.GRAPH_X*2)},t.prototype.xPos=function(t){return this.ctrl.width*((t+this.GRAPH_X)/(2*this.GRAPH_X))},t.prototype.drawSupportLine=function(){var t=this.ctrl.ctx,e=[0,this.ctrl.heightMax,this.ctrl.width,1],s=t.createLinearGradient.apply(t,e);s.addColorStop(0,"transparent"),s.addColorStop(.1,"rgba(255,255,255,.5)"),s.addColorStop(.8,"rgba(255,255,255,.5)"),s.addColorStop(1,"transparent"),t.fillStyle=s,t.fillRect.apply(t,e)},t.prototype.draw=function(){var t=this.ctrl.ctx;if(t.globalAlpha=.7,t.globalCompositeOperation="lighter",0===this.spawnAt&&this.spawn(),this.definition.supportLine)return this.drawSupportLine();for(var e=0;e<this.noOfCurves;e++)this.spawnAt+this.despawnTimeouts[e]<=Date.now()?this.amplitudes[e]-=this.DESPAWN_FACTOR:this.amplitudes[e]+=this.DESPAWN_FACTOR,this.amplitudes[e]=Math.min(Math.max(this.amplitudes[e],0),this.finalAmplitudes[e]),this.phases[e]=(this.phases[e]+this.ctrl.speed*this.speeds[e]*this.SPEED_FACTOR)%(2*Math.PI);for(var s=-1/0,i=0,a=[1,-1];i<a.length;i++){var r=a[i];t.beginPath();for(var n=-this.GRAPH_X;n<=this.GRAPH_X;n+=this.ctrl.opt.pixelDepth){var o=this.xPos(n),l=this.yPos(n);t.lineTo(o,this.ctrl.heightMax-r*l),s=Math.max(s,l)}t.closePath(),t.fillStyle="rgba(".concat(this.definition.color,", 1)"),t.strokeStyle="rgba(".concat(this.definition.color,", 1)"),t.fill()}return s<this.DEAD_PX&&this.prevMaxY>s&&(this.spawnAt=0),this.prevMaxY=s,null},t.getDefinition=function(){return[{color:"255,255,255",supportLine:!0},{color:"15, 82, 169"},{color:"173, 57, 76"},{color:"48, 220, 155"}]},t}();return function(){function a(a){var r=this,n=a.container,o=e(a,["container"]);this.phase=0,this.run=!1,this.curves=[];var l=window.getComputedStyle(n);this.opt=t({container:n,style:"ios",ratio:window.devicePixelRatio||1,speed:.2,amplitude:1,frequency:6,color:"#fff",cover:!1,width:parseInt(l.width.replace("px",""),10),height:parseInt(l.height.replace("px",""),10),autostart:!0,pixelDepth:.02,lerpSpeed:.1},o),this.speed=Number(this.opt.speed),this.amplitude=Number(this.opt.amplitude),this.width=Number(this.opt.ratio*this.opt.width),this.height=Number(this.opt.ratio*this.opt.height),this.heightMax=Number(this.height/2)-6,this.color="rgb(".concat(this.hex2rgb(this.opt.color),")"),this.interpolation={speed:this.speed,amplitude:this.amplitude},this.canvas=document.createElement("canvas");var u=this.canvas.getContext("2d");if(null===u)throw new Error("Unable to create 2D Context");this.ctx=u,this.canvas.width=this.width,this.canvas.height=this.height,!0===this.opt.cover?this.canvas.style.width=this.canvas.style.height="100%":(this.canvas.style.width="".concat(this.width/this.opt.ratio,"px"),this.canvas.style.height="".concat(this.height/this.opt.ratio,"px")),"ios9"===this.opt.style?this.curves=(this.opt.curveDefinition||i.getDefinition()).map((function(t){return new i(r,t)})):this.curves=(this.opt.curveDefinition||s.getDefinition()).map((function(t){return new s(r,t)})),this.opt.container.appendChild(this.canvas),this.opt.autostart&&this.start()}return a.prototype.hex2rgb=function(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,(function(t,e,s,i){return e+e+s+s+i+i}));var s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return s?"".concat(parseInt(s[1],16).toString(),",").concat(parseInt(s[2],16).toString(),",").concat(parseInt(s[3],16).toString()):null},a.prototype.intLerp=function(t,e,s){return t*(1-s)+e*s},a.prototype.lerp=function(t){var e=this.interpolation[t];return null!==e&&(this[t]=this.intLerp(this[t],e,this.opt.lerpSpeed),this[t]-e==0&&(this.interpolation[t]=null)),this[t]},a.prototype.clear=function(){this.ctx.globalCompositeOperation="destination-out",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.globalCompositeOperation="source-over"},a.prototype.draw=function(){this.curves.forEach((function(t){return t.draw()}))},a.prototype.startDrawCycle=function(){this.clear(),this.lerp("amplitude"),this.lerp("speed"),this.draw(),this.phase=(this.phase+Math.PI/2*this.speed)%(2*Math.PI),window.requestAnimationFrame?this.animationFrameId=window.requestAnimationFrame(this.startDrawCycle.bind(this)):this.timeoutId=setTimeout(this.startDrawCycle.bind(this),20)},a.prototype.start=function(){if(!this.canvas)throw new Error("This instance of SiriWave has been disposed, please create a new instance");this.phase=0,this.run||(this.run=!0,this.startDrawCycle())},a.prototype.stop=function(){this.phase=0,this.run=!1,this.animationFrameId&&window.cancelAnimationFrame(this.animationFrameId),this.timeoutId&&clearTimeout(this.timeoutId)},a.prototype.dispose=function(){this.stop(),this.canvas&&(this.canvas.remove(),this.canvas=null)},a.prototype.set=function(t,e){this.interpolation[t]=e},a.prototype.setSpeed=function(t){this.set("speed",t)},a.prototype.setAmplitude=function(t){this.set("amplitude",t)},a}()}()},446214:(t,e,s)=>{"use strict";s.d(e,{CategoriesModalBody:()=>l});var i=s(785893),a=s(140874),r=s(524100),n=s(667294);function o(t){return t.map((t=>t.items)).flat()}const l=({api:t,categories:e,selectedCategory:s,onItemClick:l,onItemView:u,onShowMoreClick:c,error:d,onError:h,reloadCategories:p})=>((0,n.useEffect)((()=>{e&&e.length&&u(o(e))}),[e]),d?(0,i.jsx)(r.ErrorBlock,{onReloadClick:p}):e?s?(0,i.jsx)(a.SkillsBlock,{api:t,categoryName:s,onItemClick:l,onItemView:u,onError:h}):(0,i.jsx)("div",{"data-testid":"marusia-skill-list",children:e.map((t=>(0,i.jsx)(a.CategoryBlock,{category:t,onShowMoreClick:c,onItemClick:t=>l(t,o(e))},t.name)))}):(0,i.jsx)(a.CategoriesSkeleton,{}))},11579:(t,e,s)=>{"use strict";s.d(e,{CategoriesSkeleton:()=>g,CategoryBlock:()=>h});var i=s(785893),a=s(399639),r=s(385235),n=s(54929),o=s(219051),l=s(444972),u=s(29271),c=s(387712),d=s(415129);const h=({category:t,onShowMoreClick:e,onItemClick:s})=>{const n=(0,i.jsx)(a.Header,{aside:(0,i.jsx)(r.Link,{onClick:()=>{e(t.name,t.title)},children:u.getLang("mail_marusia_modal_show_all")}),children:t.title});return(0,i.jsx)(d.CategoryGroup,{highlight:t.is_featured,header:n,children:t.items.map((t=>(0,i.jsx)(c.SkillItem,{item:t,onClick:s},t.title)))})},p=({subtitle:t})=>(0,i.jsx)(n.SimpleCell,{before:(0,i.jsx)(o.FakeAvatar,{size:28,children:(0,i.jsx)(l.Skeleton,{circle:!0,width:28,height:28})}),hasHover:!1,hasActive:!1,subtitle:t&&(0,i.jsx)(l.Skeleton,{width:70,height:12}),children:(0,i.jsx)(l.Skeleton,{width:140,height:16})}),m=({highlight:t})=>(0,i.jsxs)(d.CategoryGroup,{highlight:!!t,children:[(0,i.jsx)(p,{}),(0,i.jsx)(p,{subtitle:!0}),(0,i.jsx)(p,{subtitle:!0}),(0,i.jsx)(p,{subtitle:!0})]}),g=()=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(m,{highlight:!0}),(0,i.jsx)(m,{}),(0,i.jsx)(m,{})]})},415129:(t,e,s)=>{"use strict";s.d(e,{CategoryGroup:()=>o});var i=s(785893),a=s(378844),r=s(513724),n=s(545637);const o=({children:t,highlight:e,header:s})=>{const o=(0,i.jsx)(r.Group,{className:e?a.default.highlight:void 0,mode:e?"card":"plain",padding:e?"m":"none",header:s,separator:e?"hide":"show",children:t});return e?(0,i.jsx)(n.Div,{mode:"horizontal",style:{paddingTop:16},children:o}):o}},524100:(t,e,s)=>{"use strict";s.d(e,{ErrorBlock:()=>l});var i=s(785893),a=s(635928),r=s(322421),n=s(832550),o=s(29271);const l=({onReloadClick:t})=>(0,i.jsx)(a.Placeholder,{icon:(0,i.jsx)(r.Icon56IllustrationAntenna,{}),action:(0,i.jsx)(n.Button,{mode:"tertiary",onClick:t,children:o.getLang("mail_marusia_modal_retry")}),children:o.getLang("mail_marusia_modal_error_text")})},387712:(t,e,s)=>{"use strict";s.d(e,{SkillItem:()=>c,SkillSkeleton:()=>d});var i=s(785893),a=s(810954),r=s(354943),n=s(86894),o=s(219051),l=s(54929),u=s(444972);const c=({item:t,onClick:e})=>{const s="dark"===(0,n.useAppearance)()?t.icons.dark:t.icons.light;return(0,i.jsx)(n.Cell,{"data-testid":"marusia-skill-item",onClick:()=>{e(t)},before:(0,i.jsx)(o.FakeAvatar,{size:28,children:(0,i.jsx)("img",{className:a.default.skillImage,src:s,alt:t.title})}),after:(0,i.jsx)(r.Icon24ChevronCompactRight,{className:a.default.icon}),subtitle:t.subtitle,children:t.title})},d=()=>(0,i.jsx)(l.SimpleCell,{before:(0,i.jsx)(o.FakeAvatar,{size:28,children:(0,i.jsx)(u.Skeleton,{circle:!0,width:28,height:28})}),hasHover:!1,hasActive:!1,subtitle:(0,i.jsx)(u.Skeleton,{width:70,height:12}),children:(0,i.jsx)(u.Skeleton,{width:140,height:16})})},657865:(t,e,s)=>{"use strict";s.d(e,{SkillsBlock:()=>o});var i=s(785893),a=s(667294),r=s(387712);const n=()=>(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{}),(0,i.jsx)(r.SkillSkeleton,{})]}),o=({api:t,categoryName:e,onItemClick:s,onItemView:o,onError:l})=>{const[u,c]=(0,a.useState)(null);return(0,a.useEffect)((()=>{t.skillList(e).then((t=>{c(t.result.items)})).catch(l)}),[t,e]),(0,a.useEffect)((()=>{u&&u.length&&o(u)}),[u]),(0,i.jsx)(i.Fragment,{children:u?u.map((t=>(0,i.jsx)(r.SkillItem,{item:t,onClick:t=>s(t,u)},t.title))):(0,i.jsx)(n,{})})}},140874:(t,e,s)=>{"use strict";s.d(e,{CategoriesModalBody:()=>i.CategoriesModalBody,CategoriesSkeleton:()=>a.CategoriesSkeleton,CategoryBlock:()=>a.CategoryBlock,SkillsBlock:()=>r.SkillsBlock,itemToSuggest:()=>o.itemToSuggest,useCategories:()=>n.useCategories});var i=s(446214),a=s(11579),r=s(657865),n=s(997664),o=s(898791)},997664:(t,e,s)=>{"use strict";s.d(e,{useCategories:()=>r});var i=s(667294);let a=null;const r=t=>{const[e,s]=(0,i.useState)(null),[r,n]=(0,i.useState)(null),[o,l]=(0,i.useState)(!1),u=()=>{a=null,n(null),l(!0)},c=()=>{l(!1),s(null),n(null),(t=>(a||(a=t.skillListCategories()),a))(t).then((t=>{s(t.result.categories)})).catch(u)};return(0,i.useEffect)((()=>{c()}),[]),{categories:e,reloadCategories:c,error:o,handleError:u,selectedCategory:r,setSelectedCategory:n}}},898791:(t,e,s)=>{"use strict";s.d(e,{itemToSuggest:()=>i});const i=t=>({type:"text_suggest",callback_data:"",payload:t.subtitle,text:t.subtitle})},476091:(t,e,s)=>{"use strict";s.d(e,{MarusiaButton:()=>d});var i=s(405861),a=s(533376),r=s(351305);const n="im-send-btn--marusia",o="MarusiaButton--visible",l="MarusiaButton--loading",u="MarusiaButton__wave--active",c="MarusiaButton__typing--active";class d{setAnimations(t){return this.animation.setAnimations(t)}setIconState(t){if(!this.animation.haveAnimations())return;const e=this.state;if(this.state=t,e!==this.state)switch("listen"===this.state?this.wave.start():this.wave.stop(),this.waveContainer.classList.remove(u),this.typingContainer.classList.remove(c),t){case"ready":"loading"===e?this.animation.play("load_to_mic"):"answering"===e?this.animation.play("stop_to_mic"):"listen"===e?this.animation.play("load_to_mic"):"typing"===e?this.readyShownFirstTime||(this.readyShownFirstTime=!0,this.animation.play("intro")):this.animation.play("intro");break;case"typing":this.typingContainer.classList.add(c);break;case"loading":var s;if("listen"===e)null==(s=this.animation.play("wave_to_load"))||s.then((()=>{r.playerStore.get().isPlaying||this.playLoadingLoop()}));else if("ready"===e){var i;null==(i=this.animation.play("mic_to_loader"))||i.then((()=>{this.playLoadingLoop()}))}else if("answering"===e){var a;null==(a=this.animation.play("stop_to_loader"))||a.then((()=>{this.playLoadingLoop()}))}break;case"listen":var n;if("ready"===e)null==(n=this.animation.play("mic_to_wave"))||n.then(this.showWave.bind(this));else if("answering"===e){var o;null==(o=this.animation.play("stop_to_wave"))||o.then(this.showWave.bind(this))}else if("loading"===e){var l;null==(l=this.animation.play("mic_to_wave"))||l.then(this.showWave.bind(this))}break;case"answering":"loading"===e?this.animation.play("load_to_stop"):"listen"===e?this.animation.play("wave_to_stop"):"ready"===e&&this.animation.play("load_to_stop");break;case"error":"ready"===e&&this.animation.play("mic_to_error")}}hide(){this.button.classList.remove(n),this.container.classList.remove(o)}show(){this.button.classList.add(n),this.container.classList.add(o)}showPreload(){this.container.classList.add(l)}hidePreload(){this.container.classList.remove(l)}updateWave(t){this.wave.update(t)}dispose(){this.hide(),this.wave.dispose(),this.animationContainer.innerHTML="",this.waveContainer.innerHTML=""}showWave(){"listen"===this.state&&this.waveContainer.classList.add(u)}playLoadingLoop(){"loading"===this.state&&this.animation.play("load_loop",{loop:!0})}constructor({container:t}){var e,s,r,n;this.readyShownFirstTime=!1,this.button=t,this.container=null!=(e=this.button.querySelector("._marusia_button"))?e:document.createElement("span"),this.animationContainer=null!=(s=this.container.querySelector("._marusia_animation"))?s:document.createElement("span"),this.typingContainer=null!=(r=this.container.querySelector("._marusia_typing"))?r:document.createElement("span"),this.waveContainer=null!=(n=this.container.querySelector("._marusia_wave"))?n:document.createElement("span"),this.animation=new a.LottieAnimation(this.animationContainer),this.wave=new i.Wave({min:0,max:128},2,{container:this.waveContainer,width:40,height:40,amplitude:.2,autostart:!1,cover:!0})}}},666236:(t,e,s)=>{"use strict";s.d(e,{MarusiaStatCollector:()=>n});var i=s(262339),a=s(567161),r=s(1483);class n{logPerformance(t){return this.performanceCollector.logEvent(t)}logConversationView(t){return this.conversationViewCollector.logEvent(t)}logConversationClick(t){return this.conversationClickCollector.logEvent(t)}constructor(){this.performanceCollector=new i.MarusiaPerformanceActionStatCollector,this.conversationViewCollector=new a.MarusiaConversationViewStatsCollector,this.conversationClickCollector=new r.MarusiaConversationClickStatsCollector}}},78024:(t,e,s)=>{"use strict";s.d(e,{SuggestManager:()=>n});var i=s(29271);const a="MarusiaSuggests--visible",r="MarusiaSuggests__item";class n{toggleVisibility(t){this.container.classList.toggle(a,t)}show(){this.container.classList.add(a)}hide(){this.container.classList.remove(a)}clearSuggests(){var t;this.suggestList.innerHTML="",null==(t=this.onSuggestListUpdate)||t.call(this,[])}update(t,e=!1){var s;this.currentCommands=t,this.toggleVisibility(!!t.length),this.clearSuggests(),(e?t:this.short(t)).forEach((t=>{const e=this.createSuggestItem(t);this.suggestList.appendChild(e)})),null==(s=this.onSuggestListUpdate)||s.call(this,t)}unmount(){this.hide(),this.suggestList.innerHTML=""}static getSuggestContentForApi(t){let e="";return"event_suggest"===t.type&&(e=t.text),"text_suggest"===t.type&&(e=t.payload),n.replaceSpecialPhrases(e)}static isSuggestCommand(t){return["text_suggest","event_suggest","url_suggest"].includes(t.type)}static replaceSpecialPhrases(t){return t.replace("#DISLIKE#","👎🏻").replace("#LIKE#","👍🏻")}getSuggestWidthPx(t){return this.getTextWidth(n.getSuggestContent(t))+34}getTextWidth(t){const e=this.canvas.getContext("2d");if(!e)return 7*t.length;e.font=this.getContainerFont();return e.measureText(t).width}getContainerFont(){const t=getComputedStyle(this.suggestList);return`${t.getPropertyValue("font-weight")} ${t.getPropertyValue("font-size")} ${t.getPropertyValue("font-family")}`}short(t){let e=this.suggestList.offsetWidth,s=3,i=[],a=!0;return t.forEach((t=>{if(0===s)return void(a=!1);const r=this.getSuggestWidthPx(t);if(e-=r,e>=0)i.push(t);else{if(s-=1,0===s)return void(a=!1);e=1===s?500-r-118:500-r,e>=0&&i.push(t)}})),a||i.push({type:"more"}),i}static getSuggestContent(t){let e="";return"text_suggest"===t.type&&(e=t.text),"event_suggest"===t.type&&(e=t.text),"url_suggest"===t.type&&(e=t.text),n.replaceSpecialPhrases(e)}createSuggestItem(t){if("more"===t.type)return this.createMoreItem();const e=document.createElement("div");return e.className=r,e.innerHTML=n.getSuggestContent(t),e.onclick=()=>{this.onSuggestClick(t,this.currentCommands,"suggests")},e}createMoreItem(){const t=document.createElement("div");return t.className=r,t.innerHTML=i.getLang("mail_marusia_suggest_show_more"),t.onclick=()=>{this.update(this.currentCommands,!0)},t}constructor({container:t,onSuggestClick:e,onSuggestListUpdate:s}){var i;this.currentCommands=[],this.canvas=document.createElement("canvas"),this.container=t,this.suggestList=null!=(i=t.querySelector("._marusia_suggest_list"))?i:document.createElement("div"),this.onSuggestClick=e,this.onSuggestListUpdate=s,this.suggestList.addEventListener("wheel",(t=>((t,e)=>{t.scrollLeft+=e.deltaY})(this.suggestList,t)))}}},159767:(t,e,s)=>{"use strict";s.d(e,{TtsPlayer:()=>l});var i=s(11010),a=s(220681),r=s(167977),n=s(391199),o=s(351305);class l{init(){!1===this.isInitialized&&(this.player.src=a.SILENCE,this.player.play().catch((()=>{})),this.isInitialized=!0)}prepareSoundPlay(){this.soundPlayer.src=a.SILENCE,this.soundPlayer.play().catch((()=>{}))}prepareTtsPlay(){this.interruptCurrentAudio(),this.player.src=a.SILENCE,this.player.play().catch((()=>{}))}playSound(t){this.soundPlayer.src=t,this.soundPlayer.play().catch((()=>{}))}stop(t=!0){t&&this.restoreMediaVolume(),this.interruptCurrentAudio(),this.player.pause(),o.playerStore.setIsPlaying(!1)}play(t,e){var s=this;return(0,i._)((function*(){const i=yield s.getTtsUrl(t,e);return o.playerStore.setIsPlaying(!0),new Promise(((t,e)=>{s.player.src=i,s.reduceMediaVolume(),s.player.play().catch((()=>{})),s.interruptCurrentAudio=()=>e(new Error(n.MarusiaError.USER_INTERRUPT)),s.player.onended=()=>{o.playerStore.setIsPlaying(!1),s.restoreMediaVolume(),s.player.onended=null,t()}}))}))()}reduceMediaVolume(){null===this.prevVolume&&(this.prevVolume=this.audioPlayer.getVolume()),this.audioPlayer.setVolume(.01)}restoreMediaVolume(){null!==this.prevVolume&&(this.audioPlayer.setVolume(this.prevVolume),this.prevVolume=null)}getTtsUrl(t,e){var s=this;return(0,i._)((function*(){let i="";switch(e.type){case"tts":i=yield s.getStreamUrl(t,e.stream_id);break;case"sound":i=e.url}return i}))()}getStreamUrl(t,e){var s=this;return(0,i._)((function*(){const i=yield s.api.getApiHost(),a=yield(0,r.getSession)(s.api),n=s.api.generateDeviceId(),o={session_id:a.session_id,device_id:n,stream_id:e,phrase_id:t},l=new URLSearchParams(o).toString();return`${i.server_url}/stream?${l}`}))()}constructor({audioPlayer:t,api:e}){this.isInitialized=!1,this.prevVolume=null,this.interruptCurrentAudio=()=>{},this.player=new Audio,this.soundPlayer=new Audio,this.audioPlayer=t,this.api=e}}},351305:(t,e,s)=>{"use strict";s.d(e,{playerStore:()=>i});const i=(()=>{let t=0;const e={isPlaying:!1};let s=[];const i=t=>{s.forEach((e=>{e.cb(t)}))};return{get:()=>e,set:(t,s)=>{e[t]=s,i(e)},setIsPlaying:t=>{e.isPlaying=t,i(e)},subscribe:e=>{const i=t++;return s.push({id:i,cb:e}),()=>{s=s.filter((t=>t.id!==i))}}}})()},533376:(t,e,s)=>{"use strict";s.d(e,{LottieAnimation:()=>r});var i=s(11010),a=s(434788);class r{haveAnimations(){return!!this.animations}setAnimations(t){var e=this;return(0,i._)((function*(){const i=yield Promise.all([s.e(38288),s.e(55489)]).then(s.bind(s,682832)).then((t=>t.lottie));e.animations=Object.entries(t).reduce(((t,[s,r])=>(0,a._)({},t,{[s]:t=>{const n=document.createElement("span");e.targetEl.appendChild(n);const o={container:n,animationData:r,renderer:"svg",name:s,autoplay:!1,loop:!1,rendererSettings:{viewBoxOnly:!0}};return i.loadAnimation((0,a._)({},o,t))}})),{})}))()}play(t,e){var s;if(null==(s=this.animations)?void 0:s[t])return new Promise((s=>{if(!this.animations)return void s();const i=this.animations[t](e);i.addEventListener("complete",(()=>{s()})),i.addEventListener("DOMLoaded",(()=>{setTimeout((()=>{if(this.currentAnimation){var t;const e=this.currentAnimation.wrapper;this.currentAnimation.destroy(),null==(t=e.parentNode)||t.removeChild(e)}this.currentAnimation=i}),50)})),i.play()}))}constructor(t){this.animations=null,this.targetEl=t}}},269425:(t,e,s)=>{"use strict";s.d(e,{constructPlayerAudio:()=>c,extractPlaylistCommands:()=>y,getAudioList:()=>E,getCommandsToAutoplay:()=>v,getFullIdFromTuple:()=>m,getHashesForAudios:()=>l,getVoiceAssistantData:()=>d,isAudioAttach:()=>p});var i=s(11010),a=s(434788),r=s(182525),n=s(285853);const o="marusia_playlist_audio";function l(t,e){return u.apply(this,arguments)}function u(){return(u=(0,i._)((function*(t,e){const s=e.map((t=>`${t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_OWNER_ID]}_${t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]}_${t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_ACCESS_KEY]}`)).join(","),i=yield t.reloadAudios(s).catch((()=>null));return i?(i.forEach((t=>{const s=e.find((e=>e[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]===t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]));s&&(t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_EXTRA]=s[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_EXTRA])})),i):null}))).apply(this,arguments)}function c(t,e,s){var i;const a=function(t){var e,s,i,a;if(t.coverUrl)return`${t.coverUrl},${t.coverUrl}`;if(t.cover_url)return`${t.cover_url},${t.cover_url}`;if((null==(s=t.album)||null==(e=s.thumb)?void 0:e.photo_68)&&(null==(a=t.album)||null==(i=a.thumb)?void 0:i.photo_135)){return`${t.album.thumb.photo_68},${t.album.thumb.photo_135}`}return""}(t),l=!!t.album&&[t.album.owner_id,t.album.id,t.album.access_key],u=function(t,e){switch(t){case n.MarusiaMediaType.podcast:return{podcast:!0,fave:!1,private:!1};case n.MarusiaMediaType.tale:case n.MarusiaMediaType.books:return{voiceAssistant:e,marusiaTale:!0};case n.MarusiaMediaType.radio:return{voiceAssistant:e,radio:!0,externalStream:!0};default:return{voiceAssistant:e}}}(e,s),c=new Array(27);let d=t.title;var h;let p=null!=(h=t.artist)?h:"Marusia";var m,g,_,y,v,E,f;return e===n.MarusiaMediaType.radio&&(d=`${t.artist} ${t.title}`,p=""),c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID]=null!=(m=t.id)?m:0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_OWNER_ID]=null!=(g=t.owner_id)?g:0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_URL]=t.url,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_TITLE]=d,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_PERFORMER]=p,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_DURATION]=null!=(_=t.duration)?_:0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ALBUM_ID]=null!=(y=null==(i=t.album)?void 0:i.id)?y:0,c[7]=0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_AUTHOR_LINK]="",c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_LYRICS]=0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_FLAGS]=0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_CONTEXT]=e===n.MarusiaMediaType.tale||e===n.MarusiaMediaType.books?"":"im",c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_EXTRA]=JSON.stringify(u),c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_HASHES]="",c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_COVER_URL]=a,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ADS]=null!=(v=t.ads)?v:{},c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_SUBTITLE]="",c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_MAIN_ARTISTS]="",c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_FEAT_ARTISTS]="",c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ALBUM]=l,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_TRACK_CODE]=null!=(E=t.track_code)?E:"",c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_RESTRICTION]=0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ALBUM_PART]=0,c[23]=!0,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_ACCESS_KEY]=null!=(f=t.access_key)?f:o,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_CHART_INFO_INDEX]=!1,c[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_TRACK_PAGE_ID]="",c}function d(t,e){let s;const i=h(t),a=e.find((t=>{var e;return null==(e=t.attaches)?void 0:e.find((t=>t.id===i))}));if(a){var r;const t=null==(r=a.attaches)?void 0:r.findIndex((t=>t.id===i));if(-1!==t){var n;const e=null==(n=a.kludges)?void 0:n[`attach${t+1}_voice_assistant`];try{s=JSON.parse(e)}catch(t){}}}return s}function h(t){var e,s;return(null!=(e=t.meta.owner_id)?e:0)+"_"+(null!=(s=t.meta.id)?s:0)}function p(t){return"type"in t&&("audio"===t.type||"podcast"===t.type)}function m(t){var e,s;return`${null!=(e=t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_OWNER_ID])?e:0}_${null!=(s=t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_ID])?s:0}`}function g(t){return"media"===t.type||"playlist"===t.type}function _(t){return Promise.all(t.map(((e,s)=>function(t,e,s){return 0===t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_DURATION]?new Promise((i=>{const a=new Audio(t[r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_URL]);a.addEventListener("loadedmetadata",(()=>{s[e][r.AUDIO_PLAYER_ENUMS.AUDIO_ITEM_INDEX_DURATION]=a.duration,i()})),setTimeout(i,5e3)})):Promise.resolve()}(e,s,t))))}function y(t){if(!t.length)return[];const e=[];return t.filter(g).forEach((t=>{"media"===t.type&&e.push(t),"playlist"===t.type&&t.tracks.forEach((t=>{e.push((0,a._)({},t,{type:"media"}))}))})),e}function v(t,e){var s;const i=e.map((t=>null!=(s=t.attaches)?s:[])).flat().filter(p);if(!t.length)return[];const a=i.map((t=>t.id));let r=y(t);return r=r.filter((t=>a.includes(h(t)))),r}function E(t,e){return f.apply(this,arguments)}function f(){return(f=(0,i._)((function*(t,e){let s=e[t];const i=e.filter(((e,s)=>s<t)),a=s.media_type;if(i.filter((t=>"media"===t.type&&t.media_type===a)).length)return;const r=e.filter((t=>"media"===t.type&&t.media_type===a)).map((t=>{var e;return c(t.meta,a,{source:null==(e=t.meta)?void 0:e.source})}));return yield _(r),r}))).apply(this,arguments)}},938141:(t,e,s)=>{"use strict";s.d(e,{processCommandNeedMoreVkPermissions:()=>a});var i=s(11010);function a(t,e,s){return r.apply(this,arguments)}function r(){return(r=(0,i._)((function*(t,e,s){s(yield t.upgradeToken(e))}))).apply(this,arguments)}},465889:(t,e,s)=>{"use strict";s.d(e,{MARUSIA_HELP_BUTTON_CLASS:()=>i});const i="_im_marusia_help"},727745:(t,e,s)=>{"use strict";s.d(e,{MarusiaSharedSdk:()=>S});var i=s(11010),a=s(571039),r=s(301230),n=s(391199),o=s(39460),l=s(589100),u=s(476091),c=s(159767),d=s(351305),h=s(167977),p=s(661893),m=s(78024),g=s(285853),_=s(974861),y=s(367431),v=s(839470),E=s(666236);const f=(0,y.makeSharedState)("marusia-sdk",(()=>({vkcom:()=>{},mvk:()=>{},fastchat:()=>{}})),{version:0});class S{onPhraseUpdate(t){var e,s;null==(e=(s=this.eventCallbacks).phrase_update)||e.call(s,t.text_so_far||"...")}generateId(){return this.platform.entry+this._messageId++}enqueueCommand(t){this.processCommandsQueue.push(t)}isQueued(t){return!!this.processCommandsQueue.find((e=>e.id===t))}processCommandsFromQueue(t){if(0!==this.processCommandsQueue.length&&this.processCommandsQueue[0].id===t){const t=this.processCommandsQueue.shift();if(!t)return;if(this.isHidden)return;t.cb()}}clearQueue(){this.processCommandsQueue=[]}sendMessage(t,e,s){var i,a;null==(i=(a=this.eventCallbacks).send_message)||i.call(a,{text:t,payload:{communication_type:e,voice_assistant:{support_process_commands_by_ids:!0,id:s.id}}}),this.enqueueCommand(s)}onPhraseFinish(t,e){var s,i;const a=()=>{this.processCommands(t,e.result.commands,e.result.controls).then((()=>{var t;this.setMarusiaState("ready");let s=!0;if(e.result.commands.length){"listen"===e.result.commands[e.result.commands.length-1].type&&(s=!1,this.onClick())}e.result.controls.some((t=>t.type===_.ControlType.CONTROL_TYPE_VOLUME))&&(s=!1),s&&(null==(t=this.ttsPlayer)||t.restoreMediaVolume())})).catch((t=>{this.onError(t)}))};var r,o;if(null===e.result.asr_text)return this.clearTextInput(),null==(r=(o=this.eventCallbacks).phrase_finish)||r.call(o,""),void a();null==(s=(i=this.eventCallbacks).phrase_finish)||s.call(i,e.result.asr_text);const l={id:this.generateId(),cb:a};this.sendMessage(e.result.asr_text,n.CommunicationType.button,l),this.isRecording=!1}onStatusUpdate(t){var e;switch(this.log("textSoFar",t,null==(e=Object.entries(l.TextSoFarStatus).find((e=>e[1]===t)))?void 0:e[0]),t){case l.TextSoFarStatus.INIT:this.isDisabled=!0,this.setMarusiaState("loading");break;case l.TextSoFarStatus.MEDIA_STREAM_ACQUIRED:var s,i,a;if(this.staticStorage)null==(a=this.ttsPlayer)||a.playSound(this.staticStorage.sounds.sound_start);null==(s=(i=this.eventCallbacks).phrase_start)||s.call(i,"...");break;case l.TextSoFarStatus.PHRASE_CREATED:var r;null==(r=this.textSoFar)||r.start(),this.isDisabled=!1,this.setMarusiaState("listen"),this.isRecording=!0;break;case l.TextSoFarStatus.API_ERROR:var n,o;this.isDisabled=!1,this.setMarusiaState("ready"),null==(n=(o=this.eventCallbacks).phrase_finish)||n.call(o,"");break;case l.TextSoFarStatus.GRACE_STOP:case l.TextSoFarStatus.PRE_RESULT:var u;if(this.isDisabled=!0,this.staticStorage)null==(u=this.ttsPlayer)||u.playSound(this.staticStorage.sounds.sound_end);this.setMarusiaState("loading"),this.isRecording=!1;break;case l.TextSoFarStatus.NOTHING:var c,d,h;this.isDisabled=!1,this.setMarusiaState("ready"),this.isRecording=!1,null==(c=(d=this.eventCallbacks).phrase_finish)||c.call(d,""),null==(h=this.ttsPlayer)||h.restoreMediaVolume();break;case l.TextSoFarStatus.INTERRUPT:var p,m;this.isDisabled=!1,this.setMarusiaState("ready"),this.isRecording=!1,null==(p=(m=this.eventCallbacks).phrase_finish)||p.call(m,"");break;case l.TextSoFarStatus.SUCCESS:this.isDisabled=!1;break;case l.TextSoFarStatus.ERROR:var g,_;this.isDisabled=!1,this.setMarusiaState("ready"),null==(g=(_=this.eventCallbacks).phrase_finish)||g.call(_,"")}}onAudioProcess(t){var e,s,i;null==(e=this.marusiaButton)||e.updateWave(t),null==(s=(i=this.eventCallbacks).wave_update)||s.call(i,t)}onError(t){var e,s;switch(this.log("onError",t,t.message),t.message){case n.MarusiaError.BACKEND_COMMAND_TIMEOUT:this.setMarusiaState("error");break;case n.MarusiaError.HIDDEN:this.setMarusiaState("ready");break;case n.MarusiaError.USER_INTERRUPT:var i;null==(i=this.ttsPlayer)||i.restoreMediaVolume(),this.setMarusiaState("ready");break;case n.MarusiaError.ATTACH_LOAD_TIMEOUT:break;default:this.log("unknown error",t,t.name,t.message)}null==(e=(s=this.eventCallbacks).error)||e.call(s,t.message)}getMarusiaSessionId(){return(0,h.getSession)(this.api)}loadStatic(){var t=this;return(0,i._)((function*(){const e=yield t.api.getWebStatic(),s=[...Object.entries(e.animations)],i=yield Promise.all(s.map((t=>fetch(t[1]).then((t=>t.json()))))),a={sounds:e.sounds,animations:{}};return s.forEach(((t,s)=>{const r=t[0],n=i[s],o=e.images.marusia_bg.split("/");n.assets[0].u=o.slice(0,-1).join("/")+"/",n.assets[0].p=o[o.length-1],a.animations[r]=n})),a}))()}preload(){var t=this;return(0,i._)((function*(){var e,s;const i=yield Promise.all([t.loadStatic(),t.getMarusiaSessionId()]);return null==(e=(s=t.eventCallbacks).session_create)||e.call(s),i}))()}waitForBackendCommand(t){return new Promise(((e,s)=>{const i=t.phraseId+t.commandIds.flat().join("-"),a=setTimeout((()=>{this.backendCommandsQueue=this.backendCommandsQueue.filter((t=>t.id!==i)),s(n.MarusiaError.BACKEND_COMMAND_TIMEOUT)}),this.BACKEND_COMMAND_TIMEOUT);this.backendCommandsQueue.push({id:i,callback:()=>{var s;clearTimeout(a);const r=this.backendCommandsQueue.find((t=>t.id===i));var n;this.backendCommandsQueue=this.backendCommandsQueue.filter((t=>t.id!==i)),this.statCollector.logPerformance({key:"backend_command_processing_time",value:Date.now()-t.timeStart,entry_point:this.platform.entry}),e([...null!=(n=null==(s=r)?void 0:s.events)?n:[]])},events:[],signature:t})}))}processBackendCommands(t,e){return this.api.processBackendCommands(t,e),this.waitForBackendCommand({phraseId:t,commandIds:[...e],timeStart:Date.now()})}failIfHidden(){if(this.isHidden)throw new Error(n.MarusiaError.HIDDEN)}interruptProcessingCommands(){Object.keys(this.processingCommands).forEach((t=>{this.processingCommands[t]=!0}))}failIfInterrupted(t){if(this.processingCommands[t])throw new Error(n.MarusiaError.USER_INTERRUPT)}needNewChunk(t){return(0,p.isSuggestCommand)(t)||"playlist"===t.type||"media"===t.type}processCommands(t,e,s){var a=this;return(0,i._)((function*(){if(a.processingCommands[t]=!1,a.log(`[${t}] commands`,e),!a.api)return;let i=[],r=[];0===e.filter(p.isSuggestCommand).length&&a.clearSuggests();for(let s=0;s<e.length;s++){const n=e[s],o=s+1<e.length?e[s+1]:null,l=yield a.api.isBackendCommand(n),u=!!o&&(yield a.api.isBackendCommand(o));if(a.failIfHidden(),a.needNewChunk(n)&&r.length&&(i.push(r),r=[]),l){if(r.push(s),o&&(u||a.needNewChunk(o)))continue;i.push(r),r=[]}else switch(a.log(`[${t}] exec`,n.type,n),n.type){case"tts":case"sound":yield a.processTtsCommand(t,n);break;case"media":const i=[g.MarusiaMediaType.tale,g.MarusiaMediaType.music,g.MarusiaMediaType.books,g.MarusiaMediaType.radio];a.audioPlayer&&i.includes(n.media_type)&&(yield a.commands.processMedia(a.audioPlayer,s,e,t));break;case"playlist":a.audioPlayer&&a.commands.processPlaylist(a.audioPlayer,n,t);break;case"event_suggest":case"text_suggest":case"url_suggest":a.processSuggestCommands(e,s);break;case"portal_deeplink":a.commands.processPortalDeeplink(n);break;case"need_more_vk_permissions":a.commands.processNeedMoreVkPermissions(a.api,n,(()=>{if("text"in n.repeat_data)a.processTextPhrase(n.repeat_data.text);else{const t={};try{t.callback_data=JSON.parse(n.repeat_data.callback_data)}catch(t){a.log(t)}a.onMarusiaEvent(n.repeat_data.event,t)}})).catch((t=>{a.log("NeedMoreVkPermissions error",t)}));break;case"call_start":a.commands.processCallStart(n);break;case"send_event_data":"drop"===n.on_interrupt&&a.failIfInterrupted(t),a.processSendEventDataCommand(n);break;case"delay":yield new Promise((t=>setTimeout(t,n.length)))}if(i.length){if(o&&(u||a.needNewChunk(o)))continue;const s=yield a.processBackendCommands(t,i);a.log(`[${t}] GOT BACKEND CMD`,i,e.filter(((t,e)=>i.flat().includes(e)))),a.failIfHidden();const n=e.filter(((t,e)=>i.flat().includes(e))).filter((t=>"media"===t.type||"playlist"===t.type));a.audioPlayer&&(yield a.commands.autoPlayMediaAttaches(a.api,a.audioPlayer,n,s,t)),i=[],r=[]}}s.forEach((t=>a.audioPlayer&&a.commands.executeControl(a.audioPlayer,t)))}))()}isSuggestCommands(t){return t.every((t=>"event_suggest"===t.type||"text_suggest"===t.type||"url_suggest"===t.type))}getSuggests(t){var e=this;return(0,i._)((function*(){const s=yield e.api.getSuggests(t);var i,a,r;(e.failIfHidden(),e.isSuggestCommands(s.items))&&(null==(i=e.suggestManager)||i.update(s.items,e.suggestsFlat),null==(a=(r=e.eventCallbacks).suggest_update)||a.call(r,s.items),s.items.length&&e.statCollector.logConversationView({suggest_item:{suggests:s.items.map((t=>({text:t.text})))},type:"suggests"}))}))()}clearSuggests(){var t,e,s,i;null==(t=this.suggestManager)||t.clearSuggests(),null==(e=(s=this.eventCallbacks).suggest_update)||e.call(s,[]),null==(i=this.suggestManager)||i.hide()}onSuggestClick(t,e,s){var r=this;return(0,i._)((function*(){if(e&&r.statCollector.logConversationClick({type:null!=s?s:"hint",suggest_item:{action_index:e.findIndex((e=>e.text===t.text))+1,suggests:e.map((t=>({text:t.text})))}}),"url_suggest"===t.type)return void window.open((0,a.wrapAwayIfExternal)(t.url,!0),"_blank");r.clearSuggests(),r.stopListening();const i=m.SuggestManager.getSuggestContentForApi(t),o={};try{o.callback_data=JSON.parse(t.callback_data)}catch(t){r.log(t)}const l={id:r.generateId(),cb:()=>{"event_suggest"===t.type?r.onMarusiaEvent(t.event,o):r.processTextPhrase(i,o)}};r.sendMessage(m.SuggestManager.replaceSpecialPhrases(i),n.CommunicationType.suggest,l)}))()}processSuggestCommands(t,e){var s,i,a;const r=t[e],n=t.filter(((t,s)=>s>e)).filter((t=>m.SuggestManager.isSuggestCommand(t)));if(!m.SuggestManager.isSuggestCommand(r))return;if(n.length)return;const o=t.filter(m.SuggestManager.isSuggestCommand);null==(s=this.suggestManager)||s.update(o,this.suggestsFlat),o.length&&this.statCollector.logConversationView({suggest_item:{suggests:o.map((t=>({text:t.text})))},type:"suggests"}),null==(i=(a=this.eventCallbacks).suggest_update)||i.call(a,o)}processTtsCommand(t,e){var s=this;return(0,i._)((function*(){return s.ttsPlayer?s.ttsPlayer.play(t,e):Promise.resolve()}))()}handleOutboundMessage(t){var e,s;this.interruptProcessingCommands();const i=JSON.parse(null!=(s=null==(e=t.kludges)?void 0:e.payload)?s:"null");if(i)switch(i.communication_type){case n.CommunicationType.button:case n.CommunicationType.suggest:if(this.isQueued(i.voice_assistant.id)){if(t.local)return void this.setMarusiaState("loading");this.processCommandsFromQueue(i.voice_assistant.id)}break;case n.CommunicationType.text:t.local?(this.audioPlayer&&!this.audioPlayer.isPlaying()&&this.audioPlayer.preparePlay(),this.setMarusiaState("loading"),this.outboundMessageIds.push(t.randomId)):null!==t.randomId&&this.outboundMessageIds.includes(t.randomId)&&(this.outboundMessageIds=this.outboundMessageIds.filter((e=>e!==t.randomId)),this.processTextPhrase(t.text))}}handleInboundMessage(t){var e,s,i;const a=JSON.parse(null!=(i=null==(e=t.kludges)?void 0:e.payload)?i:"null");if(!a||!a.voice_assistant)return;(null==(s=a.voice_assistant.commands)?void 0:s.length)&&this.processPayloadCommands(a.voice_assistant.commands);const r=this.backendCommandsQueue.find((t=>{var e;return t.signature.phraseId===(null==(e=a.voice_assistant)?void 0:e.phrase_id)}));if(!r)return;const n=r.signature.phraseId,o=r.signature.commandIds[0];(0,p.isPayloadForCommand)(a,{phraseId:n,commandIds:o})&&(r.signature.commandIds.shift(),r.events.push(t),0===r.signature.commandIds.length&&r.callback())}handleSendStartSession(t,e,s){(0,v.partConfigEnabled)("marusia_send_start_session")&&(t||e||s||this.api.sendStartSessionEvent())}hasDeeplinkParams(){const t=new URLSearchParams(window.location.search),e=t.get("text"),s=t.get("text_data"),i=t.get("event_name"),a=t.get("event_data");return!!(e||s||i||a)}handleDeeplink(){const t=new URLSearchParams(window.location.search),e=t.get("event_name"),s=t.get("event_data");if(e){const t=s?(0,p.parseBase64JSON)(s):null;this.onMarusiaEvent(e,{client_data:t})}}onMarusiaEvent(t,e){var s=this;return(0,i._)((function*(){var i;const a=yield s.api.phraseCreateEvent(t,e,null==(i=s.audioPlayer)?void 0:i.getPlayerData());s.failIfHidden(),a?"error"in a?s.onError(new Error(a.error)):yield s.processCommands(a.result.phrase_id,a.result.phrase_result.commands,a.result.phrase_result.controls).then((()=>{s.setMarusiaState("ready")})).catch((t=>{s.onError(t)})):s.setMarusiaState("error")}))()}processTextPhrase(t,e){var s=this;return(0,i._)((function*(){var i;s.setMarusiaState("loading");const a=yield s.api.phraseCreateText(t,e,null==(i=s.audioPlayer)?void 0:i.getPlayerData()).catch((()=>null));s.failIfHidden(),a?s.processCommands(a.result.phrase_id,a.result.phrase_result.commands,a.result.phrase_result.controls).then((()=>{s.setMarusiaState("ready")})).catch((t=>{s.onError(t)})):s.setMarusiaState("error")}))()}handleTextInput(t){const e=this.getTextFromInputEvent(t),s=r.browser.safari?"\n"!==e&&!!e:!!e;this.setMarusiaState(s?"typing":"ready")}textInputHaveText(){return!!this.textInput&&!!this.textInput.innerText}processSendEventDataCommand(t){const e={client_data:{}};try{e.client_data.send_event_data=JSON.parse(t.callback_data)}catch(t){}this.onMarusiaEvent(t.event,e)}processPayloadCommands(t){this.log("payload commands",t);for(let e=0;e<t.length;e++){const s=t[e];switch(s.type){case"vk_get_data_event":this.processSendEventDataCommand(s);break;case"event_suggest":case"text_suggest":case"url_suggest":this.processSuggestCommands(t,e)}}}init(t){var e=this;return(0,i._)((function*(){var s,i,a;e.log("init",e,t,e.isInitialized),e.showCount+=1,null==(s=e.suggestManager)||s.show();let r=t.draftText;"..."===r&&(e.clearTextInput(),r=""),e.show(!!r);const n=yield e.api.getLastMessageCommands().catch((()=>null));if(n&&n.length&&!t.needOnboarding&&e.processPayloadCommands(n),null!==n&&0!==n.length||t.needOnboarding||e.getSuggests(!!t.unreadMessages).catch((()=>{})),e.isInitialized||e.isLoading)return;e.handleSendStartSession(!!t.unreadMessages,t.needOnboarding,e.hasDeeplinkParams());const o=Date.now();var l;e.setTextValue=t.setTextValue,e.onHelpClick=t=>{e.showSkillListModal(e.api,e.statCollector,((t,s)=>{e.onSuggestClick(t,s)}),t)},e.isLoading=!0,e.textInput=null!=(l=t.textInput)?l:null,e.textInput&&(e.textInput.addEventListener("input",e.handleTextInput.bind(e)),e.isHidden||(0,p.disableMarusiaTextInput)(e.textInput)),t.iconContainer&&(e.marusiaButton=new u.MarusiaButton({container:t.iconContainer}),e.isHidden||e.marusiaButton.show(),e.marusiaButton.showPreload());const[h,g]=yield e.preload();var _;(e.sessionId=g.session_id,yield null==(i=e.marusiaButton)?void 0:i.setAnimations(h.animations),e.staticStorage=h,e.ttsPlayer=new c.TtsPlayer({audioPlayer:e.audioPlayer,api:e.api}),e.ttsPlayer.init(),e.unsubscribeFromPlayerStore=d.playerStore.subscribe((t=>{t.isPlaying?(e.isSpeaking=!0,e.setMarusiaState("answering")):(e.isSpeaking=!1,e.setMarusiaState("ready"))})),null==(a=e.marusiaButton)||a.hidePreload(),e.textInput&&!e.isHidden&&(0,p.enableMarusiaTextInput)(e.textInput),t.needOnboarding)&&(null==(_=e.api)||_.getOnboarding().then((s=>{s.is_sent||e.getSuggests(!!t.unreadMessages).catch((()=>{}))})));e.isInitialized=!0,e.isLoading=!1,e.statCollector.logPerformance({key:"sdk_init_time",value:Date.now()-o,entry_point:e.platform.entry}),t.suggestContainer&&(e.suggestManager=new m.SuggestManager({container:t.suggestContainer,onSuggestClick:e.onSuggestClick.bind(e),onSuggestListUpdate:e.eventCallbacks.suggest_update}),e.getSuggests(!!t.unreadMessages).catch((()=>{}))),e.setMarusiaState(e.textInputHaveText()?"typing":"ready"),e.handleDeeplink()}))()}show(t){var e;this.isHidden=!1,this.setMarusiaState(t?"typing":"ready"),null==(e=this.marusiaButton)||e.show(),this.platform.show(),this.textInput&&(this.isLoading?(0,p.disableMarusiaTextInput)(this.textInput):(0,p.enableMarusiaTextInput)(this.textInput))}hide(){var t,e;this.isHidden=!0,this.setMarusiaState("ready"),null==(t=this.marusiaButton)||t.hide(),null==(e=this.suggestManager)||e.hide(),this.platform.hide(),this.textInput&&(0,p.enableMarusiaTextInput)(this.textInput),this.clearQueue()}canSentMessage(){return"loading"!==this.marusiaState&&("listen"!==this.marusiaState&&("answering"!==this.marusiaState&&!this.isLoading))}onAddMessage(t){this.log(`onAddMessage skip: ${this.isHidden}`,t);try{if(this.isHidden)return;t.forEach((t=>{t.isOutbound?this.handleOutboundMessage(t):this.handleInboundMessage(t)}))}catch(t){console.error(t)}}log(...t){this.debug&&console.log(`[${this.platform.entry}]`,...t)}on(t,e){this.eventCallbacks[t]=e}setMarusiaState(t){var e,s,i;this.log("setMarusiaState: ",t),this.marusiaState=t,null==(e=this.marusiaButton)||e.setIconState(this.marusiaState),null==(s=(i=this.eventCallbacks).state_update)||s.call(i,t)}interruptOtherEntries(){const t=f();Object.keys(t).forEach((e=>{e!==this.platform.entry&&t[e]()}))}interrupt(){var t,e,s;this.isHidden||(((null==(t=this.textSoFar)?void 0:t.isRecording)||(null==(e=this.textSoFar)?void 0:e.isCreatingPhrase))&&this.textSoFar.stop(!1,!0,!0),null==(s=this.ttsPlayer)||s.stop(!1))}onClick(){var t=this;return(0,i._)((function*(){var e,s,i;if(t.interruptOtherEntries(),t.interruptProcessingCommands(),t.isInitialized&&!t.isDisabled&&"loading"!==t.marusiaState)if(t.isSpeaking){var a;null==(a=t.ttsPlayer)||a.stop()}else{var r,n;if(null==(e=t.ttsPlayer)||e.reduceMediaVolume(),null==(s=t.ttsPlayer)||s.prepareSoundPlay(),null==(i=t.ttsPlayer)||i.prepareTtsPlay(),t.audioPlayer&&!t.audioPlayer.isPlaying()&&t.audioPlayer.preparePlay(),!t.textSoFar)t.textSoFar=new o.TextSoFar(t.onPhraseUpdate.bind(t),t.onPhraseFinish.bind(t),t.onStatusUpdate.bind(t),t.onAudioProcess.bind(t),(()=>({isHidden:t.isHidden,currentShowCount:t.showCount})),t.api,null!=(r=t.audioPlayer)?r:void 0),t.setMarusiaState("loading");if(t.textSoFar.isRecording)t.textSoFar.graceStop(),t.textSoFar.stop(!1,!0),null==(n=t.ttsPlayer)||n.restoreMediaVolume();else yield t.textSoFar.init()}}))()}clearTextInput(){var t;this.textInput&&(null==(t=this.setTextValue)||t.call(this,this.textInput,""))}stopListening(){var t,e,s;((null==(t=this.textSoFar)?void 0:t.isRecording)||(null==(e=this.textSoFar)?void 0:e.isCreatingPhrase))&&this.textSoFar.stop(!1,!0),null==(s=this.ttsPlayer)||s.stop()}isReady(){return this.isInitialized&&!this.isLoading}dispose(){var t,e;this.stopListening(),this.textSoFar=null,this.backendCommandsQueue=[],this.textInput&&(this.textInput.removeEventListener("input",this.handleTextInput.bind(this)),this.textInput=null),this.marusiaButton&&(this.marusiaButton.dispose(),this.marusiaButton=null),null==(t=this.suggestManager)||t.unmount(),this.suggestManager=null,null==(e=this.ttsPlayer)||e.stop(),this.ttsPlayer=null,this.unsubscribeFromPlayerStore(),this.hide(),this.isInitialized=!1}constructor(t){this.suggestsFlat=!1,this.debug=!1,this.statCollector=new E.MarusiaStatCollector,this.BACKEND_COMMAND_TIMEOUT=3e4,this.isInitialized=!1,this.suggestManager=null,this.isLoading=!1,this.isSpeaking=!1,this.isRecording=!1,this.isHidden=!0,this.isDisabled=!1,this.sessionId=null,this.staticStorage=null,this.marusiaState="ready",this.textInput=null,this.backendCommandsQueue=[],this.unsubscribeFromPlayerStore=()=>{},this.marusiaButton=null,this.ttsPlayer=null,this.textSoFar=null,this.onHelpClick=()=>{},this.outboundMessageIds=[],this.setTextValue=void 0,this.eventCallbacks={},this._messageId=0,this.processCommandsQueue=[],this.processingCommands={},this.showCount=0,this.platform=t.platform,this.api=t.api,this.showSkillListModal=t.showSkillListModal,this.audioPlayer=t.audioPlayer,this.commands=t.commands,this.getTextFromInputEvent=t.getTextFromInputEvent,this.suggestsFlat=!!t.suggestsFlat,this.debug=!!t.debug,f()[this.platform.entry]=()=>this.interrupt()}}},405861:(t,e,s)=>{"use strict";s.d(e,{Wave:()=>r});var i=s(163293),a=s.n(i);class r{start(){this.wave.start()}stop(){this.wave.stop()}dispose(){this.wave.stop(),this.wave.dispose()}update(t){this.cache||(this.cache=new Uint8Array(t.frequencyBinCount)),t.getByteFrequencyData(this.cache);const e=r.getAverageVolume(this.cache),s=10*this.getAlignedVolume(e);this.wave.setAmplitude(s>this.maxVisibleAmp?this.maxVisibleAmp:s)}getAlignedVolume(t){const{min:e,max:s}=this.volumeRange;return((t=t<e?e:t>s?s:t)-e)/(s-e)}static getAverageVolume(t){return t.reduce(((t,e)=>t+e),0)/t.length}constructor(t,e,s){this.volumeRange=t,this.maxVisibleAmp=e,this.wave=new(a())(s)}}},791762:(t,e,s)=>{"use strict";var i;function a(t){return 6===t||5===t||3===t||4===t}function r(t){return 5===t||3===t}s.d(e,{isErrorOccurred:()=>r,isFinalStatus:()=>a}),function(t){t[t.OKAY_GO_ON=1]="OKAY_GO_ON",t[t.KEYWORD_CONFIRMED=2]="KEYWORD_CONFIRMED",t[t.KEYWORD_NOT_CONFIRMED=3]="KEYWORD_NOT_CONFIRMED",t[t.END_OF_PHRASE=4]="END_OF_PHRASE",t[t.ERROR_OCCURRED=5]="ERROR_OCCURRED",t[t.PHRASE_RECOGNIZED=6]="PHRASE_RECOGNIZED"}(i||(i={}))},39460:(t,e,s)=>{"use strict";s.d(e,{TextSoFar:()=>l});var i=s(11010),a=s(29271),r=s(589100),n=s(791762),o=s(459357);class l{init(){var t=this;return(0,i._)((function*(){t.isCreatingPhrase=!0;const e=t.checkMarusiaVisibility().currentShowCount;t.currentShowCount=e,t.onStatusUpdate(r.TextSoFarStatus.INIT);try{const e={audio:{advanced:[{}]}};t.mediaStream=yield navigator.mediaDevices.getUserMedia(e)}catch(e){t.onStatusUpdate(r.TextSoFarStatus.ERROR);let s=e.name;switch(e.name){case"DevicesNotFoundError":case"NotFoundError":case"NotAllowedError":s=a.getLang("mail_audio_message_device_error");break;case"PermissionDeniedError":case"PermissionDismissedError":s=a.getLang("mail_audio_message_permission_error");break;case"Unsupported":s=a.getLang("mail_audio_message_unsupported_error")}throw t.onError(s),t.isCreatingPhrase=!1,e}t.onStatusUpdate(r.TextSoFarStatus.MEDIA_STREAM_ACQUIRED),t.recorder=new o.MarusiaMediaRecorder(t.mediaStream,t.onAudioProcess),t.abortController=new AbortController;try{var s;const i=yield t.api.createAsrPhrase(null==(s=t.player)?void 0:s.getPlayerData(),t.abortController.signal);if(t.phraseId=i.result.phrase_id,t.shouldInterrupt(e))return t.stopRecorder(),void t.onStatusUpdate(r.TextSoFarStatus.API_ERROR)}catch(e){return t.stopRecorder(),void t.onStatusUpdate(r.TextSoFarStatus.API_ERROR)}finally{t.isCreatingPhrase=!1}t.onStatusUpdate(r.TextSoFarStatus.PHRASE_CREATED)}))()}start(){this.attachDataAvailableHandler(),this.startRecorder()}shouldInterrupt(t){const e=this.checkMarusiaVisibility(),s=null!=t?t:this.currentShowCount;return!(!e.isHidden&&s===e.currentShowCount)}startRecorder(){this.recorder.start(200),this.onStatusUpdate(r.TextSoFarStatus.RECORDING),this.isRecording=!0}stopRecorder(){this.recorder.stop(),this.recorder.stream.getTracks().forEach((t=>t.stop())),this.mediaStream=null,this.isRecording=!1,this.recorder.removeEventListener("dataavailable",this.dataAvailableCallback)}attachDataAvailableHandler(){let t=0;var e=this;this.dataAvailableCallback=(0,i._)((function*(s){e.enqueueChunk({chunkNumber:t++,eventData:s.data})})),this.recorder.addEventListener("dataavailable",this.dataAvailableCallback)}enqueueChunk(t){this.chunks.push(t),this.gracefulStopRequested&&(this.recorder.removeEventListener("dataavailable",this.dataAvailableCallback),this.processChunks(!0)),!1===this.isChunksBeingProcessed&&this.processChunks()}processChunks(t=!1){var e=this;return(0,i._)((function*(){if(e.gracefulStopRequested&&!t)return;if("recording"===e.recorder.state&&0===e.chunks.length)return void(e.isChunksBeingProcessed=!1);if(0===e.chunks.length)return;e.isChunksBeingProcessed=!0;let s=e.chunks.shift();try{const i=yield e.api.addChunk(e.phraseId,s.chunkNumber,t,s.eventData,e.abortController.signal);if(e.onPhraseUpdateHandler(i),(0,n.isFinalStatus)(i.status)||t)return void(yield e.stop((0,n.isErrorOccurred)(i.status)));yield e.processChunks()}catch(t){if("AbortError"===t.name)return;e.onStatusUpdate(r.TextSoFarStatus.API_ERROR),yield e.stop(!0)}}))()}graceStop(){this.gracefulStopRequested=!0,this.onStatusUpdate(r.TextSoFarStatus.GRACE_STOP)}stop(t=!1,e=!1,s=!1){var a=this;return(0,i._)((function*(){if(!1===a.gracefulStopRequested&&a.onStatusUpdate(r.TextSoFarStatus.PRE_RESULT),a.abortController.abort(),a.stopRecorder(),a.chunks=[],a.isChunksBeingProcessed=!1,a.gracefulStopRequested=!1,s)a.onStatusUpdate(r.TextSoFarStatus.INTERRUPT);else if(e)a.onStatusUpdate(r.TextSoFarStatus.NOTHING);else if(t)a.onStatusUpdate(r.TextSoFarStatus.ERROR);else try{const t=yield a.api.getPhraseResult(a.phraseId);if(a.shouldInterrupt())return void a.onStatusUpdate(r.TextSoFarStatus.NOTHING);if(a.onPhraseFinishHandler(a.phraseId,t),0===t.result.commands.length&&0===t.result.controls.length)return void a.onStatusUpdate(r.TextSoFarStatus.NOTHING);a.onStatusUpdate(r.TextSoFarStatus.SUCCESS)}catch(t){a.onStatusUpdate(r.TextSoFarStatus.API_ERROR)}}))()}constructor(t,e,s,i,a,r,n){this.isRecording=!1,this.isCreatingPhrase=!1,this.chunks=[],this.abortController=new AbortController,this.isChunksBeingProcessed=!1,this.gracefulStopRequested=!1,this.onError=()=>{},this.currentShowCount=0,this.onPhraseUpdateHandler=t,this.onPhraseFinishHandler=e,this.onStatusUpdate=s,this.onAudioProcess=i,this.checkMarusiaVisibility=a,this.api=r,this.player=n}}},589100:(t,e,s)=>{"use strict";var i;s.d(e,{TextSoFarStatus:()=>i}),function(t){t[t.INIT=0]="INIT",t[t.MEDIA_STREAM_ACQUIRED=1]="MEDIA_STREAM_ACQUIRED",t[t.PHRASE_CREATED=2]="PHRASE_CREATED",t[t.RECORDING=3]="RECORDING",t[t.API_ERROR=4]="API_ERROR",t[t.GRACE_STOP=5]="GRACE_STOP",t[t.PRE_RESULT=6]="PRE_RESULT",t[t.NOTHING=7]="NOTHING",t[t.SUCCESS=8]="SUCCESS",t[t.ERROR=9]="ERROR",t[t.INTERRUPT=10]="INTERRUPT"}(i||(i={}))},974861:(t,e,s)=>{"use strict";var i;s.d(e,{ControlType:()=>i}),function(t){t.CONTROL_TYPE_RESUME="resume_control",t.CONTROL_TYPE_PAUSE="pause_control",t.CONTROL_TYPE_VOLUME="volume_control",t.CONTROL_TYPE_NEXT="next_control",t.CONTROL_TYPE_PREV="previous_control",t.CONTROL_TYPE_REPEAT="repeat_control",t.CONTROL_TYPE_REPEAT_PLAYLIST="repeat_playlist_control",t.CONTROL_TYPE_REWIND="rewind_control"}(i||(i={}))},262339:(t,e,s)=>{"use strict";s.d(e,{MarusiaPerformanceActionStatCollector:()=>a});var i=s(193452);class a{logEvent(t){const e={type:"type_marusia_performance_item",type_marusia_performance_item:t};this.actionStatCollector.logEvent(e)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.actionStatCollector=new i.ActionStatCollector(this.productStatCollector)}}},235431:(t,e,s)=>{"use strict";s.d(e,{settingsChangesStatCollector:()=>a});var i=s(193452);const a=new class{logEvent(t){const e={type:"type_settings_changes_item",type_settings_changes_item:t};this.actionStatCollector.logEvent(e)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.actionStatCollector=new i.ActionStatCollector(this.productStatCollector)}}},1483:(t,e,s)=>{"use strict";s.d(e,{MarusiaConversationClickStatsCollector:()=>r});var i=s(193452),a=s(957973);class r{logEvent(t){const e={type:a.ClickProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM,[a.ClickProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM]:t},s={type:a.EventItemType.CLICK_ITEM};this.clickStatCollector.logEvent(e,s)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.clickStatCollector=new i.ClickStatCollector(this.productStatCollector)}}},385938:(t,e,s)=>{"use strict";s.d(e,{imNavgoStatsCollector:()=>a});var i=s(193452);const a=new class{logEvent(t){this.navgoStatCollector.logEvent(t)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.navgoStatCollector=new i.NavigationStatCollector(this.productStatCollector)}}},567161:(t,e,s)=>{"use strict";s.d(e,{MarusiaConversationViewStatsCollector:()=>r});var i=s(193452),a=s(957973);class r{logEvent(t){const e={end_view:"0",start_view:"0",type:a.ViewProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM,[a.ViewProductionStatEventTypes.TYPE_MARUSIA_CONVERSATION_ITEM]:t},s={type:a.EventItemType.EVENT};this.viewStatCollector.logEvent(e,s)}constructor(){this.productStatCollector=new i.ProductionStatCollector,this.viewStatCollector=new i.ViewStatCollector(this.productStatCollector)}}},265070:(t,e,s)=>{"use strict";s.d(e,{showSkillListModal:()=>m});var i=s(434788),a=s(785893),r=s(667294),n=s(816511),o=s(400856),l=s(342787),u=s(545637),c=s(29271),d=s(140874),h=s(359639);const p=({api:t,statCollector:e,onSkillClick:s,onClose:i,refreshCoordinates:h})=>{var p,m;const{categories:g,error:_,reloadCategories:y,handleError:v,selectedCategory:E,setSelectedCategory:f}=(0,d.useCategories)(t);(0,r.useEffect)((()=>{h()}),[]);const S=(0,r.useCallback)((t=>{e.logConversationView({type:"hint",suggest_item:{suggests:t.map((t=>({text:t.title})))}})}),[e]);var C;return(0,a.jsxs)(n.ModalBox,{"data-testid":"marusia-skill-modal",children:[(0,a.jsx)(o.ModalHeader,{onClose:i,closeAriaLabel:c.getLang("global_close"),backLabel:E&&c.getLang("global_back"),onBack:()=>{f(null)},children:null!=(C=null==(p=E)?void 0:p.title)?C:c.getLang("mail_marusia_bottom_sheet_skills_title")}),(0,a.jsx)(l.ModalScrollView,{height:_?void 0:525,children:(0,a.jsx)(u.Div,{mode:"horizontal",spacing:8,children:(0,a.jsx)(d.CategoriesModalBody,{api:t,categories:g,selectedCategory:null==(m=E)?void 0:m.name,onItemClick:(t,e)=>{s((0,d.itemToSuggest)(t),e.map(d.itemToSuggest)),i()},onItemView:S,onShowMoreClick:(t,e)=>{f({name:t,title:e})},error:_,onError:v,reloadCategories:y})})})]})};function m(t,e,s){(0,h.showMessageBoxModal)((r=>(0,a.jsx)(p,(0,i._)({},r,{api:t,statCollector:e,onSkillClick:s}))),{width:420})}},934857:(t,e,s)=>{"use strict";s.d(e,{MarusiaVkcomAdapter:()=>n});var i=s(465889);const a="_im_page_history",r="im-page--marusia";class n{set onHelpClick(t){this._onHelpClick=t}show(){var t,e;null==(t=document.querySelector("."+a))||t.classList.add(r),null==(e=document.querySelector("."+i.MARUSIA_HELP_BUTTON_CLASS))||e.addEventListener("click",this._onHelpClick)}hide(){var t,e;null==(t=document.querySelector("."+a))||t.classList.remove(r),null==(e=document.querySelector("."+i.MARUSIA_HELP_BUTTON_CLASS))||e.removeEventListener("click",this._onHelpClick)}constructor(){this._onHelpClick=()=>{},this.entry="vkcom"}}},429156:(t,e,s)=>{"use strict";s.d(e,{MarusiaWebApi:()=>o});var i=s(150111),a=s(905507),r=s(111863);const n=new a.FetchService;class o extends i.MarusiaSharedApi{reloadAudios(t){return n.reloadAudios(t)}generateDeviceId(){return(0,r.generateDeviceId)("vk_web",this.debug)}}},812790:(t,e,s)=>{"use strict";s.d(e,{MarusiaWebCommands:()=>o});var i=s(468387),a=s(938141),r=s(465476),n=s(958678);class o{processMedia(t,e,s,a){return(0,i.processCommandMedia)(t,e,s,a)}processPlaylist(t,e,s){(0,i.processCommandPlaylist)(t,e,s)}processPortalDeeplink(t){window.open(t.url,"_self")}processNeedMoreVkPermissions(t,e,s){return(0,a.processCommandNeedMoreVkPermissions)(t,e,s)}processCallStart(t){(0,r.processCommandCallStart)(t)}autoPlayMediaAttaches(t,e,s,a,r){return(0,i.autoPlayMediaAttaches)(t,e,s,a,r)}executeControl(t,e){(0,n.executeControl)(t,e)}}},465476:(t,e,s)=>{"use strict";s.d(e,{processCommandCallStart:()=>a});var i=s(292071);function a(t){window.Calls&&window.Calls.call&&!window.Calls.isInActiveCall&&window.Calls.call(parseInt(String(t.recipient_id)),!1,void 0,i.CallStatSource.CONVO_HEADER)}},468387:(t,e,s)=>{"use strict";s.d(e,{autoPlayMediaAttaches:()=>d,playAudioList:()=>c,processCommandMedia:()=>g,processCommandPlaylist:()=>y});var i=s(11010),a=s(434788),r=s(145669),n=s(661893),o=s(285853),l=s(391199),u=s(269425);function c(t,e,s,i){t.getCurrentPlaylist()&&t.deleteCurrentPlaylist();const a=new r.AudioPlaylist({accessHash:void 0,albumId:`im${n.MARUSIA_PEER_ID}_${s}`,blockId:"",hasMore:!1,ownerId:window.vk.id,type:null!=i?i:r.AudioPlaylist.TYPE_TEMP});a.mergeWith({list:e}),t.addPlaylist(a),t.play((0,u.getFullIdFromTuple)(e[0]),a,"im")}function d(t,e,s,i,a){return h.apply(this,arguments)}function h(){return(h=(0,i._)((function*(t,e,s,i,a){if(!s.length)return;if(s.every(m)){return void c(e,s.map((t=>(0,u.constructPlayerAudio)(t.meta,o.MarusiaMediaType.books,{}))),a)}const r=(0,u.getCommandsToAutoplay)(s,i),n=r.every((t=>t.media_type===o.MarusiaMediaType.podcast));if(0===r.length)return;const d=i.filter((t=>t.attaches.some(u.isAudioAttach))).map((t=>document.querySelector(`._im_mess[data-msgid="${t.messageId}"]`))).filter(Boolean);var h,p,g;if(d&&(yield(h=d,new Promise(((t,e)=>{let s=!1;const i=setTimeout((()=>{s=!0,e(new Error(l.MarusiaError.ATTACH_LOAD_TIMEOUT))}),3e4),a=()=>{h.every((t=>!!t.querySelector("._audio_row")||!!t.querySelector(".im_msg_media_podcast")))?(clearTimeout(i),t()):s||setTimeout(a,100)};a()})))),n)return void(null==(g=d[0])||null==(p=g.querySelector(".podcast_snippet__play"))||p.click());const _=r.map((t=>(0,u.constructPlayerAudio)(t.meta,o.MarusiaMediaType.music,(0,u.getVoiceAssistantData)(t,i)))),y=yield(0,u.getHashesForAudios)(t,_);y&&c(e,y,a)}))).apply(this,arguments)}function p(t){return"media"===t.type&&t.media_type===o.MarusiaMediaType.radio}function m(t){return"media"===t.type&&t.media_type===o.MarusiaMediaType.books}function g(t,e,s,i){return _.apply(this,arguments)}function _(){return(_=(0,i._)((function*(t,e,s,i){const a=s.find(p);if(a)return void function(t,e,s){c(t,[(0,u.constructPlayerAudio)(e.meta,o.MarusiaMediaType.radio,{source:e.meta.source})],s,r.AudioPlaylist.TYPE_RADIO)}(t,a,i);const n=yield(0,u.getAudioList)(e,s);n&&c(t,n,i)}))).apply(this,arguments)}function y(t,e,s){var i;c(t,e.tracks.map(((t,e)=>(0,a._)({},t,{meta:(0,a._)({},t.meta,{id:null!=(i=t.meta.id)?i:e})}))).map((t=>(0,u.constructPlayerAudio)(t.meta,e.media_type))),s)}},958678:(t,e,s)=>{"use strict";s.d(e,{executeControl:()=>r});var i=s(322498),a=s(974861);function r(t,e){var s;const r=null==(s=document.querySelector("._audio_page_layout"))?void 0:s.firstChild,n=r?(0,i.currentAudioPage)(r):null;switch(e.type){case a.ControlType.CONTROL_TYPE_RESUME:t.play();break;case a.ControlType.CONTROL_TYPE_PAUSE:t.pause();break;case a.ControlType.CONTROL_TYPE_VOLUME:t.setVolume(e.level/100);break;case a.ControlType.CONTROL_TYPE_NEXT:t.playNext(!0);break;case a.ControlType.CONTROL_TYPE_PREV:t.seekToTime(0),setTimeout((()=>t.playPrev()));break;case a.ControlType.CONTROL_TYPE_REPEAT:var o;t.toggleRepeatCurrentAudio(),null==(o=n)||o.updateRepeatButton();break;case a.ControlType.CONTROL_TYPE_REPEAT_PLAYLIST:var l;t.toggleRepeatAll(),null==(l=n)||l.updateRepeatButton();break;case a.ControlType.CONTROL_TYPE_REWIND:t.seekToTime(e.elapsed)}}},468014:(t,e,s)=>{"use strict";s.r(e),s.d(e,{marusiaSdk:()=>c});var i=s(727745),a=s(812790),r=s(715203),n=s(265070),o=s(429156),l=s(95432);const u=new(s(934857).MarusiaVkcomAdapter),c=new i.MarusiaSharedSdk({platform:u,api:new o.MarusiaWebApi(window.__dev),showSkillListModal:n.showSkillListModal,audioPlayer:new r.MarusiaWebPlayerAdapter((0,l.getAudioPlayer)()),commands:new a.MarusiaWebCommands,getTextFromInputEvent:t=>t.target.innerText,debug:window.__dev});u.onHelpClick=()=>{c.onHelpClick()}},239301:(t,e,s)=>{"use strict";s.d(e,{loadMarusiaFCSdk:()=>n,loadMarusiaSdk:()=>r});var i=s(659397),a=s(508159);function r(){return(0,i.asyncImportLoader)((()=>Promise.resolve().then(s.bind(s,468014))),3).then((t=>{if(!t.marusiaSdk)throw new Error("MarusiaSdkEmptyError");return t.marusiaSdk})).catch((t=>(a.marusiaStats.logModuleLoadError(t.message),null)))}function n(){return(0,i.asyncImportLoader)((()=>s.e(3225).then(s.bind(s,242808))),3).then((t=>{if(!t.marusiaSdk)throw new Error("MarusiaFCSdkEmptyError");return t.marusiaSdk})).catch((t=>(a.marusiaStats.logModuleLoadError(t.message),null)))}},354273:(t,e,s)=>{"use strict";s.d(e,{Api:()=>h});var i=s(11010),a=s(434788),r=s(816405),n=s(927411),o=s(95154),l=s(891047),u=s(599809),c=s(301230);const d=["messages.getLongPollServer","messages.getLongPollHistory","queue.subscribe","account.setOnline"];class h{static dropCache(){indexedDB.deleteDatabase(p.CACHE_DB_NAME)}dangerouslyAbort(t){var e;t&&(null==(e=this.abortTrackers.get(t))||e(),this.abortTrackers.delete(t))}fetchMany(t,e={}){var s=this;return(0,i._)((function*(){const i=[],a=[],r=[];let n=0,o=!1;for(let l=t.length-1;l>=0;l--){const u=t[l];if(!u){a[l]="null";continue}if(e.usePrefetch){const t=s.prefetch(u.method,u.params);if(t){a[l]="null",r[l]=t,n++;continue}}const c=`res${l}`,d=`API.${u.method}(${JSON.stringify(s.enrichParams(u.method,u.params))})`;o?(i[l]=`var ${c}=fork(${d});`,a[l]=`wait(${c})`):(o=!0,i[l]=`var ${c}=${d};`,a[l]=`${c}`)}if(n===t.filter(Boolean).length)return r;const l=`${i.join("")}return [${a.join(",")}];`,u=yield s.fetch("execute",{code:l},e);for(let t=0;t<u.length;t++)r[t]&&(u[t]=r[t]);return u}))()}fetchSeq(t,e){const s=[],i=[];for(let e=0;e<t.length;e++){const a=t[e];if(!a){i.push("null");continue}const r=`res${e}`;s.push(`var ${r}=API.${a.method}(${JSON.stringify(this.enrichParams(a.method,a.params))});`),i.push(`${r}`)}const a=`${s.join("")}return [${i.join(",")}];`;return this.fetch("execute",{code:a},e)}fetchForExternalLibs(t,e,s){return this.fetch(t,e,(0,a._)({},s,{fromExternalLib:!0}))}prefetch(t,e){if(!this.prefetchCache)return;e=this.enrichParams(t,e);const s=this.prefetchCache.findIndex((s=>s.version===r.API_VERSION&&(s.method===t&&(Object.keys(e).length===Object.keys(s.request).length&&Object.keys(e).every((t=>e[t]===s.request[t])))))),i=this.prefetchCache[s];return i&&(this.prefetchCache.splice(s,1),!i.error)?i.response:void 0}constructor(t){var e,s;this.prefetchCache=(null==(s=window)||null==(e=s.cur)?void 0:e.apiPrefetchCache)||[],this.abortTrackers=new Map;var l=this;this.fetch=(0,i._)((function*(t,e,s={}){if("queue.subscribe"===t)return Promise.resolve({base_url:"mock",queues:[]});if(s.usePrefetch){const s=l.prefetch(t,e);if(s)return s}s.timeout||(s.timeout=1e4),s.fromExternalLib||(e=l.enrichParams(t,e));const i=d.includes(t),a=`${t} ${JSON.stringify(e)}`;let r=s.retries||0,o=0;for(;;)try{if(i&&window.curNotifier&&!window.curNotifier.is_server&&!c.browser.safari){yield m((u=500,h=1500,Math.random()*(h-u+1)+u));const t=yield l.cache.get(a);if(t)return t}const{response:r,abort:o}=l.request(t,e,s.timeout);s.trackId&&l.abortTrackers.set(s.trackId,o);const d=yield r.catch((t=>{if(t&&"api_error"===t.type){const{error_code:e,error_message:s}=t.error;throw new n.IApi.RequestError(e,s,t.error)}throw t})).finally((()=>{s.trackId&&l.abortTrackers.delete(s.trackId)}));if(d.execute_errors)throw new n.IApi.ExecuteErrors(d.execute_errors);return i&&l.cache.set(a,d).catch((()=>{})),d}catch(t){if(t instanceof n.IApi.AbortError)throw t;if(o++,o===r+1)throw t;yield m(Math.min(500*Math.pow(2,o-1),2e4))}var u,h})),this.request=(t,e,s)=>{const i=new AbortController;let a,o=!1;s&&(a=window.setTimeout((()=>{o=!0,i.abort()}),s));const l={};for(const t of Object.keys(e))void 0!==e[t]&&(l[t]=e[t]);return{response:(0,u.api)(t,l,{version:r.API_VERSION},{signal:i.signal}).catch((e=>{if(i.signal.aborted)throw o?new n.IApi.TimeoutError(`[API] Timeout Error: ${t}`):new n.IApi.AbortError(`[API] Abort Error: ${t}`);throw e})).finally((()=>{a&&clearTimeout(a)})),abort:()=>{i.abort()}}},this.enrichParams=(t,e)=>{switch(t.slice(0,t.indexOf("."))){case"users":case"friends":return(0,a._)({},e,{fields:o.API_USER_FIELDS.join(",")});case"groups":return(0,a._)({},e,{fields:o.API_GROUP_FIELDS.join(",")});default:return"extended"in e&&e.extended?(0,a._)({},e,{fields:Array.from(new Set([...o.API_USER_FIELDS,...o.API_GROUP_FIELDS])).join(",")}):e}},this.cache=new p(3e3,t)}}class p{get(t){return l.get(t,this.cache).then((e=>{if(void 0!==e){if(!(e.expiresAt<Date.now()))return setTimeout((()=>{l.del(t,this.cache).catch((()=>{}))}),Date.now()-e.expiresAt),e.response;l.del(t,this.cache).catch((()=>{}))}})).catch((()=>{}))}set(t,e){const s={response:e,expiresAt:Date.now()+this.invalidateTimeout};return l.set(t,s,this.cache).then((()=>{setTimeout((()=>{l.del(t,this.cache).catch((()=>{}))}),this.invalidateTimeout)})).catch((()=>{}))}constructor(t,e){this.invalidateTimeout=t,this.cache=l.createStore(p.CACHE_DB_NAME,"api-cache-"+e)}}function m(t){return new Promise((e=>setTimeout(e,t)))}p.CACHE_DB_NAME="reforged-db-v1"},415102:(t,e,s)=>{"use strict";s.d(e,{BrowserNotifications:()=>a});var i=s(945263);class a{constructor(){this.getState=()=>{var t;return(null==(t=window.pushNotifier)?void 0:t.loadEndpoint())||window.ls.get("im_ui_notify_off")?"external":this.isBrowserNotificationsEnabled()},this.onChange=t=>t&&!this.isBrowserNotificationsEnabled()?new Promise((t=>{window.DesktopNotifications.requestPermission((()=>{this.statlogsBrowserNotificationsOn(),t("external")}))})):!t&&this.isBrowserNotificationsEnabled()?(window.ls.set("im_ui_notify_off",1),this.statlogsBrowserNotificationsOff(),Promise.resolve(!1)):Promise.resolve(t),this.onExternal=()=>window.nav.go("/settings?act=notify"),this.isBrowserNotificationsEnabled=()=>window.DesktopNotifications.supported()&&!window.DesktopNotifications.checkPermissionNeeded()&&!window.ls.get("im_ui_notify_off"),this.statlogsBrowserNotificationsOn=()=>{(0,i.statlogsProbValueEvent)(1,"im_browser_notifications_on",1)},this.statlogsBrowserNotificationsOff=()=>{(0,i.statlogsProbValueEvent)(1,"im_browser_notifications_off",1)}}}},605836:(t,e,s)=>{"use strict";s.d(e,{GeoLocation:()=>a});var i=s(12402);class a{get(){return new Promise((t=>{(0,i.sendLocationFromKeyboard)((([,e])=>{const[s,i]=e.split("_");t([s,i])}))}))}}},727539:(t,e,s)=>{"use strict";s.d(e,{Idle:()=>i});class i{constructor(t){this.logger=t,this.listeners=new Set,this.isIdle=()=>void 0===this.timeoutId,this.subscribe=t=>(this.listeners.add(t),()=>{this.listeners.delete(t)}),this.onVisibilityChange=()=>{document.hidden?(document.removeEventListener("mousemove",this.onActive),document.removeEventListener("keydown",this.onActive,!0),this.onIdle()):(document.addEventListener("mousemove",this.onActive),document.addEventListener("keydown",this.onActive,!0),this.onActive())},this.onIdle=()=>{this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0,this.notify())},this.onActive=()=>{const t=void 0!==this.timeoutId;this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(this.onIdle,3e4),t||this.notify()},this.notify=()=>{this.logger.info("[IDLE]","user became "+(this.isIdle()?"idle":"active"));for(const t of this.listeners)t(this.isIdle())},this.onVisibilityChange(),document.addEventListener("visibilitychange",this.onVisibilityChange)}}},232621:(t,e,s)=>{"use strict";s.d(e,{Logger:()=>a});var i=s(543020);class a{constructor(){this.visible=!1,this.configureScope=()=>{},this.info=(...t)=>{this.visible&&console.log(...t)},this.error=(t,e)=>{e?console.error(t,e):console.error(t);const s=t=>{(0,i.logError)(t,{environment:"messenger"})};if(e instanceof Error){const i=new Error(t+" "+e.message);return i.name=e.name,i.stack=e.stack,s(i)}if("string"==typeof e)return s(new Error(t+" "+e));if(e&&"api_error"===e.type){const i=JSON.stringify(e.error);return s(new Error(t+" "+i))}return s(new Error(t))},this.show=()=>{this.visible=!0},this.hide=()=>{this.visible=!1}}}},891172:(t,e,s)=>{"use strict";s.d(e,{Notification:()=>i});class i{notify(){}playSound(){}setCounters(){}}},205261:(t,e,s)=>{"use strict";s.d(e,{FCPlayer:()=>p,FCVoicePlayer:()=>h});var i=s(434788),a=s(866310),r=s(95432),n=s(145669),o=s(721366),l=s(795558);const u=([t,e,s,i,a,r,,,,,,,,,,,,,,,n],o)=>({audioTrack:{id:`${e}_${t}`,url:s,progress:o,duration:r},title:i,artist:a,trackCode:n}),c=t=>{const[e,s]=t;return`${s}_${e}`},d=({audioTrack:t,title:e,artist:s,trackCode:i})=>{const{id:a,url:r,duration:n}=t,[o,l]=a.split("_");return[Number(l),Number(o),r,e,s,n,0,0,"",0,0,"im","[]","/////undefined/","",{},"","","",!1,i||"",0,0,0,"",!1]};class h extends o.EventBus{play(t){var e;if(t.audioTrack.id===(null==(e=this.state.currentTrackEntity)?void 0:e.audioTrack.id)&&"paused"===this.state.status)return this.state.currentTrackEntity=t,void this.resume();if(this.state.currentTrackEntity&&t.audioTrack.id!==this.state.currentTrackEntity.audioTrack.id){const{currentTrackEntity:t}=this.state,{audioTrack:e}=t;this.state=(0,i._)({},this.state,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},t,{audioTrack:(0,i._)({},e,{progress:0})})}),this.emit("stateupdated",this.state)}const{url:s,duration:a,id:r}=t.audioTrack,n="MessagedConvoVoiceTrack"===t.kind?t.urlOgg:void 0,o=`<div id="audiomsgpl_${window.vk.id}_${r}" class="audio-msg-track " data-duration="${a}" data-mp3="${s}" data-ogg="${n}" <button class="audio-msg-track--btn"></button> <button class="audio-msg-track--transcriptToggle _msg_asr_toggle"> <span class="audio-msg-track--transcriptToggleShow"></span> <span class="audio-msg-track--transcriptToggleHide"></span> </button> <div class="audio-msg-track--duration"></div> <div class="audio-msg-track--wave-wrapper"> <svg class="audio-msg-track--wave"></svg></div></div>`;this.audioEl=(0,l.ce)("div",{innerHTML:o}).firstChild,this.audioEl.dataset.convoVoiceTrack=JSON.stringify(t),this.state=(0,i._)({},this.state,{status:"playing",playedTimeAccumulator:{},currentTrackEntity:t}),this.emit("stateupdated",this.state),window.AudioMessagePlayer.togglePlay(this.audioEl),window.AudioMessagePlayer.seek(t.audioTrack.progress)}pause(){this.audioEl&&window.AudioMessagePlayer.toggle()}stop(){this.audioEl&&window.AudioMessagePlayer.toggle()}resume(){this.audioEl&&this.state.currentTrackEntity&&(this.audioEl.dataset.convoVoiceTrack=JSON.stringify(this.state.currentTrackEntity),window.AudioMessagePlayer.seek(this.state.currentTrackEntity.audioTrack.progress),window.AudioMessagePlayer.toggle())}isPlaying(){const{status:t}=this.getState();return"playing"===t}handleMediaMediatorResume(){this.resume()}handleMediaMediatorPause(){this.pause()}getState(){return this.state}playNext(){return!1}init(){}setVolume(){}setMute(){}playPrev(){}setShuffle(){}seek(){}setRepeatMode(){}setPlaybackRate(){}stopPlayer(){}constructor(t){super(),this.state={status:"stopped",playedTimeAccumulator:{},volume:100,playbackRate:1,mute:!1,shuffle:!1,repeatMode:"none"},this.mediaMediator=t,window.AudioMessagePlayer.events.on("playing",(t=>{if(this.state.currentTrackEntity&&t!==this.audioEl){const{currentTrackEntity:t}=this.state,{audioTrack:e}=t;this.state=(0,i._)({},this.state,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},t,{audioTrack:(0,i._)({},e,{progress:0})})}),this.emit("stateupdated",this.state),this.audioEl=void 0,this.state={status:"stopped",playedTimeAccumulator:{},volume:100,playbackRate:1,mute:!1,shuffle:!1,repeatMode:"none"},this.emit("stateupdated",this.state)}if(t===this.audioEl&&"string"==typeof t.dataset.audioTrack){const e=t.dataset.convoAudioTrack&&JSON.parse(t.dataset.convoAudioTrack);this.state=(0,i._)({},this.state,{status:"playing",currentTrackEntity:e}),this.emit("stateupdated",this.state)}})),window.AudioMessagePlayer.events.on("progress",((t,e)=>{if(this.audioEl===e&&this.state.currentTrackEntity){const{currentTrackEntity:e}=this.state,{audioTrack:s}=e;this.state=(0,i._)({},this.state,{currentTrackEntity:(0,i._)({},e,{audioTrack:(0,i._)({},s,{progress:t})})}),this.emit("stateupdated",this.state)}})),window.AudioMessagePlayer.events.on("fc_paused",(t=>{t===this.audioEl&&"playing"===this.state.status&&(this.state=(0,i._)({},this.state,{status:"paused"}),this.emit("stateupdated",this.state))})),window.AudioMessagePlayer.events.on("finished",(t=>{if(t===this.audioEl&&this.state.currentTrackEntity){const{currentTrackEntity:t}=this.state,{audioTrack:e}=t;this.state=(0,i._)({},this.state,{status:"ended",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},t,{audioTrack:(0,i._)({},e,{progress:0})})}),this.emit("stateupdated",this.state),this.state=(0,i._)({},this.state,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},t,{audioTrack:(0,i._)({},e,{progress:0})})}),this.emit("stateupdated",this.state)}}))}}class p extends o.EventBus{play(t,e){var s,i;const{progress:a}=t.audioTrack,r=this.vkComPlayer.getPlaylist(n.AudioPlaylist.TYPE_TEMP,window.vk.id,`im${(null==(s=t.fromMessage)?void 0:s.peerId)||""}`);r.mergeWith({list:null==(i=e)?void 0:i.getConvoAudiosList().map(d)}),this.vkComPlayer.play(d(t),r,"im"),a>0&&this.vkComPlayer.seek(a),this.vkComPlayer.play(),this.mediaMediator.handlePlayerOn(this)}pause(){this.vkComPlayer.isPlaying()&&this.vkComPlayer.pause()}stop(){this.vkComPlayer.stop()}resume(){this.vkComPlayer.isPlaying()||this.vkComPlayer.play()}isPlaying(){const{status:t}=this.getState();return"playing"===t}handleMediaMediatorResume(){this.resume(),this.isManualPause=!1}handleMediaMediatorPause(){this.pause(),this.isManualPause=!0}getState(){return this.state}playNext(){return!1}init(){}setVolume(){}setMute(){}playPrev(){}setShuffle(){}seek(){}setRepeatMode(){}setPlaybackRate(){}stopPlayer(){}constructor(t){super(),this.vkComPlayer=(0,r.getAudioPlayer)(),this.isManualPause=!1,this.state={status:"stopped",playedTimeAccumulator:{},volume:100,playbackRate:1,mute:!1,shuffle:!1,repeatMode:"none"},this.updateState=t=>{this.state=t,this.emit("stateupdated",this.state)},this.mediaMediator=t,this.vkComPlayer.on(this,a.events.PLAY_REQUESTED,(t=>{if(!t)return;const e=(0,i._)({},this.state);if(e.currentTrackEntity&&e.currentTrackEntity.audioTrack){const{currentTrackEntity:t}=e,{audioTrack:s}=t;this.updateState((0,i._)({},e,{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:(0,i._)({},t,{audioTrack:(0,i._)({},s,{progress:0})})}))}const s=u(t,0);this.updateState((0,i._)({},this.state,{status:"playing",playedTimeAccumulator:{},currentTrackEntity:s}))})),this.vkComPlayer.on(this,a.events.PLAY,(t=>{t&&(this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===c(t)||(this.state.currentTrackEntity=u(t,0)),this.updateState((0,i._)({},this.state,{status:"playing"})),this.mediaMediator.handlePlayerOn(this))})),this.vkComPlayer.on(this,a.events.PAUSE,(t=>{t&&(this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===c(t)||(this.state.currentTrackEntity=u(t,0)),this.updateState((0,i._)({},this.state,{status:"paused"})))})),this.vkComPlayer.on(this,[a.events.STOP,a.events.ENDED],(t=>{t&&(this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===c(t)||(this.state.currentTrackEntity=u(t,1)),this.updateState((0,i._)({},this.state,{status:"stopped"})))})),this.vkComPlayer.on(this,a.events.PROGRESS,((t,e)=>{if(!t||"number"!=typeof e)return;this.state.currentTrackEntity&&this.state.currentTrackEntity.audioTrack.id===c(t)||(this.state.currentTrackEntity=u(t,e)),"stopped"===this.state.status&&e&&(this.state.status="paused");const s=(0,i._)({},this.state),a=s.currentTrackEntity;this.updateState((0,i._)({},s,{currentTrackEntity:(0,i._)({},a,{audioTrack:(0,i._)({},a.audioTrack,{progress:e||0})})}))}))}}},356432:(t,e,s)=>{"use strict";s.d(e,{ProxyStorage:()=>r});var i=s(11010),a=s(395340);class r{constructor(t){this.identify=t=>{this.storage.identify(t)},this.get=t=>"settings-sound-notifications-on"===t?!window.ls.get("sound_notify_off"):this.storage.get(t),this.set=(t,e)=>{"settings-sound-notifications-on"!==t?this.storage.set(t,e):window.ls.set("sound_notify_off",Number(!e))},this.del=t=>{"settings-sound-notifications-on"!==t?this.storage.del(t):window.ls.remove("sound_notify_off")};var e=this;this.getIDB=(0,i._)((function*(t){return e.storage.getIDB(t)}));var s=this;this.setIDB=(0,i._)((function*(t,e){s.storage.setIDB(t,e)}));var r=this;this.updateIDB=(0,i._)((function*(t,e){r.storage.updateIDB(t,e)}));var n=this;this.delIDB=(0,i._)((function*(t){n.storage.delIDB(t)})),this.storage=new a.Storage(t),this.dbName=t}}},485950:(t,e,s)=>{"use strict";s.d(e,{SharedEngine:()=>a});var i=s(906e3);class a{constructor(t,e){if(this.logger=t,this.isMaster=e,this.queued={kind:"Buffer",buffer:[]},this.ts=0,this.pts=0,this.connect=t=>(this.ts=t.ts,this.pts=t.pts,this.engine.connect(t)),this.poll=()=>this.engine.poll(),this.isConnected=()=>this.engine.isConnected(),this.switch=t=>{if(this.broadcast)switch(this.logger.info("[SHARED ENGINE] switch to",t),t){case"master":if(this.isMaster)return;switch(this.queued.kind){case"Callback":this.queued.cancel();break;case"Buffer":this.queued.buffer=[]}return void(this.isMaster=!0);case"slave":if(!this.isMaster)return;return void(this.isMaster=!1)}},this.fetch=(t,e,s)=>Promise.resolve().then((()=>{if(!this.isMaster)return this.fetchSlave();const i="number"==typeof e.ts?e.ts:1/0;return this.logger.info("[SHARED ENIGNE]",this.ts,i),i>this.ts?Promise.resolve({failed:1}):this.fetchMaster(t,e,s)})).then((t=>("ts"in t&&(this.ts=t.ts,this.pts=t.pts),t))),this.fetchMaster=(t,e,s)=>{this.logger.info("[SHARED ENGINE] fetch master",t);const i=new Headers;i.append("Connection","keep-alive"),i.append("Content-Type","application/x-www-form-urlencoded");const a=Object.keys(e).reduce(((t,s)=>(void 0!==e[s]&&t.append(s,e[s]),t)),new URLSearchParams);return fetch(t,{method:"POST",signal:s,headers:i,body:a}).then((t=>{if(!t.ok)throw new Error(`ServerError ${t.status}`);return t.json()})).then((t=>{const e=this.ts;return setTimeout((()=>{this.broadcast&&this.broadcast({type:"updates",payload:{tsOld:e,data:t}})})),t}))},this.fetchSlave=()=>{if("Callback"===this.queued.kind)return Promise.reject(new Error("vkcom engine slave double fetch error"));this.logger.info("[SHARED ENGINE] fetch slave");const t=this.queued.buffer.shift(),e=t?Promise.resolve(t):new Promise((t=>{this.queued={kind:"Callback",push:e=>{this.queued={kind:"Buffer",buffer:[]},t(e)},cancel:()=>{this.queued={kind:"Buffer",buffer:[]},t({tsOld:this.ts,data:{ts:this.ts,pts:this.pts,updates:[]}})}}}));return e.then((t=>t.tsOld>this.ts?(this.queued={kind:"Buffer",buffer:[]},Promise.resolve({failed:1})):t.data))},this.engine=new i.Engine(this.logger,((...t)=>this.fetch(...t))),this.version=this.engine.version,void 0!==window.BroadcastChannel){const t=new BroadcastChannel("messenger-shared-engine");this.broadcast=e=>t.postMessage(e),t.onmessage=t=>{if("updates"===t.data.type){const e=t.data.payload;if(this.isMaster)return;if(this.logger.info("[SHARED ENGINE] broadcast received",e),!this.isConnected())return;return"Callback"===this.queued.kind?void this.queued.push(e):void this.queued.buffer.push(e)}this.logger.error("[SHARED ENGINE] Неизвестный бродкаст")}}}}},25153:(t,e,s)=>{"use strict";s.d(e,{SharedQueue:()=>i});class i{connect(){if(this.isConnected())return;this.queued=this.empty();const t=window.Notifier.getEventQueueInstance();this.unsubscribe=t.subscribe((t=>{const e={kind:"Batch",ts:"1",events:[t]};if("Callback"===this.queued.kind){const t=this.queued.resolve;return this.queued=this.empty(),void t(e)}if(this.queued.buffer.length>=this.MAX_BUFFER_SIZE)return this.unsubscribe&&this.unsubscribe(),this.unsubscribe=null,void this.queued.buffer.push({kind:"Disconnected",reason:"backpressure"});this.queued.buffer.push(e)}))}constructor(){this.MAX_BUFFER_SIZE=50,this.unsubscribe=null,this.empty=()=>({kind:"Buffer",buffer:[]}),this.poll=()=>{if("Callback"===this.queued.kind)return this.queued.reject("Queue.poll вызван дважды!"),new Promise(((t,e)=>{this.queued={kind:"Callback",resolve:t,reject:e}}));const t=this.queued.buffer.shift();if(t)return Promise.resolve(t);if(!this.isConnected())throw new Error("Queue.connect еще не был вызван!");return new Promise(((t,e)=>{this.queued={kind:"Callback",resolve:t,reject:e}}))},this.disconnect=()=>{switch(this.unsubscribe&&this.unsubscribe(),this.unsubscribe=null,this.queued.kind){case"Callback":this.queued.resolve({kind:"Disconnected",reason:"manual"}),this.queued=this.empty();break;case"Buffer":this.queued.buffer.push({kind:"Disconnected",reason:"manual"});break;default:this.queued}},this.isConnected=()=>!!this.unsubscribe,this.queued=this.empty()}}},651695:(t,e,s)=>{"use strict";s.d(e,{Stats:()=>l});var i=s(338386),a=s(999110),r=s(578137),n=s(235431),o=s(385938);class l{constructor(){this.init=()=>{},this.logEvent=t=>{!function(t){switch(t.type){case"type_action":{const e=t.type_action;switch(e.type){case"type_ab_custom_metrics_item":i.customMetricsCollector.logEvent(e.type_ab_custom_metrics_item);break;case"type_messaging_action_item":a.messagingActionItemStatCollector.logEvent(e.type_messaging_action_item);break;case"type_messaging_audio_message_item":r.audioMessageStatCollector.logEvent(e.type_messaging_audio_message_item);break;case"type_settings_changes_item":n.settingsChangesStatCollector.logEvent(e.type_settings_changes_item)}break}case"type_navgo":{const e=t.type_navgo;o.imNavgoStatsCollector.logEvent(e);break}}}(t)}}}},459357:(t,e,s)=>{"use strict";s.d(e,{MarusiaMediaRecorder:()=>l});var i=s(280467);let a,r,n=window.AudioContext||window.webkitAudioContext;function o(t){let e=new Event("error");return e.data=new Error("Wrong state for "+t),e}class l{start(t){if("inactive"!==this.state)return this.em.dispatchEvent(o("start"));this.state="recording",a||(a=new n),this.clone=this.stream.clone(),this.input=a.createMediaStreamSource(this.clone),this.analyser=a.createAnalyser(),r||(r=a.createScriptProcessor(2048,1,1)),this.input.connect(this.analyser),this.analyser.connect(r),r.connect(a.destination);let e=this;e.encoder.postMessage(["init",a.sampleRate]),r.onaudioprocess=t=>{"recording"===e.state&&(this.onAudioProcessHandler(this.analyser),e.encoder.postMessage(["encode",t.inputBuffer.getChannelData(0)]))},this.input.connect(r),r.connect(a.destination),this.em.dispatchEvent(new Event("start")),t&&(this.slicing=setInterval((()=>{"recording"===e.state&&e.requestData()}),t))}stop(){return"inactive"===this.state?this.em.dispatchEvent(o("stop")):(this.requestData(),this.state="inactive",this.clone.getTracks().forEach((t=>{t.stop()})),this.encoder.terminate(),clearInterval(this.slicing))}pause(){return"recording"!==this.state?this.em.dispatchEvent(o("pause")):(this.state="paused",this.em.dispatchEvent(new Event("pause")))}resume(){return"paused"!==this.state?this.em.dispatchEvent(o("resume")):(this.state="recording",this.em.dispatchEvent(new Event("resume")))}requestData(){return"inactive"===this.state?this.em.dispatchEvent(o("requestData")):this.encoder.postMessage(["dump",a.sampleRate])}addEventListener(...t){this.em.addEventListener(...t)}removeEventListener(...t){this.em.removeEventListener(...t)}dispatchEvent(...t){this.em.dispatchEvent(...t)}constructor(t,e){this.stream=t,this.state="inactive",this.onAudioProcessHandler=e,this.em=document.createDocumentFragment(),this.encoder=function(t){let e=t.toString().replace(/^(\(\)\s*=>|function\s*\(\))\s*{/,"").replace(/}$/,""),s=new Blob([e]);return new Worker(URL.createObjectURL(s))}(l.encoder);let s=this;this.encoder.addEventListener("message",(t=>{let e=new Event("dataavailable");e.data=new Blob([t.data],{type:s.mimeType}),s.em.dispatchEvent(e),"inactive"===s.state&&s.em.dispatchEvent(new Event("stop"))}))}}l.prototype.mimeType="audio/wav",l.isTypeSupported=t=>l.prototype.mimeType===t,l.notSupported=!navigator.mediaDevices||!n,l.encoder=i.default},280467:(t,e,s)=>{"use strict";s.d(e,{default:()=>i});const i=()=>{let t=[];onmessage=e=>{"encode"===e.data[0]?function(e){let s=e.length,i=new Uint8Array(2*s);for(let t=0;t<s;t++){let s=2*t,a=e[t];a>1?a=1:a<-1&&(a=-1),a*=32768,i[s]=a,i[s+1]=a>>8}t.push(i)}(e.data[1]):"dump"===e.data[0]&&function(e){let s=t.length?t[0].length:0,i=t.length*s,a=new Uint8Array(44+i),r=new DataView(a.buffer);r.setUint32(0,1380533830,!1),r.setUint32(4,36+i,!0),r.setUint32(8,1463899717,!1),r.setUint32(12,1718449184,!1),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,1,!0),r.setUint32(24,e,!0),r.setUint32(28,2*e,!0),r.setUint16(32,2,!0),r.setUint16(34,16,!0),r.setUint32(36,1684108385,!1),r.setUint32(40,i,!0);for(let e=0;e<t.length;e++)a.set(t[e],e*s+44);t=[],postMessage(a.buffer,[a.buffer])}(e.data[1])}}}}]);try{stManager.done("dist/ceaf88a1a984a2d187750adb81afc3f6.e98c864d82213b145748.js")}catch(t){}
"use strict";(self.webpackChunkvk=self.webpackChunkvk||[]).push([[55749],{116592:(e,t,s)=>{s.d(t,{hideUGCKeyboard:()=>i,showUGCKeyboard:()=>n});var a=s(599809);const n=e=>(0,a.api)("stickers.showUGCKeyboard",e),i=e=>(0,a.api)("stickers.hideUGCKeyboard",e)},27703:(e,t,s)=>{s.d(t,{HASHTAG_ENTITIES_ALL:()=>l,HASHTAG_ENTITIES_NEW:()=>c,RE_HASHTAG_EXTRACTION_PATTERN:()=>r,RE_HASHTAG_EXTRACTION_PATTERN_NEW:()=>_});var a=s(77520);const n="a-zA-Zа-яА-ЯёіјєїґўЁІЈЄЇҐЎ’",i="(?:&#(?:19[2-9]|(?:[2-9]|1[0-3])[0-9][0-9]);?)",o=`(?:[${n}_\\d]|${i})`,r=`(^|[s.,:'";>)(]?)(${`(#${o}{0,100}${`(?:[${n}]|${i})`}${o}{0,100})`})(@${a.RE_DOMAIN_PATTERN})?(?=$|[s.,:'"&;?<)(]?)`,l="&#(\\d{3,5});",c="(?:&#\\d{3,5};)",d=`(?:[${n}_\\d]|${c})`,_=`(^|[s.,:'";>)(]?)(${`(#${d}{0,100}${`(?:[${n}]|${c})`}${d}{0,100})`})(@${a.RE_DOMAIN_PATTERN})?(?=$|[s.,:'"&;?<)(]?)`},302925:(e,t,s)=>{s.d(t,{plaingetCancelable:()=>r,post:()=>o});var a=s(962983),n=s(67120);const i=3;function o(e,t,s){return t&&(t.im_v=i),new Promise(((a,n)=>{window.ajax.post(e,t,{timeout:s,onDone(){a.apply(null,[[...arguments]])},onFail(){return n.apply(null,[...arguments]),!0}})}))}function r(e,t,s={}){const i=new XMLHttpRequest;return{request:new Promise(((o,r)=>{let l;const c=Date.now(),d=s.timeout||60,_=(0,a.toQueryString)(t);i.onreadystatechange=()=>{if(4==i.readyState){if(window.clearInterval(l),(0,n.processWaf)(i))return;i.status>=200&&i.status<300?o([i.responseText,i]):r([i.responseText,i])}};try{i.open("GET",`${e}?${_}`,!0)}catch(e){return r([e,i])}i.send(),l=window.setInterval((()=>{Date.now()-c>1e3*d&&(window.browser.safari&&i.abort(),r(["",{}]),window.clearInterval(l))}),1e3)})),cancel:function(){i.abort()}}}},874162:(e,t,s)=>{s.d(t,{DEFAULT_CACHE:()=>l,ORDER_ERRORS:()=>d,ORDER_ITEM_ERRORS:()=>_,SAMPLE_RECIPIENT_ID:()=>c,STICKER_ANIMATION:()=>r,STICKER_IMAGE:()=>o,STICKER_PACK_ICON:()=>n,STICKER_PACK_THUMB:()=>i});var a=s(899033);const n={square_png:{id:"square.png",width:104,height:104},square_15x_png:{id:"square_1.5x.png",width:156,height:156},square_2x_png:{id:"square_2x.png",width:208,height:208},square_3x_png:{id:"square_3x.png",width:312,height:312},square_4x_png:{id:"square_4x.png",width:416,height:416}},i={"102_png":{id:"102.png",width:102,height:102,theme:a.Theme.LIGHT},"51_png":{id:"51.png",width:51,height:51,theme:a.Theme.LIGHT},"68_png":{id:"68.png",width:68,height:68,theme:a.Theme.LIGHT},"34_png":{id:"34.png",width:34,height:34,theme:a.Theme.LIGHT},"60_png":{id:"60.png",width:60,height:60,theme:a.Theme.LIGHT},"30_png":{id:"30.png",width:30,height:30,theme:a.Theme.LIGHT},"102b_png":{id:"102b.png",width:102,height:102,theme:a.Theme.DARK},"51b_png":{id:"51b.png",width:51,height:51,theme:a.Theme.DARK},"68b_png":{id:"68b.png",width:68,height:68,theme:a.Theme.DARK},"34b_png":{id:"34b.png",width:34,height:34,theme:a.Theme.DARK},"60b_png":{id:"60b.png",width:60,height:60,theme:a.Theme.DARK},"30b_png":{id:"30b.png",width:30,height:30,theme:a.Theme.DARK},"44_png":{id:"44.png",width:44,height:44},"22_png":{id:"22.png",width:22,height:22}},o={"64_png":{id:"64.png",width:64,height:64,theme:a.Theme.LIGHT},"128_png":{id:"128.png",width:128,height:128,theme:a.Theme.LIGHT},"256_png":{id:"256.png",width:256,height:256,theme:a.Theme.LIGHT},"352_png":{id:"352.png",width:352,height:352,theme:a.Theme.LIGHT},"512_png":{id:"512.png",width:512,height:512,theme:a.Theme.LIGHT},"64b_png":{id:"64b.png",width:64,height:64,theme:a.Theme.DARK},"128b_png":{id:"128b.png",width:128,height:128,theme:a.Theme.DARK},"256b_png":{id:"256b.png",width:256,height:256,theme:a.Theme.DARK},"352b_png":{id:"352b.png",width:352,height:352,theme:a.Theme.DARK},"512b_png":{id:"512b.png",width:512,height:512,theme:a.Theme.DARK}},r={[a.Theme.LIGHT]:"animation.json",[a.Theme.DARK]:"animation.b.json"},l={products:(0,a.createProductsMap)([]),productIdsQueue:new Set,productsPromise:void 0,productPromises:new Map,stickers:new Map},c=-1;var d,_;!function(e){e.NOT_SIGNED_IN="not_signed_in",e.NO_VALID_ITEMS="no_valid_items"}(d||(d={})),function(e){e.DUPLICATE_PRODUCT="duplicate_product"}(_||(_={}))},899033:(e,t,s)=>{var a;s.d(t,{ProductsByType:()=>g,Theme:()=>a,UserProductStateKey:()=>r,createProductsMap:()=>o,imageSizeCache:()=>i,imageSizesIndex:()=>n,isBasePack:()=>l,isPackProduct:()=>d,isStyleProduct:()=>c}),function(e){e.LIGHT="light",e.DARK="dark",e.DEFAULT="light"}(a||(a={}));const n=Symbol(),i=Symbol(),o=e=>new Map(e);var r;!function(e){e.IsNew="is_new"}(r||(r={}));const l=e=>void 0!==e.sticker_ids,c=e=>void 0!==e.base_id,d=e=>l(e)&&!c(e);var _;!function(e){e.Pack="pack",e.Style="style"}(_||(_={}));class g{add(e){e&&(d(e)?this.pack.add(e):c(e)&&this.style.add(e))}getPack(){return this.pack.values().next().value}getStyles(){return Array.from(this.style.values())}getCount(){return this.pack.size+this.style.size}constructor(e=[]){this.pack=new Set,this.style=new Set,e.forEach((e=>this.add(e)))}}},457299:(e,t,s)=>{s.d(t,{getStickerAnimationUrl:()=>d,getStickerImageUrl:()=>c,getStickerPackIconUrl:()=>_,getStickersKitModule:()=>u,isSampleOrderItem:()=>g,logStickersError:()=>m});var a=s(899033),n=s(874162),i=s(970978);const o=(e,t,s,n=a.Theme.DEFAULT)=>{const i=window.devicePixelRatio,o=[t*=i,s*=i,n].toString();let r=e[a.imageSizeCache];if(r&&r.has(o)){const e=r.get(o);if(e)return e}r||(r=new Map,e[a.imageSizeCache]=r);const l=(e=>{let t=e[a.imageSizesIndex];return t||(t=Object.values(e).sort(((e,t)=>e.width-t.width||e.height-t.height)),e[a.imageSizesIndex]=t),t})(e).filter((e=>!e.theme||e.theme===n)),c=l.find((e=>e.width>=t&&e.height>=s))||l[l.length-1];return r.set(o,c),c},r=(e,t,s=a.Theme.DEFAULT)=>o(n.STICKER_IMAGE,e,t,s),l=(e,t)=>e.image.base_url+"/"+t.id+(e.image.version?`?${e.image.version}`:"");function c(e,t,s,n=a.Theme.DEFAULT){var i;if(null==(i=e.render)?void 0:i.images){const{images:a}=e.render;let i;a.sort(((e,t)=>e.width-t.width||e.height-t.height));for(const e of a)if(e.width>=t&&e.height>=s){if(e.theme===n)return e.url;i=e}if(i)return i.url}return l(e,r(t,s,n))}const d=(e,t=a.Theme.DEFAULT)=>e.animation?e.animation.base_url+"/"+n.STICKER_ANIMATION[t]+(e.animation.version?`?${e.animation.version}`:""):"",_=(e,t,s,i=a.Theme.DEFAULT)=>((e,t)=>e.icon.base_url+"/"+t.id+(e.thumb.version?`?${e.thumb.version}`:""))(e,((e,t,s=a.Theme.DEFAULT)=>o(n.STICKER_PACK_ICON,e,t,s))(t,s,i)),g=e=>e.recipient_id===n.SAMPLE_RECIPIENT_ID,u=()=>s.e(51162).then(s.bind(s,406857)),m=e=>{(0,i.logError)(new Error(`Stickers: ${e}`),{environment:"stickers"})}},197834:(e,t,s)=>{s.d(t,{replaceHashtags:()=>l});var a=s(27703),n=s(839470);let i;const o=[[192,1399],[12352,12543],[19968,40959],[44032,55215]];function r(e){var t;const s=null==(t=e.match(a.HASHTAG_ENTITIES_ALL))?void 0:t[1];if(!s)return!1;const n=parseInt(s);for(const e of o)if(n>=e[0]&&n<=e[1])return!0;return!1}function l(e,t){return e.replace((i||(i=(0,n.partConfigEnabled)("new_hashtags_parser")?new RegExp(a.RE_HASHTAG_EXTRACTION_PATTERN_NEW,"ig"):new RegExp(a.RE_HASHTAG_EXTRACTION_PATTERN,"ig")),i),((e,s,i,o,l)=>{let c="";if((0,n.partConfigEnabled)("new_hashtags_parser")){const e=i.matchAll(new RegExp(a.HASHTAG_ENTITIES_NEW,"ig"));for(const t of e){const[e]=t;if(!r(e)){c=i.slice(t.index),i=i.slice(0,t.index);break}}}return"#"===i?(s||"")+i+(l||"")+c:(s||"")+t(i+(l||""))+c}))}},141256:(e,t,s)=>{s.d(t,{replaceMassMentions:()=>n});var a=s(375353);function n(e,t){return e.replace(a.MASS_MENTION_REGEXP,(e=>t?t(e,"","",e,e):`<span class="mem_pseudolink" data-mention="${e.slice(1).toLowerCase()}">${e}</span>`))}},597765:(e,t,s)=>{s.d(t,{$ugcInfo:()=>o,hideUgcFromKeyboardFx:()=>l,setUgcInfo:()=>r,showUgcFromKeyboardFx:()=>c});var a=s(434788),n=s(798116),i=s(116592);const o=(0,n.createStore)({}),r=(0,n.createEvent)(),l=(0,n.createEffect)((e=>(0,i.hideUGCKeyboard)({owner_id:e}))),c=(0,n.createEffect)((e=>(0,i.showUGCKeyboard)({owner_id:e})));o.on(r,((e,t)=>t)).on(l.done,(e=>(0,a._)({},e,{is_keyboard_hidden:!0}))).on(c.done,(e=>(0,a._)({},e,{is_keyboard_hidden:!1})))},874223:(e,t,s)=>{s.d(t,{getConvoListFolderCounterDisplayed:()=>c,getConvoListFolderCounterTotal:()=>d,getEmptyFolderEls:()=>r,getFolderInlineMenuActions:()=>m,getFolderMentionsCount:()=>u,getFolderUnreadCount:()=>g,isConvoListFolderHidden:()=>_,isEmptyFolder:()=>l});var a=s(434788),n=s(552666),i=s(728785),o=s(602849);function r(e){const t=(0,n.unpackStore)(e);if(!t.dialog_tabs_all[t.active_tab])return[];switch(t.active_tab){case i.ConvoListFolder.MR:return[{type:"empty_message_requests"}];case i.ConvoListFolder.BUSINESS_NOTIFY:return[{type:"empty_business_notify"}];case i.ConvoListFolder.ARCHIVE:return[{type:"empty_archives"}];default:return[{type:"empty_dialogs"}]}}function l(e){var t;const s=(0,n.unpackStore)(e);return!(null==(t=s.dialog_tabs[s.active_tab])?void 0:t.length)}function c(e,t){const s=(0,n.unpackStore)(e);let a;switch(t){case i.ConvoListFolder.PEER_TAGS:a=0;break;case i.ConvoListFolder.BUSINESS_NOTIFY:var o,r,l;a=null!=(l=null==(r=s.dialog_tab_cts)||null==(o=r[t])?void 0:o.unread)?l:0;break;case i.ConvoListFolder.ARCHIVE:var c,d,_;a=null!=(_=null==(d=s.dialog_tab_cts)||null==(c=d[t])?void 0:c.unread)?_:0;break;default:var g,u,m;a=null!=(m=null==(u=s.dialog_tab_cts)||null==(g=u[t])?void 0:g.total)?m:0}return Math.min(a,999)}function d(e,t){const s=(0,n.unpackStore)(e);return t===i.ConvoListFolder.PEER_TAGS?0:null!=(r=null==(o=s.dialog_tab_cts)||null==(a=o[t])?void 0:a.total)?r:0;var a,o,r}function _(e,t){const s=(0,n.unpackStore)(e);switch(t){case i.ConvoListFolder.BUSINESS_NOTIFY:return!!s.settings.business_notify_folder_hidden||0===d(s,i.ConvoListFolder.BUSINESS_NOTIFY);case i.ConvoListFolder.ARCHIVE:return!!(s.dialog_tab_cts.archive&&s.dialog_tab_cts.archive.total<=0)||Boolean(s.settings.archives_folder_hidden);default:return!1}}function g(e,t){const s=c(e,t);return s?s<100?s.toString():"99+":""}function u(e,t){var s,a;var i;return((null!=(i=null==(a=(0,n.unpackStore)(e).dialog_tab_cts)||null==(s=a[t])?void 0:s.mentions)?i:0)||"").toString()}function m(e,t){const s=(0,o.getFolderInlineMenuActionsData)(t),n=[];switch(t){case i.ConvoListFolder.BUSINESS_NOTIFY:case i.ConvoListFolder.ARCHIVE:d(e,t)>0&&_(e,t)&&n.push(i.FolderAction.SHOW)}return n.map((e=>(0,a._)({action:e},s[e])))}},149822:(e,t,s)=>{s.d(t,{addNewMember:()=>r,cancelMessageRequestAction:()=>_,createChatAction:()=>l,createCommunityChatAction:()=>c,kickUserAction:()=>g});var a=s(836873),n=s(207930),i=s(998898),o=s(656448);const r=(0,a.wrapHashAction)(((e,t,s,a)=>{var i;return(0,n.addChatMembers)(e,t,a.gid,(null==(i=a.tabs[e])?void 0:i.hash)||"",s).then((()=>a))})),l=(0,a.wrapHashActionReversed)(((e,t,s,a,o)=>{var r;return e.creating=!0,null==(r=e.longpoll)||r.pause(),(0,n.multiStart)(e.writeHash,s,a,o).then((([t])=>{var s;return e.next_peer=t.peerId,e.tabs[t.peerId]=t,(0,i.updateListedConvos)(e,t,!1,(e=>[t.peerId].concat(e))),null==(s=e.longpoll)||s.resume(),e})).then((e=>t?d(e,e.next_peer,t):e)).then((e=>(e.creating=!1,e))).catch((t=>{var s;throw e.creating=!1,null==(s=e.longpoll)||s.resume(),t}))})),c=(0,a.wrapHashActionReversed)(((e,t,s,a,i=!1)=>(e.creating=!0,(0,n.multiStart)(e.writeHash,[],s,void 0,e.gid,!0,i).then((([{peer_id:s}])=>{if(!s)throw new Error("No peer_id");return e.peer=s,(0,o.collectChatCreateStats)(s,a,e.gid),t?d(e,s,t):e})).then((e=>(e.creating=!1,e))).catch((t=>{throw e.creating=!1,t})))));function d(e,t,s){return(0,n.ownerPhotoSave)(t,s,e.gid).then((()=>e))}const _=(0,a.wrapHashActionReversed)(((e,t,s)=>(0,n.kickUser)(t,s,e.tabs[t].hash||"").then((()=>{const a=e.tabs[t];return a&&a.invitedByMessageRequest&&(a.invitedByMessageRequest=a.invitedByMessageRequest.filter((e=>e.id!==s))),e})))),g=(0,a.wrapHashActionReversed)(((e,t,s)=>{const a=e.tabs[t];return(0,n.kickUser)(t,s,a.hash||"",e.gid).then((()=>(a.memberIds=a.memberIds.filter((e=>e!==s)),a.adminIds=a.adminIds.filter((e=>e!==s)),a.membersCount=a.memberIds.length,e)))}))},540537:(e,t,s)=>{s.d(t,{getCustomChatMemberSearch:()=>M,loadConversations:()=>I,loadPeer:()=>y,pinConvoHandler:()=>k,restoreHistoryQueue:()=>S,restoreQueuedMessagesInDom:()=>A,searchHints:()=>R,toggleHideFolderHandler:()=>w,toggleHideFolderNoticeHandler:()=>O,unpinConvoHandler:()=>P});var a=s(434788),n=s(836873),i=s(207930),o=s(300069),r=s(816893),l=s(998898),c=s(215066),d=s(638871),_=s(731062),g=s(672132),u=s(502478),m=s(408014),p=s(839470),h=s(832468),f=s(934701),b=s(783400),v=s(321342),C=s(316646),T=s(47304),L=s(823826),E=s(875610);const I=(0,n.wrapHashActionReversed)(((e,t,s,a)=>(0,i.getConversations)(e.writeHash,e.gid,t,s,a).then((([e])=>e)))),y=(e,t,s,n,l,c)=>{e.tabHistoryNotChanged=!1;const d=(0,m.getTab)(e,t),g=d&&(d.lastmsg||Object.keys(d.msgs||{}).length>0),u=n&&(0,p.partConfigEnabled)("messages_new_empty_dialog_screen")&&!(0,h.getEmptyScreenUserInfo)(e,t)&&!g&&(0,m.isUserEmptyScreenRich)(e,t)?(0,f.loadUserEmptyDialogData)(t).catch((()=>Promise.resolve())):Promise.resolve(),b=(0,_.retryFn)(i.start,3,(e=>e-1))(t,s||0,!!n,e.prevPeer,e.gid,l);return Promise.all([b,u]).then((([n,i])=>{const[l,c,d,_,g,u]=n;if(i&&!l.history&&(0,o.addEmptyScreenUserInfo)(t,i,e),c.forEach((t=>(0,r.oCacheAdd)(e,t))),e.tabs||(e.tabs={}),e.dialog_tab_cts=g,e.tabs[t]||(e.tabs[t]=(0,h.normalizeTab)(e,l)),(0,o.updateBlockStates)(_,e).then((()=>{})).catch((()=>{})),s){if(e.tabs[t]){const s=e.tabs[t].lastmsg,a=e.tabs[t].lastmsg_meta;Object.assign(e.tabs[t],l),e.tabs[t].lastmsg=s,e.tabs[t].lastmsg_meta=a}}else Object.assign(e.tabs[t],l);if(e.admins=(0,a._)({},e.admins,d),u&&(e.tabs[t].peer_profile_info=u),(0,p.partConfigEnabled)("messages_reactions")){const s=(0,m.getConvoReactedPeerIds)(e,t).filter((t=>!(0,L.oCacheExists)(e,t)));s&&(0,E.loadChatMember)({[t]:s},e)}return S(e,t)})).catch((e=>{const t=(0,C.getErrorText)(e,`loadPeer [${c}]`);return(0,T.dummyCatch)(new Error(t))}))};function S(e,t){if(!e.imQueue||!e.imQueueSet)return Promise.resolve(e);const s=e.imQueue(t,!1),a=(0,m.getTab)(e,t);if(!a)return Promise.resolve(e);const n=s.filter((s=>!(0,b.isExistingRid)(e,t,s.rid)));return a.msgs=n.reduce(((e,t)=>(e["rid"+t.rid]=t.mess,e)),a.msgs||{}),e.imQueueSet(t,n).then((()=>{})).catch((()=>{})),a.history=A(e,n,a.history),Promise.resolve(e)}function A(e,t,s){if(!e.imQueue)return s;const a=Array.isArray(t)?t:e.imQueue(t,!1);return 0===a.length||a.map((e=>(e.mess.failed=!!e.failed,e.mess))).filter((t=>(0,b.isMessageStored)(e,t.peerId,t.messageId))).forEach((t=>(0,v.appendMessageToHistory)(e,t,s))),s}function R(e,t,s=i.HintsSearchType.ALL,a,n){return(0,i.hints)(e,a.hidegid?0:n.gid,s,t).then((([e,t,s])=>(a.skipStoreUpdate||(t.forEach((e=>(0,r.oCacheAdd)(n,e))),(0,o.updateBlockStates)(s,n).then((()=>{}),(()=>{})),(0,l.mergeTabs)(n,e).then((()=>{}),(()=>{}))),e))).then((t=>{if(e){const s=t&&Object.keys(t).length;(0,c.saveSearchAttemptStats)(c.serviceMessages,0,s,e)}return Object.keys(t).sort(((e,s)=>t[+e].order-t[+s].order)).map((e=>t[+e]))}))}const k=(0,n.wrapHashActionReversed)(((e,t)=>{var s;return(0,i.pinConvo)(t,(null==(s=e.tabs[t])?void 0:s.hash)||"")})),P=(0,n.wrapHashActionReversed)(((e,t)=>{var s;return(0,i.unpinConvo)(t,(null==(s=e.tabs[t])?void 0:s.hash)||"")})),M=(0,n.wrapHashActionReversed)(((e,t)=>{const s=(0,m.getTab)(e,t);if(!s||!(0,m.isChatConvo)(s))return Promise.resolve(e);if(s.isDonutChat){function n(e){return e.map((e=>({name:`${e.first_name} ${e.last_name}`,id:e.id,photo:e.photo_100,peerId:e.id})))}const{ownerId:i}=s,o=(0,u.isCommunityInterface)(e),r="photo_100",l="donut",c="donut";s.customChatMemberServerSearch=(0,_.debouncedPromise)((e=>{let t={q:e,from_list:c,group_id:-i,fields:r};return o&&(t=(0,a._)({},t,{from_list:"donut_friends"})),(0,d.search)(t).then((({items:e})=>Array.isArray(e)?n(e):[]))}),400);return(o?(0,d.getMembers)({group_id:String(-i),filter:l,fields:r}):(0,d.getFriends)({owner_id:i,fields:r})).then((({items:t})=>{const a=n(t),i=new g.vkIndexer(a,(e=>e.name));return s.customChatMemberSearch=e=>Promise.resolve(e?i.search(e):i.list),e}))}return Promise.resolve(e)})),w=(0,n.wrapHashActionReversed)(((e,t,s,a=!1)=>(0,i.toggleHideFolder)(t,s,a,e.writeHash))),O=(0,n.wrapHashActionReversed)(((e,t,s)=>(0,i.toggleHideFolderNotice)(t,s,e.writeHash)))},998898:(e,t,s)=>{s.d(t,{mergeTabs:()=>p,removeDeletedUnreadMsgsFromTab:()=>f,removeStoredRecommendedListItem:()=>E,resetFolderList:()=>S,setActions:()=>C,setConvoBusinessNotifyEnabled:()=>y,setConvoIsNew:()=>I,setFilteredExpiringMessagesData:()=>b,setFilteredMentionsData:()=>v,updateListedConvos:()=>h,updateRecommendedListItemOnline:()=>L});var a=s(434788),n=s(832468),i=s(49988),o=s(502478),r=s(408014),l=s(47304),c=s(728785),d=s(705758),_=s(755320),g=s(839470),u=s(568012),m=s(931917);function p(e,t,s){(0,n.normalizeTabsGotFromServer)(e,t);const r=e.tabs[e.peer];return e.tabs=Object.keys(t).reduce(((s,n)=>{const r=Number(n),c=e.tabs[r]?e.tabs[r].msgs:{},d=Object.assign({},c||{},t[r].msgs||{});if((0,g.partConfigEnabled)("im_clocks_fix")){Object.keys(t[r].msgs||{}).filter((e=>c&&!c[e])).forEach((t=>{const s=(0,i.parseMessage)(d[t]);s.randomId&&e.imQueueComplete&&(e.imQueueComplete(r,s.randomId),delete d["rid"+s.randomId],(0,g.partConfigEnabled)("im_chasiky_debug")&&window.meBufferLog&&delete window.meBufferLog[s.randomId])}))}return s[r]=Object.assign({},e.tabs[r]||{},t[r]),d&&(s[r].msgs=d),t[r].lastmsg||((0,o.isLastMsgDebugEnabled)(e)&&!1!==s[r].lastmsg&&(console.log((0,a._)({},t[r])),(0,l.showDebugAlert)()),s[r].lastmsg=!1),s}),e.tabs),r&&!s&&(e.tabs[e.peer]=r),Promise.resolve(e)}function h(e,t,s,a,i){t.deletedDialog||(e.dialog_tabs=Object.keys(e.dialog_tabs).reduce(((e,o)=>{const r=e[o];return!s&&!(0,n.getFilterFnForConvoListFolder)(o)(t)||i&&!i(o,r,t)||(e[o]=(0,d.arrayUnique)(a(r,o))),e}),e.dialog_tabs))}function f(e,t,s){const a=(0,r.getTab)(s,e);if(!a)return Promise.resolve(s);if(a.unread=a.unread?a.unread-t.length:0,(0,g.partConfigEnabled)("me_web_read_by_cmid")){const a=t.reduce(((e,t)=>(e[t]=!0,e)),{});b(e,(e=>!a[e]),s),v(e,(e=>!a[e]),s)}else{const a=t.reduce(((e,t)=>(e[t]=!0,e)),{});b(e,(e=>!a[e]),s),v(e,(e=>!a[e]),s)}return Promise.resolve(s)}function b(e,t,s){const a=(0,r.getTab)(s,e);return a?((0,g.partConfigEnabled)("me_web_read_by_cmid")?a.expiring_cmids&&(a.expiring_cmids=a.expiring_cmids.filter(t),a.expiring_cmids.length||delete a.expiring_cmids):a.expiring_messages&&(a.expiring_messages=a.expiring_messages.filter(t),a.expiring_messages.length||delete a.expiring_messages),s):s}function v(e,t,s){const a=(0,r.getTab)(s,e);return a?((0,g.partConfigEnabled)("me_web_read_by_cmid")?a.mention_cmids&&(a.mention_cmids=a.mention_cmids.filter(t),a.mention_cmids.length||delete a.mention_cmids):a.mentions&&(a.mentions=a.mentions.filter(t),a.mentions.length||delete a.mentions),s):s}function C(e){var t,s;const a=e.peer,n=e.id;if(0===a)return Promise.resolve(e);const i=(0,r.getTab)(e,a);if(!i)return Promise.resolve(e);const l=m.Ranges.isChatOrChannelPeer(a),d=(0,r.isChannelPeer)(i),p=(0,r.isCommunityChat)(i),h=(0,r.isBusinessNotifyTab)(i)&&(0,o.isBusinessNotifyEnabled)(e),f=(0,r.tabIsArchived)(i),b=l&&!(0,r.isChatActive)(i),v=!!i.offset,C=[];if((null==(t=i.callInProgress)?void 0:t.can_finish_call)&&(null==(s=i.callInProgress)?void 0:s.call_id)&&C.push(c.ConvoAction.CALL_FINISH),h)return C.push(e.mutedPeers.includes(a)?c.ConvoAction.UNMUTE:c.ConvoAction.MUTE),C.push((0,r.isConvoBusinessNotifyEnabled)(i)?c.ConvoAction.DISABLE_BUSINESS_NOTIFY:c.ConvoAction.ENABLE_BUSINESS_NOTIFY),C.push(c.ConvoAction.CLEAR),Promise.resolve(T(e,i,C));v&&C.push(c.ConvoAction.MEDIA),(0,o.isCommunityInterface)(e)||!m.Ranges.isUserIdTransitional(a)||m.Ranges.isContactId(a)||(0,_.isVkAdminPeer)(a)||(0,_.isSupportAgentPeer)(a)||n===a||i.blacklisted||i.blacklisted_by_me||i.block_error||i.is_subscribed||i.is_new||!i.lastmsg||C.push(c.ConvoAction.ADD_FRIEND),v&&C.push(c.ConvoAction.SEARCH),0===i.unread&&v&&C.push(c.ConvoAction.UNREAD),!m.Ranges.isEmailId(a)&&!v||d||C.push(c.ConvoAction.CLEAR),!(0,o.isCommunityInterface)(e)||d||p||C.push(c.ConvoAction.BLOCK),d&&!b&&C.push(c.ConvoAction.SETTINGS),m.Ranges.isGroupId(a)&&(i.can_send_notify?C.push(c.ConvoAction.BLOCK_NOTIFY):C.push(i.blocked_community?c.ConvoAction.ALLOW_COMMUNITY:c.ConvoAction.BLOCK_COMMUNITY));!((0,g.partConfigEnabled)("fav_dialog_with_yourself")&&n===a)&&!(0,o.isCommunityInterface)(e)&&!m.Ranges.isContactId(a)&&(l||m.Ranges.isUserIdTransitional(a)||m.Ranges.isGroupId(a))&&(!l||!b)&&C.push(e.mutedPeers.includes(a)?c.ConvoAction.UNMUTE:c.ConvoAction.MUTE);l&&!b&&(0,u.canInviteUser)(e,a)&&!(0,o.isCommunityInterface)(e)&&C.push(c.ConvoAction.CHAT_INVITE);!(0,o.isCommunityInterface)(e)&&m.Ranges.isUserIdTransitional(a)&&a!==window.vk.id&&!i.blacklisted&&!i.blacklisted_by_me&&!i.block_error&&i.canBeAddedToChat&&C.push(c.ConvoAction.USER_INVITE),!l||b||(0,o.isCommunityInterface)(e)||C.push(c.ConvoAction.LEAVE),l&&i.data.closed&&!i.data.kicked&&C.push(c.ConvoAction.RETURN),(0,r.canBePinned)(e,i)&&C.push((0,_.isPinnedSortId)(i.major_sort_id||0)?c.ConvoAction.UNPIN_CONVO:c.ConvoAction.PIN_CONVO),l&&i.pinned&&(C.push((0,r.isPinnedMessageHidden)(i)?c.ConvoAction.PIN_UNHIDE:c.ConvoAction.PIN_HIDE),(0,u.canPinOrUnpin)(e)&&!f&&C.push(c.ConvoAction.UNPIN)),(0,r.canArchiveTab)(i)&&!(0,o.isCommunityInterface)(e)&&C.push(f?c.ConvoAction.UNARCHIVE:c.ConvoAction.ARCHIVE);!(0,o.isCommunityInterface)(e)&&m.Ranges.isUserIdTransitional(a)&&a!==window.vk.id&&C.push(i.blacklisted_by_me?c.ConvoAction.UNBLOCK_USER:c.ConvoAction.BLOCK_USER);return!(0,o.isCommunityInterface)(e)&&m.Ranges.isUserIdTransitional(a)&&a!==window.vk.id&&C.push(c.ConvoAction.REPORT_USER),Promise.resolve(T(e,i,C))}function T(e,t,s){const a=(0,n.getConvoActionData)(t,(0,o.isCommunityInterface)(e));return e.curActions=s.reduce(((e,t)=>(e[t]=a[t],e)),{}),e}function L(e,t,s,a){const n=e.recommendationList,i=n&&n.item_data[t];return i&&(i.online=s||a?1:0,i.online_info&&(i.online_info.is_online=s,i.online_info.is_mobile=a)),Promise.resolve(e)}function E(e,t){const s=e.recommendationList;if(!s)return Promise.resolve(e);const n=(0,a._)({},s.item_data);return delete n[t],e.recommendationList=(0,a._)({},s,{items:s.items.filter((e=>e!==t)),item_data:n}),Promise.resolve(e)}function I(e,t,s){return s.tabs[e]&&(s.tabs[e].is_new=!!t),Promise.resolve(s)}function y(e,t,s){const a=(0,r.getTab)(e,t);return a?(a.can_send_business_notify=s,Promise.resolve(e)):Promise.resolve(e)}function S(e,t){return e.dialog_tabs[t]=[],e.dialog_tabs_all[t]=!1,Promise.resolve(e)}},184667:(e,t,s)=>{s.d(t,{loadHashes:()=>n});var a=s(207930);function n(e,t,s){return(0,a.renewHash)(e,t.hidegid?void 0:s.gid)}},123378:(e,t,s)=>{s.d(t,{getFullMessage:()=>r,markAudioMessageAsListened:()=>l});var a=s(599809),n=s(638871),i=s(783400),o=s(552666);const r=(e,t)=>(0,a.api)("messages.getByConversationMessageId",{peer_id:e,conversation_message_ids:t,extended:1,fields:"kludges"}),l=(e,t,s)=>{const a=(0,o.unpackStore)(e),r=(0,i.getMessage)(a,s,t);return!r||(0,i.isOutbound)(r)||(0,i.isVoiceMessageListened)(r)?Promise.reject():(0,n.markAsListened)(t,a.gid)}},934701:(e,t,s)=>{s.d(t,{changeMessageReaction:()=>L,loadUserEmptyDialogData:()=>u,markReactionsAsRead:()=>f,setPeerBanStatus:()=>T,setPeerSubscribedStatus:()=>m,setUnreadReactions:()=>v,updateCmidToMessageIdMap:()=>p,updateConvoRecommendationList:()=>g,updateMessagesReactions:()=>E});var a=s(11010),n=s(638871),i=s(931917),o=s(783400),r=s(502478),l=s(207930),c=s(731062),d=s(300069);const _=(0,c.debouncedPromise)(l.getRecommendedContacts,3e3);function g(e){return e.isRecommendationListRerenderNeeded=!1,(0,r.getLocalSettingsValue)(e,"messages_recommendation_list_hidden")?Promise.resolve(e):_().then((([t])=>{if(!t)return e;const s=!e.recommendationList||e.recommendationList.items.some(((e,s)=>e!==t.items[s]));return e.recommendationList=t,e.isRecommendationListRerenderNeeded=s,e})).catch((t=>{if("debounce"===t)return e;throw t}))}function u(e){return(0,n.getMutual)({target_uid:e,order:"random",count:3}).then((t=>(0,n.usersGet)({user_ids:[e,...t].join(","),fields:"occupation, bdate, city, can_write_private_message, common_count, photo"})))}function m(e,t,s){const a=s.tabs[e];if(!a)return Promise.resolve(s);return(t?(0,n.deleteFriend)({user_id:e}):(0,n.addFriend)({user_id:e})).then((()=>(a.is_subscribed=!t,a.is_subscribed&&a.is_subscribed_to_me&&(a.is_friend=1),Promise.resolve(s))))}function p(e,t,s,a){return h.apply(this,arguments)}function h(){return(h=(0,a._)((function*(e,t,s,a){const i=(0,r.getTabCmidToMessageIdMap)(e,t),l=(0,r.getUnreadReactions)(e,t),c=Array.from(l).filter((s=>!i.get(a)&&!(0,o.getMessageByCmid)(e,t,s)&&s!==a)).sort(((e,t)=>e-t)).slice(0,99);return c.push(a),(0,n.getByConversationMessageId)(c,t,s).then((s=>{const{items:a}=s,n=a.reduce(((e,t)=>{const s=t.conversation_message_id,a=t.id;return e.set(s,a),e}),new Map),o=new Map;return l.forEach((e=>{const t=i.get(e)||n.get(e);t&&o.set(e,t)})),e.cmidToMessageIdMap.set(t,o),e}))}))).apply(this,arguments)}function f(e,t,s){return b.apply(this,arguments)}function b(){return(b=(0,a._)((function*(e,t,s){return(0,n.markReactionsAsRead)(e,t,s)}))).apply(this,arguments)}function v(e,t,s){return C.apply(this,arguments)}function C(){return(C=(0,a._)((function*(e,t,s){return i.Ranges.isZeroOwner(t)?Promise.resolve(e):e.tabs[t]?(e.tabs[t].unread_reaction_cmids=s,Promise.resolve(e)):Promise.resolve(e)}))).apply(this,arguments)}function T(e,t,s){const a=s.tabs[e];if(!a)return Promise.resolve(s);return(t?(0,n.unbanUser)(e):(0,n.banUser)(e)).then((()=>(a.blacklisted_by_me=t?0:1,a.block_error=a.blacklisted_by_me?23:void 0,(0,d.updateBlockStates)({[e]:{free:!0,time:Date.now().valueOf()}},s))))}function L(e,t,s,a,i){return a!==s?(0,n.sendReaction)(e,t,s,i):(0,n.deleteReaction)(e,t,i)}function E(e,t,s){return(0,n.getMessagesReactions)(e,t).then((({items:a})=>{const n=t.map((t=>{var n,i;const r=(null==(n=a.find((e=>e.cmid===t)))?void 0:n.counters)||[];if(0===(0,o.getMessageReactions)(s,e,t).length&&0===r.length)return Promise.resolve(s);const l=Number(null==(i=(0,o.getMessageByCmid)(s,e,t))?void 0:i.messageId);return l?(0,d.setMessageReactions)(s,e,l,r):Promise.resolve(s)}));return Promise.all(n).then((()=>s))}))}},816893:(e,t,s)=>{s.d(t,{oCacheAdd:()=>n});var a=s(705758);function n(e,t){const s=(0,a.unpackStore)(e);s.oCache||(s.oCache={}),t.id&&(s.oCache[t.id]=t)}},95638:(e,t,s)=>{s.d(t,{CHANGE_VOICE_UI:()=>i,changePeer:()=>c,changeTab:()=>d,changeVoiceTranscriptUI:()=>_,compactCounterEvents:()=>m,editMessageLocallyEvent:()=>o,failedMessage:()=>g,resendEvent:()=>u,resetPeer:()=>l,transitionEvent:()=>r});var a=s(434788),n=s(835200);const i="change_voice_ui";function o(e){return(0,a._)({},e,{type:n.EDIT_MESSAGE})}function r(e){return{type:n.TRANSITION,state:e}}function l(e=!1,t=!1){return{type:n.RESET_PEER,cancelSearch:e,removeActivePeer:t}}function c(e,t=!1,s=!1,a=!1,i=""){return{type:n.CHANGE_PEER,peerId:e,msgid:t,forward:s,cancelSearch:a,entryPoint:i}}function d(e){return{type:n.CHANGE_TAB,tab:e}}function _(){return{type:i}}function g(e,t,s){return{type:n.FAILED_MESSAGE,message:t,peerId:e,error:s}}function u(e,t){return{type:n.RESEND,message:t,peerId:e}}function m(e){let t=!1;return e.reduceRight(((e,s)=>{const a=s.type===n.UNREAD_COUNT,i=!t&&a;return a&&!i||e.unshift(s),i&&(t=!0),e}),[])}},602849:(e,t,s)=>{s.d(t,{getFilteredConvoList:()=>g,getFolderInlineMenuActionsData:()=>_});var a=s(728785),n=s(620145),i=s(746677),o=s(98914),r=s(29271),l=s(408014),c=s(832468),d=s(552666);function _(e){var t,s;const l=e;var c,d;return{[a.FolderAction.SHOW]:{name:null!=(c=null==(t={[a.ConvoListFolder.BUSINESS_NOTIFY]:r.getLang("mail_folder_action_show_business_notify"),[a.ConvoListFolder.ARCHIVE]:r.getLang("mail_folder_action_show_archive")})?void 0:t[l])?c:r.getLang("mail_folder_action_show_default"),icon:null!=(d=null==(s={[a.ConvoListFolder.BUSINESS_NOTIFY]:(0,n.getIcon20WorkOutline)().icon,[a.ConvoListFolder.ARCHIVE]:(0,i.getIcon20ArchiveOutline)().icon})?void 0:s[l])?d:(0,o.getIcon20Add)().icon}}}function g(e,t,s){const a=(0,d.unpackStore)(e),n=(0,c.getFilterFnForConvoListFolder)(s);return t.reduce(((e,t)=>{const s=(0,l.getTab)(a,t);return s&&n(s)&&e.push(s.peerId),e}),[])}},836873:(e,t,s)=>{s.d(t,{wrapHashAction:()=>i,wrapHashActionReversed:()=>o});var a=s(408014),n=s(184667);function i(e){return(...t)=>{let s=t[t.length-1];return e(...t).catch((a=>{if(a&&a.match&&a.match(/1001;/))return r(s,e,t);throw a}))}}function o(e){return(t,...s)=>e(t,...s).catch((a=>{if(a&&a.match&&a.match(/1001;/))return r(t,e,[t].concat(s));throw a}))}function r(e,t,s){return function(e){return e.resync_in_process?e.resync_in_process:Promise.resolve(!1)}(e).then((i=>i?t(...s):function(e){if(!e.renew_hashes){const t=e.last_hashes_update||0;if(Date.now()-t<1e4)return Promise.resolve();const s=Object.keys(e.tabs).filter((t=>(0,a.isFullyLoadedTab)(e,+t)));e.renew_hashes=(0,n.loadHashes)(s,{},e).then((([t,a,n])=>(s.forEach((s=>{const a=+s;e.tabs[a].hash=t[a]})),e.writeHash=a,e.manageTagsHash=n,delete e.renew_hashes,e.last_hashes_update=Date.now(),e)))}return e.renew_hashes}(e).then((()=>t(...s)))))}},83667:(e,t,s)=>{s.d(t,{getUserInitials:()=>c,makeUserFromUserConvo:()=>l,prepareContactName:()=>d});var a=s(659397),n=s(679177),i=s(666920),o=s(664988),r=s(82161);function l(e){return{id:e.peerId,link:e.href,name:e.name,first_name:"",short_name:"",first_name_gen:"",inv_name:"",kick_name:"",sex:e.sex,photo:e.photo||""}}function c(e){const t=(0,a.decodeHTMLEntities)(e),s=(0,n.emojiRegex)().exec(t);return s?0===s.index?(0,i.emojiReplace)(s[0]):t[0]:t.split(/\s/).reduce(((e,t)=>e+t.slice(0,1)),"").slice(0,2)}function d(e){const t=(0,o.replaceEntities)(e);return(0,i.emojiToHTML)((0,r.clean)(t),!0)}},625139:(e,t,s)=>{s.d(t,{convertImMessageToMarusia:()=>c,formatDate:()=>l,replaceSpecialSymbols:()=>o,secondsToHuman:()=>r});var a=s(728785),n=s(221780),i=s(835200);function o(e){return e.replace(/&lt;&lt;/g,"&laquo;").replace(/&gt;&gt;/g,"&raquo;").replace(/ \-\-/g," &mdash;").replace(/\-\- /g,"&mdash; ").replace(a.MENTION_RAW,"$1$4")}function r(e){const t=Math.floor(e/3600),s=Math.floor(e/60)-60*t;let a=!1,n=!1;return[t,s,e-3600*t-60*s].reduce(((e,t)=>{if(0===t&&!n)return n=!0,e;let s=`${e}${""!==e?":":""}${a&&t<10?"0"+t:t.toString()}`;return a=!0,n=!0,s}),"")}function l(e,t){return(0,n.langDate)(1e3*e,"{hour}:{minute} {am_pm}",1e3*t,[],!0)}function c(e){var t;const s={attaches:e.attaches,isOutbound:!!(e.flags&i.FLAG_OUTBOUND),kludges:e.kludges,local:null!=(t=e.local)&&t,text:e.text,messageId:null,randomId:0};var a;"string"==typeof e.messageId?(s.messageId=null,s.randomId=Number(e.messageId.replace("rid",""))):(s.messageId=e.messageId,s.randomId=null!=(a=e.randomId)?a:s.randomId);return s}},207930:(e,t,s)=>{s.d(t,{HintsSearchType:()=>l,addChatMembers:()=>i,getConversations:()=>o,getRecommendedContacts:()=>h,hints:()=>c,kickUser:()=>u,multiStart:()=>_,ownerPhoto:()=>d,ownerPhotoSave:()=>g,pinConvo:()=>m,renewHash:()=>r,start:()=>v,toggleHideFolder:()=>f,toggleHideFolderNotice:()=>b,unpinConvo:()=>p});var a=s(302925),n=s(728785);const i=(e,t,s,i,o)=>(0,a.post)(n.CONTROLLER,{act:"a_add_chat_members",peer:e,new_peer:t.join(","),gid:s,hash:i,show_history:o?1:0}),o=(e,t,s,i,o)=>(0,a.post)(n.CONTROLLER,{act:"a_get_conversations",offset:o,count:i,filter:s,gid:t,hash:e}),r=(e,t)=>(0,a.post)(n.CONTROLLER,{act:"a_renew_hash",peers:e.join(","),gid:t});var l;!function(e){e.FRIENDS="friends",e.FRIENDS_AND_CONTACTS="friends_and_contacts",e.ALL="all"}(l||(l={}));const c=(e,t,s,i)=>(0,a.post)(n.CONTROLLER,{act:"a_hints",str:e,gid:t,query:s,peerIds:i.join(",")}),d=(e,t)=>(0,a.post)(n.CONTROLLER,{act:"a_owner_photo",photo:e,peer:t}),_=(e,t,s,i,o,r=!1,l=!1)=>(0,a.post)(n.CONTROLLER,{act:"a_multi_start",hash:e,peers:t.join(","),title:s,flags:i,gid:o,is_community_chat:Number(r),is_donut_chat:Number(l)}),g=(e,t,s)=>(0,a.post)("al_page.php",{act:"owner_photo_save",peer:e,_query:t,gid:s}),u=(e,t,s,i)=>(0,a.post)(n.CONTROLLER,{act:"a_kick_user",chat:e,hash:s,mid:t,gid:i}),m=(e,t)=>(0,a.post)(n.CONTROLLER,{act:"a_pin_convo",peer_id:e,hash:t}),p=(e,t)=>(0,a.post)(n.CONTROLLER,{act:"a_unpin_convo",peer_id:e,hash:t}),h=()=>(0,a.post)(n.CONTROLLER,{act:"a_recommend_contacts"}),f=(e,t,s,i)=>(0,a.post)(n.CONTROLLER,{act:"a_toggle_hide_folder",folder:e,hash:i,hide:t?1:0,reset:s?1:0}),b=(e,t,s)=>(0,a.post)(n.CONTROLLER,{act:"a_toggle_hide_folder_notice",notice:e,hide:t,hash:s}),v=(e,t,s,i,o,r)=>(0,a.post)(n.CONTROLLER,{act:"a_start",peer:e,msgid:t,history:Number(s),prevpeer:i,gid:o,block:r})},321342:(e,t,s)=>{s.d(t,{appendMessageToHistory:()=>p,ensureDomHasActions:()=>h,removeMessagesWithStack:()=>f,removeNewUnreadBarAndMerge:()=>b,unpackHistory:()=>m});var a=s(408014),n=s(795558),i=s(783400),o=s(82161),r=s(221780),l=s(705758),c=s(196655),d=s(540537),_=s(728785),g=s(659397),u=s(931917);function m(e){return"string"==typeof e?(0,n.se)(`<div>${e}</div>`):e}function p(e,t,s,p=!0,v=!0){const C=(0,a.getTab)(e,t.peerId);if(!C||!s)return;const T=m(s);if(!s||T.querySelector("._im_mess")||T.querySelector("._im_bar_date")||(T.innerHTML=""),C.skipped&&C.skipped>0)return T;let L=[];if(!t.local&&e.imQueue&&(L=e.imQueue(t.peerId,p)),L.length>0){f(L.reduce(((e,t)=>{const s=T.querySelector(`._im_mess_rid${t.rid}`);return s&&e.push(s),e}),[]),T)}const E=(0,c.renderMessage)(e,t);let I=(0,n.domLC)(T);I&&!I.classList.contains("_im_mess_stack")&&(I=(0,n.domClosestSibling)(I,"._im_mess_stack",-1));let y=(0,i.getLastMessage)(e,t.peerId,t.messageId);for(;t.peerId===e.peer&&y&&!T.querySelector(`._im_mess_${y.messageId}`);)y=(0,i.getLastMessage)(e,t.peerId,y.messageId);const S=T.querySelector("._im_unread_bar_row"),A=y?(0,i.shiftDate)(e,y.date):0,R=u.Ranges.isChatOrChannelPeer(t.peerId)&&(0,a.isCasperChatTab)(C);if(!y||(0,i.isNewStack)(C,y,t,e,v)){let s="",a=!1;if(S&&(0,i.isOutbound)(t)&&b(e,T,t.peerId),1===C.unread&&!(0,i.isOutbound)(t)&&v&&(s+=(0,o.getTemplate)("im_mess_bar",{}),a=!0,b(e,T,t.peerId)),!(0,g.isDateToday)(new Date(A))&&!R){const n=new Date,i=a?"im-page--history-new-bar_hide _im_invisible_bar":"";s+=(0,o.getTemplate)("im_day_bar",{day:(0,r.getShortDate)(t.date,e.timeshift,!0,r.getLang("months_of","raw"),!0),date:t.date,day_class:n.getDate()+n.getMonth()+n.getFullYear()+" "+i})}if((0,i.isServiceMsg)(t))s+=(0,o.getTemplate)("im_service_row",{text:(0,c.renderServiceMsg)(e,t,C.peerId),type:"",date:t.date,from_id:"",message_id:t.messageId});else{const a=(0,c.getStackDataFromMessage)(e,t);s+=(0,o.getTemplate)(a.is_nft_photo?"im_mess_stack_nft":"im_mess_stack_no_nft",Object.assign(a,{messages:E,peer_id:a.peerId}))}(0,l.toArray)((0,n.sech)(s)).forEach((e=>T&&T.appendChild(e)))}else S&&e.peer===t.peerId&&!C.inplaceSearch&&(0,i.isOutbound)(t)&&b(e,T,t.peerId),I.querySelector("._im_stack_messages").appendChild((0,n.se)(E));const k=Date.now()-1e3*t.date>_.SENDING_ICON_TIMEOUT;return(0,i.isOutbound)(t)&&!k&&setTimeout((()=>{const e=T.querySelector(`._im_mess_${t.messageId}`);e&&e.classList.contains(c.SENDING_CLASS)&&e.classList.add("im-mess_sending")}),_.SENDING_ICON_TIMEOUT),L=L.filter((e=>e.rid!==t.randomId)),h(T),(0,d.restoreQueuedMessagesInDom)(e,L,T)}function h(e){const t=e.querySelectorAll("._im_mess_noa:not(._im_mess_callsnippet):not(._im_mess_srv)");for(let e=t.length;e--;)t[e].classList.contains("im-mess_fwd")||t[e].insertAdjacentHTML("afterbegin",(0,o.getTemplate)("sImHistoryRowActions")),t[e].classList.remove("_im_mess_noa")}function f(e,t){const s=e.filter((e=>!e.classList.contains("im-mess_srv"))).map((e=>e.parentElement));return e.forEach((e=>{const{parentNode:t}=e;if(!t)return;if(!e.classList.contains("im-mess_srv"))return void t.removeChild(e);const s=t.parentNode;s&&s.removeChild(t)})),s.filter((e=>0===(0,n.domChildren)(e).length)).map((e=>e?e.closest("._im_mess_stack"):void 0)).forEach((e=>{var t,s;(null==(t=(0,n.domPS)(e))?void 0:t.classList.contains("_im_bar_date"))&&(0,n.re)((0,n.domPS)(e)),(null==(s=(0,n.domPS)(e))?void 0:s.classList.contains("_im_unread_bar_row"))&&(0,n.re)((0,n.domPS)(e)),(0,n.re)(e)})),t}function b(e,t,s){let a=t.querySelector("._im_unread_bar_row");if(!a)return t;const o=(0,n.domClosestSibling)(a,"._im_mess_stack",-1),r=(0,n.domClosestSibling)(a,"._im_mess_stack"),c=o?Array.from(o.querySelectorAll("._im_mess")).pop():null,d=r?r.querySelector("._im_mess"):null;if((0,n.re)(a),function(e){let t=e.querySelector("._im_invisible_bar");t&&t.classList.remove("_im_invisible_bar","im-page--history-new-bar_hide")}(t),!d||!c)return t;const _=d.dataset.msgid,g=(0,i.getPreviousMessage)(e,s,_),u=(0,i.getMessage)(e,s,_);if(!g||!u||(0,i.isNewStack)(e.tabs[s],g,u,e))return t;const m=o.querySelector("._im_stack_messages"),p=r.querySelector("._im_stack_messages").children;return(0,l.toArray)(p).forEach((e=>{(0,n.re)(e),m.appendChild(e)})),(0,n.re)(r),t}},196655:(e,t,s)=>{s.d(t,{FAILED_CLASS:()=>O,SENDING_CLASS:()=>w,getServiceLinkTemplate:()=>j,getStackDataFromMessage:()=>B,parseMessageText:()=>x,renderCallUserList:()=>H,renderMessage:()=>N,renderMessageMedia:()=>F,renderMessageReactions:()=>$,renderReactionsPanel:()=>G,renderServiceMsg:()=>U});var a=s(408014),n=s(783400),i=s(82161),o=s(221780),r=s(29271),l=s(795557),c=s(426043),d=s(197834),_=s(141256),g=s(896879),u=s(502478),m=s(12402),p=s(795558),h=s(625139),f=s(552666),b=s(823826),v=s(872306),C=s(659397),T=s(47095),L=s(839470),E=s(728785),I=s(588470),y=s(408164),S=s(68003),A=s(970978),R=s(931917),k=s(67109),P=s(377911),M=s(991243);const w="_im_mess_sending",O="_im_mess_failed";function N(e,t){const s=[],c=(0,a.getTab)(e,t.peerId),d=c&&(0,n.isUnread)(c,t),_=(0,n.isCallMessage)(t)||(0,n.isActiveGroupCallMessage)(t),g=c&&(0,a.getPinnedMessage)(c),p=(0,n.hasReply)(t)?(0,i.getTemplate)("im_message_media",{type:"reply",messageId:t.messageId,attaches:D("reply"),text:""}):"";_||s.push("_im_mess"),(0,n.isOutbound)(t)&&d&&!_&&s.push("im-mess_unread _im_mess_unread"),(0,n.isOutbound)(t)&&!_&&s.push("im-mess_out"),(0,n.wasEdited)(t)&&s.push("im-mess_was_edited"),(0,n.canMessageBeEdited)(e,t)&&s.push("im-mess_editable"),(0,n.isImportant)(t)&&s.push("im-mess_fav"),(e.selectedMessages||[]).includes(t.messageId)&&s.push("im-mess_selected"),g&&g.messageId===t.messageId&&s.push("_im_mess_pinned");const b=Date.now()-1e3*t.date>E.SENDING_ICON_TIMEOUT;t.local&&b&&s.push("im-mess_sending"),t.local&&s.push(`${w}`),t.local&&(0,n.wasEdited)(t)&&!d&&s.push("im-mess_unread im-mess_nobg"),t.failed&&s.push(`im-mess_failed ${O}`),(0,n.isGift)(t)&&s.push("im-mess_gift"),_&&s.push("_im_mess_callsnippet"),(0,n.isCasperMessage)(t)&&s.push("im-mess_casper"),(0,n.isWidgetMessage)(t)&&s.push("im-mess_widget"),(0,n.canSendReactions)(e,t)&&s.push("im-mess_reactions");const v=F(e,t).concat(function(e){if(e.kludges.keyboard&&e.kludges.keyboard.inline){const t=e.kludges.keyboard.buttons;let s=0;return[].concat((0,i.getTemplate)("sImMessageKeyboard",{content:t.map((e=>(0,i.getTemplate)("sImMessageKeyboardRow",{content:e.map((e=>(0,i.getTemplate)("sImMessageKeyboardButton",{label:(0,m.getButtonLabel)(e),appearance:(0,m.getButtonAppearance)(e),modifier:e.action.type.replace("_","-"),attributes:(0,m.getAttributesFromActionObject)(e.action,s++),tagName:e.action.type===m.BUTTON_TYPE_OPEN_LINK||e.action.type===m.BUTTON_TYPE_OPEN_MODAL_VIEW?"a":"button"}))).join("")}))).join("")}))}return[]}(t)),C=function(e,t){let s="";const a=(0,f.unpackStore)(e).sourceEnabled,c=a&&t.kludges&&t.kludges.from_widget&&t.kludges.ref_source;(0,n.wasEdited)(t)&&(s+=(0,i.getTemplate)("sImLblWasEdited",{update_time:t.update_time}));if((0,u.isCommunityInterface)(e)&&c){let e,a=t.kludges.ref_source;try{if(e=JSON.parse((0,i.unclean)(a||"")),e.link&&e.info){e.link=(0,l.replaceHyperLinks)((0,i.clean)(e.link),(e=>(0,l.linksReplacer)(e)));const t=(0,i.clean)((0,o.langStr)(r.getLang("mail_source_info"),"link",e.link,"info",(0,i.clean)(e.info)));s+=(0,i.getTemplate)("sImLblWasSourceInfo",{source:t})}}catch(e){}}return s}(e,t),T=(0,L.partConfigEnabled)("messenger_make_away_link_useful")?1e3:55;let y=p+x(e,t.text,t.kludges,t.peerId,T);t.subject&&"..."!==t.subject.trim()&&!R.Ranges.isChatOrChannelPeer(t.peerId)&&(y=(0,i.getTemplate)("im_topic",{topic:t.subject})+y);let S=v.length>0?(0,i.getTemplate)("im_message_media",{type:"media",messageId:t.messageId,attaches:v.join(""),text:""}):"";const A=t.kludges.has_template?function(e){return'<div class="bot-carousel-placeholder _im_bot_carousel_'+e.messageId+'"></div>'}(t):"";(0,n.isGift)(t)||(S=y+A+S),(0,n.isCallMessage)(t)&&(S+=function(e,t,s){const a=e.viewer_id,n=t.attaches[0],o=n.initiatorId,l=n.state,c=a===o,d=Boolean(t.kludges.attach1_call_video),_=t.kludges.attach1_call_participants&&JSON.parse(t.kludges.attach1_call_participants)||[],g="group_call"===t.kludges.attach1_kind,u={title:"",description:"",modifier:"",button:"",user_list:""},m=d?r.getLang("mail_call_snippet_outgoing_video"):r.getLang("mail_call_snippet_outgoing"),p=d?r.getLang("mail_call_snippet_incoming_video"):r.getLang("mail_call_snippet_incoming");switch(l){case"reached":{const e=s?"":(0,h.secondsToHuman)(n.duration);u.title=c?m:p,u.description=`${r.getLang("mail_call_snippet_finished")} · ${e}`;break}case"canceled_by_initiator":c?(u.title=m,u.description=r.getLang("mail_call_snippet_canceled")):(u.title=p,u.description=r.getLang("mail_call_snippet_missed"));break;case"canceled_by_receiver":if(c){if(s)return r.getLang("mail_call_declined");u.title=m,u.description=r.getLang("mail_call_snippet_declined")}else u.title=p,u.description=r.getLang("mail_call_snippet_canceled");break;default:u.title=r.getLang("mail_added_call")}g&&(u.title=r.getLang("mail_call_snippet_group"));const f=_.map(Number);return u.user_list=H(e,f)||(0,I.getIcon24Phone)().icon,u.classes="im-mess--call-snippet CallSnippet--interactive _im-call-snippet",u.attributes=`data-participants="${f.join(",")}"`,(0,i.getTemplate)("sImCallSnippet",u)}(e,t)),S||(S=(0,i.getTemplate)("im_attachment_deleted",{text:r.getLang("mail_attach_deleted")})),S+=C;return(0,i.getTemplate)("im_msg_row",{msg_id:t.messageId,cmid:t.chat_local_id,from_id:t.peerId,aria_hidden:t.local&&!t.failed?"true":"false",ts:t.date,marker_params:t.failed?`aria-label="${r.getLang("mail_send_message_error")}" role="link"`:"",unread_params:d?`aria-label="${r.getLang("mail_unread_message")}"`:"",cls:s.join(" "),reactions:""}).replace("%text%",(()=>S))}function x(e,t,s,a,n){const i=Math.round(1e9*Math.random()).toString(16),o={};let r=0,m=(0,l.replaceHyperLinks)(t||"",(e=>{const t=`!link_${r}_${i}!`;return o[t]=(0,l.linksReplacer)(e,n),r++,t}));return m=(0,g.replaceMentions)(m),e.isMassMentionsMessageAllowed&&(m=(0,_.replaceMassMentions)(m)),m=(0,c.replaceEmailLinks)(m),m=(0,d.replaceHashtags)(m,(t=>{const s=(0,u.getGroupId)(e);return`<a href="/${s?"gim"+s:"im"}?sel=${a||(0,u.getPeer)(e)}&st=${encodeURIComponent(t)}">${t}</a>`})),Object.keys(o).forEach((e=>{m=m.replace(e,(()=>o[e]))})),s.emoji&&(m=window.Emoji.emojiToHTML(m,!0)),m}function D(e){return(0,i.getTemplate)("im_preloader",{preloader:(0,p.rs)(window.vk.pr_tpl,{id:""}),cls:`im-preloader_attach im-preloader_visible im-preloader_${e}`})}function F(e,t){return t.attaches.reduce(((s,a)=>{if((0,n.hasReply)(t)&&(a.type===T.AttachmentType.MAIL||a.type===T.AttachmentType.REPLY))return s;switch(a.type){case T.AttachmentType.CALL:return s;case T.AttachmentType.STICKER:s.push(function(e,t,s,a,o){const{messageId:r}=o,l=(0,P.getStickerSizeForMessenger)(),c=window.devicePixelRatio>1.25?2*l:l,d=(0,M.findClosestStickerSize)(c),_=r&&"animation"===s;let g;const u={};let m;try{var p;m=(null==(p=o.kludges)?void 0:p.attachments)&&JSON.parse(o.kludges.attachments)}catch(e){}if(m){var h;const e=null==(h=m.find((e=>"sticker"===e.type)))?void 0:h.sticker;if(e){const t=S.colorScheme.isDarkScheme()?e.images_with_background:e.images;var f;if(t)t.sort(((e,t)=>e.width-t.width)),g=null==(f=t.find((e=>e.width>=c)))?void 0:f.url;if(e.vmoji){const t=(0,n.getMessageAdminId)(a,o)||(0,n.getMessageUserId)(a,o);u.vmoji={avatarOwnerId:R.Ranges.isUserIdTransitional(t)?t:null,avatarCharacterId:e.vmoji.character_id}}}}g||(g=window.Stickers.getStickerUrl(Number(e),d));let b=`<img height="${l}" class="sticker_img im_gift" src="${g}"/>`;if(r&&_){const s="animatedSticker"+r;b=`<div id="${s}" data-loop-count=3 data-animation-path="${"/stickers.php?act=proxy_animation&product_id="+t+"&sticker_id="+e}" onmouseenter="StickersAnimation.loadAndPlaySticker(this);"\n     data-uniq-id="${r}" data-sticker-id="${Number(e)}" class="sticker_animation sticker_animation_${l} im_gift">${b}</div>`;Number.isInteger(r)&&window.StickersSettings.getAutoplay()&&window.StickersAnimation&&window.StickersAnimation.loadAndPlayStickerWithTimer(s,10)}b=`<div class="sticker_img_wrapper">${b}</div>`,t&&(b=`<a onmouseover="return Emoji.stickerOver(${Number(e)}, this);"\n        onclick="return Emoji.clickSticker(${Number(t)}, this, event, ${(0,i.escapeAttr)(JSON.stringify(u))});">${b}</a>`);return b=`<div class="im_sticker_row">${b}</div>`,b}(a.id,a.productId,a.kind,e,t));break;case T.AttachmentType.UGC_STICKER:s.push(function(){const e=(0,P.getStickerSizeForMessenger)();return(0,k.getUGCStickerSkeleton)(e)}());break;default:s.push(D(a.type))}return s}),[])}function H(e,t){if(!t.length)return"";const s=t.slice(0,3).reduce(((t,s)=>{const a=(0,b.oCacheGet)(e,s);return a&&(t+=(0,i.getTemplate)("sImCallUser",{url:a.photo,name:a.name})),t}),"");return(0,i.getTemplate)("sImCallUsers",{users:s})}function B(e,t){var s,l,c,d,_,g,m,p,T,L,E,I,y;const S=(0,f.unpackStore)(e),{peerId:A,messageId:k}=t,P=(0,a.getTab)(e,A),M=(0,n.getMessageUserId)(S,t),w=(0,n.getMessageAdminId)(e,t),O=(0,b.oCacheGet)(S,w?-S.gid:M),N={name:(null==(s=O)?void 0:s.name)||(null==(l=P)?void 0:l.name)||"",first_name:(null==(c=O)?void 0:c.first_name)||(null==(d=P)?void 0:d.name)||"",href:(null==(_=O)?void 0:_.link)||(null==(g=P)?void 0:g.href)||"",sex:(null==(m=O)?void 0:m.sex)||(null==(p=P)?void 0:p.sex)||0,photo:(null==(T=O)?void 0:T.photo)||(null==(L=P)?void 0:L.photo)||"",image_status:(null==(E=O)?void 0:E.image_status)||""},x=R.Ranges.isChatOrChannelPeer(A)?N.name:N.first_name,D=N.href,F=R.Ranges.isChatOrChannelPeer(A)&&N.image_status?N.image_status:"";let H=(0,i.getTemplate)("im_mess_stack_name",{name:x+F,link:D,class:(0,n.isMoney)(t)?" im-mess-stack--lnk-money-transfer":""});if((0,n.isGift)(t)&&(H+=(0,i.getTemplate)("sImGiftLabel",{content:(0,o.langSex)(N.sex||0,r.getLang("mail_gift_message_sent","raw"))})),(0,n.isMoney)(t)){const e=(0,n.isMoneyRequest)(t)?r.getLang("mail_money_request_message_sent","raw"):r.getLang("mail_money_tranfer_message_sent","raw");H+=(0,i.getTemplate)("sImMoneyTransferLabel",{content:(0,o.langSex)(N.sex||0,e)})}const B=function(e,t){const s=(0,f.unpackStore)(e),{peerId:o,messageId:l}=t,c=(0,a.getTab)(s,o),d=c&&R.Ranges.isChatOrChannelPeer(o)&&(0,a.isCasperChatTab)(c),_=(0,n.getMessageAdminId)(e,t),g=(0,u.isCommunityInterface)(e)?"/gim"+s.gid:"/im";let m=d?"":(0,i.getTemplate)("im_stack_date",{date:(0,h.formatDate)(t.date,s.timeshift),link:`${g}?sel=${o}&msgid=${l}`});if(_&&s.admins[_]){const e=s.admins[_],t=_===s.viewer_id?r.getLang("mail_by_you"):e[0];m+=" "+(0,i.getTemplate)("im_admin_link",{name:t,href:e[1]})}return m+function(e,t){if(!(0,n.isCasperMessage)(t))return"";const s=(0,a.getTab)(e,t.peerId),[o,r,l]=v.casperMessagesStore.getTimings(t.chat_local_id),c=Math.max(o+r-l,0);return(0,i.getTemplate)("sImBomb",{classnames:(0,C.classNames)({"im-mess-stack--bomb_hidden":s&&(0,a.isCasperChatTab)(s),"im-mess-stack--bomb_expiring":c<=v.EXPIRING_TIME,"im-mess-stack--bomb_expiring-soon":c<=v.EXPIRING_SOON_TIME})})}(s,t)}(e,t);return{photo:N.photo,is_nft_photo:(null==(I=(0,a.getTab)(e,M))?void 0:I.is_nft_photo)||R.Ranges.isChatOrChannelPeer(A)&&(null==(y=O)?void 0:y.is_nft_photo),href:D,cls:"",date_attr:"",link:`/im?sel=${A}&msgid=${k}`,name:(0,i.stripHTML)(H),stack_name:H,peerId:M,messageMeta:B,admin:w}}function U(e,t,s,a=!0){var l,c,d,_;const g=(0,f.unpackStore)(e),u=t.kludges,m=u.source_act,p=Number(u.source_mid),v=Number(R.Ranges.isChatOrChannelPeer(s)?u.from:(0,n.isOutbound)(t)?g.id:t.userId),C=v===p,T=(0,b.oCacheGet)(e,v);let L="raw";const E=("conversation_style_update"===m||"conversation_style_update_action"===m)&&u.source_style&&(g.conversationStylesEasterEggs===u.source_style||"all"===g.conversationStylesEasterEggs);let I="";switch(m){case"chat_create":I=r.getLang("mail_im_chat_created",L);break;case"chat_title_update":I=u.source_is_channel?r.getLang("mail_im_title_updated_channel",L):r.getLang("mail_im_title_updated_dot",L);break;case"chat_invite_user":I=C?r.getLang("mail_im_returned_to_chat",L):r.getLang("mail_im_invited",L);break;case"chat_kick_user":I=C?r.getLang("mail_im_left",L):r.getLang("mail_im_kicked_from_chat",L);break;case"chat_photo_update":I=r.getLang("mail_im_photo_set",L);break;case"chat_photo_remove":I=u.source_is_channel?r.getLang("mail_im_photo_removed_channel",L):r.getLang("mail_im_photo_removed",L);break;case"chat_pin_message":I=u.source_message?r.getLang("mail_im_pin_message",L):r.getLang("mail_im_pin_message_empty2",L);break;case"chat_unpin_message":I=u.source_message?r.getLang("mail_im_unpin_message",L):r.getLang("mail_im_unpin_message_empty2",L);break;case"chat_invite_user_by_link":I=r.getLang("mail_im_invite_by_link",L);break;case"chat_invite_user_by_message_request":I=r.getLang("mail_im_invite_by_message_request",L);break;case"chat_screenshot":I=g.id===p?r.getLang("mail_im_chat_own_screenshot",L):r.getLang("mail_im_chat_screenshot",L);break;case"chat_group_call_started":I=r.getLang("mail_im_start_group_call",L);break;case"chat_invite_user_by_call":I=r.getLang("mail_im_invited_to_call",L);break;case"chat_invite_user_by_call_join_link":I=r.getLang("mail_im_invite_by_call_link",L);break;case"sent_message_requests_count":L=Number(u.count_mr),I=r.getLang("mail_creation_count_mr_service_msg",L);break;case"accepted_message_request":var y;I=(null==(y=T)?void 0:y.contact_name)?r.getLang("mail_im_accepted_message_request",L):r.getLang("mail_im_accepted_message_request_no_name",L);break;case"chat_kick_user_call_block":I=r.getLang("mail_im_kick_user_call_block",L);break;case"chat_kick_don":I=r.getLang("mail_im_chat_kick_don",L);break;case"conversation_style_update":case"conversation_style_update_action":I=u.source_style?E?r.getLang("mail_im_change_chat_theme_easter_egg",L):r.getLang("mail_im_change_chat_theme",L):r.getLang("mail_im_reset_chat_theme",L);break;case"call_transcription_failed":I=r.getLang("mail_im_call_transcription_failed",L);break;default:return r.getLang("mail_no_support")}const S=(0,b.oCacheGet)(e,p),k=S?function(e,t,s){return"chat_invite_user_by_message_request"===e?s:t}(m,(null==(c=T)?void 0:c.sex)||0,S.sex):null==(l=T)?void 0:l.sex;I=(0,o.langSex)(k||0,I);!a&&(I=I.replace(/<br\s*\/?>/g," "));const P=(0,i.clean)((0,i.unclean)(T?function(e,t){return"chat_invite_user_by_message_request"===t?e.inv_name:e.name}(T,m):""));if(I=I.replace("{from}",j((null==(d=T)?void 0:d.link)||"",P,a)),I=I.replace("{contact}",(null==(_=T)?void 0:_.contact_name)||""),p&&!C){var M;const e=u.source_email,t=(0,i.clean)((0,i.unclean)(S?function(e,t){if("chat_invite_user_by_message_request"===t)return e.name;return"chat_kick_user"===t?e.inv_name:e.kick_name}(S,m):"")),s=e?j(`/im?email=${encodeURIComponent(e)}`,"email",a):j((null==(M=S)?void 0:M.link)||"",t,a);I=I.replace("{user}",s)}if(u.source_text&&u.source_text.length>0){let e=u.source_old_text?`«<b class="im_srv_lnk">${u.source_old_text}</b>» &rarr; `:"";I=I.replace("{title}",e+`«<b class="im_srv_lnk">${u.source_text}</b>»`)}if("chat_pin_message"===m||"chat_unpin_message"===m)if(u.source_message){const e=j("",(0,h.replaceSpecialSymbols)(window.Emoji.emojiToHTML((0,i.stripHTML)(u.source_message.replace(/<br\s?\/?>/gi," ")),!0)),!1,"im_srv_mess_link");I=I.replace("{msg}",e)}else I=I.replace(/{link}(.+){\/link}/i,((e,t)=>j("",t,!1,"im_srv_mess_link")));if("conversation_style_update"===m||"conversation_style_update_action"===m){if(u.source_style){const e=E?r.getLang("mail_conversation_style_easter_egg"):function(e){let t="";switch(e){case"candy":t=r.getLang("mail_conversation_style_candy");break;case"crimson":t=r.getLang("mail_conversation_style_crimson");break;case"default":t=r.getLang("mail_conversation_style_default");break;case"disco":t=r.getLang("mail_conversation_style_disco");break;case"emerald":t=r.getLang("mail_conversation_style_emerald");break;case"frost":t=r.getLang("mail_conversation_style_frost");break;case"lagoon":t=r.getLang("mail_conversation_style_lagoon");break;case"marine":t=r.getLang("mail_conversation_style_marine");break;case"sunset":t=r.getLang("mail_conversation_style_sunset");break;case"unicorn":t=r.getLang("mail_conversation_style_unicorn");break;case"valentine":t=r.getLang("mail_conversation_style_valentine");break;case"warm_valentine":t=r.getLang("mail_conversation_style_warm_valentine");break;case"new_year":t=r.getLang("mail_conversation_style_new_year");break;case"halloween_violet":t=r.getLang("mail_conversation_style_halloween_violet");break;case"halloween_orange":t=r.getLang("mail_conversation_style_halloween_orange");break;case"easter_egg":t=r.getLang("mail_conversation_style_easter_egg");break;case"midnight":t=r.getLang("mail_conversation_style_midnight");break;case"retrowave":t=r.getLang("mail_conversation_style_retrowave");break;case"twilight":t=r.getLang("mail_conversation_style_twilight");break;case"womens_day":t=r.getLang("mail_conversation_style_womens_day");break;case"mable":t=r.getLang("mail_conversation_style_mable")}t||(0,A.logError)(new Error("Wrong conversation style"));return t}(u.source_style);I=I.replace("{style}",e)}const e=g.conversationStylesLongreadLink;I=I.replace(/{link}(.+){\/link}/i,((t,s)=>j(e,s,!0)))}return I}function j(e,t,s,a=""){return s?`<a class="im_srv_lnk ${a}" target="_blank" rel="noopener" href="${e}">${t}</a>`:`<span class="${a}">${t}</span>`}function G(e,t){const s=e.map((({id:e,icon:s})=>{const a=t===e?"MessageReactionsPanel__reaction--selected":"";return(0,i.getTemplate)("sImReactionsPanelItem",{id:e,icon:s,selected:a})}));return(0,i.getTemplate)("sImReactionsPanel",{reactions:s.join(""),classes:(0,L.partConfigEnabled)("messages_reactions_panel_on_hover")?"MessageReactionsPanel--hovered":""})}function $(e,t,s){const a=(0,n.getMessageReactions)(s,e,t),o=(0,n.getMyReaction)(s,e,t),r=a.length<=3&&a.every((e=>e.count<=3)),l=(0,L.partConfigEnabled)("messages_reactions_modal")&&!R.Ranges.isUserId(e)?(0,i.getTemplate)("sImMessageReactionsModalButton"):"";return a.map((({reaction_id:e,user_ids:t=[],count:a})=>{const n=(0,u.getReactionData)(s,e),l=[];o===e&&l.push("MessageReactions--selected"),n||l.push("_im_message_unknown_reaction");const c=r?t.map((e=>(0,b.oCacheGet)(s,e))).filter(Boolean):[],d=n?(0,i.getTemplate)("sImMessageReactionsIcon",{icon:n.icon}):(0,y.getIcon46MessageReaction404)().icon,_=c.map((e=>e?(0,i.getTemplate)("sImMessageReactionsPeer",{src:e.photo,name:e.name,peer_id:e.id}):"")).join("");return(0,i.getTemplate)("sImMessageReactions",{id:e,count:a,icon:d,peers:_,classes:l.join(" ")})})).join("")+l}},441416:(e,t,s)=>{s.d(t,{updateUnreadCounter:()=>o});var a=s(552666),n=s(849222),i=s(502478);function o(e){const t=(0,i.getGroupId)(e),s=(0,i.getUnreadCount)(e),o=t?"mgid"+t:"msg",r=(0,a.unpackStore)(e);(0,n.handlePageCount)(o,s,"","",r.unread_counters.countNotMuted>0)}},67109:(e,t,s)=>{s.d(t,{getUGCStickerSkeleton:()=>n});var a=s(727931);const n=(e=a.StickerSize.SMALL)=>`\n  <div class="im_sticker_row">\n    <div class="StickerUGC__skeleton StickerUGC_size${e}"></div>\n  </div>\n  `},727931:(e,t,s)=>{var a;s.d(t,{REGULAR_SIZES:()=>i,SIZE_512:()=>n,StickerSize:()=>a}),function(e){e[e.SMALL=128]="SMALL",e[e.MIDDLE=168]="MIDDLE",e[e.BIG=208]="BIG"}(a||(a={}));const n=512,i=[64,128,256,352,n]},377911:(e,t,s)=>{s.d(t,{getStickerSizeForMessenger:()=>i});var a=s(839470),n=s(727931);const i=()=>(0,a.partConfigEnabled)("big_stickers_in_messenger")?(()=>{switch((0,a.getTestGroup)("big_stickers_size")){case a.GROUP_C1:case a.GROUP_C2:return n.StickerSize.BIG;case a.GROUP_B1:case a.GROUP_B2:return n.StickerSize.MIDDLE}return n.StickerSize.SMALL})():n.StickerSize.SMALL},991243:(e,t,s)=>{s.d(t,{findClosestStickerSize:()=>b,getBoxLayerWrap:()=>g,getLangCode:()=>f,getPurchaseResult:()=>p,hideLoader:()=>m,showLoader:()=>u,updateStickersFromQueue:()=>h});var a=s(221780),n=s(29271),i=s(68003),o=s(795558),r=s(584356),l=s(899033),c=s(727931),d=s(457299);function _(){return document.querySelector("#box_loader")}function g(){return document.querySelector("#box_layer_wrap")}function u(){const e=_();(0,r.boxRefreshCoords)(e),(0,o.show)(e),(0,o.show)(g())}function m(){(0,o.hide)(_())}function p(e){const t=new l.ProductsByType(e.items.filter((e=>!e.error)).map((e=>e.product))),s=t.getPack(),i=t.getStyles();if(s)return i.length?(0,a.langStr)(n.getLang("purchases_stickers_purchase_result_pack_and_styles",i.length),"pack_title",s.title,"n",i.length):(0,a.langStr)(n.getLang("purchases_stickers_purchase_result_pack"),"title",s.title);if(i.length)switch(i.length){case 1:return(0,a.langStr)(n.getLang("purchases_stickers_purchase_result_1_style"),"title",i[0].title);case 2:return(0,a.langStr)(n.getLang("purchases_stickers_purchase_result_2_styles"),"title1",i[0].title,"title2",i[1].title);case 3:return(0,a.langStr)(n.getLang("purchases_stickers_purchase_result_3_styles"),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title);case 4:return(0,a.langStr)(n.getLang("purchases_stickers_purchase_result_3_styles_and_1_more"),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title);default:const e=i.length-3;return(0,a.langStr)(n.getLang("purchases_stickers_purchase_result_3_styles_and_n_more",e),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title,"n",e)}return null}function h(e){!function(e){const t=i.colorScheme.isDarkScheme()?"data-src-dark":"data-src-light";e.querySelectorAll(`.sticker_img[${t}]`).forEach((e=>{const s=e.getAttribute(t);s&&(e.src=s)}))}(e)}const f=()=>window.vk.lang||"ru",b=e=>e>c.SIZE_512?((0,d.logStickersError)("Нет размера стикера больше 512px"),c.SIZE_512):c.REGULAR_SIZES.find((t=>t>=e))},620145:(e,t,s)=>{function a(){return{icon:'<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><g id="work_outline_20__Icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="work_outline_20__Icons-20/work_outline_20"><g id="work_outline_20__work_outline_20"><path opacity=".4" d="M0 0h20v20H0z"/><path d="M10.8 2c1.11 0 1.51.12 1.92.33.4.22.73.54.95.95.2.38.31.76.33 1.71v.51h1.36c1.04 0 1.45.12 1.86.33.4.22.73.54.95.95.21.4.33.82.33 1.86v1.8c0 .89-.1 1.21-.27 1.54-.17.31-.41.57-.73.74v1.53a3.25 3.25 0 0 1-3.07 3.24l-.18.01h-8.5a3.25 3.25 0 0 1-3.24-3.07l-.01-.18v-1.53l-.13-.08c-.26-.17-.46-.4-.6-.66-.16-.3-.26-.6-.27-1.35v-2c0-1.03.12-1.44.33-1.85.22-.4.54-.73.95-.95.38-.2.76-.31 1.64-.33H6v-.3c0-1.11.12-1.51.33-1.92.22-.4.54-.73.95-.95.38-.2.76-.31 1.71-.33h1.8ZM16 13H4v1.25c0 .92.7 1.67 1.6 1.74l.15.01h8.5c.92 0 1.67-.7 1.74-1.6l.01-.15V13Zm-.47-6H4.47l-.31.01c-.36.02-.52.06-.67.15a.77.77 0 0 0-.33.33c-.1.2-.15.39-.16.98V10.82c.01.2.03.3.06.38l.03.07c.03.06.08.1.14.14l.07.03c.11.04.28.06.76.06h11.88c.48 0 .65-.02.76-.06l.07-.03c.06-.03.1-.08.14-.14l.03-.07c.04-.11.06-.28.06-.76v-1.8c0-.72-.04-.94-.16-1.15a.77.77 0 0 0-.33-.33c-.2-.1-.39-.15-.98-.16Zm-4.56-3.5H8.72c-.33.02-.5.05-.63.1l-.1.06a.77.77 0 0 0-.33.33l-.05.1c-.07.17-.1.4-.1.94l-.01.47h5v-.78a1.82 1.82 0 0 0-.1-.63l-.06-.1a.77.77 0 0 0-.33-.33l-.1-.05a2.6 2.6 0 0 0-.94-.1Z" id="work_outline_20__Icon-Color" fill="currentColor" fill-rule="nonzero"/></g></g></g></svg>',name:"work_outline_20"}}s.d(t,{getIcon20WorkOutline:()=>a})},588470:(e,t,s)=>{function a(){return{icon:'<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g id="phone_24__Page-2" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="phone_24__phone_24"><path id="phone_24__Bounds" d="M0 0h24v24H0z"/><path d="M14.61 14.76a3.64 3.64 0 0 1 4.9-.29l1.03.86a2.8 2.8 0 0 1 .26 3.96 3.32 3.32 0 0 1-2.2 1.14c-3.27.44-6.7-1.14-10.3-4.73-3.6-3.6-5.17-7.04-4.73-10.3a3.25 3.25 0 0 1 1.14-2.2 2.8 2.8 0 0 1 3.95.26l.87 1.03a3.63 3.63 0 0 1-.29 4.9l-.73.73c-.2.2-.26.5-.17.75.27.73.95 1.65 2.05 2.74a8.6 8.6 0 0 0 2.74 2.05c.26.1.55.03.75-.17l.73-.73Z" id="phone_24__2x" fill="currentColor"/></g></g></svg>',name:"phone_24"}}s.d(t,{getIcon24Phone:()=>a})},880580:(e,t,s)=>{function a(){return{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M11.18 3.9h1.64c1.1 0 1.8 0 2.35.05.52.04.73.11.84.17a2 2 0 0 1 .87.87c.06.11.13.32.17.84.05.54.05 1.26.05 2.35v7.64c0 1.1 0 1.8-.05 2.35-.04.52-.11.73-.17.84a2 2 0 0 1-.87.87c-.11.06-.32.13-.84.17-.54.05-1.26.05-2.35.05h-1.64c-1.1 0-1.8 0-2.35-.05a2.24 2.24 0 0 1-.84-.17 2 2 0 0 1-.87-.87 2.24 2.24 0 0 1-.17-.84c-.05-.54-.05-1.26-.05-2.35V8.18c0-1.1 0-1.8.05-2.35.04-.52.11-.73.17-.84a2 2 0 0 1 .87-.87c.11-.06.32-.13.84-.17.54-.05 1.26-.05 2.35-.05ZM5.1 8.18c0-2.13 0-3.2.41-4a3.8 3.8 0 0 1 1.66-1.66C8 2.1 9.05 2.1 11.18 2.1h1.64c2.13 0 3.2 0 4 .41a3.8 3.8 0 0 1 1.66 1.66c.42.82.42 1.88.42 4.01v7.64c0 2.13 0 3.2-.41 4a3.8 3.8 0 0 1-1.66 1.66c-.82.42-1.88.42-4.01.42h-1.64c-2.13 0-3.2 0-4-.41a3.8 3.8 0 0 1-1.67-1.66c-.41-.82-.41-1.88-.41-4.01V8.18Zm6.15 8.02a.9.9 0 1 0 0 1.8h1.5a.9.9 0 0 0 0-1.8h-1.5Z" clip-rule="evenodd"/></svg>',name:"smartphone_outline_24"}}s.d(t,{getIcon24SmartphoneOutline:()=>a})},978671:(e,t,s)=>{function a(){return{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M14.85 7.95A2.85 2.85 0 0 0 12 5.1a2.85 2.85 0 0 0-2.85 2.85A2.85 2.85 0 0 0 12 10.8a2.85 2.85 0 0 0 2.85-2.85Zm1.8 0A4.65 4.65 0 0 1 12 12.6a4.65 4.65 0 0 1-4.65-4.65A4.65 4.65 0 0 1 12 3.3a4.65 4.65 0 0 1 4.65 4.65ZM5.9 18.43c0 .77-.09.67.34.67h11.52c.43 0 .34.1.34-.67 0-1.9-2.78-3.03-6.1-3.03s-6.1 1.14-6.1 3.03Zm-1.8 0c0-3.33 3.67-4.83 7.9-4.83s7.9 1.5 7.9 4.83c0 1.73-.69 2.47-2.13 2.47H6.23c-1.45 0-2.13-.74-2.13-2.47Z"/></svg>',name:"user_outline_24"}}s.d(t,{getIcon24UserOutline:()=>a})},408164:(e,t,s)=>{function a(){return{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="46" height="46" fill="currentColor" viewBox="0 0 46 46"><path fill-rule="evenodd" d="M22.46 6.18c-.2.16-.37.6-.7 1.49-1.2 3.25-1.8 4.87-2.69 6.28a16.16 16.16 0 0 1-5.12 5.12c-1.4.88-3.03 1.49-6.28 2.69-.9.33-1.33.5-1.5.7a.9.9 0 0 0 0 1.08c.17.2.61.37 1.5.7 3.25 1.2 4.87 1.8 6.28 2.69a16.16 16.16 0 0 1 5.12 5.12c.88 1.4 1.48 3.03 2.69 6.28.33.89.5 1.34.7 1.5a.9.9 0 0 0 1.07 0c.22-.17.38-.61.71-1.5 1.2-3.25 1.8-4.87 2.69-6.28a16.16 16.16 0 0 1 5.12-5.12c1.4-.88 3.03-1.48 6.28-2.69.9-.33 1.33-.5 1.5-.7a.9.9 0 0 0 0-1.07c-.17-.22-.61-.38-1.5-.71-3.25-1.2-4.87-1.8-6.28-2.69a16.16 16.16 0 0 1-5.12-5.12c-.88-1.4-1.48-3.03-2.69-6.28-.33-.9-.5-1.33-.7-1.5a.9.9 0 0 0-1.07 0Zm-.87 18.94c0 .11.09.2.2.2h1.79a.2.2 0 0 0 .2-.2c0-.38.05-.7.14-.95a1.92 1.92 0 0 1 .43-.68c.2-.2.45-.38.75-.57a4.78 4.78 0 0 0 .94-.72 2.95 2.95 0 0 0 .85-2.12 2.93 2.93 0 0 0-1.9-2.81 5.08 5.08 0 0 0-2.02-.38c-.7 0-1.33.12-1.91.37a3.17 3.17 0 0 0-1.4 1.12c-.28.42-.46.94-.52 1.55a.34.34 0 0 0 .34.36h1.62c.2 0 .37-.17.42-.36a1.35 1.35 0 0 1 .73-.92c.22-.1.46-.16.7-.16.26 0 .5.05.71.16.22.1.39.26.51.46s.2.43.2.7c0 .25-.06.47-.17.68-.11.2-.26.38-.45.55a5.44 5.44 0 0 1-.64.47c-.32.2-.6.43-.82.67-.23.25-.4.57-.52.97s-.18.94-.18 1.61Zm.16 3.87c.27.27.6.4.98.4.25 0 .47-.05.68-.18.21-.12.38-.3.5-.5a1.32 1.32 0 0 0-.22-1.67 1.34 1.34 0 0 0-.96-.4c-.38 0-.71.14-.98.4-.27.27-.4.6-.4.97 0 .38.13.71.4.98Z" clip-rule="evenodd"/></svg>',name:"message_reaction_404_46"}}s.d(t,{getIcon46MessageReaction404:()=>a})},991364:(e,t,s)=>{function a(){return{icon:'<svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22.03 10c-8.48 0-14.97 5.92-14.97 12.8 0 2.47.82 4.79 2.25 6.74a1.5 1.5 0 0 1 .3.9c0 1.63-.43 3.22-.96 4.67a41.9 41.9 0 0 1-1.17 2.8c3.31-.33 5.5-1.4 6.8-2.96a1.5 1.5 0 0 1 1.69-.43 17.06 17.06 0 0 0 6.06 1.1C30.5 35.61 37 29.68 37 22.8 37 15.93 30.5 10 22.03 10zM4.06 22.8C4.06 13.9 12.3 7 22.03 7 31.75 7 40 13.88 40 22.8c0 8.93-8.25 15.81-17.97 15.81-2.17 0-4.25-.33-6.17-.95-2.26 2.14-5.55 3.18-9.6 3.34a2.2 2.2 0 0 1-2.07-3.08l.42-.95c.43-.96.86-1.9 1.22-2.9.41-1.11.69-2.18.76-3.18a14.28 14.28 0 0 1-2.53-8.08z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="M43.01 18.77a1.5 1.5 0 0 0 .38 2.09c3.44 2.38 5.55 5.98 5.55 9.95 0 2.47-.81 4.78-2.25 6.73a1.5 1.5 0 0 0-.3.9c0 1.63.43 3.22.96 4.67.35.96.77 1.92 1.17 2.8-3.31-.33-5.5-1.4-6.8-2.96a1.5 1.5 0 0 0-1.69-.43 17.06 17.06 0 0 1-6.06 1.1c-2.98 0-5.75-.76-8.08-2.03a1.5 1.5 0 0 0-1.44 2.63 20.19 20.19 0 0 0 15.7 1.44c2.25 2.14 5.54 3.18 9.59 3.34a2.2 2.2 0 0 0 2.07-3.08l-.42-.95c-.44-.96-.86-1.9-1.22-2.9a11.65 11.65 0 0 1-.76-3.18 14.28 14.28 0 0 0 2.53-8.08c0-5.1-2.72-9.56-6.84-12.42a1.5 1.5 0 0 0-2.09.38z" fill="currentColor"/></svg>',name:"messages_outline_56"}}s.d(t,{getIcon56MessagesOutline:()=>a})},793357:(e,t,s)=>{s.d(t,{ONLINE_SEEN_LAST_MONTH:()=>i,ONLINE_SEEN_LAST_WEEK:()=>n,ONLINE_SEEN_LONG_AGO:()=>o,ONLINE_SEEN_RECENTLY:()=>a});const a="recently",n="last_week",i="last_month",o="long_ago"},220661:(e,t,s)=>{s.d(t,{WIDGET_ACTIONS:()=>o,initWidgets:()=>g});var a=s(599809),n=s(29271),i=s(571039);const o="_im_widget_action",r=".SAKWidget__scrollButton--left",l=".SAKWidget__scrollButton--right";const c=(e,t)=>{switch(e.type){case"open_url":window.open((0,i.wrapAwayIfExternal)(e.url,!0));break;case"open_mini_app":case"open_game":let d=e.app_launch_params.webview_url||e.url;if(!d){var s;d=null==(s=[...t.mini_apps,...t.games].find(((t,s)=>t.id===e.app_launch_params.app_id)))?void 0:s.webview_url}d&&window.open(d);break;case"send_message":o=e.peer_id,r=e.message.text,l=e.message.payload,c=e.message.show_confirmation,(0,a.api)("messages.send",{peer_id:o,random_id:Math.round(2e9*Math.random()),payload:l,message:r}).then((()=>{c&&Notifier.showEvent({text:n.getLang("mail_send3")})}))}var o,r,l,c},d=(e,t)=>{const s=e.querySelector(r),a=e.querySelector(l),n=t.scrollLeft,i=n>0,o=n<t.scrollWidth-t.clientWidth;s.style.display=i?"":"none",a.style.display=o?"":"none"},_=e=>{if(e.widgetInitialized)return;e.widgetInitialized="1";const t=JSON.parse(e.dataset.meta);e.querySelectorAll(".SAKWidget__tappable--vkcom").forEach((e=>{const s=JSON.parse(e.dataset.action);e.onclick=e=>{e.stopPropagation(),c(s,t)}}));e.querySelectorAll(".SAKWidget__scrollBox").forEach((e=>{const t=e.querySelector(".SAKWidget__scrollBoxInner")||e;d(e,t),t.onscroll=()=>d(e,t),e.querySelector(r).onclick=e=>{e.stopPropagation(),t.scroll({left:t.scrollLeft-50,behavior:"smooth"})},e.querySelector(l).onclick=e=>{e.stopPropagation(),t.scroll({left:t.scrollLeft+50,behavior:"smooth"})}}))},g=e=>{if(!e)return;e.querySelectorAll(".SAKWidget__container").forEach(_)}},755778:(e,t,s)=>{s.d(t,{getLastSeenByStatus:()=>i});var a=s(793357),n=s(29271);function i(e,t){let s;switch(e){case a.ONLINE_SEEN_RECENTLY:s=getLang("global_online_was_recently","raw");break;case a.ONLINE_SEEN_LAST_WEEK:s=getLang("global_online_was_week","raw");break;case a.ONLINE_SEEN_LAST_MONTH:s=getLang("global_online_this_month","raw");break;case a.ONLINE_SEEN_LONG_AGO:s=getLang("global_online_long_ago","raw");break;default:return""}return(0,n.langSex)(t,s)}},875610:(e,t,s)=>{s.d(t,{ACTION_PRIORITIES:()=>re,ACTIVITY_PERIOD:()=>te,ACTIVITY_TYPE_RECORDING_AUDIO:()=>ae,ACTIVITY_TYPE_TYPING:()=>se,CONTROLLER:()=>A.CONTROLLER,acceptMessageRequest:()=>At,addAttachmentsToStoreData:()=>Xe,addCarouselTemplateToStore:()=>Ze,addDialog:()=>Me,addMessage:()=>Ne,addMessageReactionsToHistory:()=>et,addNewMember:()=>P.addNewMember,addSelection:()=>We,callbackTopBannerAction:()=>ia,cancelRecording:()=>Os,cancelSearch:()=>mt,changeCommunityAccess:()=>_a,changeDialogsTab:()=>_s,changePeer:()=>be,checkChatMember:()=>sa,checkNewPeople:()=>Bt,cleanSelected:()=>ze,cleanTab:()=>Ss,clearDate:()=>pt,createTemplate:()=>ua,deleteDialog:()=>Ts,deleteKeyboard:()=>la,deleteTemplate:()=>ga,deletedDialog:()=>Ot,deliverEditedMessage:()=>Ye,deliverMessage:()=>Ve,editMessage:()=>Oe,favMessage:()=>zt,filterFromTab:()=>H.getFilterFnForConvoListFolder,flushDialog:()=>Nt,flushHistory:()=>xt,flushSpam:()=>Xt,forwardMessages:()=>Mt,getChatDetails:()=>Js,getContactsList:()=>ss,getInviteLink:()=>Bs,getMessageLocalId:()=>Qs,getMutexQueue:()=>bs,getOwnerPhoto:()=>ts,getPeerActiveCallData:()=>Ea,getPinnedMessage:()=>zs,hidePromoTooltip:()=>aa,hideTopBannerAction:()=>na,initTextStore:()=>He,initializeChatResize:()=>Fs,isAnythingLoading:()=>rs,isEverythingLoaded:()=>ys,isSearchAllLoaded:()=>gt,isSearchingInplace:()=>ut,joinChat:()=>Hs,leaveChat:()=>$t,leaveInvitation:()=>js,loadActualLastMessage:()=>vt,loadBanner:()=>oa,loadChatInfo:()=>Ft,loadChatMember:()=>Ht,loadDialogs:()=>dt,loadHashes:()=>k.loadHashes,loadImportant:()=>bt,loadKeyboard:()=>da,loadLessHistory:()=>Le,loadLongPollKey:()=>ye,loadLongPollTs:()=>Se,loadMedia:()=>Je,loadMoreHistory:()=>Te,loadNewPeople:()=>Ut,loadSpam:()=>Zt,localIndexToDialog:()=>H.getConvoInfoFromLocalIndex,markDialogAnswered:()=>ps,markDialogRead:()=>fs,markDialogUnread:()=>hs,markInboundMessagesAsRead:()=>De,markOutboundMessagesAsRead:()=>Fe,mergeTabs:()=>F.mergeTabs,peerProfileManageTags:()=>Ca,peerProfileSaveNote:()=>Ta,peerProfileToggleTag:()=>va,pinMessage:()=>Ys,pinMessageOptimistic:()=>Ks,preloadSearchIndex:()=>ct,prepareCasperMessagesFromMessages:()=>ba,prepareForward:()=>wt,presetAvatar:()=>as,processFwd:()=>Be,readTillSpecificMessage:()=>Ie,rejectMessageRequest:()=>Rt,releaseBlock:()=>vs,reloadMessage:()=>La,removeChatPhoto:()=>Xs,removeExpiredFailed:()=>_e,removeFailed:()=>de,removeFromRecentSearch:()=>qs,removeMessageSend:()=>Lt,removeMessages:()=>Tt,removeMessagesMarkDeleted:()=>Ct,removeMessagesWithRestore:()=>Et,removePeerActiveCallData:()=>Ia,replaceMessage:()=>Qe,resendMessage:()=>Re,resetInviteLink:()=>Us,resetRecentSearch:()=>$s,resetTabAll:()=>pa,restoreDialog:()=>Ls,restoreMessage:()=>It,restoreMessageSend:()=>yt,resync:()=>ns,returnToChat:()=>qt,saveHistoryScroll:()=>ds,saveRecentSearchPeer:()=>Gs,searchHints:()=>O.searchHints,searchHintsIndex:()=>nt,searchImTopConv:()=>rt,searchLocalHints:()=>lt,searchMessages:()=>_t,searchMessagesInplace:()=>ft,searchTopConv:()=>ot,selectPeer:()=>pe,selectPeerOnMessage:()=>fe,sendMessage:()=>Ke,sendRecordingAudio:()=>Pt,sendTyping:()=>kt,setActions:()=>F.setActions,setActivity:()=>je,setCallAvailability:()=>ce,setCreationType:()=>es,setCurrentSearch:()=>at,setCurrentSearchDate:()=>tt,setDelayedMessage:()=>os,setExecStack:()=>Wt,setInplaceSearch:()=>st,setKeyboard:()=>ra,setMessageErrored:()=>Ae,setMutedPeer:()=>Yt,setVoiceMessageAvail:()=>Ns,shouldIncludeDialog:()=>gs,spamDialog:()=>Es,strHistory:()=>le,stringifyTab:()=>As,syncHistory:()=>ws,syncMessageReactStatus:()=>ue,syncMessagesEditableStatus:()=>ge,toggleAdmin:()=>ta,toggleAdminOptimisticly:()=>ea,toggleCommunityMessages:()=>Ms,toggleCommunityMute:()=>Cs,toggleConversation:()=>xs,toggleDialogImportant:()=>ms,toggleKeyboard:()=>ca,toggleMuteMentionsPeer:()=>Vt,toggleMutePeer:()=>Kt,toggleSendingAbility:()=>is,unpinMessage:()=>Ws,unpinMessageOptimistic:()=>Vs,updateActivity:()=>Ge,updateBlockStates:()=>x.updateBlockStates,updateCasperMessageExpiringStatus:()=>fa,updateChatPhoto:()=>jt,updateChatTopic:()=>Dt,updateFavAndTitle:()=>cs,updateFavMessage:()=>Qt,updateFlags:()=>Zs,updateFolderState:()=>us,updateGoToEndVisibility:()=>Rs,updateGoToMentionVisibility:()=>ks,updateGoToReactionAvailability:()=>Ps,updateImportant:()=>Jt,updateMentions:()=>Ce,updateMessageRequestsCounter:()=>ha,updateOnline:()=>Ue,updatePeerProfileTags:()=>Ra,updatePeerTags:()=>Sa,updatePeerTagsFilter:()=>ya,updatePeerTagsFilterFolder:()=>Aa,updateSearchQuery:()=>Ds,updateTabbedPeers:()=>Is,updateTemplate:()=>ma,updateVideoThumb:()=>we,waitActivity:()=>$e});var a=s(434788),n=s(302925),i=s(241857),o=s(29271),r=s(664988),l=s(82161),c=s(196635),d=s(835200),_=s(731062),g=s(755320),u=s(705758),m=s(227575),p=s(527405),h=s(165203),f=s(375353),b=s(222009),v=s(894523),C=s(590646),T=s(568012),L=s(783400),E=s(804381),I=s(795558),y=s(552666),S=s(872306),A=s(728785),R=s(836873),k=s(184667),P=s(149822),M=s(95638),w=s(610812),O=s(540537),N=s(408014),x=s(300069),D=s(523305),F=s(998898),H=s(832468),B=s(207930),U=s(672132),j=s(502478),G=s(441416),$=s(862736),q=s(123378),K=s(656448),V=s(839470),Y=s(321342),W=s(874223),z=s(602849),Q=s(489141),J=s(931917),Z=s(638871),X=s(597765),ee=s(457299);const te=5,se="typing",ae="audiomessage",{scheduleNav:ne,commitNav:ie,scheduleNavWithTimeOut:oe}=(0,c.updateLazyLocation)(),re={[A.ConvoAction.SEARCH]:0,[A.ConvoAction.MEDIA]:1,[A.ConvoAction.CHAT_INVITE]:2,[A.ConvoAction.USER_INVITE]:2,[A.ConvoAction.CREATE_CHAT]:2,[A.ConvoAction.ADD_FRIEND]:3,[A.ConvoAction.SETTINGS]:3,[A.ConvoAction.PIN_HIDE]:10,[A.ConvoAction.PIN_UNHIDE]:10,[A.ConvoAction.UNPIN]:11,[A.ConvoAction.UNREAD]:20,[A.ConvoAction.MUTE]:21,[A.ConvoAction.UNMUTE]:21,[A.ConvoAction.PIN_CONVO]:22,[A.ConvoAction.UNPIN_CONVO]:22,[A.ConvoAction.ARCHIVE]:30,[A.ConvoAction.UNARCHIVE]:30,[A.ConvoAction.CLEAR]:31,[A.ConvoAction.CALL_FINISH]:31,[A.ConvoAction.ENABLE_BUSINESS_NOTIFY]:32,[A.ConvoAction.DISABLE_BUSINESS_NOTIFY]:32,[A.ConvoAction.BLOCK]:32,[A.ConvoAction.BLOCK_COMMUNITY]:33,[A.ConvoAction.ALLOW_COMMUNITY]:33,[A.ConvoAction.BLOCK_NOTIFY]:34,[A.ConvoAction.LEAVE]:35,[A.ConvoAction.RETURN]:35};function le(e){return"string"==typeof e?e:e.innerHTML}function ce(e,t){return t.tabs[e].can_start_call=(0,T.canStartGroupCall)(t,e),Promise.resolve(t)}function de(e,t,s,a,n){const i=n.imQueue(s),o=[],r=[];i.forEach((e=>{e.failed&&a&&e.mess.messageId!==a&&r.push(e),!e.failed||a&&e.mess.messageId!==a||o.push("rid"+e.rid)})),n.imQueueSet(s,r);const l=(0,b.getTab)(n,s);if(!l)return Promise.resolve(n);const c=r.length?r[r.length-1].mess:(0,b.getLastMessage)(e,s,o[0]);return l.lastmsg=c&&c.messageId,l.lastmsg_meta=c,o.forEach((e=>delete l.msgs[e])),l.history=(0,p.removeMessages)(o,(0,Y.unpackHistory)(l.history)),(0,p.removeMessages)(o,t),Promise.resolve(n)}function _e(e,t,s){const a=864e5,n=s.imQueue(t),i=[],o=[],r=Date.now();return n.forEach((e=>{e.failed&&r-e.ts<a&&o.push(e),e.failed&&r-e.ts>=a&&i.push("rid"+e.rid)})),s.imQueueSet(t,o),s.tabs[t].history=(0,p.removeMessages)(i,(0,Y.unpackHistory)(s.tabs[t].history)),(0,p.removeMessages)(i,e),Promise.resolve(s)}function ge(e,t){const s=(0,b.getTab)(e,t);if(!s)return Promise.resolve(e);const a=(0,Y.unpackHistory)(s.history),n=Object.values(s.msgs);for(let s=n.length-1;s>=0;s-=1){const i=(0,b.parserMessage)(n[s]);if((0,Q.isOutOfMessageEditingTime)(e,i.date))break;const o=a.querySelector(`._im_mess_${i.messageId}`);o&&(0,p.updateMessageEditableStatus)(e,t,a,o)}return Promise.resolve(e)}function ue(e,t){const s=(0,b.getTab)(e,t);if(!(0,p.isFullyLoadedTab)(e,t))return Promise.resolve(e);const a=(0,Y.unpackHistory)(s.history),n=Object.values(s.msgs);for(let s=n.length-1;s>=0;s-=1){const i=(0,b.parserMessage)(n[s]),o=a.querySelector(`._im_mess_${i.messageId}`);o&&(0,p.updateMessageReactStatus)(e,t,a,o)}return Promise.resolve(e)}function me(e,t){return!1===(t.block_states[e]||{}).free?Promise.resolve(t):(0,n.post)(A.CONTROLLER,{act:"a_block",peer:e,prevPeer:t.prevPeer,gid:t.gid}).then((([e])=>(0,x.updateBlockStates)(e,t)))}function pe(e,t){let s=t.peer;return Promise.resolve(t).then((t=>(t.tabHistoryNotChanged=!1,(0,p.isFullyLoadedTab)(t,s)&&!t.tabs[s].msgid?(t.gid&&me(s,t),Promise.resolve(t).then(F.setActions)):((0,p.isFullyLoadedTab)(t,s)&&(t.tabs[s].msgid=!1),(0,O.loadPeer)(t,s,0,e,!0,"selectPeer"))))).then(F.setActions).then(he.bind(null,s))}function he(e,t,s=!1){return(0,p.isTabLoaded)(t,e)&&(t.tabs[e].last_touched=Date.now()),(0,p.isTabLoaded)(t,e)&&s&&(t.tabs[e].last_visited=Date.now()),t}function fe(e,t,s){let a=s.msgid,n=s.peer;return!e&&(0,p.isFullyLoadedTab)(s,n)&&s.tabs[n].msgs[a]?(t===s.peer?s.tabHistoryNotChanged=!0:s.tabHistoryNotChanged=!1,s.gid&&me(n,s),Promise.resolve(s).then(F.setActions).then(he.bind(null,n))):(0,O.loadPeer)(s,n,a,!0,!0,"selectOnMessage").then(F.setActions).then((()=>((0,b.getTab)(s,n).msgid=a,s))).then(he.bind(null,n))}function be(e,t,s,a){var n;if(rs(a))throw(0,p.showWaitUntilUploadedBox)(),new Error("Cant change peer while loading something");let i=a.gid?"gim"+a.gid:"im";if(a.prevPeer=a.peer,a.peer=e,a.msgid=t||"",a.currentEntryPoint=s,cur.peer=e,null==(n=window.StickerPickerViewer)||n.initPeerId(),ne({sel:e?(0,p.convertPeerToUrl)(e):null,msgid:a.msgid,email:"",0:i}),0!==a.prevPeer&&he(a.prevPeer,a,!0),0!==e){let t=[];(0,p.isTabLoaded)(a,e)&&he(e,a,!0),t=a.tabbedPeers.map((e=>e.peer)).indexOf(e)<0?[{peer:e,type:"perm"}].concat(a.tabbedPeers):a.tabbedPeers.map((t=>(t.peer===e&&"perm"!==t.type&&(t.type="perm"),t))),Is(t,!1,a);const s=(0,b.getTab)(a,e);s&&(0,N.tabIsMessageRequest)(s)&&(0,K.collectOpenMessageRequestStats)(e)}else Is(a.tabbedPeers,!1,a);return ie(),(0,$.updateCounters)(location.href,document.referrer),mt(a.prevPeer,a)}const ve=(0,R.wrapHashAction)((function(e,t){const s=t.tabs[e];return s.membersLoaded?Promise.resolve(t):(0,n.post)(A.CONTROLLER,{act:"a_get_chat_members",chat:e,gid:t.gid,hash:s.hash}).then((([[e,a,n]])=>(s.memberIds=e,s.adminIds=a,n.forEach((e=>(0,C.oCacheAdd)(t,e))),s.membersLoaded=!0,t)))}));function Ce(e){const t=e.isMassMentionsMessageAllowed;cur.wallMentions=()=>new Promise(((s,a)=>{if(cur.wallMentions=[],!J.Ranges.isChatOrChannelPeer(e.peer)||!(0,p.isFullyLoadedTab)(e,e.peer)||(0,p.isFvkcomgroup)(e,e.peer))return a();let n=e.tabs[e.peer];function i(){let a=[];Object.keys(n.msgs||{}).reverse().forEach((e=>{let t=(0,b.parserMessage)(n.msgs[e]),s=t&&t.userId;s&&s!=vk.id&&-1===a.indexOf(s)&&(0,p.isUserAliveInChat)(n,s)&&a.push(s)})),(n.memberIds||[]).forEach((e=>{-1===a.indexOf(e)&&a.push(e)}));let i=[];a.forEach((t=>{if((0,C.oCacheExists)(e,t)){let s=(0,C.oCacheGet)(e,t),a=s.link.substring(1);i.push([s.id,s.name,"@"+a,s.photo,void 0,void 0,void 0,a,s.first_name,"",s.note])}}));const r=o.getLang("mail_im_mention_all"),l=o.getLang("mail_im_mention_online");t&&(0,T.canMassMention)(e)&&i&&i.length>1&&(f.MASS_MENTION_ALIASES.online.forEach((e=>i.push(["online",l,"@"+e,"/images/mention_online.svg",void 0,void 0,void 0,e,e,""]))),f.MASS_MENTION_ALIASES.all.forEach((e=>i.push(["all",r,"@"+e,"/images/mention_all.svg",void 0,void 0,void 0,e,e,""])))),s(i)}n.membersLoaded?i():ve(e.peer,e).then(i)}))}function Te(e,t,s){let a=s.tabs[s.peer];return(0,n.post)(A.CONTROLLER,{peer:s.peer,whole:e,act:"a_history",offset:a.offset+(a.skipped||0),toend:t,gid:s.gid}).then((([e,t,n,i])=>(a.allShown=n,s.admins=(0,l.extend)(s.admins,i),a.history=e+le(a.history),a.historyToAppend=e,a.offset+=Object.keys(t).length,a.msgs=(0,l.extend)(a.msgs,t),s)))}function Le(e){let t=e.tabs[e.peer];return(0,n.post)(A.CONTROLLER,{peer:e.peer,act:"a_history",rev:1,offset:t.skipped,gid:e.gid}).then((([s,a,n,i,o])=>{t.allShown=t.allShown||n,t.history=le(t.history)+s,t.historyToAppend=s;const r=Object.keys(a).length;return t.skipped-=r,t.offset+=r,t.msgs=(0,l.extend)(t.msgs,a),e}))}function Ee(e,t,s,a,n){let i=e.tabs[t];if((0,V.partConfigEnabled)("me_web_read_by_cmid")){if(n===d.FLAG_OUTBOUND&&i.out_up_to_cmid>a)return e;n===d.FLAG_OUTBOUND?i.out_up_to_cmid=a:i.in_up_to_cmid=a}else{if(n===d.FLAG_OUTBOUND&&i.out_up_to>s)return e;n===d.FLAG_OUTBOUND?i.out_up_to=s:i.in_up_to=s}return e}const Ie=(0,R.wrapHashAction)((function(e,t,s){const i=s.tabs[t];if(!(0,V.partConfigEnabled)("simplified_start_conversation")&&(0,N.tabIsMessageRequest)(i)||(0,p.tabIsOutgoingMessageRequest)(i))return Promise.resolve(s);const o=(0,b.getMessage)(s,t,e);if(!(0,v.isUnread)(i,o))return Promise.resolve(s);let r={};return(0,V.partConfigEnabled)("me_web_read_by_cmid")?(s.longpoll.push([d.readInboundByCmidEvent([10006,t,o.chat_local_id,null])]),r.start_cmid=o.chat_local_id):(s.longpoll.push([d.readInboundEvent([6,t,o.messageId,null])]),r.ids=[o.messageId]),(0,n.post)(A.CONTROLLER,(0,a._)({peer:t,hash:i.hash,act:"a_mark_read",gid:s.gid},r)).then((()=>Ee(s,t,e,o.chat_local_id,d.FLAG_OUTBOUND)))}));function ye(e){return(0,n.post)(A.CONTROLLER,{act:"a_get_key",uid:e.id,gid:e.gid}).then((([t,s,a])=>(0,l.extend)({},e,{imKey:t,imUrl:s,imPart:a})))}function Se(e){return(0,n.post)(A.CONTROLLER,{act:"a_get_ts",gid:e.gid}).then((([t])=>(0,l.extend)({},e,{imTs:t})))}function Ae(e,t,s){let a=s.tabs[e];return a.msgs[t.messageId]&&(a.msgs[t.messageId].errored=1,a.history=(0,p.setMessageError)(e,t,(0,Y.unpackHistory)(a.history))),Promise.resolve(s)}function Re(e,t,s,a){let n=a.tabs[e];return n.msgs[t]&&(n.msgs[t].errored=0,n.lastmsg_meta=s,n.lastmsg=t,n.history=(0,p.startResendMessage)(e,t,(0,Y.unpackHistory)(n.history))),Promise.resolve(a)}function ke(e,t){return 0===e.length?Promise.resolve(t):(0,n.post)(A.CONTROLLER,{act:"a_get_admin",admins:e.join(","),gid:t.gid}).then((([e])=>(t.admins=(0,l.extend)(t.admins,e),t)))}function Pe(e,t){if(!(0,l.inArray)(e,t.tabbedPeers.map((e=>e.peer)))&&(0!==t.peer||t.searchText)&&!(0,l.inArray)(e,t.mutedPeers)){const s={peer:e,type:"temp"};Is(t.tabbedPeers.concat([s]),!1,t)}}function Me(e,t,s){return(0,N.isBusinessNotifyPeer)(s,e)?t:(0,p.isReversedDialogs)(s)?t.concat([e]):[e].concat(t)}function we(e,t){const s=e.get().peer,a=(0,b.getTab)(e,s);if((0,p.isFullyLoadedTab)(e,s)){const s=(0,Y.unpackHistory)(a.history);a.history=(0,p.updateMessageInCache)(e,s,t)}}function Oe(e,t){const s=e.peerId;if((0,p.isTabLoaded)(t,s)){var a;const n=t.tabs[s];if((0,p.isFullyLoadedTab)(t,s)&&(null==(a=n.msgs)?void 0:a[e.messageId])){const s=(0,Y.unpackHistory)(n.history);n.msgs[e.messageId]=(0,l.extend)(!0,{},e),n.history=(0,p.editAndReplaceMessage)(t,e,s)}n.lastmsg===e.messageId&&(n.lastmsg_meta=e);const i=n.pinned&&(0,b.parserMessage)(n.pinned);i&&i.messageId===e.messageId&&(n.pinned=e);if(!(0,v.isOut)(e)&&(0,v.isUnread)(n,e)){const a=(0,w.hasUserMentions)(e,t.id),i=(0,V.partConfigEnabled)("me_web_read_by_cmid")?n.mention_cmids&&n.mention_cmids.includes(e.chat_local_id):n.mentions&&n.mentions.includes(e.messageId);a&&!i?(0,V.partConfigEnabled)("me_web_read_by_cmid")?(n.mention_cmids||(n.mention_cmids=[]),n.mention_cmids.push(e.chat_local_id)):(n.mentions||(n.mentions=[]),n.mentions.push(e.messageId)):!a&&i&&((0,V.partConfigEnabled)("me_web_read_by_cmid")?(0,F.setFilteredMentionsData)(s,(t=>t!==e.chat_local_id),t):(0,F.setFilteredMentionsData)(s,(t=>t!==e.messageId),t))}return Promise.resolve(t)}return(0,O.loadPeer)(t,s,0,!1,!1,"editMessage").then((t=>{const a=t.tabs[s];return(0,F.updateListedConvos)(t,a,!1,(e=>Me(s,e,t)),((e,s,a)=>gs(t,e,s,a))),he(e.peerId,t),t}))}function Ne(e,t){const s=e.flags&d.FLAG_OUTBOUND,n=e.peerId,i=(0,a._)({},e);if(delete i.minorSortId,(0,p.isTabLoaded)(t,n)){let a=t.tabs[n];if("number"==typeof e.messageId&&a.lastmsg>e.messageId)return Promise.resolve(t);a.deletedDialog=!1,e.local&&(0,N.isChatConvo)(a)&&(a.data.closed=0),e.local&&(t.msg_local_ids_sort=t.msg_local_ids_sort||{lastSortId:0},t.msg_local_ids_sort[e.messageId]=++t.msg_local_ids_sort.lastSortId);const o=(0,V.partConfigEnabled)("simplified_start_conversation")?!(0,N.tabIsNotImportantMessageRequest)(a):!(0,N.tabIsMessageRequest)(a);if(!s&&o){((0,V.partConfigEnabled)("me_web_read_by_cmid")?e.chat_local_id>a.in_up_to_cmid:e.messageId>a.in_up_to)&&(a.lastmsg===e.messageId&&a.unread?xe(t,1,e.peerId):(!a.unread&&xe(t,1,e.peerId),a.unread++)),S.casperMessagesStore.has(e.chat_local_id)&&!(0,b.isCasperChatTab)(a)&&((0,V.partConfigEnabled)("me_web_read_by_cmid")?(a.expiring_cmids||(a.expiring_cmids=[]),a.expiring_cmids.push(e.chat_local_id)):(a.expiring_messages||(a.expiring_messages=[]),a.expiring_messages.push(e.messageId))),(0,w.hasUserMentions)(e,t.id)&&((0,V.partConfigEnabled)("me_web_read_by_cmid")?(a.mention_cmids||(a.mention_cmids=[]),a.mention_cmids.push(e.chat_local_id)):(a.mentions||(a.mentions=[]),a.mentions.push(e.messageId))),Pe(e.peerId,t)}else a.unread=0;if((0,p.isFullyLoadedTab)(t,n)){const s=(0,v.isMessageToBlockedCommunity)(a,e),n=s||0===a.offset;s&&(a.blocked_community=0),a.skipped>0&&a.skipped++,a.offset++,a.msgs[e.messageId]=i;const o=(0,Y.unpackHistory)(a.history);a.history=(0,Y.appendMessageToHistory)(t,e,o,!0,!0),n&&(0,F.setActions)(t)}if(a.typing){let t=a.typing.userIds.indexOf(e.userId);t>=0&&a.typing.userIds.splice(t,1)}return a.lastmsg=e.messageId,a.lastmsg_meta=i,a.minor_sort_id=e.minorSortId,he(e.peerId,t),(0,F.updateListedConvos)(t,a,!1,(e=>Me(n,e,t)),((e,s,a)=>gs(t,e,s,a))),Promise.resolve(t)}return e.flags&d.FLAG_STEALTH?Promise.resolve(t):(0,O.loadPeer)(t,n,0,!1,!1,"addMessage").then((t=>{const a=t.tabs[n];return(0,F.updateListedConvos)(t,a,!1,(e=>Me(n,e,t)),((e,s,a)=>gs(t,e,s,a))),he(e.peerId,t),s||Pe(e.peerId,t),t}))}function xe(e,t,s){e.cur_unread_cnt||(e.cur_unread_cnt={}),-1===t&&delete e.cur_unread_cnt[s],(0,x.addToUnreadCounter)(t,s,e).then(G.updateUnreadCounter)}function De(e,t){const s=(0,b.getTab)(t,e.peerId);if((0,p.isFullyLoadedTab)(t,e.peerId)){let a=s.unread;if(t=Ee(t,e.peerId,e.upToId,e.upToCmid,0),null!==e.unread?s.unread=e.unread:s.unread=(0,b.countUnread)(e.peerId,t)+(s.unread>0?+s.skipped:0),a>0&&!s.unread&&xe(t,-1,e.peerId),!s.skipped){const a=(0,Y.unpackHistory)(s.history);s.history=(0,Y.removeNewUnreadBarAndMerge)(t,a,e.peerId)}}else(0,p.isTabLoaded)(t,e.peerId)&&(t.tabs[e.peerId].unread>0&&0===e.unread&&xe(t,-1,e.peerId),t.tabs[e.peerId].unread=e.unread||0,(0,V.partConfigEnabled)("me_web_read_by_cmid")?t.tabs[e.peerId].in_up_to_cmid=e.upToCmid:t.tabs[e.peerId].in_up_to=e.upToId);return(0,p.isTabLoaded)(t,e.peerId)&&0===s.unread&&(t.dialog_tabs[h.FOLDER_UNREAD]=t.dialog_tabs[h.FOLDER_UNREAD].filter((t=>(0,l.intval)(t)!==e.peerId))),(0,p.isTabLoaded)(t,e.peerId)&&((0,V.partConfigEnabled)("me_web_read_by_cmid")?((0,F.setFilteredExpiringMessagesData)(e.peerId,(t=>t>e.upToCmid),t),(0,F.setFilteredMentionsData)(e.peerId,(t=>t>e.upToCmid),t)):((0,F.setFilteredExpiringMessagesData)(e.peerId,(t=>t>e.upToId),t),(0,F.setFilteredMentionsData)(e.peerId,(t=>t>e.upToId),t))),0!==(0,j.getUnreadCountWithMuted)(t)||t.active_tab!==h.FOLDER_UNREAD||t.gid?Promise.resolve(t):_s(h.FOLDER_ALL,t)}function Fe(e,t){let s=t.tabs[e.peerId];if((0,p.isTabLoaded)(t,e.peerId)&&Ee(t,e.peerId,e.upToId,e.upToCmid,d.FLAG_OUTBOUND),(0,p.isFullyLoadedTab)(t,e.peerId)){let a=(0,Y.unpackHistory)(s.history);s.history=(0,p.markMessagesAsRead)(t,e.peerId,a)}return Promise.resolve(t)}function He(e,t,s,a,n){return n.text={},n.imQueue=e,n.imQueueResend=t,n.imQueueSet=s,n.imQueueComplete=a,Promise.resolve(n)}function Be(e,t,s){function a(e,t){return{id:e.messageId,text:e.text,date:e.date,kludges:e.kludges,authorName:t}}if(1===e.length){const n=e[0],i=(0,b.getMessage)(s,t,n),o=(0,b.getAuthorFullName)(s,t,n);return!1===o?s.set(Ht.bind(null,{[t]:[i.userId]})).then((s=>{const o=(0,b.getAuthorFullName)(s,t,n);return{msgIds:e,object:a(i,o)}})):Promise.resolve({msgIds:e,object:a(i,o)})}return Promise.resolve({msgIds:e})}function Ue(e,t,s,a){let n=(0,b.getTab)(a,e);if(n&&n.last_seen&&n.last_seen.can_see){let e=!1!==t?mobPlatforms[t]?1:0:n.last_seen.mobile;n.online=t,n.last_seen={platform:t,time:s||n.last_seen.time,mobile:e,can_see:n.last_seen.can_see}}const{is_online:i,is_mobile:o}=(0,p.convertLegacyOnlineToAPIFlags)(t);return(0,F.updateRecommendedListItemOnline)(a,e,i,o)}function je(e,t,s){const a=(0,b.getTab)(s,e.peerId);return a&&(e.ts=Date.now()/1e3,a.activity||(a.activity={}),a.activity[t]=e,a.typing===se&&(a.typing=e)),Promise.resolve(s)}function Ge(e,t){const s=(0,b.getTab)(t,e.peerId),a=(0,v.isAudioMsg)(e)?"audiomessage":"typing";return s&&s.activity&&s.activity[a]&&(s.activity[a].userIds=s.activity[a].userIds.filter((t=>t!==e.userId))),Promise.resolve(t)}function $e({peerId:e},t,s){return(0,_.pause)(te+2).then((()=>{if((0,p.isTabLoaded)(s,e)){let a=s.tabs[e];if((a.activity||{})[t]){Date.now()-1e3*a.activity[t].ts>=1e3*te&&(delete a.activity[t],0===Object.keys(a.activity).length&&delete a.activity)}if(a.typing){Date.now()-1e3*a.typing.ts>=1e3*te&&(a.typing=void 0)}}return s}))}function qe(e){const t={},s=e.find((e=>"poll"===e[0]));if(s){let[,,e]=s;Object.assign(t,e)}return t}const Ke=function(e,t,s,a){let i=Date.now()+(0,r.rand)(0,100).toFixed(0);const o=a.ref_id,l=a.ref_source;a.ref_source=void 0,a.ref_id=void 0,(l||o)&&(ne({ref_source:null,ref:null}),ie()),(0,E.statlogsSendingQueueLength)(a);const c="send",d=t.attaches.length>0,_=(0,E.statlogsSendingTime)(a,c,"server",d),u=Object.assign({act:"a_send",to:e,hash:s.hash,ref_source:l,ref:o,msg:t.message,payload:t.payload,media:(0,g.convertAttachesToPhpMedia)(t.attaches),guid:i,share_url:t.share_url,cancelled_shares:t.cancelled_shares,random_id:t.rid,gid:s.hidegid?void 0:a.gid,entrypoint:a.currentEntryPoint||"",sticker_referrer:t.sticker_referrer,module:cur.module},s.external,qe(t.attaches));return(0,V.partConfigEnabled)("im_chasiky_debug")&&window.meBufferLog[t.rid].push("sending message",u),(0,n.post)(A.CONTROLLER,u,2e4).then((([e])=>((0,V.partConfigEnabled)("im_chasiky_debug")&&window.meBufferLog[t.rid]&&window.meBufferLog[t.rid].push("message sent",e),_(),a.version!==e.version&&nav.reload({force:!0}),a))).catch((e=>{throw(0,V.partConfigEnabled)("im_chasiky_debug")&&window.meBufferLog[t.rid]&&window.meBufferLog[t.rid].push("sending failed",e),(0,E.statlogsSendingError)(a,e,c,"server_send"),e}))},Ve=(0,R.wrapHashAction)((function(e,t,s={},n){let i=n.tabs[e];return Ke(e,t,(0,a._)({hash:i.hash},s),n)})),Ye=(0,R.wrapHashAction)((function(e,t,s){const a="edit",i=t.attaches.length>0,o=(0,E.statlogsSendingTime)(s,a,"server",i);return(0,n.post)(A.CONTROLLER,Object.assign({act:"a_edit_message",module:cur.module,hash:e.hash,id:t.messageId,peerId:e.peerId,gid:s.gid,msg:t.origText,media:(0,g.convertAttachesToPhpMedia)(t.attaches),share_url:t.share_url,cancelled_shares:t.cancelled_shares},qe(t.attaches)),2e4).then((([e])=>(o(),s))).catch((e=>{throw(0,E.statlogsSendingError)(s,e,a,"server_send"),e}))}));function We(e,t){if(t.selectedMessages||(t.selectedMessages=[]),1===e.length&&(0,l.inArray)(e[0],t.selectedMessages))t.selectedMessages=t.selectedMessages.filter((t=>t!==e[0]));else{let s=t.selectedMessages.concat(e);t.selectedMessages=(0,u.arrayUnique)(s).sort(((e,t)=>e-t))}return Promise.resolve(t)}function ze(e){return e.selectedMessages=[],Promise.resolve(e)}function Qe(e,t){if((0,V.partConfigEnabled)("im_chasiky_debug")&&delete window.meBufferLog[e.randomId],(0,p.isFullyLoadedTab)(t,e.peerId)){const s=t.tabs[e.peerId],n=(0,a._)({},e);delete n.minorSortId;let i=t.imQueue(e.peerId).filter((t=>t.failed&&t.rid!==e.randomId));t.imQueueSet(e.peerId,i),t.imQueueComplete(e.peerId,e.randomId),s.lastmsg_meta=n,s.lastmsg=e.messageId,s.minor_sort_id=e.minorSortId,s.msgs["rid"+e.randomId]&&(s.msgs[e.messageId]=n,delete s.msgs["rid"+e.randomId]),t.msg_local_ids_sort&&delete t.msg_local_ids_sort["rid"+e.randomId],s.history=(0,p.replaceMessageAttrs)(t,(0,Y.unpackHistory)(s.history),n)}else console.error(new Error(`Tab ${e.peerId} not loaded on local message replace`));return Promise.resolve(t)}function Je(e,t){const s="unknown",a=(0,E.statlogsSendingTime)(t,s,"attach"),i={act:"a_get_media",id:e.messageId,gid:t.gid};return(0,_.retryFn)(n.post,3,(e=>e*e))(A.CONTROLLER,i).then((s=>(a(),Xe(e,s,t)))).catch((a=>((0,E.statlogsSendingError)(t,a,s,"server_load_attach"),Xe(e,null,t))))}function Ze(e,t){return(0,q.getFullMessage)(e.peerId,e.chat_local_id).then((s=>{const a=t.tabs[e.peerId],n=s.items[0].template;return n&&a.msgs&&(a.msgs[e.messageId].kludges.template=n),Promise.resolve(t)})).then((t=>function(e,t){let s=t.tabs[e.peerId];s.history&&(s.history=(0,p.replaceCarousel)((0,Y.unpackHistory)(s.history),e,t));return Promise.resolve(t)}(e,t)))}function Xe(e,t,s){let a=s.tabs[e.peerId];const n=t&&t[2];return a.mediacontent||(a.mediacontent={}),a.mediacontent[e.messageId]=t||[(0,l.getTemplate)("im_retry_link")],n&&(n.no_forward&&(a.msgs[e.messageId].kludges.no_forward=!0),n.no_pin&&(a.msgs[e.messageId].kludges.no_pin=!0)),function(e,t){let s=t.tabs[e.peerId];return s.history=(0,p.replaceAttaches)((0,Y.unpackHistory)(s.history),e,t),Promise.resolve(t)}(e,s)}function et(e,t,s){var a,n;const i=(0,y.unpackStore)(s);let o=null==(a=i.tabs)?void 0:a[e];return(null==(n=o)?void 0:n.history)&&(o.history=(0,p.replaceMessageReactions)((0,Y.unpackHistory)(o.history),e,t,i)),Promise.resolve(i)}function tt(e,t,s){let a=(0,p.dayFromVal)(t),n=s.tabs[e];return n.searchDay=a,n.searchOffset=0,n.searchAllLoaded=!1,n.searchMsgs=[],Promise.resolve(s)}function st(e,t,s){return s.tabs[t].searchText=e,ht(t,s),s}function at(e,t,s){if(t){let a=s.tabs[t];a.searchText=e,a.searchOffset=0,a.searchAllLoaded=!1}else s.searchText=e,s.searchOffset=0,s.searchAllLoaded=!1;return Promise.resolve(s)}function nt(e,t,s,a){return(0,O.searchHints)(e,t,s,{},a).then((e=>e.map((e=>({peerId:e.peerId,name:e.tab,photo:e.photo,online:e.online,is_friend:"friends"===s})))))}function it(e){return(t,s)=>e(s).then((e=>{let a=(t?e.search(t):e.list).map(H.getConvoInfoFromLocalIndex);return s.mapped_index||(s.mapped_index={}),a.forEach((e=>{s.mapped_index[e.peerId]=e})),a}))}let ot=it((e=>e.topConvTree)),rt=it((e=>e.imTopConvTree)),lt=it((e=>e.hintsTree));function ct(e,t){let s,a,i;t.topConvTree=new Promise((e=>{s=e})),t.hintsTree=new Promise((e=>{a=e})),t.imTopConvTree=new Promise((e=>{i=e}));const o=e?e.select(m.RECENT_SEARCH_OP):[];return(0,_.retryFn)(n.post,1,(()=>4))(A.CONTROLLER,{act:"a_dialogs_preload",rs:o.join(","),gid:t.gid}).catch((e=>[[],[],[]])).then((([e,n,o,r])=>(t.popular_sugg=o,new U.vkIndexer(e,(e=>e[1]),s),new U.vkIndexer(n,(e=>e[1]),a),r&&r.length>0?new U.vkIndexer(r,(e=>e[1]),i):i(),t)))}function dt(e){const t=e.active_tab,s=e.dialog_tabs[t];let a,i;return s.length>0?s.forEach((t=>{const s=e.tabs[t],n=s.minor_sort_id,o=s.major_sort_id;(n||o)&&(void 0===a||a>o?(a=o,i=n):a===o&&i>n&&(i=n))})):(a=0,i=0),(0,n.post)(A.CONTROLLER,{act:"a_get_dialogs",start_message_id:i,major_sort_id:a,tab:t,gid:e.gid,tags:t===h.FOLDER_PEER_TAGS&&e.peer_tags_filter?e.peer_tags_filter.mask:null}).then((([a,n,i,o])=>(i.forEach((t=>(0,C.oCacheAdd)(e,t))),(0,x.updateBlockStates)(o,e),(0,F.mergeTabs)(e,n),e.dialog_tabs[t]=s.filter((e=>!n[e])).concat(Object.keys(n).map(l.intval)),(0,b.isCommunityInterface)(e)||(e.dialog_tabs[t]=(0,z.getFilteredConvoList)(e,e.dialog_tabs[t],t)),e.dialog_tabs_all[t]=!a.has_more,Promise.resolve(e))))}const _t=(0,R.wrapHashAction)((function(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_search",q:e,from:"all",gid:t.gid,hash:t.writeHash,offset:t.searchOffset||0}).then((([s,a,n,i,o])=>(a.forEach((e=>(0,C.oCacheAdd)(t,e))),(0,p.normalizeTabsGotFromServer)(t,s),e===t.searchText&&(t.searchOffset=i,t.searchAllLoaded=o),Object.keys(s).filter((e=>!t.tabs[e])).forEach((e=>{t.tabs[e]=s[e]})),[s,n])))}));function gt(e,t){return t.tabs[e].searchAllLoaded}function ut(e,t){if(t.peer===e&&(0,p.isFullyLoadedTab)(t,e)){return t.tabs[e].inplaceSearch}return!1}function mt(e,t){if((0,p.isFullyLoadedTab)(t,e)){let s=t.tabs[e];delete s.inplaceSearch,delete s.searchOffset,delete s.searchAllLoaded,delete s.searchText,delete s.searchDay,delete s.searchMsgs,ne({st:""}),ie()}return Promise.resolve(t)}function pt(e,t){if((0,p.isFullyLoadedTab)(t,e)){let s=t.tabs[e];delete s.searchDay,s.searchOffset=0,s.searchAllLoaded=!1,s.searchMsgs=[]}return Promise.resolve(t)}function ht(e,t){return t.tabs[e].inplaceSearch=!0,Promise.resolve(t)}const ft=(0,R.wrapHashAction)((function(e,t){let s=t.tabs[e],a="";if(ht(e,t),s.searchDay&&(a=`day:${s.searchDay}`),!a&&!s.searchText)return Promise.reject();let i=`in:${e} ${a} ${s.searchText||""}`;return ne({st:s.searchText}),ie(),(0,n.post)(A.CONTROLLER,{act:"a_search",q:i,from:"in",gid:t.gid,hash:t.writeHash,offset:s.searchOffset||0}).then((([e,t,a,n])=>(s.searchOffset=t,s.searchAllLoaded=a,s.searchMsgs=(s.searchMsgs||[]).concat(n),e)))}));function bt(e){return(0,n.post)(A.CONTROLLER,{act:"a_important",offset:e,part:e>0})}function vt(e,t){let s=(0,b.getTab)(e,t);return(0,n.post)(A.CONTROLLER,{act:"a_load_lastmsg",peerId:t,gid:e.get().gid}).then((([n,i,o,r])=>{const c=(0,l.intval)(n[0]),d=(0,y.unpackStore)(e);!c&&(0,N.isBusinessNotifyTab)(s)&&(d.dialog_tabs[h.FOLDER_BUSINESS_NOTIFY]=d.dialog_tabs[h.FOLDER_BUSINESS_NOTIFY].filter((e=>e!==t))),!(0,p.isLastMsgDebugEnabled)(e)||c||!1===s.lastmsg||(0,N.isBusinessNotifyTab)(s)||(console.log((0,a._)({},s)),(0,p.showDebugAlert)(!0)),s.lastmsg=c||!1,s.lastmsg_meta=n,[s.unread,s.in_up_to,s.out_up_to,s.in_up_to_cmid,s.out_up_to_cmid]=i,(0,V.partConfigEnabled)("me_web_read_by_cmid")?(o?s.mention_cmids=o:s.mention_cmids&&delete s.mention_cmids,r?s.expiring_cmids=r:s.expiring_cmids&&delete s.expiring_cmids):(o?s.mentions=o:s.mentions&&delete s.mentions,r?s.expiring_messages=r:s.expiring_messages&&delete s.expiring_messages),s.unread||(d.dialog_tabs[h.FOLDER_UNREAD]=d.dialog_tabs[h.FOLDER_UNREAD].filter((e=>(0,l.intval)(e)!==t))),(0,F.updateListedConvos)(d,s,!1,(e=>Me(t,e,d)),((e,t,s)=>gs(d,e,t,s)))}))}function Ct(e,t,s){if((0,p.isFullyLoadedTab)(s,t)){let a=s.tabs[t];a.deleted=a.deleted?a.deleted.concat(e):e}return Promise.resolve(s)}function Tt(e,t,s){if((0,p.isFullyLoadedTab)(s,t)){let a=s.tabs[t];if(a.history=(0,p.removeMessages)(e,(0,Y.unpackHistory)(a.history)),a.offset-=e.filter((e=>a.msgs[e])).length,e.forEach((e=>delete a.msgs[e])),e.forEach((e=>{let t=(s.selectedMessages||[]).indexOf(e);-1!=t&&s.selectedMessages.splice(t,1)})),a.inplaceSearch){const t=e.reduce(((e,t)=>(e[t]=!0,e)),{});a.searchMsgs=a.searchMsgs.filter((e=>!t[e])),a.searchOffset=a.searchMsgs.length}}return Promise.resolve(s)}const Lt=(0,R.wrapHashAction)((function(e,t,s,a,i){return(0,n.post)(A.CONTROLLER,{act:"a_mark",peer:t,hash:s||i.tabs[t].hash,gid:i.gid,msgs_ids:e.join(","),mark:a})}));function Et(e,t,s,a){if((0,p.isFullyLoadedTab)(a,t)){let n=a.tabs[t];n.deleted=n.deleted?n.deleted.concat(e):e,n.history=(0,p.removeMessagesWithRestore)(e,t,s,(0,Y.unpackHistory)(n.history)),n.offset-=e.filter((e=>n.msgs[e])).length}return Promise.resolve(a)}function It(e,t,s){if((0,p.isFullyLoadedTab)(s,t)){let a=s.tabs[t];a.deleted&&(a.deleted=a.deleted.filter((t=>t!==e))),a.history=(0,p.restoreMessage)(e,t,(0,Y.unpackHistory)(a.history)),a.offset++}return Promise.resolve(s)}function yt(e,t,s,a){return(0,n.post)(A.CONTROLLER,{act:"a_restore",id:e,peer:t,hash:s,gid:a})}const St=(0,R.wrapHashAction)((function(e,t,s){return(0,N.tabIsMessageRequest)(s.tabs[e])?Promise.resolve(s):(s.tabs[e].lastTyping=Date.now(),(0,n.post)(A.CONTROLLER,{act:"a_activity",type:t,peer:e,gid:s.gid,hash:s.tabs[e].hash}).then((()=>s),(()=>s)))})),At=(0,R.wrapHashAction)(((e,t)=>(0,n.post)(A.CONTROLLER,{act:"a_accept_message_request",peer_id:e,hash:t.tabs[e].hash}).then((()=>{const s=t.tabs[e];return s.is_message_request=!1,s.folders=(0,b.removeMessageRequestFolderFlags)(s.folders),t})))),Rt=(0,R.wrapHashAction)(((e,t,s)=>(0,n.post)(A.CONTROLLER,{act:"a_reject_message_request",peer_id:e,is_spam:Number(t),hash:s.tabs[e].hash}).then((()=>((0,F.updateListedConvos)(s,s.tabs[e],!0,(t=>t.filter((t=>t!==Number(e))))),Is(s.tabbedPeers.filter((t=>t.peer!==e)),!0,s),s))))),kt=(0,R.wrapHashAction)((function(e,t){return St(e,se,t)})),Pt=(0,R.wrapHashAction)((function(e,t){return St(e,ae,t)}));function Mt(e,t,s,a){return t&&(a.pendingForward=null,e||(e={msgIds:[]}),t.addAttach(s?"reply":"mail",e.msgIds.join(";"),e.object||null)),Promise.resolve(a)}function wt(e,t){return t.pendingForward=e,Promise.resolve(t)}function Ot(e,t,s){if(!(0,p.isTabLoaded)(s,e))return Promise.resolve(s);s.blockedFlagUpdates||(s.blockedFlagUpdates={}),s.blockedFlagUpdates[e]=!0;const a=s.tabs[e];return(0,F.updateListedConvos)(s,a,!0,(t=>t.filter((t=>t!==e)))),a.unread>0&&((0,V.partConfigEnabled)("simplified_start_conversation")?!(0,N.tabIsNotImportantMessageRequest)(a):!(0,N.tabIsMessageRequest)(a))&&!(0,N.isBusinessNotifyTab)(a)&&xe(s,-1,e),a.deletedDialog=!0,Is(s.tabbedPeers.filter((t=>t.peer!==e)),!0,s),t.then((([t,n])=>(delete s.blockedFlagUpdates[e],a.msgs=null,a.history=null,a.unread=0,a.lastmsg=!1,a.lastmsg_meta=null,s)))}function Nt(e,t,s){if(!(0,p.isTabLoaded)(s,e))return Promise.resolve(s);s.blockedFlagUpdates||(s.blockedFlagUpdates={}),s.blockedFlagUpdates[e]=!0;const a=s.tabs[e];return t.then((([t,n])=>(delete s.blockedFlagUpdates[e],a.msgs=null,a.history=null,a.unread=0,a.lastmsg=!1,a.lastmsg_meta=null,s)))}const xt=(0,R.wrapHashAction)((function(e,t,s){return Nt(e,(0,n.post)(A.CONTROLLER,{act:"a_flush_history",id:e,from:"im",gid:s.gid,hash:s.tabs[e].hash,leave_chat:t}),s)})),Dt=(0,R.wrapHashAction)((function(e,t,s){return(0,n.post)(A.CONTROLLER,{act:"a_set_chat_title",peer:e,new_title:t,gid:s.gid,hash:s.tabs[e].hash}).then((()=>(s.onUpdate&&s.onUpdate(),s)))})),Ft=(0,R.wrapHashAction)((function(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_load_chat_info",peer:e,gid:t.gid,hash:t.tabs[e].hash}).then((([s])=>(t.tabs[e]=(0,l.extend)(t.tabs[e],s),t)))}));function Ht(e,t){if((0,r.isEmpty)(e))return Promise.resolve(t);let s=Object.keys(e).map((t=>`${t}:${e[t].join(",")}`)).join(";");return(0,n.post)(A.CONTROLLER,{act:"a_load_member",need:s,gid:t.gid}).then((([e])=>(e.forEach((e=>(0,C.oCacheAdd)(t,e))),t)))}function Bt(e,t,s){const a={},n=s.get();function i(e,t){J.Ranges.isChatOrChannelPeer(e)&&t&&!(0,C.oCacheExists)(n,t)&&(a[e]?-1===a[e].indexOf(t)&&a[e].push(t):a[e]=[t])}const o=t.filter((e=>!(0,p.isTabLoaded)(n,e.peerId))).map((e=>e.peerId));t.forEach((e=>{i(e.peerId,e.userId)})),e.forEach((e=>{i(e.peerId,Number(e.kludges.source_mid)),i(e.peerId,Number(e.kludges.from))}));let r=t.filter((e=>e.flags&d.FLAG_OUTBOUND&&!e.local)).map((e=>e.kludges.from_admin)).filter((e=>e&&!n.admins[e]));if(0===Object.keys(a).length&&0===r.length&&0===o.length)return Promise.resolve(n);return{shouldLoad:Object.keys(a).length>0||r.length>0||o.length>0,needMembers:a,needAdminIds:r,needPeers:o}}function Ut({needMembers:e,needAdminIds:t,needPeers:s},a,n){return a.pause(),Promise.all([Ht(e,n),ke(t,n),Promise.all(s.map((e=>(0,O.loadPeer)(n,e,0,!1,!1,"loadPeople"))))]).catch((()=>n)).then((()=>a.resume())).then((()=>n))}const jt=(0,R.wrapHashAction)((function(e,t){return e.kludges.source_act===p.CHAT_PHOTO_REMOVE?(delete t.tabs[e.peerId].photo,delete t.tabs[e.peerId].photoLarge,Promise.resolve(t)):(t.onUpdate&&t.onUpdate(),(0,n.post)(A.CONTROLLER,{act:"a_get_chat_photo",msg_id:e.messageId}).then((([s,a])=>{t.chat_photo_msg=a;let n=t.tabs[e.peerId];if(t.tabs[e.peerId].photo=s[0],t.tabs[e.peerId].photoLarge=s[1],(0,p.isFullyLoadedTab)(t,e.peerId)){let s=e.kludges.source_act;n.history=(0,p.addChatPhotoToUpdate)(e,s,t,(0,Y.unpackHistory)(n.history))}return t})))}));function Gt(e,t,s,a){return t!==vk.id||(0,p.isTabLoaded)(a,s)&&a.peer==s&&(a=(0,F.setActions)(a)),Promise.resolve(a)}const $t=(0,R.wrapHashAction)((function(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_leave_chat",chat:J.Ranges.convertChatPeerIdToChatId(e),gid:t.gid,hash:t.tabs[e].hash}).then(Gt.bind(null,p.CHAT_KICK_USER,vk.id,e,t))})),qt=(0,R.wrapHashAction)((function(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_return_to_chat",chat:J.Ranges.convertChatPeerIdToChatId(e),gid:t.gid,hash:t.tabs[e].hash}).then(Gt.bind(null,p.CHAT_INVITE_USER,vk.id,e,t))})),Kt=(0,R.wrapHashAction)((function(e,t,s,a){return(0,n.post)(A.CONTROLLER,{act:"a_mute",peer:e,hash:a.tabs[e].hash,gid:a.gid,value:Number(t),until:s}).then((()=>{let s=t?"mute":"unmute";return window.Notifier&&Notifier.lcSend("im",{act:s,peer:e}),a})).then(Yt.bind(null,e,t))})),Vt=(0,R.wrapHashAction)((function(e,t,s){return(0,n.post)(A.CONTROLLER,{act:"a_mute_mentions",peer:e,hash:s.tabs[e].hash,gid:s.gid,value:Number(t)}).then((()=>s))}));function Yt(e,t,s){let a=s.mutedPeers.filter((t=>t!==e));return t&&a.push(e),s.mutedPeers=a,cur.mutedPeers=s.mutedPeers,(0,F.setActions)(s)}function Wt(e,t){return t.stack=e,Promise.resolve(t)}const zt=(0,R.wrapHashAction)((function(e,t,s,a){return Qt(e,s,t,a),(0,n.post)(A.CONTROLLER,{act:"a_mark_important",ids:e,val:t?1:0,from:"im",gid:a.gid,peer:s,hash:a.tabs[s].hash}).then((()=>a))}));function Qt(e,t,s,a){if((0,p.isFullyLoadedTab)(a,t)){let n=a.tabs[t];e.filter((e=>n.msgs[e])).forEach((e=>{const i=(0,b.getMessage)(a,t,e),o=s?i.flags|d.FLAG_IMPORTANT:i.flags&~d.FLAG_IMPORTANT;i.flags=o,n.msgs[e]=i,n.history=(0,p.updateStar)(e,s,(0,Y.unpackHistory)(n.history))}))}return Promise.resolve(a)}function Jt(e,t,s){return s.importants||(s.importants={}),(s.importants[t]||0)!==e&&(s.important_cnt+=e,s.importants[t]=e),Promise.resolve(s)}function Zt(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_spam",offset:e,gid:t,part:e>0})}function Xt(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_flush_spam",gid:t,hash:e})}function es(e,t,s){return s.creationType=e,s.creationFilter=t,Promise.resolve(s)}function ts(e,t){return(0,B.ownerPhoto)(JSON.parse(e).data[0],t)}function ss(e){return(0,n.post)(A.CONTROLLER,{act:"a_get_contacts"}).then((([t])=>(e.contactsList=t,e)))}function as(e,t){return t.next_chat_avatar=e,Promise.resolve(t)}function ns(e){let t;e.resync_in_process=new Promise((e=>{t=e}));let s=Object.keys(e.tabs).length,a=e.active_tab;return(0,u.lplog)("Resync started"),(0,V.partConfigEnabled)("im_chasiky_debug")&&window.meBufferLog&&(window.meBufferLog.resync={timestamp:Date.now(),ts:window.lpConnect.options.ts}),(0,n.post)(A.CONTROLLER,{act:"a_resync",sel:e.peer,gid:e.gid,loaded:s,tab:a,add_peers:e.tabbedPeers.map((e=>e.peer)).join(",")}).then((([s,n,i,o,r])=>{n.forEach((t=>(0,C.oCacheAdd)(e,t))),(0,p.normalizeTabsGotFromServer)(e,s),(0,u.lplog)("Resync success","success");let c,d=e.peer;if(J.Ranges.isZeroOwner(d))c=Promise.resolve(!1);else{let t={tabs:{[d]:e.tabs[d]},oCache:{},imQueueComplete:e.imQueueComplete};c=(0,F.mergeTabs)(t,{[d]:s[d]})}return c.then((n=>{e.tabs=s,e.admins=(0,l.extend)(e.admins,o),n&&(e.tabs[d]=n.tabs[d],e.tabs[d].history=(0,O.restoreQueuedMessagesInDom)(e,d,(0,Y.unpackHistory)(e.tabs[d].history))),e.loadingDialogs=!1,e.mutedPeers=i.mutedPeers,e.lastDialogsOptions={has_more:i.has_more},e.dialog_tab_cts=i.folder_cts,e.dialog_tabs[a]=r.map(l.intval),e.dialog_tabs_all[a]=!1;let c=e.dialog_tabs[a].map((t=>e.tabs[t]));for(const t of Object.keys(e.dialog_tabs)){if(a===t)continue;const s=[];if(a===h.FOLDER_ALL)for(const e of c)(0,H.getFilterFnForConvoListFolder)(t)(e)&&s.push(e.peerId);e.dialog_tabs_all[t]=!1,e.dialog_tabs[t]=s}return delete e.resync_in_process,setTimeout(t.bind(null,!0),0),(0,x.setUnreadCounters)(i,e)}))})).then((e=>((0,G.updateUnreadCounter)(e),e))).catch((t=>((0,u.lplog)("Resync error: "+t.message+" "+t.stack,"error"),(0,_.pause)(2).then(ns.bind(null,e)))))}function is(e,t){return t.lockedSending=e,Promise.resolve(t)}function os(e,t,s){return e&&!s.delayed_message?(s.delayed_message=e,s.delayed_ts=t):e||(s.delayed_message=e,s.delayed_ts=t),Promise.resolve(s)}function rs(e){return!!e.textMediaSelector.urlAttachmentLoading||!(!window.cur.initChooseUploadFlags||!window.cur.initChooseUploadFlags.start||window.cur.initChooseUploadFlags.finish)||!!window.cur.fileApiUploadStarted||!!(window.Upload&&Upload.options&&Upload.isSomethingUploading)&&Object.keys(Upload.options).filter((e=>Upload.isSomethingUploading(e))).length>0}function cs(e,t,s){s.cur_unread_cnt||(s.cur_unread_cnt={}),t&&!(0,l.inArray)(e,s.mutedPeers)&&(s.cur_unread_cnt[e]=!0);let a=document.title,n=window.devicePixelRatio>=2?"_2x":"";if(t&&!s.update_title_to){let e=function(e,t,s){return function(){s.update_old_title=e;let a=Object.keys(s.cur_unread_cnt).length;if(0===a)return(0,I.setDocumentTitle)(e||document.title),(0,i.setFavIcon)("/images/icons/favicons/fav_im"+t+".ico"),clearInterval(s.update_title_to),void(s.update_title_to=!1);if(e)(0,I.setDocumentTitle)(e),(0,i.setFavIcon)("/images/icons/favicons/fav_im"+t+".ico"),e=!1;else{e=document.title;let s=a>9?10:a;(0,i.setFavIcon)("/images/icons/favicons/fav_im"+s+t+".ico"),(0,I.setDocumentTitle)((0,r.winToUtf)(o.getLang("mail_im_new_messages",a)))}}}(a,n,s);s.update_title_to=setInterval(e,1e3),e()}else!t&&s.update_old_title&&((0,I.setDocumentTitle)(s.update_old_title),s.cur_unread_cnt={},a=!1,s.update_old_title=!1,(0,i.setFavIcon)("/images/icons/favicons/fav_im"+n+".ico"),clearInterval(s.update_title_to),s.update_title_to=!1);return Promise.resolve(s)}function ds(e,t,s,a,n){return(0,p.isFullyLoadedTab)(n,e)&&(n.tabs[e].scrollTop=(0,l.intval)(t),n.tabs[e].scrollBottom=(0,l.intval)(s),n.tabs[e].contHeight=(0,l.intval)(a)),Promise.resolve(n)}function _s(e,t){const s=t.active_tab;if(t.active_tab=e,(0,c.updateLocation)({tab:e===h.FOLDER_ALL?null:e,tags:e===h.FOLDER_PEER_TAGS&&t.peer_tags_filter?t.peer_tags_filter.mask:null}),e!==h.FOLDER_ALL&&!(0,p.isReversedDialogs)(t)){const s=t.dialog_tabs[e],a=(0,z.getFilteredConvoList)(t,t.dialog_tabs[h.FOLDER_ALL],e);t.dialog_tabs[e]=s.length>=a.length?s:a}return s===h.FOLDER_PEER_TAGS&&e!==s&&(t.peer_tags_filter.ids=[],(0,D.renderPeerTagsFilter)(t),(0,D.renderPeerTagsFilterPane)(t)),Promise.resolve(t)}function gs(e,t,s,a){let n=e.dialog_tabs_all;if(0===a.minor_sort_id&&0===a.major_sort_id)return!1;if(t===h.FOLDER_BUSINESS_NOTIFY&&!a.lastmsg)return!1;if(n[h.FOLDER_ALL]||n[t])return!0;if(s.includes(a.peerId))return!0;if("r"===a.lastmsg[0])return!0;return s.map((t=>e.tabs[t.toString()])).filter((t=>(0,p.isReversedDialogs)(e)?t.major_sort_id>a.major_sort_id||t.minor_sort_id>a.minor_sort_id:t.major_sort_id<a.major_sort_id||t.minor_sort_id<a.minor_sort_id)).length>0}function us(e,t,s,a,n,i){if((0,p.isTabLoaded)(i,e)&&!n){let a=i.tabs[e];return s===d.REPLACE_DIRECTORIES&&(t^=a.folders),function(e,t,s){return!(e===d.SET_DIRECTORIES&&s.folders&t||!(e!==d.RESET_DIRECTORIES||s.folders&t)||((0,V.partConfigEnabled)("simplified_start_conversation")?(0,N.tabIsNotImportantMessageRequest)(s):(0,N.tabIsMessageRequest)(s)))}(s,t,a)&&Object.keys(h.FOLDER_MASKS).filter((e=>h.FOLDER_MASKS[e]&t)).forEach((e=>{const t=i.dialog_tab_cts[e];t&&(t.total=(0,W.getConvoListFolderCounterDisplayed)(i,e)+function(e,t,s){return t!==d.RESET_DIRECTORIES||e.folders&h.FOLDER_MASKS[s]?t===d.REPLACE_DIRECTORIES?e.folders&h.FOLDER_MASKS[s]?-1:1:t===d.SET_DIRECTORIES?1:-1:0}(a,s,e))})),s===d.SET_DIRECTORIES?i.tabs[e].folders|=t:s===d.RESET_DIRECTORIES?i.tabs[e].folders&=~t:i.tabs[e].folders=t^=a.folders,(0,F.updateListedConvos)(i,i.tabs[e],!0,((t,s)=>s===h.FOLDER_PEER_TAGS?t:(0,z.getFilteredConvoList)(i,[...t,e],s)),((e,t,s)=>gs(i,e,t,s))),Promise.resolve(i)}return(0,O.loadPeer)(i,e,0,!1,!1,"updateFolders").then((()=>us(e,t,s,null,!1,i)))}const ms=(0,R.wrapHashAction)((function(e,t){let s=h.FOLDER_MASKS[h.FOLDER_IMPORTANT],a=t.tabs[e].folders&s,i=a?d.resetDirectoriesEvent:d.setDirectoriesEvent;return t.longpoll.push([i([0,e,s,!0])]),(0,n.post)(A.CONTROLLER,{act:"a_dialog_star",val:a?0:1,peer:e,hash:t.tabs[e].hash,gid:t.gid}).then((()=>t))})),ps=(0,R.wrapHashAction)((function(e,t){let s=h.FOLDER_MASKS[h.FOLDER_UNRESPOND];const a=t.tabs[e];if(a)return(0,V.partConfigEnabled)("me_web_read_by_cmid")?t.longpoll.push([d.resetDirectoriesEvent([0,e,s,!0]),d.readInboundByCmidEvent([10006,e,a.lastmsg_meta.chat_local_id,null])]):t.longpoll.push([d.resetDirectoriesEvent([0,e,s,!0]),d.readInboundEvent([6,e,a.lastmsg,null])]),(0,n.post)(A.CONTROLLER,{act:"a_mark_answered",peer:e,lastmsg:a.lastmsg,hash:t.tabs[e].hash,gid:t.gid}).then((()=>t))})),hs=(0,R.wrapHashAction)(((e,t)=>(t.longpoll.push([(0,M.resetPeer)(),d.setDirectoriesEvent([0,e,h.FOLDER_MASKS[h.FOLDER_MARKED_UNREAD],!0])]),(0,n.post)(A.CONTROLLER,{act:"a_mark_conversation_as_unread",peer_id:e,hash:t.tabs[e].hash,gid:t.gid})))),fs=(0,R.wrapHashAction)(((e,t)=>{t.longpoll.push([d.resetDirectoriesEvent([0,e,h.FOLDER_MASKS[h.FOLDER_MARKED_UNREAD],!0])]);const s=t.tabs[e],i=(0,V.partConfigEnabled)("me_web_read_by_cmid")?{start_cmid:(0,L.getLastMeta)(t,e).chat_local_id}:{ids:[s.lastmsg]};return(0,n.post)(A.CONTROLLER,(0,a._)({peer:e,mark_conversation_as_read:!0,hash:s.hash,act:"a_mark_read",gid:t.gid},i)).then((()=>t))}));function bs(e){return(0,n.post)(A.CONTROLLER,{act:"a_get_mutex_key",gid:e})}function vs(e,t){return(0,x.updateBlockStates)({[e]:{free:!0}},t),(0,n.post)(A.CONTROLLER,{act:"a_block_release",peer:e,gid:t.gid}).then((()=>t))}function Cs(e,t){let s=ls.get("comm_mute_"+t.gid)?1:0;return e&&(s^=1),ls.set("comm_mute_"+t.gid,s),t.mute=s,Promise.resolve(t)}const Ts=(0,R.wrapHashAction)((function(e,t){return(0,F.updateListedConvos)(t,t.tabs[e],!0,(t=>t.filter((t=>t!==e)))),t.tabs[e].deletedDialog=!0,(0,n.post)(A.CONTROLLER,{act:"a_delete_dialog",peer:e,gid:t.gid,hash:t.tabs[e].hash}).then((s=>(s[0]?(Is(t.tabbedPeers.filter((t=>t.peer!==e)),!0,t),t.tabs[e].unread=0,t.tabs[e].lastmsg=!1,t.tabs[e].lastmsg_meta=null):(t.tabs[e].deletedDialog=!1,(0,F.updateListedConvos)(t,t.tabs[e],!1,(s=>Me(e,s,t)),((e,s,a)=>gs(t,e,s,a)))),s)))}));function Ls(e,t,s,a){return(0,n.post)(A.CONTROLLER,{act:"a_restore_dialog",hash:t,gid:a.gid,spam:s?1:0,peer:e}).then((t=>(a.tabs[e].deletedDialog=!1,(0,F.updateListedConvos)(a,a.tabs[e],!1,(t=>[e].concat(t))),a.tabs[e].unread=t,a)))}function Es(e,t,s){return(0,n.post)(A.CONTROLLER,{act:"a_spam_dialog",peer:e,gid:s.gid,hash:t})}function Is(e,t,s){return s.tabbedPeers=e,(0,p.isClassicInterface)(s)&&(ne({peers:s.tabbedPeers.filter((({peer:e,type:t})=>e!==s.peer&&"perm"===t)).map((e=>(0,p.getBareTab)(e.peer,s))).filter((e=>!e.deletedDialog)).map((e=>e.peerId)).map(p.convertPeerToUrl).join("_"),to:""}),t&&ie()),Promise.resolve(s)}function ys(e){return!e.peer||(ut(e.peer,e)?gt(e.peer,e):!!(0,p.isFullyLoadedTab)(e,e.peer)&&e.tabs[e.peer].allShown)}function Ss(e,t){const s=t.tabs[e];return(0,p.isFullyLoadedTab)(t,e)&&(s.skipped=null,s.msgs=null,s.offset=null,s.allShown=null,s.history=null),Promise.resolve(t)}function As(e,t){const s=t.tabs[e];return(0,p.isFullyLoadedTab)(t,e)&&(s.history=le(s.history)),Promise.resolve(t)}function Rs(e,t){return t.go_to_end_visible=e,Promise.resolve(t)}function ks(e,t){return t.go_to_mentions_visible=e,Promise.resolve(t)}function Ps(e,t){return t.go_to_reactions_available=e,Promise.resolve(t)}function Ms(e,t,s){if(!J.Ranges.isGroupId(t))return Promise.resolve(s);const a=(0,b.getTab)(s,t);return a.blocked_community=!e,!1===e&&(a.can_send_notify=!1),(0,n.post)(A.CONTROLLER,{act:"a_toggle_community",peer_id:t,hash:a.hash,state:e?1:0}).then((()=>(0,F.setActions)(s)))}function ws(e){if(0!==e.peer&&(0,p.isFullyLoadedTab)(e,e.peer)){const t=(0,b.getTab)(e,e.peer),s=(0,I.geByClass1)("_im_peer_history");s&&(t.history=(0,Y.unpackHistory)(s.innerHTML))}return Promise.resolve(e)}function Os(e){return e.audio_msg.isRecording=!1,Promise.resolve(e)}function Ns(e,t){return t.voice_message_available=e,Promise.resolve(t)}function xs(e){ne({act:e?"create":null}),ie()}function Ds(e=null){ne({q:e}),ie()}function Fs(e){return void 0===e.chatResizeInitialized&&(e.chatResizeInitialized=!0,(0,p.getClassicChatHeight)()>(0,I.clientHeight)()&&(0,p.setClassicChatHeight)(0)),Promise.resolve(e)}const Hs=(0,R.wrapHashAction)((function(e,t,s,a){return(0,n.post)(A.CONTROLLER,{act:"a_join_chat",chat_id:e,hash:t,invite_link:s,write_hash:a.writeHash}).then((([e,t,s,n])=>(s.forEach((e=>(0,C.oCacheAdd)(a,e))),a.tabs[e]=t,(0,F.updateListedConvos)(a,t,!1,(t=>Me(e,t,a)),((e,t,s)=>gs(a,e,t,s))),a.admins=(0,l.extend)(a.admins,n),[e])))}));function Bs(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_get_link",gid:t.gid,chat_id:e})}const Us=(0,R.wrapHashAction)((function(e,t){const s=t.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_reset_link",chat_id:e-2e9,write_hash:t.writeHash,gid:t.gid}).then((e=>(s.inviteLink=e[0],e)))}));function js(e){return oe({invite_chat_id:null,invite_hash:null,mr:null,invite_link:null}),e.invitation=void 0,Promise.resolve(e)}function Gs(e,t){const s=(0,u.arrayUnique)([e].concat(t.select(m.RECENT_SEARCH_OP))).slice(0,500);t.update(m.RECENT_SEARCH_OP,s)}function $s(e){e.update(m.RECENT_SEARCH_OP,[])}function qs(e,t){const s=t.select(m.RECENT_SEARCH_OP).filter((t=>t!==e));return t.update(m.RECENT_SEARCH_OP,s),s}function Ks(e,t,s){const a=s.tabs[t],n=(0,b.getMessage)(s,t,e);return(0,b.isChatActive)(a)&&!n.kludges.source_act&&(a.pinned=n),Promise.resolve(s)}function Vs(e,t){return t.tabs[e].pinned=null,Promise.resolve(t)}const Ys=(0,R.wrapHashAction)((function(e,t,s){const a=s.tabs[t];return(0,b.isChatActive)(a)?(0,n.post)(A.CONTROLLER,{act:"a_pin_message",msgid:e,chat:t,gid:s.gid,hash:s.tabs[t].hash}).then((([e])=>(s.tabs[t]=Object.assign({},a,e),s))):Promise.resolve(s)})),Ws=(0,R.wrapHashAction)((function(e,t){const s=t.tabs[e];return(0,b.isChatActive)(s)?(0,n.post)(A.CONTROLLER,{act:"a_unpin_message",chat:e,gid:t.gid,hash:t.tabs[e].hash}).then((([a])=>(t.tabs[e]=Object.assign({},s,a),t))):Promise.resolve(t)})),zs=(0,R.wrapHashAction)((function(e,t){const s=t.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_get_pinned_message",chat:e,gid:t.gid,hash:t.tabs[e].hash}).then((([e])=>(s.pinned=e||null,t)))})),Qs=(0,R.wrapHashAction)((function(e,t,s){const a=s.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_get_message_local_id",chat:e,chat_local_id:t,hash:a.hash})})),Js=(0,R.wrapHashAction)((function(e,t){return Promise.all([ve(e,t),function(e,t){const s=t.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_get_chat_details",chat:e,gid:t.gid,hash:s.hash}).then((([e])=>(s.photoGrid=e.grid,s.photoLarge=e.photo,s.membersLastSeen=e.lastSeen||null,s.inviters=e.inviters,s.caccess=e.caccess,s.invitedByMe=e.invitedByMe||[],s.inviteLinks=e.links||null,s.invitedByMessageRequest=e.invitedByMessageRequest,s.canRestore=e.canRestore,s.serverSettings=e.serverSettings||null,s.isDefaultPhotoOwner=e.isDefaultPhotoOwner||null,s.owner=e.owner||null,s.allowedUpdateFlags=e.allowedUpdateFlags,s.canInvite=e.canInvite||null,s.notifications=e.notifications,t)))}(e,t),(0,O.getCustomChatMemberSearch)(t,e)||Promise.resolve(),(0,Z.getUGCStickersInfo)(String(e)).then((e=>{var s,a;const n=null==(a=e)||null==(s=a.lists)?void 0:s[0];return n&&(0,X.setUgcInfo)(n),t})).catch((()=>{(0,ee.logStickersError)("im_actions -> getUGCStickersInfo error")}))]).then((()=>t))})),Zs=(0,R.wrapHashAction)((function(e,t,s){const a=s.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_update_flags",chat:e,gid:s.gid,hash:a.hash,flags:t}).then((e=>(s.onUpdate&&s.onUpdate(),e)))})),Xs=(0,R.wrapHashAction)((function(e,t){const s=t.tabs[e];return(0,n.post)("al_page.php",{act:"owner_photo_remove",oid:e,gid:t.gid,hash:s.photoHash}).then((()=>(s.photo=null,s.photoLarge=null,t.onUpdate&&t.onUpdate(),t)))}));function ea(e,t,s,a){const n=a.tabs[e];return n.adminIds=s?[].concat(n.adminIds,t).filter(((e,t,s)=>s.indexOf(e)===t)):n.adminIds.filter((e=>e!==t)),Promise.resolve(a)}const ta=(0,R.wrapHashAction)((function(e,t,s,a){const i=a.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_toggle_admin",chat:e,hash:i.hash,mid:t,is_admin:+s,gid:a.gid}).then((()=>ea(e,t,s,a)))}));function sa(e,t,s,a){const n=(0,b.getMessage)(e,s,t).userId;return(0,C.oCacheGet)(a,n)?Promise.resolve(a):Ht({[s]:[n]},a)}function aa(){ajax.post("al_im.php",{act:"a_hide_promo_tooltip"})}const na=(0,R.wrapHashAction)((function(e,t){return t.tabs[e].top_banner=void 0,(0,n.post)(A.CONTROLLER,{act:"a_hide_banner",peer_id:e,gid:t.gid,hash:t.tabs[e].hash}).then((()=>t))})),ia=(0,R.wrapHashAction)((function(e,t,s){s.tabs[e].top_banner=void 0;const a=s.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_callback_banner",peer_id:e,callback_data:t,hash:a.hash}).then((()=>s))}));function oa(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_load_banner",peer_id:e,gid:t.gid}).then((([s])=>(t.tabs[e].top_banner=s,t)))}function ra(e,t,s){return s.tabs[e].keyboard=t&&t.buttons?t:null,ca(e,!1,!0,s)}function la(e,t){return ra(e,null,t)}function ca(e,t,s,a){return((a.tabs||{})[e]||{}).keyboard&&(a.tabs[e].keyboard.hide=t,s&&ls.set("is_keyboards_hide",Object.assign(ls.get("is_keyboards_hide")||{},{[e]:t}))),Promise.resolve(a)}const da=(0,R.wrapHashAction)((function(e,t){const s=t.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_get_keyboard",peer_id:e,hash:s.hash}).then((([s])=>ra(e,s,t)))}));function _a(e,t,s,a){const i=a.tabs[e];return i.caccess[t]=s,(0,n.post)(A.CONTROLLER,{act:"a_change_caccess",peer_id:e,member_id:t,hash:i.hash,access:s?1:0,gid:a.gid}).then((()=>a)).catch((e=>{throw i.caccess[t]=!s,e}))}const ga=(0,R.wrapHashAction)((function(e,t){const s=t.tabs[t.peer];return(0,n.post)(A.CONTROLLER,{act:"a_delete_template",template_id:e,hash:s.hash,gid:t.gid,peer_id:t.peer}).then((()=>{const s=t.templates.find((t=>t.id===e));return s&&(s.deleted=!0),t}))}));function ua(e,t,s){const a=s.tabs[s.peer];return(0,n.post)(A.CONTROLLER,{act:"a_create_template",hash:a.hash,gid:s.gid,peer_id:s.peer,name:e,text:t}).then((e=>(s.templates.unshift(e[0]),s)))}function ma(e,t,s,a){const i=a.tabs[a.peer];return(0,n.post)(A.CONTROLLER,{act:"a_update_template",template_id:e,hash:i.hash,gid:a.gid,peer_id:a.peer,group_id:a.gid,name:t,text:s}).then((t=>{const s=a.templates.find((t=>t.id===e));return s&&Object.assign(s,t[0]),a}))}function pa(e,t){if((0,p.isFullyLoadedTab)(t,e)){const s=(0,b.getTab)(t,e);s.allShown=!1,s.lastReset=Date.now()}return t}function ha(e,t){const{updateType:s,updateArg:a}=e;let n=0;s===d.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED&&(n=a===d.MESSAGE_REQUEST_STATUS_NEW?1:-1),s===d.MAIL_CHAT_UPDATE_TYPE_CONTACT_CONVERTED&&(n=-1);const i=t.dialog_tab_cts[A.ConvoListFolder.MR];return i&&(i.total=(0,W.getConvoListFolderCounterDisplayed)(t,A.ConvoListFolder.MR)+n),Promise.resolve(t)}function fa(e,t,s){if((0,p.isFullyLoadedTab)(s,e.peerId)){const a=(0,b.getTab)(s,e.peerId);a.history=(0,p.setCasperMessageExpiringStatusDOM)(a.history,t,e.messageId)}return Promise.resolve(s)}function ba(e,t){return Promise.resolve().then((()=>{if((0,p.isFullyLoadedTab)(t,e)){const s=(0,b.getTab)(t,e);Object.values(s.msgs).forEach((e=>{const t=(0,b.parserMessage)(e);(0,v.isCasperMessage)(t)&&!S.casperMessagesStore.has(t.chat_local_id)&&S.casperMessagesStore.add(t)}))}return Promise.resolve(t)}))}const va=(0,R.wrapHashAction)((function(e,t,s,a,i){return(0,n.post)(A.CONTROLLER,{act:"a_peer_profile_toggle_tag",hash:i.manage_tags_hash,group_id:i.gid,peer_id:a,tag_id:e,action:s}).then((s=>{i.tabs[a].peer_tags=s[0];const n=i.peer_profile_tags.findIndex((t=>t.id===e));return t?i.peer_profile_tags[n].uses++:!t&&i.peer_profile_tags[n].uses>0&&i.peer_profile_tags[n].uses--,i}))})),Ca=(0,R.wrapHashAction)((function(e,t){return(0,n.post)(A.CONTROLLER,{act:"a_peer_profile_manage_tags",hash:t.manage_tags_hash,group_id:t.gid,tags:JSON.stringify(e)}).then((e=>(t.peer_profile_tags=e[0].tags,t)))})),Ta=(0,R.wrapHashAction)((function(e,t,s){return(0,n.post)(A.CONTROLLER,{act:"a_peer_profile_save_note",hash:s.manage_tags_hash,group_id:s.gid,peer_id:e,note:t}).then((()=>(s.tabs[e].peer_profile_info.note=t,s)))})),La=(0,R.wrapHashAction)(((e,t)=>(0,n.post)(A.CONTROLLER,{act:"a_reload_message",msg_id:e,hash:t.writeHash}).then((([e])=>e)))),Ea=(0,R.wrapHashAction)(((e,t)=>{const s=t.tabs[e];return(0,n.post)(A.CONTROLLER,{act:"a_get_active_call_data",peer_id:s.peerId,hash:s.hash}).then((([e])=>(e?s.callInProgress=e:s.callInProgress&&delete s.callInProgress,t)))})),Ia=(e,t)=>{const s=t.tabs[e];return s.callInProgress&&delete s.callInProgress,Promise.resolve(t)};function ya(e,t){return t.peer_tags_filter&&t.peer_tags_filter.ids!==e&&(0,F.resetFolderList)(t,A.ConvoListFolder.PEER_TAGS),t.peer_tags_filter={ids:e,mask:(0,D.convertPeerTagsFilterToMask)(t.peer_profile_tags,e)},Promise.resolve(t)}function Sa(e,t,s,a){const n=(0,b.getTab)(a,e);if(n){const e=n.peer_tags?n.peer_tags.ids:[];if(n.peer_tags={ids:t,mask:s},t.length!==e.length){let s,n;t.length>e.length?(s=!0,n=t.filter((t=>!e.includes(t)))[0]):(s=!1,n=e.filter((e=>!t.includes(e)))[0]),a=function(e,t,s){if(!s.peer_profile_tags)return s;const a=s.peer_profile_tags.find((t=>t.id===e));a&&(t?a.uses++:a.uses>0&&a.uses--);return s}(n,s,a)}}return Promise.resolve(a)}function Aa(e){return e.dialog_tabs[h.FOLDER_PEER_TAGS]=e.dialog_tabs[h.FOLDER_ALL].map((t=>(0,b.getTab)(e,t))).filter((t=>(0,D.applyPeerTagsFilterToTab)(e,t))).map((e=>e.peerId)),Promise.resolve(e)}function Ra(e){return(0,n.post)(A.CONTROLLER,{act:"a_get_peer_profile_tags",group_id:e.gid}).then((t=>(e.peer_profile_tags=t[0].tags,e.active_tab===h.FOLDER_PEER_TAGS?(e.peer_tags_filter.ids=e.peer_profile_tags.filter((t=>e.peer_tags_filter.ids.includes(t.id))).map((e=>e.id)),e.peer_tags_filter.mask=(0,D.convertPeerTagsFilterToMask)(e.peer_profile_tags,e.peer_tags_filter.ids),(0,c.updateLocation)({tab:h.FOLDER_PEER_TAGS,tags:e.peer_tags_filter.mask}),Aa(e)):e)))}},804381:(e,t,s)=>{s.d(t,{statlogsCommunityTemplatesClickEvent:()=>g,statlogsForwardEvent:()=>d,statlogsForwardFromChannel:()=>u,statlogsForwardFromCommunityEvent:()=>_,statlogsSendingError:()=>b,statlogsSendingQueueLength:()=>C,statlogsSendingRetry:()=>T,statlogsSendingTime:()=>p,statlogsSendingTimeEnd:()=>f,statlogsSendingTimeStart:()=>h});var a=s(945263),n=s(385376),i=s(839470),o=s(202688),r=s(705758);const l=new o.DevNullStatCollector(new o.CustomStatCollector);let c={};function d(e){(0,a.statlogsProbValueEvent)(.1,"im_forward_stat",m(e),!!e.get().gid)}function _(e,t){(0,a.statlogsProbValueEvent)(.1,"im_forward_from_community_stat",m(e),!!e.get().gid,+t)}function g(){(0,a.statlogsProbValueEvent)(1,"im_apply_community_template_stat",1)}function u(){(0,a.statlogsProbValueEvent)(1,"messages_channel_forward_click",1)}function m(e){const t=e.get().pendingForward;return+(t&&t.msgIds&&t.msgIds.length)}function p(e,t,s,a=!1){if(!(0,i.randEnabled)(1))return()=>{};const o=+new Date,c=v(e),d=function(e){const t=(0,r.unpackStore)(e);return Boolean(t.longpoll&&t.longpoll.isSSE)}(e)?"sse":"longpoll";return function(){const e=+new Date-o;(0,n.saveStatlogEvents)({name:"messages_send_time_web",value:e,keys:[t,s,c,a,d]}),"opt_to_lp"===s&&l.logEvent({key:"messages_send_time_web",value_str:d,value:e})}}function h(e,t,s,a){if(t.messageId&&-1!==String(t.messageId).indexOf("rid")){const n=[t.messageId.replace("rid",""),s,a].join("_"),i=t.attaches.length>0;c[n]=p(e,s,a,i)}}function f(e,t,s,a){const n=[t.randomId,s,a].join("_"),i=c[n];i&&(i(),delete c[n])}function b(e,t,s,n){const o=v(e),r=""===t?"network":"unknown";(0,i.randEnabled)(1)&&(0,a.statlogsValueEvent)("messages_send_errors_web",r,s,n,o)}function v(e){const t=(0,r.unpackStore)(e);return Boolean(t.longpoll&&t.longpoll.isEnabled&&t.longpoll.isEnabled())}function C(e){const t=(0,r.unpackStore)(e),s=t.imQueue(t.peer).length;(0,i.randEnabled)(1)&&(0,a.statlogsValueEvent)("messages_send_queue_size",s)}function T(e,t="unknown"){(0,i.randEnabled)(1)&&(0,a.statlogsValueEvent)("messages_send_retry",1,t,e)}},242426:(e,t,s)=>{s.d(t,{PeerProfile:()=>S});var a=s(434788),n=s(785893),i=s(667294),o=s(584356),r=s(45697),l=s.n(r),c=s(222009),d=s(682615),_=s(196026),g=s(659397),u=s(29271),m=s(907964),p=s(364517),h=s(752654),f=s(875610),b=s(435742),v=s(209937),C=s(433636),T=s(301063),L=s(7685),E=s(457561),I=s(47304);const y="peer_profile_modal";class S extends i.PureComponent{render(){const{store:e}=this.props,t=e.get(),s=(0,c.getTab)(t,t.peer),{isCollapsed:i,tags:o,peerTags:r,note:l,isTagsModalOpened:_,isNoteModalOpened:f}=this.state,I=o.length>0,y=I?o.reduce(((e,t)=>(e[t.id]=!0,e)),{}):[],S=r.filter((e=>y[e])),A=s.peer_profile_info,R=A&&(A.city||A.age),k=(0,d.classNames)("PeerProfile__wrapper",{"PeerProfile__wrapper--collapsed":i});return(0,n.jsxs)("div",{className:k,children:[(0,n.jsx)(p.Scroll,{className:"PeerProfile__scroll",neverHide:!0,children:(0,n.jsxs)("dl",{className:"PeerProfile__container",children:[(0,n.jsx)("dt",{className:"PeerProfile__label",children:u.getLang("mail_im_peer_profile_tags_label_text")}),(0,n.jsxs)("dd",{className:"PeerProfile__content PeerProfile__tags",children:[i&&!I&&!s.ad_id&&(0,n.jsx)(m.default,{className:"PeerProfile__manageTagsLink",onClick:e=>this.toggleModal(e,!0,"tags"),children:u.getLang("mail_im_peer_profile_manage_tags")}),(I||s.ad_id)&&(0,n.jsx)(b.PeerProfileTagsList,{tags:o,peerTags:S,isPeerProfileCollapsed:i,adId:s.ad_id,hasAdAccess:s.has_ad_access,isEasyPromotedMarket:s.is_easy_promoted_market,isMailRuAd:s.is_mail_ru_ad,toggleProfile:this.toggleProfile}),!i&&(0,n.jsx)(v.PeerProfileTagsGrid,{tags:[...o].map((e=>(0,a._)({},e,{isChecked:r.includes(e.id)}))),onPeerTagsChange:this.onPeerTagsChange}),!i&&(0,n.jsx)(m.default,{className:"PeerProfile__manageTagsLink",onClick:e=>this.toggleModal(e,!0,"tags"),children:u.getLang("mail_im_peer_profile_manage_tags")}),_&&(0,n.jsx)(C.PeerProfileTagsModal,{tags:o,onSave:this.onSave,onClose:e=>this.toggleModal(e,!1,"tags")})]}),(0,n.jsx)("dt",{className:"PeerProfile__label",children:u.getLang("mail_im_peer_profile_info_label_text")}),(0,n.jsxs)("dd",{className:"PeerProfile__content PeerProfile__info",children:[R&&(0,n.jsxs)(n.Fragment,{children:[A.city&&(0,n.jsx)("span",{className:"PeerProfile__infoItem",children:(0,g.decodeHTMLEntities)(A.city)}),A.age&&(0,n.jsx)("span",{className:"PeerProfile__infoItem",children:(0,g.decodeHTMLEntities)(A.age)}),A.likes_cnt&&(0,n.jsx)(h.default,{className:"PeerProfile__infoTooltip",position:"t",text:u.getLang("mail_peer_profile_likes_replies_tooltip"),appearance:"light",children:(0,n.jsxs)("span",{className:"PeerProfile__infoItem",children:[A.likes_cnt&&(0,n.jsx)("span",{className:"PeerProfile__infoItem",children:(0,g.decodeHTMLEntities)(A.likes_cnt)}),A.replies_cnt&&(0,n.jsx)("span",{className:"PeerProfile__infoItem",children:(0,g.decodeHTMLEntities)(A.replies_cnt)})]})})]}),!R&&(0,n.jsx)("span",{children:u.getLang("mail_im_peer_profile_info_empty")})]}),t.is_peer_profile_note_enabled&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("dt",{className:"PeerProfile__label",children:u.getLang("mail_im_peer_profile_note_label_text")}),(0,n.jsxs)("dd",{className:"PeerProfile__content PeerProfile__note",children:[!l&&(0,n.jsx)(m.default,{onClick:e=>this.toggleModal(e,!0,"note"),children:u.getLang("mail_im_peer_profile_note_add_link")}),!!l&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{className:"PeerProfile__noteText",children:(0,g.decodeHTMLEntities)(l)}),(0,n.jsx)("span",{className:"PeerProfile__noteDivider",children:" · "}),(0,n.jsx)(m.default,{onClick:e=>this.toggleModal(e,!0,"note"),children:u.getLang("mail_im_peer_profile_note_edit_link")})]}),f&&(0,n.jsx)(T.PeerProfileNoteModal,{note:l,onNoteSave:this.onNoteSave,onClose:e=>this.toggleModal(e,!1,"note")})]})]}),(0,n.jsx)("dt",{className:"PeerProfile__label",children:u.getLang("mail_im_peer_profile_join_date_label_text")}),(0,n.jsx)("dd",{className:"PeerProfile__content",children:A&&A.join_date?(0,g.decodeHTMLEntities)(A.join_date):(0,u.langSex)(s.sex,u.getLang("mail_im_peer_profile_join_date_empty_text","raw"))})]})}),(I||s.ad_id)&&(0,n.jsx)("button",{className:"PeerProfile__toggler",onClick:this.toggleProfile,children:this.state.isCollapsed?(0,n.jsx)(L.Icon24ChevronDown,{}):(0,n.jsx)(E.Icon24ChevronUp,{})})]})}constructor(e){super(e),this.toggleProfile=()=>{this.setState({isCollapsed:!this.state.isCollapsed})},this.onPeerTagsChange=(e,t)=>{const{store:s}=this.props,a=s.get().peer;this.setState((s=>({peerTags:t?[].concat(s.peerTags,e):s.peerTags.filter((t=>t!==e))})),(()=>{s.set(f.peerProfileToggleTag.bind(null,e,t,t?"bind":"unbind",a)).catch(I.dummyCatch)}))},this.onSave=e=>{this.setState({tags:e},(()=>{const{store:e}=this.props;e.set(f.peerProfileManageTags.bind(null,[...this.state.tags])).then((e=>{const t=e.get().peer_profile_tags;this.setState({isCollapsed:0===t.length,tags:t,isTagsModalOpened:!1}),(0,o.showDoneBox)(u.getLang("mail_im_peer_profile_manage_tags_success"),{out:1e3})})).catch(I.dummyCatch)}))},this.onNoteSave=e=>{const{store:t}=this.props,s=t.get().peer;t.set(f.peerProfileSaveNote.bind(null,s,e)).then((()=>{this.setState({note:e,isNoteModalOpened:!1}),(0,o.showDoneBox)(e?u.getLang("mail_im_peer_profile_save_note_success"):u.getLang("mail_im_peer_profile_delete_note_success"),{out:1e3})})).catch(I.dummyCatch)},this.toggleModal=(e,t,s)=>{switch(e&&e.preventDefault(),s){case"tags":this.setState({isTagsModalOpened:t});break;case"note":this.setState({isNoteModalOpened:t})}t&&(0,_.cancelStackPush)(y,(()=>{(0,_.cancelStackFilter)(y),this.toggleModal(null,!1,s)}))};const{store:t}=e,s=t.get(),a=s.peer,n=(0,c.getTab)(s,a),i=n.peer_profile_info||{};this.state={isCollapsed:!0,tags:s.peer_profile_tags||[],peerTags:n.peer_tags?n.peer_tags.ids:[],note:i.note,isTagsModalOpened:!1,isNoteModalOpened:!1}}}S.propTypes={store:l().object.isRequired}},301063:(e,t,s)=>{s.d(t,{PeerProfileNoteModal:()=>m});var a=s(785893),n=s(667294),i=s(45697),o=s.n(i),r=s(682615),l=s(659397),c=s(29271),d=s(240567),_=s(589897),g=s(442717),u=s(92116);class m extends n.Component{componentDidMount(){this.inputRef.current.focus()}render(){const e=(0,r.classNames)("PeerProfileNoteModal",{"PeerProfileNoteModal--hidden":this.state.isConfirmationModalOpen}),t=[...this.props.note?[(0,a.jsx)(_.default,{size:"m",appearance:"link",onClick:e=>this.toggleConfirmationModal(e,!0),className:"PeerProfileNoteModal__deleteButton",children:c.getLang("mail_im_peer_profile_note_delete_link")},"delete")]:[],(0,a.jsx)(_.default,{size:"m",appearance:"tertiary",onClick:this.props.onClose,children:c.getLang("global_cancel")},"cancel"),(0,a.jsx)(_.default,{size:"m",onClick:this.onSubmit,loading:this.state.isLoading,children:c.getLang("global_save")},"save")];return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(d.BaseModal,{onClose:this.props.onClose,className:e,disableBackdropClick:!0,disableEscapeClose:!0,children:(0,a.jsxs)("form",{onSubmit:this.onSubmit,children:[(0,a.jsx)(g.Modal.Header,{title:c.getLang("mail_im_peer_profile_note_box_title"),onClose:this.props.onClose,appearance:"blue"}),(0,a.jsx)(g.Modal.Body,{children:(0,a.jsx)(u.Textarea,{className:"PeerProfileNoteModal__input",value:(0,l.decodeHTMLEntities)(this.state.note),placeholder:c.getLang("mail_im_peer_profile_note_box_placeholder"),onChange:this.onChange,style:{height:21},maxLength:96,getRef:this.inputRef})}),(0,a.jsx)(g.Modal.Footer,{actionButtons:t})]})}),this.state.isConfirmationModalOpen&&(0,a.jsx)(g.Modal,{title:c.getLang("global_warning"),appearance:"blue",actionButtons:[(0,a.jsx)(_.default,{appearance:"tertiary",onClick:e=>this.toggleConfirmationModal(e,!1),children:c.getLang("global_cancel")},"cancel"),(0,a.jsx)(_.default,{onClick:e=>{this.toggleConfirmationModal(e,!1),this.setState({note:""},(()=>this.onSubmit(null,!0)))},children:c.getLang("global_delete")},"delete")],onClose:e=>this.toggleConfirmationModal(e,!1),className:"PeerProfileConfirmationModal",children:c.getLang("mail_im_peer_profile_note_delete_confirmation_text")})]})}constructor(e){super(e),this.onChange=e=>{const t=e.target.value;this.setState({note:t})},this.onSubmit=(e,t=!1)=>{e&&e.preventDefault();const s=this.state.note&&this.state.note.trim();t||s?(this.setState({isLoading:!0}),this.props.onNoteSave(s)):this.setState({note:""})},this.toggleConfirmationModal=(e,t)=>{e&&e.preventDefault(),this.setState({isConfirmationModalOpen:t})},this.state={note:e.note||"",isLoading:!1,isConfirmationBoxOpen:!1,isConfirmationModalOpen:!1},this.inputRef=n.createRef()}}m.propTypes={note:o().string,onClose:o().func.isRequired,onNoteSave:o().func.isRequired}},209937:(e,t,s)=>{s.d(t,{PeerProfileTagsGrid:()=>l});var a=s(785893),n=s(667294),i=s(45697),o=s.n(i),r=s(805552);class l extends n.Component{render(){const{tags:e}=this.props;return(0,a.jsx)("div",{className:"PeerProfileTagsGrid",children:e.map(((e,t)=>(0,a.jsx)(r.PeerProfileTagsGridItem,{data:e,onCheckboxChange:this.onCheckboxChange},t)))})}constructor(...e){super(...e),this.onCheckboxChange=(e,t)=>{this.props.onPeerTagsChange(e,t)}}}l.propTypes={tags:o().array.isRequired,onPeerTagsChange:o().func.isRequired}},805552:(e,t,s)=>{s.d(t,{PeerProfileTagsGridItem:()=>l});var a=s(785893),n=(s(667294),s(45697)),i=s.n(n),o=s(659397),r=s(866781);function l({data:e,onCheckboxChange:t}){const s=(0,o.decodeHTMLEntities)(e.name);return(0,a.jsx)("div",{className:"PeerProfileTagsGridItem",onClick:s=>{s&&s.preventDefault(),t(e.id,!e.isChecked)},children:(0,a.jsxs)(r.default,{className:"PeerProfileTagsGridItem__checkbox",checked:e.isChecked,onChange:(s,a)=>t(e.id,a),children:[(0,a.jsx)("span",{className:"PeerProfileTagsGridItem__color",style:{backgroundColor:e.color}}),(0,a.jsx)("span",{className:"PeerProfileTagsGridItem__name",title:s,children:s})]})})}l.propTypes={data:i().object.isRequired,onCheckboxChange:i().func.isRequired}},435742:(e,t,s)=>{s.d(t,{PeerProfileTagsList:()=>d});var a=s(785893),n=s(667294),i=s(45697),o=s.n(i),r=s(29271),l=s(907964),c=s(655552);class d extends n.Component{render(){const{peerTags:e,tags:t,isPeerProfileCollapsed:s,adId:n,hasAdAccess:i,isEasyPromotedMarket:o,toggleProfile:d,isMailRuAd:_}=this.props;let g=t.filter((t=>e.includes(t.id)));n&&g.unshift({adId:n,hasAdAccess:i,isEasyPromotedMarket:o,isMailRuAd:_});let u=0;if(s&&this.state.isTagsCollapsed&&g.length>5){u=g.splice(5).length}return g=g.map(((e,t)=>(0,a.jsx)(c.PeerProfileTagsListItem,{data:e},t))),(0,a.jsxs)("div",{className:"PeerProfileTagsList",children:[g.length>0&&g,u>0&&(0,a.jsx)("div",{className:"PeerProfileTagsListItem PeerProfileTagsListItem--extra",onClick:this.onExtraClick,children:`+ ${r.getLang("mail_im_peer_profile_extra_tags",u)}`}),!g.length&&(0,a.jsxs)("div",{className:"PeerProfileTagsListItem--empty",children:[r.getLang("mail_im_peer_profile_tags_empty")," ",(0,a.jsx)("span",{className:"PeerProfileTagsList__linkDivider",children:"·"})," ",(0,a.jsx)(l.default,{className:"PeerProfileTagsList__toggleProfileLink",onClick:d,children:s?r.getLang("mail_im_peer_profile_toggle_tags_on"):r.getLang("mail_im_peer_profile_toggle_tags_off")})]})]})}constructor(e){super(e),this.onExtraClick=()=>{this.setState({isTagsCollapsed:!1})},this.state={isTagsCollapsed:!0}}}d.propTypes={tags:o().array.isRequired,peerTags:o().array.isRequired,isPeerProfileCollapsed:o().bool.isRequired,adId:o().number,hasAdAccess:o().bool,isEasyPromotedMarket:o().bool,toggleProfile:o().func.isRequired,isMailRuAd:o().bool}},655552:(e,t,s)=>{s.d(t,{PeerProfileTagsListItem:()=>_});var a=s(785893),n=s(667294),i=s(45697),o=s.n(i),r=s(659397),l=s(514986),c=s(29271),d=s(523305);class _ extends n.Component{render(){const{data:e}=this.props;if(e.adId){const t=(0,d.createAdUrl)(e.isMailRuAd,e.adId);let s="";if(e.isEasyPromotedMarket)s=c.getLang("mail_ad_tag_easy_promoted_market");else{const t=e.isMailRuAd?c.getLang("mail_ad_mail_ru_tag_text_prefix"):c.getLang("mail_ad_tag_text_prefix");s=e.hasAdAccess?`${t} ${e.adId}`:c.getLang("mail_ad_tag_no_access_text")}const n=(0,a.jsx)("span",{className:"PeerProfileTagsListItem__adTagText",children:s});return(0,a.jsxs)("div",{className:"PeerProfileTagsListItem PeerProfileTagsListItem--adTag",children:[e.hasAdAccess&&(0,a.jsx)("a",{className:"PeerProfileTagsListItem__adTagLink",href:t,target:"_blank",children:n}),!e.hasAdAccess&&(0,a.jsx)("button",{className:"PeerProfileTagsListItem__adTagAlert",onClick:this.onAdTagAlertClick,children:n})]})}return(0,a.jsx)("div",{className:"PeerProfileTagsListItem",style:{backgroundColor:e.color},children:(0,a.jsx)("span",{children:(0,r.decodeHTMLEntities)(e.name)})})}constructor(...e){super(...e),this.onAdTagAlertClick=()=>{(0,l.showFastBox)(c.getLang("mail_ad_tag_no_access_box_title"),c.getLang("mail_ad_tag_no_access_box_text"))}}}_.propTypes={data:o().object.isRequired}},433636:(e,t,s)=>{s.d(t,{PeerProfileTagsModal:()=>T});var a=s(434788),n=s(785893),i=s(667294),o=s(45697),r=s.n(o),l=s(682615),c=s(659397),d=s(221780),_=s(29271),g=s(240567),u=s(589897),m=s(907964),p=s(442717),h=s(364517),f=s(235714);const b=["#4bb34b","#5c9ce6","#e64646","#792ec0","#63b9ba","#ffa000","#ffc107","#76787a","#9e8d6b","#45678f","#539b9c","#454647","#7a6c4f","#6bc76b","#5181b8","#ff5c5c","#a162de","#7ececf","#aaaeb3","#bbaa84"],v=b[0],C="deleted";class T extends i.Component{render(){const{tags:e,isConfirmationModalOpen:t,indexToRemove:s}=this.state,a=e[s],i=(0,l.classNames)("PeerProfileTagsModal",{"PeerProfileTagsModal--hidden":t});return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(g.BaseModal,{onClose:this.props.onClose,className:i,disableBackdropClick:!0,disableEscapeClose:!0,children:(0,n.jsxs)("form",{onSubmit:this.onSubmit,children:[(0,n.jsx)(p.Modal.Header,{title:_.getLang("mail_im_peer_profile_manage_tags_box_title"),onClose:this.props.onClose,appearance:"blue"}),(0,n.jsx)(p.Modal.Body,{children:(0,n.jsx)(h.Scroll,{className:"PeerProfileTagsModal__scroll",neverHide:!0,children:(0,n.jsxs)("div",{className:"PeerProfileTagsModal__tagsInputs",ref:this.inputsRef,children:[this.state.tags.map(((e,t)=>(0,n.jsx)(f.PeerProfileTagsModalField,{index:t,data:e,onNameChange:this.onNameChange,onRemove:this.onRemove},t))),this.state.tags.length<20?(0,n.jsx)(m.default,{className:"PeerProfileTagsModal__addLink",onClick:this.onAddLinkClick,children:_.getLang("mail_im_peer_profile_manage_tags_add_link")}):""]})})}),(0,n.jsx)(p.Modal.Footer,{actionButtons:[(0,n.jsx)(u.default,{size:"m",appearance:"tertiary",onClick:this.props.onClose,children:_.getLang("global_cancel")},"cancel"),(0,n.jsx)(u.default,{size:"m",onClick:this.onSubmit,loading:this.state.isLoading,children:_.getLang("global_save")},"save")]})]})}),t&&(0,n.jsx)(p.Modal,{title:_.getLang("global_warning"),appearance:"blue",actionButtons:[(0,n.jsx)(u.default,{appearance:"tertiary",onClick:e=>this.toggleConfirmationModal(e,!1),children:_.getLang("global_cancel")},"cancel"),(0,n.jsx)(u.default,{onClick:e=>{this.toggleConfirmationModal(e,!1),this.onRemove(this.state.indexToRemove,!0)},children:_.getLang("global_delete")},"delete")],onClose:e=>this.toggleConfirmationModal(e,!1),className:"PeerProfileConfirmationModal",children:(0,d.langStr)(1===a.uses?_.getLang("mail_im_peer_profile_tag_delete_confirmation_text_single"):_.getLang("mail_im_peer_profile_tag_delete_confirmation_text",a.uses,!0),"tag_name",(0,c.decodeHTMLEntities)(a.name))})]})}constructor(e){super(e),this.generateEmptyTag=()=>({name:"",color:this.state&&this.state.tags.length?this.getAvailableColor():v,state:"new"}),this.getAvailableColor=()=>{const e=[...this.state.tags].reduce(((e,t)=>(t.state!==C&&(e[t.color]=!0),e)),{});return b.find((t=>!e[t]))},this.onAddLinkClick=e=>{e&&e.preventDefault(),this.state.tags.filter((e=>e.state!==C)).length>=20||this.setState((e=>({tags:[...e.tags,this.generateEmptyTag()]})),(()=>{this.inputsRef.current.scrollIntoView({block:"end"})}))},this.onNameChange=(e,t)=>{const s=e.target.value;this.setState({tags:this.state.tags.map(((e,n)=>n===t?(0,a._)({},e,{name:s,state:e.state||"changed"}):e))})},this.onRemove=(e,t=!1)=>{const s=this.state.tags[e];!t&&s.id&&s.uses>0?this.setState({isConfirmationModalOpen:!0,indexToRemove:e}):this.setState({tags:this.state.tags.filter(((t,s)=>s!==e)),deletedTags:[...this.state.deletedTags,(0,a._)({},s,{state:C})]})},this.onSubmit=e=>{e&&e.preventDefault();const t=[...this.state.tags,...this.state.deletedTags].reduce(((e,t)=>(t.name.trim()&&t.state&&e.push({id:t.id,name:t.name,color:t.color,state:t.state}),e)),[]);this.setState({isLoading:!0}),this.props.onSave(t)},this.toggleConfirmationModal=(e,t)=>{e&&e.preventDefault(),this.setState({isConfirmationModalOpen:t})},this.state={tags:e.tags.length?e.tags.map((e=>(0,a._)({},e))):[this.generateEmptyTag()],deletedTags:[],isLoading:!1,isConfirmationModalOpen:!1,indexToRemove:null},this.inputsRef=i.createRef()}}T.propTypes={onClose:r().func.isRequired,tags:r().array.isRequired,onSave:r().func.isRequired}},235714:(e,t,s)=>{s.d(t,{PeerProfileTagsModalField:()=>_});var a=s(785893),n=s(667294),i=s(45697),o=s.n(i),r=s(29271),l=s(752654),c=s(659397),d=s(579431);class _ extends n.Component{componentDidMount(){this.props.data.id||this.inputRef.current.focus()}render(){const{index:e,data:t,onNameChange:s,onRemove:n}=this.props;return(0,a.jsxs)("div",{className:"PeerProfileTagsModalField",children:[(0,a.jsx)("input",{type:"hidden",value:t.id?t.id:""}),(0,a.jsx)("input",{type:"text",className:"PeerProfileTagsModalField__input",value:(0,c.decodeHTMLEntities)(t.name),ref:this.inputRef,onChange:t=>s(t,e),onKeyDown:this.onKeyDown,maxLength:20,placeholder:r.getLang("mail_im_peer_profile_manage_tags_placeholder")}),(0,a.jsx)("span",{className:"PeerProfileTagsModalField__color",style:{backgroundColor:t.color}}),(0,a.jsx)(l.default,{position:"t",text:r.getLang("mail_im_peer_profile_manage_tags_remove"),children:(0,a.jsx)("span",{className:"PeerProfileTagsModalField__remove",onClick:()=>n(e),children:(0,a.jsx)(d.Icon20Cancel,{})})})]})}constructor(e){super(e),this.onKeyDown=e=>"Enter"!==e.key||(e.preventDefault(),!1),this.inputRef=n.createRef()}}_.propTypes={index:o().number.isRequired,data:o().object.isRequired,onNameChange:o().func.isRequired,onRemove:o().func.isRequired}},733097:(e,t,s)=>{s.d(t,{mount:()=>f});var a=s(514986),n=s(29271),i=s(795558),o=s(875610),r=s(527405),l=s(15080),c=s(95638),d=s(95432),_=s(854099);const g="_im_join_chat",u="_im_accept_mr",m="_im_reject_mr",p="_im_join_chat_donut";function h(e){return e.parentNode.getAttribute("data-receiver-chat-peer-id")}function f(e,t,s){const f=(0,l.createModule)({handlers:(l,f)=>{f(e,"click",g,(e=>function(e,t){const s=(0,i.domData)(t,"chat-id"),r=(0,i.domData)(t,"hash"),l=(0,i.domData)(t,"chat-link");return _.FlatButton.lock(t),(0,o.joinChat)(s,r,l,e.get()).then((([s])=>{_.FlatButton.unlock(t);const a=e.get();a.longpoll.push([(0,c.changePeer)(s)]),a.onJoinChat&&a.onJoinChat(s)})).catch((e=>{(0,a.showFastBox)(n.getLang("mail_join_invite_error_title"),e),_.FlatButton.unlock(t)}))}(t,e.target))),f(e,"click",u,(e=>function(e,t){const s=h(t);return _.FlatButton.lock(t),e.set(o.acceptMessageRequest.bind(null,s)).then((()=>{_.FlatButton.unlock(t),e.get().longpoll.push([(0,c.changePeer)(s,!1,!1,!1,"chat_preview")])})).catch((e=>{(0,r.hideAllBoxes)(),(0,a.showFastBox)(n.getLang("mail_join_invite_error_title"),e),_.FlatButton.unlock(t)}))}(t,e.target))),f(e,"click",m,(e=>function(e,t,s){const i=h(s);return _.FlatButton.lock(s),e.set((e=>(0,o.rejectMessageRequest)(i,!1,e))).then((()=>{t.updateMenu(),t.updateList(),_.FlatButton.unlock(s),(0,r.hideAllBoxes)()})).catch((e=>{(0,r.hideAllBoxes)(),(0,a.showFastBox)(n.getLang("mail_error"),e),_.FlatButton.unlock(s)}))}(t,s,e.target))),f(e,"click",p,(e=>function(e,t){const s=(0,i.domData)(t,"chat-id"),l=(0,i.domData)(t,"hash"),_=(0,i.domData)(t,"chat-link"),g=(0,i.domData)(t,"owner-id");(0,r.hideAllBoxes)(),(0,d.showDonutSubscribePopup)(null,null,g,"chat_preview","",{type:"subscribe",params:{act:"subscribe_popup"},onSuccessPayment:()=>{(0,o.joinChat)(s,l,_,e.get()).then((([t])=>{var s;const a=e.get();null==(s=a.longpoll)||s.push([(0,c.changePeer)(t)]),a.onJoinChat&&a.onJoinChat(t)})).catch((e=>{(0,a.showFastBox)(n.getLang("mail_join_invite_error_title"),e)}))}})}(t,e.target)))}});return{unmount(){(0,l.destroyModule)(f)}}}},489141:(e,t,s)=>{s.d(t,{convertEmojiHtmlToRegularText:()=>d,findLastMessageToEdit:()=>_,isOutOfMessageEditingTime:()=>c,replaceMsgAfterEdit:()=>u,wasMessageReallyModified:()=>g});var a=s(222009),n=s(82161),i=s(894523),o=s(527405),r=s(755320),l=s(705758);function c(e,t){return Date.now()/1e3-t>e.pinMessageEditSettings.messageEditAllowedTime}function d(e){let t=document.createElement("div");return e=e.replace(/\[((id|club)\d+)\|(.+?)]/g,((...e)=>{const t=e[1],s=e[3];return/^\@/.test(s)?s:`@${t} (${s})`})),t.innerHTML=e,Emoji.val(t)}function _(e,t){return+(t&&t.msgs?Object.keys(t.msgs):[]).filter((e=>e>0)).sort(((e,t)=>t-e)).find((s=>function(e,t){t=(0,a.parserMessage)(t);const s=(0,l.unpackStore)(e),n=vk.id==t.peerId&&!s.gid,{messageEditAllowedTime:r,pinEditDelayTime:c,isPinEditEnabled:d}=s.pinMessageEditSettings,_=Date.now()/1e3,g=(0,a.getPinnedMessage)(s),u=g&&g.messageId===t.messageId,m=t.kludges&&t.kludges.pinned_at,p=_-t.date>r,h=m&&_-m<c;if(333==t.peerId)return!1;if(!n&&!(0,i.isOut)(t))return!1;if((0,i.isServiceMsg)(t))return!1;if((0,i.isGift)(t)||(0,i.isSticker)(t)||(0,i.isAudioMsg)(t)||(0,i.isGraffiti)(t)||(0,i.isMoney)(t)||(0,i.isVKPay)(t)||(0,i.isCallMessage)(t)||(0,i.isCasperMessage)(t))return!1;if((0,o.isAlreadyDeleted)(e,t.peerId,t.messageId))return!1;if(n)return!0;if(u&&p&&d){if(h)return!1}else if(p)return!1;return!0}(e,t.msgs[s])))||null}function g(e,t,s){let a=(0,r.convertKludgesToAttaches)(t.kludges,t.messageId),n=s.dData.attaches;if(d(t.text)!==s.dData.txt||a.length!==n.length)return!0;for(let e=a.length;e--;){const t=a[e],s=n[e];if(t.id!=s.id||t.type!=s.type||"poll"==t.type&&s.object&&s.object.poll_is_edited)return!0}return!1}function u(e,t,s,a,i,r){t.origText=s,t.text=(0,o.replaceSpecialSymbols)((0,n.clean)(s)).replace(/\n/gi,"<br>"),t.attaches=a,t.kludges.emoji=1,t.local=1,t.share_url=i,t.cancelled_shares=r,t.update_time=Math.floor(Date.now()/1e3),e.get().tabs[t.peerId].msgs[t.messageId]=t}},37396:(e,t,s)=>{s.d(t,{ImDraft:()=>r,loadDraftForPeer:()=>c});var a=s(302925),n=s(82161),i=s(835200),o=s(875610);function r(e,t){this._db=e,this._key=t,this.dData={txt:"",attaches:[],urlBinds:[],cancelled:[]},this.load()}function l(e){switch(e.type){case"mail":case"reply":return e.id<0&&1==e.object.fwd_count;default:return!e.object}}function c(e,t){return new r(e,"draft_"+t)}r.prototype.dump=function(){if(!this._key)return;const e={txt:(t=this.dData).txt,attaches:t.attaches.length?t.attaches:void 0,urlBinds:t.urlBinds.length?t.urlBinds:void 0,cancelled:t.cancelled.length?t.cancelled:void 0};var t;const s=0===e.txt.length&&!e.attaches&&!e.urlBinds&&!e.cancelled;this._db.updateByKey(this._key,s?void 0:e)},r.prototype.load=function(){if(this._key){let e=this._db.selectByKey(this._key);e&&(this.dData=function(e){return{txt:e.txt,attaches:e.attaches||[],urlBinds:e.urlBinds||[],cancelled:e.cancelled||[]}}(e))}},r.prototype.clear=function(){this.dData={txt:"",attaches:[],urlBinds:[],cancelled:[]},this.dump()},r.prototype.setText=function(e){this.dData.txt=(0,n.trim)(e),this.dump()},r.prototype.addAttach=function(e,t,s){if("share"===e&&this.removeAttachByType(e),"mail"!==e&&"reply"!==e||(this.removeAttachByType("mail"),this.removeAttachByType("reply")),"audio_playlist"===e||"artist"===e){if(this.dData.attaches.find((t=>t.type===e)))return!1}if(!e||!t&&"poll"!==e)return!1;const a=this.dData.attaches.findIndex((s=>s.type===e&&s.id===t));-1===a?(this.dData.attaches.push({type:e,id:t,object:s}),this.dump()):"video"!==e&&"poll"!==e||(this.dData.attaches[a]={type:e,id:t,object:s},this.dump())},r.prototype.syncWithSelector=function(e){let t=this.getFwdRaw();this.dData.attaches=(t?[t]:[]).concat(e.getMedias().map((([e,t])=>this.dData.attaches.find((s=>s.type==e&&s.id==t))||{type:e,id:t}))),this.dump()},r.prototype.removeAttachByType=function(e){for(let t=this.dData.attaches.length;t--;)this.dData.attaches[t].type===e&&this.dData.attaches.splice(t,1);this.dump()},r.prototype.removeAllAttaches=function(){this.dData.attaches=[],this.dData.cancelled=[],this.dump()},r.prototype.addBindUrl=function(e,t,s){this.getBoundAttach(e)||(this.dData.urlBinds.push({url:e,type:t,id:s}),this.dump())},r.prototype.getBoundAttach=function(e){let t=this.dData.urlBinds.find((t=>t.url===e));return t&&this.dData.attaches.find((e=>e.type===t.type&&e.id===t.id))||null},r.prototype.getShareUrl=function(){let e=this.dData.attaches.find((e=>"share"===e.type));if(e&&e.object)return e.object.url.replace(/&amp;/g,"&")},r.prototype.hasOnlyReplies=function(e=null){return e?e.flags&i.FLAG_HAS_REPLY&&!this.dData.attaches.find((e=>"mail"!==e.type)):this.hasAttaches()&&!this.dData.attaches.find((e=>"reply"!==e.type))},r.prototype.getCancelledShares=function(){return this.dData.cancelled.length?this.dData.cancelled:void 0},r.prototype.hasAttaches=function(){return this.dData.attaches.length>0},r.prototype.destroy=function(){this.dData={},this._key=this._db=null},r.prototype.prepareObjects=function(e,t){return this.dData.attaches.find(l)?(0,a.post)(o.CONTROLLER,{act:"draft_medias",gid:e,messageId:t||0,media:t?void 0:this.dData.attaches.map((e=>[e.type,e.id])).join("*")}).then((([e])=>{this.dData.attaches=e.map((e=>({type:e[0],id:e[1],object:e[2]})))})):Promise.resolve()},r.prototype.getFwdRaw=function(){return this.dData.attaches.find((e=>"mail"===e.type||"reply"===e.type))},r.prototype.getFwdCount=function(){let e=this.getFwdRaw();return e?e.id<0?e.object.fwd_count:e.id.split(";").length:0}},590646:(e,t,s)=>{s.d(t,{oCacheAdd:()=>n.oCacheAdd,oCacheExists:()=>a.oCacheExists,oCacheGet:()=>a.oCacheGet});var a=s(823826),n=s(816893)},528283:(e,t,s)=>{s.d(t,{getPeerProfileHeight:()=>d,mount:()=>g});var a=s(785893),n=(s(667294),s(795558)),i=s(973935),o=s(222009),r=s(527405),l=s(242426);function c(){return document.querySelector("#PeerProfile")}function d(){const e=c();return e?e.offsetHeight:0}function _(e,t){if(!t)return void e.style.removeProperty("padding-top");const s=parseInt((0,n.getStyle)(e,"padding-top"));e.style.paddingTop=s+d()+"px"}function g(e){return{render(t){const s=t.get(),n=c(),d=s.peer,g=(0,o.getTab)(s,d);s.is_peer_profile_enabled&&n&&(0,r.isFullyLoadedTab)(s,d)&&!(0,o.isChannelPeer)(g)&&!(0,o.isCommunityChat)(t,d)&&(n.innerHTML&&i.unmountComponentAtNode(n),i.render((0,a.jsx)(l.PeerProfile,{store:t}),n,(()=>{_(e,!0)})))},destroy(){const t=c();t&&(i.unmountComponentAtNode(t),_(e,!1))}}}},824264:(e,t,s)=>{s.d(t,{mount:()=>o});var a=s(15080),n=s(527405);function i(e){return{unmount(){(0,a.destroyModule)(e)}}}function o(e,t,s,o){const{bindMutations:r}=(0,a.createMutations)(i),l=t=>{s().messageKeyboardButtonClick(t),e.hide()};return r((0,a.createModule)({handlers:(t,s)=>{s(e.bodyNode,"click",n.MESSAGE_KEYBOARD_BUTTON_CLASS,l),s(e.bodyNode,"click",n.MESSAGE_ASR_COLLAPSE_TOGGLE_BUTTON,n.onASRCollapseToggleClick)}}))}},343394:(e,t,s)=>{s.d(t,{isPinnedMessageVisibleInTab:()=>b,mount:()=>S,pinnedMessageHide:()=>v,pinnedMessageUnHide:()=>C,pinnedMessageUnpin:()=>T});var a=s(15080),n=s(29271),i=s(504867),o=s(795558),r=s(875610),l=s(824264),c=s(527405),d=s(222009),_=s(705758),g=s(227575),u=s(320422),m=s(408014),p=s(931917);const h="_im_pin_hide",f="_im_pinned_message";function b(e,t){if((0,_.unpackStore)(e).searchShown)return!1;const s=(0,d.getTab)(e,t);return!!(s&&p.Ranges.isChatOrChannelPeer(t)&&s.pinned)&&!(0,m.isPinnedMessageHidden)(s)}function v(e,t,s,a=!0){let n=(0,d.getTab)(e,t),r=n&&(0,d.parserMessage)(n.pinned);n&&r&&(n.pinHideId=r.chat_local_id,cur.imDb.update(g.PIN_HIDDEN_ID_OP,[n.peerId,n.pinHideId]),E(s,t,e),(0,o.re)((0,o.geByClass1)("_im_pinned_tt")),a&&window.Notifier&&Notifier.lcSend("pin_hide",{hide:1,peer:t}),(0,i.statlogsValueEvent)("im_pinned_messages","hide"))}function C(e,t,s,a=!0){let n=(0,d.getTab)(e,t);n&&n.pinHideId&&(delete n.pinHideId,cur.imDb.update(g.PIN_HIDDEN_ID_OP,[n.peerId,void 0]),E(s,t,e),a&&window.Notifier&&Notifier.lcSend("pin_hide",{hide:0,peer:t}),(0,i.statlogsValueEvent)("im_pinned_messages","show"))}function T(e,t,s){const a=E.bind(null,s,t);let n=(0,c.showUnpinDialog)((()=>{n.hideProgress(),n.hide(),e.set(r.unpinMessageOptimistic.bind(null,t)).then(a).then((e=>e.set(r.unpinMessage.bind(null,t)))).then(a)}))}function L(e,t,s){const a=e.get().peer,n=(0,d.parserMessage)((0,d.getTab)(e,a).pinned);if(s.target.classList.contains(h))n&&v(e,a,t);else if("A"!==s.target.tagName){const o=n&&n.messageId;o&&!(0,c.isAlreadyDeleted)(e,a,o)?(0,c.focusOnMessage)(e,t().focusOnMessage,a,o):(0,c.showPinnedBox)(e,t,a,l.mount,s),(0,i.statlogsValueEvent)("im_pinned_messages","open")}}function E(e,t,s){return e().updateChatTopic(t,s),(0,r.setActions)(s.get()),e().updateActions(s),s}function I(e){(0,u.showTooltip)(e.target,{text:n.getLang("mail_hide_unpin_hover"),black:1,needLeft:1,shift:[8,4],forcetoup:!0,className:"_im_pinned_tt",appendEl:document.body})}function y(e){return{unmount(){(0,a.destroyModule)(e)}}}function S(e,t,s){const{bindMutations:n}=(0,a.createMutations)(y),i=L.bind(null,t,s),o=I.bind(null);return n((0,a.createModule)({handlers:(t,s)=>{s(e,"click",f,i),s(e,"mouseover",h,o)}}))}},222009:(e,t,s)=>{s.d(t,{checkVoiceMessageAvailable:()=>B,countUnread:()=>y,doPopularSuggExist:()=>q,existsIncomingMessageRequest:()=>te,getAttachIdFromMessage:()=>oe,getAuthorFullName:()=>A,getBareTab:()=>M,getCurrentKeyboard:()=>T,getFirstUnread:()=>v,getGroupId:()=>V,getKeyboard:()=>L,getLastMessage:()=>S,getLocalId:()=>u.getLocalId,getMessage:()=>R,getMessageRangeFromSelection:()=>I,getPinnedMessage:()=>$,getSearchText:()=>U,getSelectedMessages:()=>E,getTab:()=>_.getTabSafe,getTabDraft:()=>Y,getTemplates:()=>W,getUnreadScrollBottom:()=>D,isAnyMessageBeingEdited:()=>K,isBusinessNotifyChangedEvent:()=>ae,isCasperChat:()=>ie,isCasperChatTab:()=>_.isCasperChatTab,isChannelPeer:()=>_.isChannelPeer,isChatActive:()=>_.isChatActive,isClassicInterface:()=>g.isClassicInterface,isCommunityBlocked:()=>H,isCommunityChat:()=>ne,isCommunityInterface:()=>g.isCommunityInterface,isFoldersAvailable:()=>P,isFullyLoadedTab:()=>_.isFullyLoadedTab,isGoToEndVisible:()=>O,isGoToMentionVisible:()=>N,isGoToReactionAvailable:()=>x,isLocksAvailable:()=>k,isMessageRequestChangedEvent:()=>se,isMessageRequestFolder:()=>X,isRecentSearchesActive:()=>G,isReversedDialogs:()=>g.isReversedConvoOrder,isSearchShown:()=>C,isSearching:()=>g.isSearchView,isSearchingValue:()=>j,isSendingAvailable:()=>F,isTabMarkedUnread:()=>_.isTabMarkedUnread,makeTabNotFullyLoaded:()=>w,parserMessage:()=>m.parseMessage,removeMessageRequestFolderFlags:()=>Z,tabIsMessageRequest:()=>z,tabIsMessageRequestToChat:()=>J,tabIsOutgoingMessageRequest:()=>ee,tabIsRejectedMessageRequest:()=>Q});var a=s(894523),n=s(82161),i=s(835200),o=s(165203),r=s(590646),l=s(37396),c=s(705758),d=s(568012),_=s(408014),g=s(502478),u=s(783400),m=s(49988),p=s(728785),h=s(874223),f=s(839470),b=s(931917);function v(e,t){const s=(0,c.unpackStore)(e),i=s.tabs[s.peer];return Object.keys(i.msgs).filter((s=>{const o=R(e,t,s);return(0,f.partConfigEnabled)("me_web_read_by_cmid")?!(0,a.isOut)(o)&&(0,n.intval)(o.chat_local_id)>i.in_up_to_cmid:!(0,a.isOut)(o)&&(0,n.intval)(s)>i.in_up_to}))[0]}function C(e){return(0,c.unpackStore)(e).searchShown}function T(e){return L(e,(0,g.getPeer)(e))}function L(e,t){const{keyboard:s}=(0,_.getTabSafe)(e,t)||{};if(!s||!s.buttons||s.buttons.length)return s}function E(e){return(0,c.unpackStore)(e).selectedMessages}function I(e,t,s){const i=(0,_.getTabSafe)(e,t),o=E(e)[0];if(void 0===o)return[s];const r=Math.min(s,o),l=Math.max(s,o);return Object.keys(i.msgs).filter((e=>e>=r&&e<=l)).filter((t=>{const s=R(e,e.get().peer,t);return!(0,a.isServiceMsg)(s)&&!(0,a.isCallMessage)(s)})).map(n.intval)}function y(e,t){const s=(0,c.unpackStore)(t);let n=(0,_.getTabSafe)(s,e),i=0;for(let s in n.msgs)if(n.msgs.hasOwnProperty(s)){const o=R(t,e,s);(0,a.isOut)(o)||(i+=(0,a.isUnread)(n,o)?1:0)}return i}function S(e,t,s){const a=(0,_.getTabSafe)(e,t),n=R(e,t,s),o=Object.keys(e.msg_local_ids_sort||{}).length>1?Object.values(a.msgs).sort(((t,s)=>{const{messageId:a}=(0,m.parseMessage)(t),{messageId:n}=(0,m.parseMessage)(s);return(0,u.getLocalId)(e,a)-(0,u.getLocalId)(e,n)})):Object.values(a.msgs);if(!n)return(0,m.parseMessage)(o[o.length-1]);const r=n.local;for(let t=o.length-1;t>=0;t--){const s=(0,m.parseMessage)(o[t]),a=s.local&&s.type!==i.EDIT_MESSAGE;if(!r&&a)continue;if(r&&!a||(0,u.getLocalId)(e,n.messageId)>(0,u.getLocalId)(e,s.messageId))return s}}function A(e,t,s){const n=(0,_.getTabSafe)(e,t),i=R(e,t,s),o=(0,c.unpackStore)(e);return(0,a.isOut)(i)?(0,r.oCacheGet)(e,o.id).name:i.userId!==i.peerId?!!(0,r.oCacheExists)(e,i.userId)&&(0,r.oCacheGet)(e,i.userId).name:n.tab}function R(e,t,s){const a=(0,_.getTabSafe)(e,t),n=a&&a.msgs&&a.msgs[s];return n?(0,m.parseMessage)(n):null}function k(e){return(0,c.unpackStore)(e).gid}function P(e){return(0,c.unpackStore)(e).gid}function M(e,t){let s=(0,c.unpackStore)(t);return s.tabs[e]||s.mapped_index[e]}function w(e,t){let s=(0,_.getTabSafe)(e,t);s&&(s.msgs=void 0,s.msgid=void 0,s.scrollTop=void 0,s.scrollBottom=void 0,s.contHeight=void 0,s.offset=void 0,s.skipped=void 0)}function O(e){const t=e.get().go_to_end_visible;return!!t&&t[0]}function N(e){const t=e.get().go_to_mentions_visible;return!!t&&t[0]}function x(e){return e.get().go_to_reactions_available}function D(e){const t=e.get().go_to_end_visible;return t?t[1]:0}function F(e){return!(0,c.unpackStore)(e).lockedSending}function H(e,t){return!!b.Ranges.isGroupId(t)&&!!(0,_.getTabSafe)(e,t).blocked_community}function B(e){return(0,c.unpackStore)(e).voice_message_available}function U(e){return(0,c.unpackStore)(e).searchText}function j(e,t){const s=(0,c.unpackStore)(e);return!!(t&&t!==U(e)||s.recentSearch)}function G(e){return(0,c.unpackStore)(e).recentSearch}function $(e){const t=(0,_.getCurrentTab)(e);return t&&t.pinned&&(0,m.parseMessage)(t.pinned)}function q(e){let t=e.get().popular_sugg;return t&&t.length>0}function K(e){return 1==(0,c.unpackStore)(e).isEditing}function V(e){return(0,c.unpackStore)(e).gid}function Y(e){return e.draft||(e.draft=(0,l.loadDraftForPeer)(cur.imDb,e.peerId)),e.draft}function W(e){return((0,c.unpackStore)(e).templates||[]).filter((e=>!e.deleted))}function z(e){return!!e&&(0,_.tabIsMessageRequest)(e)}function Q(e){return Boolean(e.folders&o.FOLDER_MASKS[o.FOLDER_MESSAGE_REQUEST_REJECTED])}function J(e){return b.Ranges.isChatOrChannelPeer(e.peerId)&&z(e)}function Z(e){return e&~o.FOLDER_MASKS[o.FOLDER_MESSAGE_REQUEST]&~o.FOLDER_MASKS[o.FOLDER_MESSAGE_REQUEST_REJECTED]&~o.FOLDER_MASKS[p.FOLDER_NOT_IMPORTANT_MESSAGE_REQUEST]}function X(e){return(0,c.unpackStore)(e).active_tab===o.FOLDER_MESSAGE_REQUEST}function ee(e){return b.Ranges.isContactId(e.peerId)}function te(e){return!!(0,h.getConvoListFolderCounterTotal)(e,p.ConvoListFolder.MR)}function se({type:e,updateType:t}){return e===i.CONVERSATION_UPDATED&&(t===i.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED||t===i.MAIL_CHAT_UPDATE_TYPE_CONTACT_CONVERTED)}function ae({type:e,updateType:t}){return e===i.CONVERSATION_UPDATED&&t===i.MAIL_CHAT_UPDATE_TYPE_BUSINESS_NOTIFY_DATA_CHANGED}function ne(e,t){const s=(0,_.getTabSafe)(e,t);return!!s&&(0,_.isCommunityChat)(s)}function ie(e,t){return(0,_.doesChatTabHaveFlag)((0,_.getTabSafe)(e,t),d.MAIL_CHAT_FLAG_IS_CASPER)}const oe=e=>{var t,s;return null==(s=e)||null==(t=s.kludges)?void 0:t.attach1}},165203:(e,t,s)=>{s.d(t,{ARROW_DOWN:()=>i,ARROW_UP:()=>n,END_KEY:()=>l,ENTER:()=>d,FOLDER_ALL:()=>a.FOLDER_ALL,FOLDER_ARCHIVE:()=>a.FOLDER_ARCHIVE,FOLDER_BUSINESS_NOTIFY:()=>a.FOLDER_BUSINESS_NOTIFY,FOLDER_IMPORTANT:()=>a.FOLDER_IMPORTANT,FOLDER_MARKED_UNREAD:()=>a.FOLDER_MARKED_UNREAD,FOLDER_MASKS:()=>a.FOLDER_MASKS,FOLDER_MESSAGE_REQUEST:()=>a.FOLDER_MESSAGE_REQUEST,FOLDER_MESSAGE_REQUEST_REJECTED:()=>a.FOLDER_MESSAGE_REQUEST_REJECTED,FOLDER_PEER_TAGS:()=>a.FOLDER_PEER_TAGS,FOLDER_UNREAD:()=>a.FOLDER_UNREAD,FOLDER_UNRESPOND:()=>a.FOLDER_UNRESPOND,HOME:()=>c,LINE_FEED:()=>m,PAGE_DOWN:()=>r,PAGE_UP:()=>o,PRINTABLE:()=>u,UNPRINTABLE_KEYS:()=>_,UP_DOWN_CONTROLS:()=>g});var a=s(728785);const n=38,i=40,o=33,r=34,l=35,c=36,d=13,_=[n,i,o,r,d,27,l,c],g=[o,r,i,n,c,l],u="printable",m=10},527405:(e,t,s)=>{s.d(t,{AUDIO_MSG_CLASS:()=>xe,BOT_CAROUSEL_CLASS:()=>re,CALL_ENTRY_POINT_HEADER:()=>Ea,CALL_ENTRY_POINT_JOIN_BANNER:()=>Aa,CALL_ENTRY_POINT_JOIN_HEADER:()=>Sa,CALL_ENTRY_POINT_JOIN_SNIPPET:()=>ya,CALL_ENTRY_POINT_LIST:()=>Ia,CALL_ENTRY_POINT_SNIPPET:()=>La,CALL_TRANSCRIPTION_FAILED:()=>Le,CHAT_GROUP_CALL_STARTED:()=>ve,CHAT_INVITE_BY_LINK:()=>fe,CHAT_INVITE_USER:()=>_e,CHAT_KICK_DON:()=>Te,CHAT_KICK_USER:()=>ge,CHAT_KICK_USER_CALL_BLOCK:()=>Ce,CHAT_PHOTO_REMOVE:()=>me,CHAT_PHOTO_UPDATE:()=>ue,CHAT_PIN_MESSAGE:()=>pe,CHAT_SCREENSHOT:()=>be,CHAT_TITLE_ACTION:()=>de,CHAT_UNPIN_MESSAGE:()=>he,CLEAR_RECENT_CLASS:()=>Re,CREATE_CHAT_ACTION:()=>ce,DESELECT_ALL_CLASS:()=>Ee,FAILED_CLASS:()=>k.FAILED_CLASS,HIDE_ASIDE_NOTICE_CLASS:()=>ye,HIDE_ASIDE_PROMO_BLOCK_CLASS:()=>Se,HIDE_TOP_NOTICE_CLASS:()=>Ie,INSTALL_VKADMIN_LINK:()=>Ae,JOIN_CALL_BY_LINK_CLASS:()=>le,MESSAGE_ASR_COLLAPSE_TOGGLE_BUTTON:()=>De,MESSAGE_KEYBOARD_BUTTON_CLASS:()=>ne,MESSAGE_SEARCH_CLASS:()=>Oe,MESSAGE_STACK_CLASS:()=>ie,MSG_DUPLICATE:()=>mt,MSG_LOCAL_DUPLICATE:()=>pt,MSG_NEW:()=>ut,PINNED_CONTAINER_CLASS:()=>Ne,RESTORE_CLASS:()=>se,SENDING_CLASS:()=>k.SENDING_CLASS,TOGGLE_ALL_TAB:()=>we,TOGGLE_ARCHIVES_TAB:()=>Me,TOGGLE_BUSINESS_NOTIFY_TAB:()=>Pe,TOGGLE_MR_TAB:()=>ke,TYPING_CLASS:()=>ae,addChatPhotoToUpdate:()=>Jt,applyInnerHtml:()=>ze,applyMessageHandlers:()=>Vs,blockLatencyCompensation:()=>vs,canForwardMessages:()=>da,canMarkImportant:()=>_a,canMessageBeDeletedForAll:()=>ta,canPinMessage:()=>ca,changeTab:()=>us,checkMessageRequestsTab:()=>oa,checkSelectClick:()=>ss,cleanHistory:()=>cs,compensateHistoryHeightChange:()=>Qe,convertLegacyOnlineToAPIFlags:()=>Dt,convertPeerToUrl:()=>Tt,dayFromVal:()=>tt,editAndReplaceMessage:()=>rt,focusOnMessage:()=>na,formatPhoneNumber:()=>st,formatTimespan:()=>aa,formatTyper:()=>Kt,getAliveMembersCount:()=>Qs,getAttachIdFromMessage:()=>u.getAttachIdFromMessage,getAvailableMicrophones:()=>et,getBareTab:()=>u.getBareTab,getBaseLink:()=>Ss,getCallbackButton:()=>Ba,getChatMemberCount:()=>Ta,getChatMembersByIds:()=>sa,getClassicChatHeight:()=>Ye,getConvoLocation:()=>Oa,getHistoryTopIndent:()=>qs,getLastSeenText:()=>Ls,getLastSeenTextInHeader:()=>Ts,getMessageRequestDateText:()=>la,getMessageStoreStatus:()=>ht,getNowEditingMessage:()=>ia,getPinnedMessageHeight:()=>Ks,getRightMenuMaxItems:()=>Da,getTab:()=>u.getTab,getUserInitials:()=>A.getUserInitials,handleCallLinkClick:()=>ka,hideAllBoxes:()=>ra,hideAsideNotice:()=>ws,hideAsidePromoBlock:()=>Os,hideTopNotice:()=>Ms,installVKAdminApp:()=>Ns,inviteUser:()=>ds,isAlreadyDeleted:()=>Je,isAnyMessageBeingEdited:()=>u.isAnyMessageBeingEdited,isAppActionOptionAvailableForPeer:()=>ma,isCallToPeerAvailable:()=>Pa,isCallToPeerFromSnippetAvailable:()=>Ma,isClassicInterface:()=>u.isClassicInterface,isCommunityInterface:()=>u.isCommunityInterface,isEditableFocused:()=>Rs,isFoldersAvailable:()=>u.isFoldersAvailable,isFullyLoadedTab:()=>u.isFullyLoadedTab,isFvkcomgroup:()=>bt,isGiftOptionAvailableForPeer:()=>pa,isImportant:()=>ms,isLastMsgDebugEnabled:()=>E.isLastMsgDebugEnabled,isLocksAvailable:()=>u.isLocksAvailable,isMessageTooLong:()=>Zs,isMessagesVisible:()=>Ps,isMoneyOptionAvailableForPeer:()=>ha,isPeerActive:()=>ft,isPeerBlocked:()=>hs,isPeerBlockedByMe:()=>bs,isPeerCurrentUser:()=>ua,isPendingForward:()=>fs,isReversedDialogs:()=>u.isReversedDialogs,isSelfMessage:()=>Zt,isTabLoaded:()=>vt,isTabLoadedWithMessage:()=>Ct,isTabMarkedUnread:()=>u.isTabMarkedUnread,isUnrespond:()=>ps,isUserAliveInChat:()=>zs,isViewWithRecommendations:()=>Ft,isVoiceMessageAvailable:()=>Xe,joinCallFromIm:()=>wa,loadSummaryActivityType:()=>Vt,lockButton:()=>Hs,markMessagesAsRead:()=>ct,normalizeTabsGotFromServer:()=>S.normalizeTabsGotFromServer,onASRCollapseToggleClick:()=>Ua,parserMessage:()=>u.parserMessage,prepareContactName:()=>A.prepareContactName,removeExpiredMessageIfNeed:()=>ga,removeExpiredMessagesStub:()=>jt,removeMessages:()=>Ut,removeMessagesWithRestore:()=>$t,removeStartingFromMessage:()=>Gt,renderBtnSearchOnlyMessages:()=>Rt,renderClearRecent:()=>wt,renderConversationsSep:()=>Pt,renderConvoRecommendList:()=>Nt,renderEmptySearch:()=>Qt,renderFindFriendsStub:()=>xt,renderGoTo:()=>as,renderMessagesSep:()=>kt,renderPhotosFromTab:()=>At,renderPinnedMessage:()=>Us,renderPopularSuggSep:()=>Mt,renderPopularSuggestions:()=>Ot,renderShortText:()=>Ds,replaceAttaches:()=>dt,replaceCarousel:()=>_t,replaceExpiredMessageWithPlaceholder:()=>fa,replaceExpiredRepliedMessageWithPlaceholder:()=>Ca,replaceMessageAttrs:()=>Ze,replaceMessageReactions:()=>gt,replaceSpecialSymbols:()=>R.replaceSpecialSymbols,restoreMessage:()=>qt,secondsToHuman:()=>R.secondsToHuman,setCallbackButtonLoadingState:()=>Ha,setCasperMessageExpiringStatusDOM:()=>lt,setClassicChatHeight:()=>We,setMessageError:()=>Ht,showBlacklistBox:()=>ys,showBlacklistBoxUser:()=>Is,showCasperExpiringTooltip:()=>$s,showChatInvitationBox:()=>Fa,showDebugAlert:()=>I.showDebugAlert,showEditTimeTooltip:()=>Gs,showFavvedBox:()=>As,showFlushChat:()=>ns,showGroupCallsNewYearTooltip:()=>xa,showGroupCallsOnboardingBox:()=>Na,showInvitationBox:()=>Xs,showLeaveDialog:()=>is,showMessageInfoTooltip:()=>js,showMsgDeleteDialog:()=>rs,showPinnedBox:()=>Ys,showRepliedBox:()=>Ws,showSpamLayer:()=>Cs,showUnpinDialog:()=>os,showUnreadOnly:()=>gs,showVerifiedTooltip:()=>Xt,showWaitUntilUploadedBox:()=>ea,simplifyCounter:()=>Et,splitMessageToParts:()=>Js,startCallFromIm:()=>Ra,startResendMessage:()=>Bt,tabFromIds:()=>ts,tabIsMessageRequest:()=>u.tabIsMessageRequest,tabIsOutgoingMessageRequest:()=>u.tabIsOutgoingMessageRequest,tabIsRejectedMessageRequest:()=>u.tabIsRejectedMessageRequest,toggleDialogsFolder:()=>_s,unUrlPeer:()=>Lt,unlockButton:()=>Bs,updateListenedMark:()=>nt,updateMessageEditableStatus:()=>it,updateMessageInCache:()=>at,updateMessageReactStatus:()=>ot,updateStar:()=>ks,wrapLoading:()=>es});var a=s(434788),n=s(835200),i=s(301230),o=s(725296),r=s(584356),l=s(672948),c=s(893106),d=s(82161),_=s(165203),g=s(196635),u=s(222009),m=s(894523),p=s(896879),h=s(682615),f=s(320422),b=s(514986),v=s(953908),C=s(733097),T=s(292071),L=s(95638),E=s(502478),I=s(47304),y=s(728785),S=s(832468),A=s(83667),R=s(625139),k=s(196655),P=s(705758),M=s(590646),w=s(343394),O=s(875610),N=s(568012),x=s(755778),D=s(12402),F=s(872306),H=s(528283),B=s(795558),U=s(221780),j=s(408014),G=s(978671),$=s(880580),q=s(991364),K=s(571039),V=s(839470),Y=s(874223),W=s(321342),z=s(540537),Q=s(783400),J=s(220661),Z=s(931917),X=s(854099),ee=s(811453);const te="_im_mess_original",se="_im_mess_restore",ae="_im_typing",ne="_im_mess_btn",ie="_im_mess_stack",oe="_im_mess",re="_im_bot_carousel",le="_im_join_call_by_link",ce="chat_create",de="chat_title_update",_e="chat_invite_user",ge="chat_kick_user",ue="chat_photo_update",me="chat_photo_remove",pe="chat_pin_message",he="chat_unpin_message",fe="chat_invite_user_by_link",be="chat_screenshot",ve="chat_group_call_started",Ce="chat_kick_user_call_block",Te="chat_kick_don",Le="call_transcription_failed",Ee="_im_deselect_all",Ie="_im_top_notice_hide",ye="_im_aside_notice_hide",Se="_im_aside_promo_block_hide",Ae="_im_vkadmin_promo_link",Re="_im_clear_recent",ke="_im_toggle_mr_tab",Pe="_im_toggle_business_notify_tab",Me="_im_toggle_archives_tab",we="_im_toggle_all_tab",Oe="_im_mess_search",Ne="_im_pinned",xe="im_msg_audiomsg",De="_msg_asr_collapse_toggle",Fe="im_msg_audiomsg--transcription-expanded",He="._im_mess_stack",Be="._im_replied_message",Ue=4096,je=100,Ge=8,$e=52,qe=62,Ke=72,Ve="chatPosition";function Ye(){return ls.get(Ve)||0}function We(e){e>=(0,B.clientHeight)()-30&&(e=0),ls.set(Ve,e)}function ze(e,t){e&&e.innerHTML!==t&&(e.innerHTML=t)}function Qe(e,t,s,a){let n=t&&!s?1:!t&&s?-1:0;n&&!(0,u.isClassicInterface)(e)&&a().compensateHistoryHeightChange(n)}function Je(e,t,s){let a=e.get?e.get():e;if(vt(a,t)){let e=a.tabs[t].deleted||[];return(0,d.inArray)(s,e)}return!1}function Ze(e,t,s){let a=s.randomId,n=(0,B.geByClass1)(`_im_mess_rid${a}`,t);return n&&(t=(0,W.removeMessagesWithStack)([n],t),t=(0,W.appendMessageToHistory)(e,s,t,!1)),t}function Xe(e){const t=(0,u.checkVoiceMessageAvailable)(e);return(0,u.isCommunityInterface)(e)||i.browser.mobile&&i.browser.safari?Promise.resolve(!1):void 0!==t?Promise.resolve(t):et().then((e=>e.length>0)).catch((e=>!1))}function et(){return window.AudioContext&&navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then((function(e){let t=[];for(let s=0;s<e.length;s++)"audioinput"==e[s].kind&&t.push(e[s]);return t})):Promise.reject(new Error("NotSupported"))}function tt(e){let t=e.split(".");return(t[0]<10?"0":"")+t[0]+(t[1]<10?"0":"")+t[1]+t[2]}function st(e){const t=(""+e).replace(/\D/g,"").match(/^(\d+)(\d{3})(\d{3})(\d{2})(\d{2})$/);return t?`+${t[1]} (${t[2]}) ${t[3]}-${t[4]}-${t[5]}`:""}function at(e,t,s){const a=(0,B.domData)(s,"msgid"),n=(0,B.geByClass1)(`_im_mess_${a}`,t),i=s.cloneNode(!0);return n&&(n.parentNode.replaceChild(i,n),(0,W.ensureDomHasActions)(t)),t}function nt(e,t){var s;const a=null==(s=e.querySelector(`._im_mess_${t}`))?void 0:s.querySelector(".im_msg_audiomsg");if(a)return a.classList.remove("im_msg_audiomsg--unlistened"),e}function it(e,t,s,a){const n=+a.dataset.msgid,i=(0,u.getMessage)(e,t,n),o=(0,Q.canMessageBeEdited)(e,i),r=a.classList.contains("im-mess_editable");if(o!==r){const e=(0,B.geByClass1)(`${oe}_${n}`),t=[a];e&&t.push(e),t.forEach((e=>{e.classList.toggle("im-mess_editable",o)})),at(0,s,a)}}function ot(e,t,s,a){const n=Number(a.dataset.msgid),i=(0,u.getMessage)(e,t,n);if(!i)return;const o=(0,Q.canSendReactions)(e,i),r=a.classList.contains("im-mess_reactions");if(o!==r){const e=document.querySelector(`.${oe}_${n}`),t=[a];e&&t.push(e),t.forEach((e=>{e.classList.toggle("im-mess_reactions",o)})),at(0,s,a)}}function rt(e,t,s){if(function(e){return e.kludges&&"app_action"===e.kludges.attach1_type}(t))return s;const a=(0,B.geByClass1)(`_im_mess_${t.messageId}`,s);if(a){const n=(0,B.se)((0,k.renderMessage)(e,t));a.classList.contains("im-mess_is_editing")&&n.classList.add("im-mess_is_editing"),a.parentNode.replaceChild(n,a),(0,W.ensureDomHasActions)(s)}return s}function lt(e,t,s){const a=(0,B.geByClass1)(`_im_mess_${s}`,e);if(a){const e=a.closest(He),s=e&&e.querySelector(".im-mess-stack--bomb");s&&s.classList.add(t?"im-mess-stack--bomb_expiring-soon":"im-mess-stack--bomb_expiring")}return e}function ct(e,t,s){let a=e.tabs[t];return(0,P.toArray)((0,B.geByClass)("_im_mess_unread",s)).forEach((e=>{let t=!1;if((0,V.partConfigEnabled)("me_web_read_by_cmid")){const s=(0,d.intval)((0,B.domData)(e,"cmid"));if(!s)return;t=a.out_up_to_cmid>=s}else{let s=(0,d.intval)((0,B.domData)(e,"msgid"));if(!s)return;t=a.out_up_to>=s}t&&((0,B.removeClass)(e,"_im_mess_unread"),(0,B.removeClass)(e,"im-mess_unread"),function(e){let t=(0,B.geByClass1)("_im_mess_blind_unread_marker",e);t&&(t.removeAttribute("aria-label"),t.removeAttribute("role"),t.removeAttribute("tabindex"))}(e))})),s}function dt(e,t,s){const{peerId:a,messageId:n}=t,i=(0,B.geByClass1)("_im_msg_reply"+n,e),o=(0,B.geByClass1)("_im_msg_media"+n,e),r=s.tabs[a].mediacontent[n][0];return i&&(i.innerHTML=r[0]),o&&(o.innerHTML=r[1]),(0,J.initWidgets)(o),e}function _t(e,t,s){const{messageId:a}=t,n=e.querySelector("._im_bot_carousel_"+a);if(!n)return;const i=function(e,t){const s=(0,u.getMessage)(e,t.peerId,t.messageId).kludges.template;let a=!1;if(!s)return"";const n=s.elements.reduce(((e,s,n)=>{let i="",o="";const r=(0,d.clean)(s.title),l=(0,d.clean)(s.description);if(s.photo&&(i+=(0,d.getTemplate)("sImBotCarouselSlidePhoto",{url:s.photo.sizes.find((e=>"q"===e.type)).url,alt:r||l||""}),a=!0),r&&(o+=(0,d.getTemplate)("sImBotCarouselSlideTitle",{content:(0,ee.prepareToWriting)(r)})),l&&(o+=(0,d.getTemplate)("sImBotCarouselSlideDescription",{content:(0,ee.prepareToWriting)(l)})),(s.title||s.description)&&(i+=(0,d.getTemplate)("sImBotCarouselSlideContent",{content:o})),s.action&&("open_link"===s.action.type&&(i=(0,d.getTemplate)("sImBotCarouselSlideLinkWrapper",{content:i,url:(0,K.wrapAwayIfExternal)(s.action.link,!0)})),"open_photo"===s.action.type&&(i=(0,d.getTemplate)("sImBotCarouselSlidePhotoLinkWrapper",{content:i,photo_id:`${s.photo.owner_id}_${s.photo.id}`,msg_id:t.messageId}))),s.buttons){const e=s.buttons.reduce(((e,t,s)=>{const a=Number(n+""+s);return e+(0,d.getTemplate)("sImBotCarouselSlideButton",{label:(0,D.getButtonLabel)(t),appearance:(0,D.getButtonAppearance)(t),modifier:t.action.type.replace("_","-"),attributes:(0,D.getAttributesFromActionObject)(t.action,a),tag_name:"open_link"===t.action.type?"a":"button"})}),"");i+=(0,d.getTemplate)("sImBotCarouselSlideButtons",{content:e})}return e+(0,d.getTemplate)("sImBotCarouselSlide",{content:i,index:n})}),"");return s.elements.length>1?(0,d.getTemplate)("sImBotCarousel",{content:(0,d.getTemplate)("sImCarousel",{content:n,controls_class:a?"BotCarousel__control--fourth":"BotCarousel__control",scroll_count:"1"}),msg_id:t.messageId}):(0,d.getTemplate)("sImBotCarousel",{content:n,msg_id:t.messageId})}(s,t);return(0,B.domReplaceEl)(n,i),e}function gt(e,t,s,a){const n=e.querySelector("._im_mess_"+s);if(!n)return;const i=[...n.querySelectorAll("._im_mess_reactions")].pop();if(!i)return;const o=Number(n.dataset.cmid);return i.innerHTML=(0,k.renderMessageReactions)(t,o,a),e}const ut=0,mt=1,pt=2;function ht(e,t){if(!(0,u.isFullyLoadedTab)(t,e.peerId))return ut;const s=t.tabs[e.peerId];return s.msgs[e.messageId]?mt:s.msgs["rid"+e.randomId]?pt:ut}function ft(e,t){return e===t.peer}function bt(e,t){return(0,j.doesChatTabHaveFlag)((0,u.getTab)(e,t),1024)}function vt(e,t){return!!e.tabs[t]}function Ct(e,t){return!!vt(e,t)&&null!==e.tabs[t].lastmsg}function Tt(e){return Z.Ranges.isChatOrChannelPeer(e)?"c"+(e-2e9):Z.Ranges.isEmailId(e)?"e"+Math.abs(e+2e9):Z.Ranges.isContactId(e)?"mr"+(e-19e8):e}function Lt(e){switch(e.slice(0,1)){case"e":return-2e9-(0,d.intval)(e.slice(1));case"c":return 2e9+(0,d.intval)(e.slice(1));default:return(0,d.intval)(e)}}function Et(e){return e>9999999?Math.floor(e/1e6)+"M":e>9999?Math.floor(e/1e3)+"K":e>0?e.toString():""}function It(e,t){let s=`<img src="${e}" alt="" class="dialogs_inline_chatter dialogs_inline_chatter_half"/>`;return t&&(s=(0,d.getTemplate)("im_dialogs_link",{href:t,photo:s})),`<div class="im_grid">\n    <div class="dialogs_inline_chatter dialogs_inline_chatter_half">\n      ${s}\n    </div>\n  </div>`}function yt(e,t){let s=`<img src="${e}" alt="" class="dialogs_inline_chatter"/>`;return t&&(s=(0,d.getTemplate)("im_dialogs_link",{href:t,photo:s})),`<div class="im_grid">\n    <div class="dialogs_inline_chatter">\n      ${s}\n    </div>\n  </div>`}function St(e,t=[]){if("string"==typeof e)return(0,d.getTemplate)("sImDialogImRowPhoto",{photo:`<img src="${e}" alt=""/>`});switch(e.length){case 1:return(0,d.getTemplate)("sImDialogImRowPhoto",{photo:`<img src="${e[0]}" alt=""/>`});case 2:return e.map(((e,s)=>It(e,t[s]))).join("");case 3:return It(e[0],t[0])+e.slice(1).map(((e,s)=>yt(e,t[s+1]))).join("");case 4:return e.map(((e,s)=>yt(e,t[s]))).join("")}}function At(e,t,s){return(0,S.isDialogWithYourself)(e.get().id,t.peerId)?(0,d.getTemplate)("sImDialogImRowPhoto",{photo:`<img src="${y.FAVORITES_ICON_URL}" alt="">`}):"string"==typeof t.photo&&t.photo?(0,d.getTemplate)("sImDialogImRowPhoto",{photo:`<img src="${t.photo}" alt="">${t.photo_icon||""}`}):Z.Ranges.isChatOrChannelPeer(t.peerId)&&t.membersCount<2?(0,d.getTemplate)("sImDialogImRowPhoto",{photo:`<img src="${e.get().default_chat_photo}" alt="">`}):Array.isArray(t.photo)?St(t.photo):Z.Ranges.isContactId(t.peerId)?(0,d.getTemplate)("sImContactAvatar",{name:(0,A.getUserInitials)(t.tab),size:30,classes:"nim-peer--contact-avatar"}):St(...(0,S.getDataForChatMemberGrid)(e,t,s))}function Rt(e){let t=e.get().gid?U.getLang("mail_search_only_messages_comm"):U.getLang("mail_search_only_messages");return`<li class="im-page--mess-search-w">\n    <div class="im-page--mess-search ${Oe}">\n      <button type="button" class="im-i--messages-search"></button>${t}\n    </div>\n  </li>`}function kt(){return`<li class="im-search-results-head">${U.getLang("mail_search_messages")}</li>`}function Pt(){return`<li class="im-search-results-head">${U.getLang("mail_search_conversations_sep")}</li>`}function Mt(){return`<li class="im-search-results-head">${U.getLang("mail_search_dialogs_sep")}</li>`}function wt(){return`<li class="im-search-results-head _im_recent_bar">\n    ${U.getLang("mail_recent_searches")}\n    <button type="button" class="${Re} im-page--clear-recent">${U.getLang("mail_clear_recent")}</button>\n  </li>`}function Ot(e){let t=e.get().popular_sugg;const s=(0,u.isClassicInterface)(e)?7:4;return t.length>s&&(t=t.slice(0,s)),'<li class="im-popular clear_fix">'+t.map((t=>{let s=t.peerId;const a=(0,S.isDialogWithYourself)(e.get().id,s);let n=!a&&(0,M.oCacheGet)(e,s)||t,i=e.get().tabs[s]||t,o=(e.get().mutedPeers||[]).indexOf(s)>=0,r=["im-popular--item","fl_l","_im_dialog","_dont_add_recent","_im_sugg_"+s,i.unread>0&&"sugg-is_unread",o&&"sugg-is_muted"].filter((e=>!!e)).join(" ");const l=i.is_nft_photo&&!a?(c=n.photo,_=44,(0,d.getTemplate)("sImDialogImRowAvatarRichSkinPhoto",{photo:c,size:_})):`<img class="im-popular--avatar" src="${n.photo}"/>`;var c,_;return`<div class="${r}" data-peer="${s}">\n    <a class="im-popular--avatar-w ${(0,P.onlinePlatformClass)(i.online)}" href="${n.link}">${l}</a>\n    <div class="im-popular--name-w"><a class="im-popular--name" href="${n.link}">${n.first_name||n.name}</a></div>\n    <span class="im-popular--unread _sugg_unread_ct">${Et(i.unread)}</span>\n</div>`})).join("")+"</li>"}function Nt(e){if((0,E.getLocalSettingsValue)(e,"messages_recommendation_list_hidden"))return"<div></div>";const t=(0,j.getRecommendedConvoList)(e),s=t?t.items.map(((e,s)=>function(e,t){const s=Z.Ranges.isContactId(e.peer_id),a=s?`/im?sel=${e.peer_id}`:`/${e.screen_name}`,n=!s&&e.online&&e.online_info?"online"+(e.online_info.is_mobile?" mobile":""):"";let i="";switch(!0){case s&&!e.photo:i=(0,d.getTemplate)("sImContactAvatar",{name:(0,A.getUserInitials)(e.name),size:46,classes:""});break;case e.is_nft_photo:{const t={online:(0,d.getTemplate)("sImDrawNftOnline"),"online mobile":(0,d.getTemplate)("sImDrawNftOnlineMobile")};i=(0,d.getTemplate)("sImUserNftAvatar",{online:t[n]||"",src:e.photo});break}default:i=(0,d.getTemplate)("sImUserAvatar",{src:e.photo,online_class:n,classes:""})}return(0,d.getTemplate)("sImConvoRecommendListUser",{name:e.name,id:e.peer_id,link:a,photo:i,position:t,track_code:e.track_code,remove_label:U.getLang("mail_recommend_block_remove_item")})}(t.item_data[e],s))):[],a=[(0,d.getTemplate)("sImConvoRecommendListButton",{icon:(0,G.getIcon24UserOutline)().icon,title:U.getLang("mail_recommend_block_action_find_friends"),tag_name:"a",attributes:'href="/friends?act=find" target="_blank"'}),(0,d.getTemplate)("sImConvoRecommendListButton",{icon:(0,$.getIcon24SmartphoneOutline)().icon,title:U.getLang("mail_recommend_block_action_invite"),tag_name:"button",attributes:'data-action="invite_by_phone_number"',classes:"_convoRecommendAction"})],n=s.length?(0,d.getTemplate)("sImCarousel",{content:s.join("")+a.join(""),controls_class:"ConvoRecommendList__control",scroll_count:"4"}):a.join("");return(0,d.getTemplate)("sImConvoRecommendList",{list_content:n})}function xt(e){return(0,P.unpackStore)(e).findFriendsStub||""}function Dt(e){const t=Boolean(e&&mobPlatforms[e]);return{is_online:Boolean(e&&!t),is_mobile:t}}function Ft(e){const t=(0,P.unpackStore)(e);return t.active_tab===y.FOLDER_ALL&&!(0,u.isCommunityInterface)(e)&&t.isRecommendationListEnabled}function Ht(e,t,s){let a=(0,B.geByClass1)("_im_mess_"+t.messageId,s);if(a){(0,B.attr)(a,"aria-hidden","false"),(0,B.addClass)(a,`im-mess_failed ${k.FAILED_CLASS}`);const e=(0,B.geByClass1)("_im_mess_marker",a);(0,B.attr)(e,"aria-label",U.getLang("mail_send_message_error")),(0,B.attr)(e,"role","link")}return s}function Bt(e,t,s){let a=(0,B.geByClass1)("_im_mess_"+t,s);if(a){(0,B.removeClass)(a,"im-mess_failed"),(0,B.attr)(a,"aria-hidden","true"),(0,B.removeClass)(a,k.FAILED_CLASS);const e=(0,B.geByClass1)("_im_mess_marker",a);(0,B.attr)(e,"aria-label",""),(0,B.attr)(e,"role","")}return s}function Ut(e,t){let s=e.map((e=>(0,B.geByClass1)("_im_mess_"+e,t))).filter((e=>e));return(0,W.removeMessagesWithStack)(s,t)}function jt(e,t){const s=t||document,a=[];return e.forEach((e=>{const t=s.querySelector(`._im_expired_message_${e}`);if(!t)return;const n=+t.dataset.count;if(t.dataset.count=n-1,t.classList.remove(`_im_expired_message_${e}`),1===n){(!(0,B.domNS)(t)||(0,B.hasClass)((0,B.domNS)(t),"_im_bar_date"))&&((0,B.hasClass)((0,B.domPS)(t),"_im_bar_date")&&(0,B.re)((0,B.domPS)(t)),(0,B.hasClass)((0,B.domPS)(t),"_im_unread_bar_row")&&(0,B.re)((0,B.domPS)(t))),(0,B.re)(t)}else a.includes(t)||a.push(t)})),a.length&&a.forEach((e=>{const t=+e.dataset.count;if(t>0){const s=ba(t),a=(0,B.se)(s);a.classList.add(...e.classList),e.replaceWith(a)}})),t}function Gt(e){let t=e;for(;t;){let e=t;if(t=t.previousElementSibling,null===t){(0,B.hasClass)(e,"mess_srv")&&(t=e.parentNode);const s=(0,B.gpeByClass)("_im_mess_stack",e);s&&(t=s.previousElementSibling,1===(0,B.domChildren)(e.parentNode).length&&s.parentNode.removeChild(s))}(0,B.hasClass)(e,"_im_unread_bar_row")||e.parentNode.removeChild(e)}}function $t(e,t,s,a){const n=s===y.ConvoAction.REPORT_UGC_STICKER?zt:Wt;return e.map((e=>(0,B.geByClass1)("_im_mess_"+e,a))).filter((e=>e)).forEach((e=>{(0,B.val)(e,n(t,e,s)),(0,B.addClass)(e,"im-mess_light")})),a}function qt(e,t,s){let a=(0,B.geByClass1)("_im_mess_"+e,s);if(a){let e=(0,B.geByClass1)(te,a);(0,B.val)(a,e.innerHTML),(0,B.removeClass)(a,"im-mess_light")}return s}function Kt(e={},t,s,a,n=2,i=!1){if(i)return Yt(e,t,s,a,!0,n);const o=Yt(e,t,s,a,!1,n);return o.length>60?Yt(e,t,s,a,!0,n):o}function Vt(e){const t={[O.ACTIVITY_TYPE_TYPING]:1,[O.ACTIVITY_TYPE_RECORDING_AUDIO]:2},s=Object.keys(e).sort(((e,s)=>t[s]-t[e])),a={},n=s.reduce(((t,s)=>{const{userIds:n=[]}=e[s]||{};return n.forEach((e=>{a[e]||(a[e]=!0,t[s]=!0)})),t}),{}),i=s.filter((e=>!!n[e]));return i.length>1?"":i[0]}function Yt(e,t,s,a,n,i){const o=function(e,t,s){const a=[],n={};return Object.keys(t).map((s=>{((t[s]||{}).userIds||[]).forEach((t=>{(0,M.oCacheExists)(e,t)?parseInt(t,10)!==e.id&&(n[t]=s):a.push(t)}))})),a.length&&(0,O.loadChatMember)({[s]:a},e),Object.keys(n).sort(((e,s)=>t[n[e]].ts-t[n[s]].ts))}(a,e,t);if(0===o.length)return"";const r=Z.Ranges.isUserIdTransitional(t)||Z.Ranges.isGroupId(t)?"first_name":n?"short_name":"name",l=Vt(e);let c="";l===O.ACTIVITY_TYPE_RECORDING_AUDIO?c=U.getLang("mail_recording_audio_several",o.length):l===O.ACTIVITY_TYPE_TYPING&&(c=U.getLang("mail_typing_several",o.length));const d=o.slice(0,Math.min(o.length-1,i));let _=d.map((e=>(0,M.oCacheGet)(a,e)[r])).join(", ");if(o.length>i+1){const t=function(e){const t={};return Object.keys(e).forEach((s=>{const{userIds:a=[]}=e[s];a.forEach((e=>{t[e]=1}))})),Object.keys(t).length}(e);_+=" "+U.getLang("mail_and_peer").replace("{count}",t-i).replace("{typing}",c)}else if(o.length>1&&(_+=` ${U.getLang("mail_and_peer_one")}`),!Z.Ranges.isChatOrChannelPeer(t)&&s)_+=` ${c}`;else{_+=` ${(0,M.oCacheGet)(a,o[d.length])[r]} ${c}`}return _.trim()}function Wt(e,t,s){let a=t.innerHTML;return`<div class="im-mess--text">\n    ${"delete"===s?U.getLang("mail_deleted_stop"):U.getLang("mail_marked_as_spam")} <button type="button" data-peer="${e}" class="${se} im-mess--btn">${U.getLang("mail_restore")}</button>\n    <div class="${te} im-mess--original">${a}</div>\n  </div>`}function zt(){return`<div class="im-mess--text">\n    ${U.getLang("stickers_ugc_text_after_report")}\n  </div>`}function Qt(){const{icon:e}=(0,q.getIcon56MessagesOutline)();return`<div class="im-page--chat-search-empty">\n    ${e}\n    ${U.getLang("mail_im_search_empty")}\n  </div>`}function Jt(e,t,s,a){if(t===ue){let t=(0,B.geByClass1)("_im_mess_"+e.messageId,a);if(t){let a=s.tabs[e.peerId];t.parentNode.innerHTML=(0,d.getTemplate)("im_msg_row",{msg_id:e.messageId,cmid:e.chat_local_id,from_id:e.peerId,text:(0,k.renderServiceMsg)(s,e,a.peerId)+s.chat_photo_msg,ts:e.date,cls:"im-mess_srv _im_mess_srv",reactions:""})}}return a}function Zt(e,t){return!t&&e===vk.id}function Xt(e,t){return(0,f.showTooltip)(e,{url:Z.Ranges.isGroupId(t)?"al_groups.php":"al_profile.php",params:{act:"verified_tt",mid:t,gid:t},slide:15,ajxdt:200,showdt:200,hidedt:200,dir:"auto",shift:[94,7,7],className:"verified_tt"})}function es(e){return(t,s="bottom",a="")=>{let n=(0,B.se)((0,d.getTemplate)("im_preloader",{preloader:(0,B.rs)(vk.pr_tpl,{id:""}),cls:["bottom"===s?"im-preloader_bottom":"im-preloader_top",a].join(" ")})),i=!1;function o(){i=!0,(0,B.removeClass)(n,"im-preloader_visible"),n.parentNode&&n.parentNode.removeChild(n),e&&e.classList.remove("_is-loading-list")}e.classList.add("_is-loading-list"),setTimeout((()=>{i||("bottom"===s?e.appendChild(n):e.insertBefore(n,(0,B.domFC)(e)),(0,B.addClass)(n,"im-preloader_visible"))}),0),t.then(o).catch((e=>{console.error(e),o()}))}}function ts(e,t){return{0:{msgs:e.reduce(((e,t)=>(e[t]=[t,n.FLAG_IMPORTANT,0,0,"",{},{},0,0,0],e)),{}),hash:t,history:1}}}function ss(e,t){if(!t&&!e)return!1;let s=e.target||e.srcElement,a=Ge,n=!1,i=/_im_mess|im_log_act|im_log_ract|_im_log_body|im_log_rspacer|_im_graffiti_w|_wall_post_cont/;do{if(!s||s.onclick||s.onmousedown||"A"==s.tagName||(0,B.hasClass)(s,"_im_no_select")||(0,B.hasClass)(s,"im_msg_media_link")||"IMG"==s.tagName&&!(0,B.hasClass)(s,"_im_graffiti")&&!(0,B.hasClass)(s,"emoji")&&!(0,B.hasClass)(s,"emoji_css")&&!(0,B.hasClass)(s,"im_gift")||"TEXTAREA"==s.tagName||(0,B.hasClass)(s,"im-gift--button")||(0,B.hasClass)(s,"GiftSnippetContent__button")||(0,B.hasClass)(s,"play_new")||(0,B.hasClass)(s,"videoplayer")||(n=i.test(s.className)))break}while(a--&&(s=s.parentNode));return!n||!!(0,d.trim)((window.getSelection&&window.getSelection()||document.getSelection&&document.getSelection()||"").toString())}function as(e,t){return`<div class="im-mess--text">\n      <span>${U.getLang("mail_restored")}</span>\n      <a class="_im_go_to" href="/im?sel=${Tt(e)}&msgid=${t}">${U.getLang("mail_im_goto_conversation")}</a>\n    </div>`}function ns(e,t,s){let a=U.getLang("mail_deleteall1"),n=U.getLang("mail_sure_to_delete_all"),i=U.getLang("mail_delete");return Z.Ranges.isChatOrChannelPeer(t)&&((0,j.doesChatTabHaveFlag)(e,1024)?(a=U.getLang("mail_leave_channel"),n=U.getLang("mail_unfollow_channel_confirmation"),i=U.getLang("mail_unfollow_channel")):n=U.getLang("mail_chat_sure_to_delete_all")),Z.Ranges.isGroupId(t)&&(n=U.getLang("mail_group_sure_to_delete_all")),(0,b.showFastBox)(a,n,i,s,U.getLang("global_cancel"))}function is(e,t,s){const a=(0,u.getTab)(e,t),n=Z.Ranges.isChatOrChannelPeer(t),i=n&&Z.Ranges.isChatOrChannelPeer(a),r=n&&(0,u.tabIsMessageRequestToChat)(a);let l=U.getLang("mail_deleteall1"),c=U.getLang("mail_sure_to_delete_all"),d=U.getLang("mail_delete");if(n){if(!(0,u.isChatActive)(a))return ns(a,t,s.bind(null,!0));i?(l=U.getLang("mail_leave_channel"),c=U.getLang("mail_vkcomgroup_leave_confirm"),d=U.getLang("mail_leave_channel")):r?(l=U.getLang("mail_reject_mr_confirmation_title"),c=U.getLang("mail_reject_mr_confirmation_text"),d=U.getLang("mail_message_request_reject")):(l=U.getLang("mail_leave_chat"),c=U.getLang("mail_chat_leave_confirm"),d=U.getLang("mail_leave_chat"))}Z.Ranges.isGroupId(t)&&(c=U.getLang("mail_group_sure_to_delete_all"));const _=new b.MessageBox({title:l,width:i?450:500}).content(c).setButtons(d,(()=>s(!!(0,o.isChecked)((0,B.geByClass1)("_check_is_delete"))||!n)),U.getLang("global_cancel")).show();return!n||i||r||_.setControlsText(`<div class="checkbox im-delete-forall-checkbox _check_is_delete" onclick="checkbox(this);" role="checkbox" aria-checked="false">${U.getLang("mail_deleteall1")}</div>`),_}function os(e){return(0,b.showFastBox)(U.getLang("mail_unpin_title"),U.getLang("mail_unpin_text"),U.getLang("mail_unpin"),e,U.getLang("global_cancel"))}function rs(e,t,s,a){let n=U.getLang("mail_dialog_msg_delete_N",t),i=(0,b.showFastBox)(U.getLang("mail_dialog_msg_delete_title"),n,U.getLang("mail_delete"),(()=>a((0,o.isChecked)((0,B.geByClass1)("_check_forall")))),U.getLang("global_cancel")),r="",l=!1;return s&&(r=`<div class="checkbox im-delete-forall-checkbox _check_forall" onclick="checkbox(this);" role="checkbox" aria-checked="false">${U.getLang("mail_delete_for_all")}</div>`,l=cur.imDb.selectByKey("del_forall_checked")),i.setControlsText(r),l&&(0,o.checkbox)((0,B.geByClass1)("_check_forall")),i}function cs(e,t,s,a,n,i){t.showProgress(),e.set(a.bind(null,n,i)).then((()=>{var s;t.hideProgress(),t.hide(),e.get().longpoll.push([(0,L.resetPeer)()]);const a=e.get();[_.FOLDER_BUSINESS_NOTIFY,_.FOLDER_ARCHIVE].includes(a.active_tab)&&!(null==(s=a.dialog_tabs[a.active_tab])?void 0:s.length)&&a.longpoll.push([(0,L.changeTab)(_.FOLDER_ALL)])}))}function ds(e,t,s,a){const n=e.get().tabs[t].memberIds;e.set(a.bind(null,"add_member",n)).then(s().showCreation)}function _s(e,t,s,a){const n=e.get();if(![_.FOLDER_BUSINESS_NOTIFY,_.FOLDER_ARCHIVE].includes(a)&&n.active_tab===_.FOLDER_ALL&&0===(0,Y.getConvoListFolderCounterTotal)(n,a))return!1;const i=n.active_tab===a?_.FOLDER_ALL:a;return e.set((e=>s(i,e))).then(t)}function gs(e,t,s){if(e.get().active_tab===_.FOLDER_ALL&&0===(0,E.getUnreadCountWithMuted)(e))return Promise.resolve(!1);let a=e.get().active_tab===_.FOLDER_UNREAD?_.FOLDER_ALL:_.FOLDER_UNREAD;return e.set(s.bind(null,a)).then((e=>{t().restoreDialogs(e,!0)})).then((()=>!0))}function us(e,t,s,a){if(t.get().active_tab===e&&e!==_.FOLDER_PEER_TAGS)return Promise.resolve(t);let n=(0,u.isReversedDialogs)(t);return t.set(a.bind(null,e)).then((e=>(s().restoreDialogs(e,!0,n!==(0,u.isReversedDialogs)(e)),e)))}function ms(e,t){void 0===t&&(t=e.get().peer);let s=e.get().tabs[t];return _.FOLDER_MASKS[_.FOLDER_IMPORTANT]&s.folders}function ps(e,t,s=!1){if(void 0===t&&(t=e.get().peer),!(0,u.isFoldersAvailable)(e))return!1;let a=s||e.get().tabs[t];return!!(_.FOLDER_MASKS[_.FOLDER_UNRESPOND]&a.folders)}function hs(e,t){return!1===((t.get().block_states||{})[e]||{}).free}function fs(e){return null!=e.get().pendingForward}function bs(e,t){return(t.get().block_states[e]||{}).who===vk.id}function vs(e,t){let s=e.get().block_states;Object.keys(s).forEach((a=>{s[a].time?!1===s[a].free&&Date.now()-s[a].time>=5e4&&t.push([n.mutexEvent([,1,"gim"+e.get().gid,a,0,""])]):s[a].time=Date.now()}))}function Cs(e,t,s){let a;return!(0,b.showTabbedBox)("al_im.php",{act:"a_spam",offset:"0",gid:e.get().gid},{onDone:(s,n)=>{n&&(a=t(s,e,n))},params:{width:638,onDestroy:()=>{AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0),a.unmount()}}},s)}function Ts(e,t){return Ls(e.get(),t,(0,u.getTab)(e,t).last_seen)}function Ls(e,t,s,a){if((0,S.isDialogWithYourself)(e.id,t))return"";if(s.platform)return U.getLang("mail_header_online_status")+(s.mobile?Es(t,!1,!1,!0):"");if(!s.can_see){const a=(0,M.oCacheGet)(e,t),n=a||e.tabs[t];return(0,x.getLastSeenByStatus)(s.status,n.sex)}if(!s.time||Date.now()-1e3*s.time>7776e6)return"";let n=(0,U.getDateText)(s.time,e.timeshift),i=(0,U.langSex)((0,M.oCacheGet)(e,t).sex,U.getLang("mail_last_activity_tip","raw")).replace("{user}","").replace("{time}",n);return s.mobile&&(i+=Es(t,!1,!1,a)),i}function Es(e,t,s,a){let n={mid:e};s||(n.was=1),t?n.forcetoup=!0:n.forcetodown=!0,n=Object.assign(n,a);let i=JSON.stringify(n).slice(1,-1).replace(/"/g,"&quot;");return(0,d.getTemplate)("im_wrap_mobile",{class:"im_status_mob_onl",params:i})}function Is(e,t){let s=t.get().tabs[e];return(0,b.showBox)("al_settings.php",{act:"blacklist_box",q:s.href},{stat:[window.jsc("web/settings.js"),"settings.css"]})}function ys(e,t){return(0,b.showBox)("groupsedit.php",{act:"bl_edit",name:"/id"+e,gid:t.get().gid},{stat:["page.css","ui_controls.js","ui_controls.css"]})}function Ss(e){return e.get().gid?"/gim"+e.get().gid:"/im"}function As(e,t,s,a){let n;Vs((0,b.showTabbedBox)("al_im.php",{act:"a_important",offset:"0"},{onDone:(a,i)=>{i&&(n=s(a,e,t,i))},params:{width:638,onHide:()=>{AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)},onDestroy:()=>{n&&n.unmount()}}},a),e)}function Rs(){const e=document.activeElement;return null!==e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.getAttribute("contenteditable"))}function ks(e,t,s){let a=(0,B.geByClass1)("_im_mess_"+e,s);return a&&(0,B.toggleClass)(a,"im-mess_fav",t),s}function Ps(e,t,s){let a=(0,u.getFirstUnread)(e,e.get().peer);if(!a)return[!1,0];let n=(0,B.geByClass1)(`_im_mess_${a}`,t);if(!n){const s=(0,u.getLastMessage)(e,e.get().peer,a);if(!s)return[!0,0];n=(0,B.geByClass1)(`_im_mess_${s.messageId}`,t)}const i=(0,B.hasClass)(n,"_im_mess_srv")?n:(0,B.gpeByClass)("_im_mess_stack",n);if(!i)return[!0,0];const o=n?n.offsetTop:0,r=i.offsetTop+o,l=s.contHeight();return r<=s.scrollTop()+s.getScrollHeight()?[!0,0]:[!1,Math.max(0,l-r)]}function Ms(e,t,s){(0,v.cancelEvent)(t);const a=(0,B.gpeByClass)("_im_top_notice",s);(0,c.fadeOut)(a,200,B.re.pbind(a));const n=(0,B.gpeByClass)("_im_page_dialogs",a);n&&(0,B.hasClass)(n,"im-page--dialogs-notice")&&(0,B.removeClass)(n,"im-page--dialogs-notice"),ajax.post("al_im.php",{act:"a_hide_top_notice",type:a.getAttribute("data-type"),hash:a.getAttribute("data-hash")})}function ws(e,t,s){(0,v.cancelEvent)(t);const a=(0,B.gpeByClass)("_im_aside_notice",s);(0,c.slideUp)(a,200,B.re.pbind(a)),ajax.post("al_im.php",{act:"a_hide_top_notice",type:a.getAttribute("data-type"),hash:a.getAttribute("data-hash")})}function Os(e,t){(0,v.cancelEvent)(e);const s=(0,B.gpeByClass)("_im_aside_promo_block",t);(0,c.slideUp)(s,200,B.re.pbind(s)),ajax.post("al_im.php",{act:"a_hide_promo_block",type:s.getAttribute("data-type"),hash:s.getAttribute("data-hash")})}function Ns(e,t){(0,B.gpeByClass)("_im_aside_promo_block",t).classList.add("--action-called"),ajax.post("al_im.php",{act:"a_vkadmin_app_install",hash:(0,B.domData)(t,"hash"),platform:(0,B.domData)(t,"platform")})}function xs(e){const t=e.filter((({type:e})=>"reply"!==e));return t.length>1?function(e){return[...e].sort(((e,t)=>"mail"!==e.type?"mail"===t.type?-1:1:0))}(t):t}function Ds(e,t,s,a,n){var i;let o=function(e,t){let s=e.replace(/\<br\s*\/?\>(\n)?/gi," ").replace(/[\n\r]/gi," ");return s=(0,p.replaceMentions)(s,((e,t,s,a,n)=>n)),t&&(s=Emoji.emojiToHTML(s,!0)),s}(s,a);if(t&&"..."!==t.trim()&&!Z.Ranges.isChatOrChannelPeer(e)&&(o=(0,d.getTemplate)("im_topic",{topic:t,cls:"im-topic_dialog"})+o),null==(i=o)?void 0:i.length)return o;const r=xs(n),[l]=r;return l?(0,d.getTemplate)("im_dialog_media",{name:Fs(l,r)}):(0,d.getTemplate)("im_dialog_deleted_media")}function Fs(e,t){const s={photo:U.getLang("mail_added_photos","raw"),video:U.getLang("mail_added_videos","raw"),audio:U.getLang("mail_added_audios","raw")};switch(e.type){case"mail":{const t=e.object?e.object.fwd_count:e.id.split(";").length;return(0,U.langNumeric)(t,U.getLang("mail_fwd_msgs","raw"),!0)}case"photo":case"video":case"audio":if("video"===e.type&&"clip"===e.kind)return U.getLang("mail_added_clip");const a=t.filter((t=>t.type===e.type)).length;return(0,U.langNumeric)(a,s[e.type],!0);case"audio_playlist":return"audio_album"===e.kind?U.getLang("mail_added_audio_album"):U.getLang("mail_added_audio_playlist");case"artist":return U.getLang("mail_added_artist");case"doc":switch(e.kind){case"graffiti":return U.getLang("mail_added_graffiti");case"audiomsg":case"audio_message":return U.getLang("mail_added_audiomsg");default:return U.getLang("mail_added_docs")}case"geo":case"map":return U.getLang("mail_added_geo");case"wall":return U.getLang("mail_added_wall");case"wall_reply":return U.getLang("mail_added_wall_reply");case"gift":return U.getLang("mail_added_gift");case"link":case"share":return U.getLang("mail_added_link");case"sticker":return U.getLang("mail_added_sticker");case"ugc_sticker":return U.getLang("mail_added_ugc_sticker");case"app_action":return U.getLang("mail_added_widget");case"market":return U.getLang("mail_added_market_item");case"money_transfer":return U.getLang("mail_added_money_transfer");case"money_request":return U.getLang("mail_added_money_request");case"story":return U.getLang("mail_added_story");case"mask":return U.getLang("mail_added_mask");case"article":return U.getLang("mail_added_article");case"call":case"group_call_in_progress":return U.getLang("mail_added_call");case"poll":return U.getLang("mail_added_poll");case"podcast":return U.getLang("mail_added_podcast");case"widget":return U.getLang("mail_added_widget");default:return U.getLang("mail_added_"+e.type)}}function Hs(e){(0,B.addClass)(e,"im-send-btn_loading")}function Bs(e){(0,B.removeClass)(e,"im-send-btn_loading")}function Us(e){const t=e.get(),s=(0,u.getPinnedMessage)(e);if(!s||!(0,w.isPinnedMessageVisibleInTab)(e,(0,E.getPeer)(e)))return"";const a=(0,M.oCacheGet)(e,s.userId);if(!a)return"";let n;if((0,m.isMoneyRequest)(s)&&void 0!==s.kludges.attach1_tr_amount)n=function(e,t){let s="",a="%s "+t.kludges.attach1_currency;"RUB"===t.kludges.attach1_currency&&(a=U.getLang("mail_money_amount_rub","raw"));if(t.kludges.attach1_total_amount){let e=(0,U.langNumeric)(t.kludges.attach1_tr_amount/1e3,"%s",!0),n=(0,U.langNumeric)(t.kludges.attach1_total_amount/1e3,a,!0);s=U.getLang("mail_money_request_collected_amount_from").replace("{amount}",e).replace("{total_amount}",n)}else{let e=(0,U.langNumeric)(t.kludges.attach1_tr_amount/1e3,a,!0);s=U.getLang("mail_money_request_collected_amount").replace("{amount}",e)}if((0,d.intval)(t.kludges.attach1_held_amount)){let e=(0,U.langNumeric)(t.kludges.attach1_held_amount/1e3,a,!0);s+=" "+U.getLang("mail_money_request_held_amount").replace("{amount}",e)}t.text&&(s+='<span class="divider"></span>'+(0,k.parseMessageText)(e,t.text,t.kludges));t.kludges.attach1_total_amount&&(s+=(0,d.getTemplate)("im_pinned_message_media_bar",{percent:Math.min(100,Math.floor(t.kludges.attach1_tr_amount/t.kludges.attach1_total_amount*100))}));return s}(t,s);else if(s.text)n=(0,k.parseMessageText)(t,s.text,s.kludges);else if(s.attaches.length){const e=xs(s.attaches),t=(0,m.isAppAction)(s)?s.kludges.attach1_preview:Fs(e[0],e);n=(0,d.getTemplate)("im_pinned_message_media",{text:t})}else n=(0,d.getTemplate)("im_pinned_message_deleted_media");return n=n.replace(/<br\s?\/?>/gi," "),(0,d.getTemplate)("im_pinned_message",{link:a.link,name:a.name,date:(0,U.getSmDate)(s.date,t.timeshift),content:n})}function js(e,t,s){let a=s.getAttribute("data-info");a&&(0,f.showTooltip)(s,{text:a,className:"_im_history_tooltip",appendParentCls:"_im_mess_stack",black:1,hidedt:1e3,shift:[0,4]})}function Gs(e,t,s){let a=+s.getAttribute("data-time");a&&(0,f.showTooltip)(s,{text:U.getLang("mail_message_edited")+" "+(0,U.getSmDate)(a,e.get().timeshift),className:"_im_history_tooltip",appendParentCls:"_im_mess_stack",black:1,shift:[0,4]})}function $s(e,t,s){const a=s.target,n=a.closest("."+ie),i=n.querySelector("."+oe);if(!i)return;const o=Number(i.getAttribute("data-cmid")),r=F.casperMessagesStore.getExpireTime(o),c="_im_bomb_tooltip_"+Math.round(1e4*Math.random()).toString(16);let d;if(window.tooltips){const e=t.querySelectorAll(".im-mess-stack--bomb");Array.from(e).forEach((e=>{e!==a&&tooltips.hide(e,{fasthide:!0})}))}const _=qs(e);function g(){const e=n.querySelector(`.${c} .tt_text`);e&&(e.innerHTML=u((0,l.formatTime)(F.casperMessagesStore.getExpireTime(o)))),d=setTimeout(g,500)}function u(e){return`<div class="wrapped">${e}</div>`}(0,f.showTooltip)(a,{text:u((0,l.formatTime)(r)),className:"_im_history_tooltip "+c,appendParentCls:ie,black:1,shift:[12,4],onShowStart:g,onShowEnd(){d=setTimeout(g,500)},onHide(){clearTimeout(d)},force:!0,toup:a.getBoundingClientRect().top>_+37,hasover:!0}),setTimeout(g,500)}function qs(e){const t=(0,E.getPeer)(e),s=(0,u.getTab)(e,t),a=(0,w.isPinnedMessageVisibleInTab)(e,(0,E.getPeer)(e))||s&&s.top_banner,n=(0,H.getPeerProfileHeight)(),i=s&&(0,u.tabIsMessageRequest)(s)&&!(0,u.tabIsRejectedMessageRequest)(s);return 105+(a?i?Ke:Ks(e):0)+n}function Ks(e){const t=(0,u.getPinnedMessage)(e);return t&&(0,m.isMoneyRequest)(t)?qe:$e}function Vs(e,t){e.bodyNode.addEventListener("mouseover",(e=>{e.target.classList.contains("_im_edit_time")&&Gs(t,0,e.target),e.target.classList.contains("_im_page_info")&&js(0,0,e.target)})),e.bodyNode.addEventListener("click",(e=>{e.target.closest(`.${De}`)&&Ua(e)}))}function Ys(e,t,s,a,n){const i=e.get();let o;Vs((0,b.showTabbedBox)("al_im.php",{act:"a_get_pinned_message_box",chat:s,gid:e.get().gid,hash:i.tabs[s].hash},{onDone:(s,n)=>{n&&(o=a(s,e,t,n),(0,J.initWidgets)(s.bodyNode))},params:{width:638,containerClass:"im-show-message-box",onHide:()=>{AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)},onDestroy:()=>{o&&o.unmount()}}},n),e)}function Ws(e,t,s){const a=e.get();Vs((0,b.showTabbedBox)("al_im.php",{act:"a_get_replied_message_box",chat:a.peer,msgid:t,gid:a.gid,hash:a.tabs[a.peer].hash},{onDone:(e,t)=>{},params:{width:638,onHide:()=>{AudioMessagePlayer.loaded&&AudioMessagePlayer.detachPlayer(!0)},onDestroy:()=>{}}},s),e)}function zs(e,t){return!(!Z.Ranges.isChatOrChannelPeer(e.peerId)||!e.memberIds)&&e.memberIds.indexOf(t)>=0}function Qs(e){return!Z.Ranges.isChatOrChannelPeer(e.peerId)||e.data.kicked?0:e.membersCount}function Js(e,t){let s=[],a=t.find((e=>"mail"===e[0])),n=a?a[1].split(";"):[];for(n.length>je&&(a[1]=n.slice(0,je).join(";"));e.length>Ue;){let t=e.substr(0,Ue).lastIndexOf(" ");-1==t&&(t=Ue),s.push({msgText:(0,d.trim)(e.substr(0,t))}),e=(0,d.trim)(e.substr(t))}for(e.length&&s.push({msgText:e,attaches:t}),s.length||s.push({attaches:t}),n=n.slice(je);n.length;n=n.slice(je))s.push({attaches:[["mail",n.slice(0,je).join(";")]]});return s}function Zs(e){return e.length>Ue}function Xs(e,t,s,a=!0,n=null){const i=Object.assign(function(e,t){if(t)return{chat_id:e.invite_chat_id,hash:e.invite_hash,link:e.invite_link};return e}(t,a),{act:"a_chat_preview"});let o=!1;(0,b.showBox)("al_im.php",i,{stat:["boxes.css"],params:{hideButtons:!0,onHide(){e.set(s),o&&o.unmount()}},onFail:e=>(setTimeout((()=>(0,b.showFastBox)(U.getLang("global_error"),e)),0),!0),onDone(t){o=(0,C.mount)(t.bodyNode,e,n)}},{})}function ea(){(0,b.showFastBox)(U.getLang("global_error"),U.getLang("mail_message_wait_until_uploaded"))}function ta(e,t){const s=(0,u.getTab)(e,t.peerId)||{},a=e.get(),n=Z.Ranges.isChatOrChannelPeer(t.peerId)&&(0,N.isUserAdminInChat)(s,a.id),i=Z.Ranges.isChatOrChannelPeer(t.peerId)&&(0,N.isUserAdminInChat)(s,t.userId);if(!t)return!1;if(!(0,m.isOut)(t)&&(!n||i))return!1;if(333==t.peerId)return!1;if(Date.now()/1e3-t.date>86400)return!1;if(Je(e,t.peerId,t.messageId))return!1;if(Z.Ranges.isChatOrChannelPeer(t.peerId)){if(!(0,u.isChatActive)(s))return!1}else if(s.block_error>0)return!1;return!0}function sa(e,t){return t.map((t=>(0,M.oCacheGet)(e,t)))}function aa(e,t){if("number"!=typeof e||0===e)return"";const s=[[31536e3,t?U.getLang("global_years_accusative","raw"):U.getLang("global_age_years","raw")],[2592e3,t?U.getLang("global_months_accusative","raw"):U.getLang("global_age_months","raw")],[604800,t?U.getLang("global_weeks_accusative","raw"):U.getLang("global_age_weeks","raw")],[86400,t?U.getLang("global_days_accusative","raw"):U.getLang("global_age_days","raw")],[3600,t?U.getLang("global_hours_accusative","raw"):U.getLang("global_hours","raw")],[60,t?U.getLang("global_minutes_accusative","raw"):U.getLang("global_minutes","raw")],[1,t?U.getLang("global_seconds_accusative","raw"):U.getLang("global_age_seconds","raw")]];let a,n=e,i=[];if(s.forEach((([e,t])=>{let s=Math.floor(n/e);n%=e,s>=1&&i.push((0,U.langNumeric)(s,t))})),a=i.length,1===a)return i.pop();const o=i.slice(0,a-1).join(", "),r=i.pop();return U.getLang("global_and").replace(/{before}/gi,o).replace(/{after}/gi,r)}function na(e,t,s,a){if(a&&!Je(e,s,a)){(0,u.getMessage)(e,s,a)?(e.setState({msgid:a}),(0,g.updateLocation)({msgid:a}),t()):e.get().longpoll.push([(0,L.changePeer)(s,a)])}}function ia(e){let t=(0,B.geByClass1)("im-mess_is_editing");if(!t)return null;let s=e.get().tabs[e.get().peer],a=(0,u.parserMessage)(s.msgs[(0,B.domData)(t,"msgid")]);return a&&a.peerId==e.get().peer?a:null}function oa(e,t){const s="unshown";if((0,u.isClassicInterface)(e)){const t=document.getElementById("ui_rmenu_mr");t&&((0,u.existsIncomingMessageRequest)(e)?t.classList.remove(s):t.classList.add(s))}else t(e)}function ra(){let e=(0,r.curBox)();for(;e;)e.hide(),e=(0,r.curBox)()}function la(e,t){return U.getLang("mail_invitation_sended_ago").replace("{when}",(0,U.getDateText)(e,t))}function ca(e,t){const s=(0,E.getPeer)(e),a=(0,u.getMessage)(e,s,t);return(0,N.canPinOrUnpin)(e,s)&&!(0,m.isCasperMessage)(a)}function da(e,t){const s=(0,E.getPeer)(e);return!t.find((t=>{const a=(0,u.getMessage)(e,s,t);return(0,m.isCasperMessage)(a)}))}function _a(e,t){const s=(0,E.getPeer)(e);return!t.find((t=>{const a=(0,u.getMessage)(e,s,t);return(0,m.isCasperMessage)(a)}))}function ga(e,t){const s=F.casperMessagesStore.isProcessed(e.chat_local_id),a=F.casperMessagesStore.has(e.chat_local_id),n=F.casperMessagesStore.getExpireTime(e.chat_local_id)>F.MAX_DEVIATION;(!a&&!s||a&&n)&&t(e),a&&n&&F.casperMessagesStore.remove(e.chat_local_id)}function ua(e){return e===vk.id}function ma(e){return!ua(e)&&(Z.Ranges.isChatOrChannelPeer(e)||Z.Ranges.isUserId(e))}function pa(e,t){return Z.Ranges.isUserId(t)&&!ua(t)&&!(0,u.isCommunityInterface)(e)&&!Z.Ranges.isContactId(t)}function ha(e,t){const s=e.get(),a=(0,u.isCommunityInterface)(e);return Z.Ranges.isUserIdTransitional(t)&&!ua(t)&&!a&&!(0,d.inArray)(t,s.moneyTransferExcept)&&!Z.Ranges.isContactId(t)||Z.Ranges.isGroupId(t)&&s.moneyTransferCommAvail&&(0,j.getCurrentTab)(e).moneyTransferAvail&&!a||a&&s.moneyRequestAvail&&!Z.Ranges.isChatOrChannelPeer(t)||Z.Ranges.isChatOrChannelPeer(t)&&(0,j.getCurrentTab)(e).moneyRequestAvail&&!(0,u.isCasperChat)(e,t)}function fa(e,t,s){const a="im-expired-message",n=(0,B.geByClass1)(`_im_mess_${s.messageId}`,t),i=n&&n.closest(He);if(!n||!i)return t;const o=Array.from(i.querySelectorAll("._im_mess")),[r,l]=function(e){const t=e.previousElementSibling,s=e.nextElementSibling;return[t&&1===t.nodeType?t:null,s&&1===s.nodeType?s:null]}(i),c=r&&r.classList.contains(a),d=l&&l.classList.contains(a),_=c&&0===o.findIndex((e=>+e.getAttribute("data-msgid")===s.messageId)),g=d&&o.findIndex((e=>+e.getAttribute("data-msgid")===s.messageId))===o.length-1,u=ba((_?+r.getAttribute("data-count"):0)+(g?+l.getAttribute("data-count"):0)+1,`_im_expired_message_${s.messageId}`),m=(0,B.se)(u);if(_&&(m.classList.add(...r.classList),r.remove()),g&&(m.classList.add(...l.classList),l.remove()),1===o.length)i.replaceWith(m);else{const[t,a]=o.reduce(((e,t)=>{const a=+t.getAttribute("data-msgid");return a<s.messageId&&e[0].push(t),a>s.messageId&&e[1].push(t),e}),[[],[]]);i.replaceWith((0,B.se)(va(e,t))||"",m,(0,B.se)(va(e,a))||"")}return t}function ba(e,t=""){return(0,d.getTemplate)("sImExpiredMessagePlaceholder",{text:(0,U.langNumeric)(e,U.getLang("mail_messages_expired","raw")).replace("{count}",e),count:e,id_classes:(0,h.classNames)(t)})}function va(e,t){if(0===t.length)return"";const s=+t[0].getAttribute("data-peer"),a=+t[0].getAttribute("data-msgid"),n=(0,u.getMessage)(e,s,a);return(0,d.getTemplate)("im_mess_stack",Object.assign((0,k.getStackDataFromMessage)(e,n),{messages:t.reduce(((e,t)=>e+t.outerHTML),"")}))}function Ca(e,t){const s=Be+`[data-msgid="${t.messageId}"]`;Array.from(e.querySelectorAll(s)).forEach((e=>{const t=e.querySelector(".im-replied--text"),s=e.querySelector(".im-replied--photo-wrapper");t.innerHTML=(0,d.getTemplate)("im_dialog_media",{name:U.getLang("mail_expired_message")}),s.innerHTML=""}))}function Ta(e){return Z.Ranges.isChatOrChannelPeer(e.peerId)&&e.membersCount?(0,U.langNumeric)(e.membersCount,U.getLang("mail_im_n_chat_members","raw")):""}const La=T.CallStatSource.CONVO_SNIPPET,Ea=T.CallStatSource.CONVO_HEADER,Ia=T.CallStatSource.CONVO_LIST,ya=T.CallStatSource.CONVO_JOIN_SNIPPET,Sa=T.CallStatSource.CONVO_JOIN_HEADER,Aa=T.CallStatSource.CONVO_JOIN_BANNER;T.CallStatSource.WIDGET;function Ra(e,t,s=!1,n,i,o=!1,r=!1){if(window.Calls&&window.Calls.call&&!window.Calls.isInActiveCall){if(o)return void window.Calls.showStartCallModal(t,void 0,i,!0);if(r)return void window.Calls.showCallByNamePopup(t,i);if(!t)return void window.Calls.startCall(s,i);if(Z.Ranges.isChatOrChannelPeer(t)){const o=(0,u.getTab)(e,t),r=(0,a._)({},o,{canAddMembers:(0,N.canInviteUser)(e,t,void 0)});window.Calls.startGroupCall(t,[r],n,s,i)}else{const n=(0,M.oCacheGet)(e,t),o=(0,a._)({},n,{canAddMembers:!0});window.Calls.call(t,s,[o,[n]],i)}}}function ka(e){(0,v.cancelEvent)(e);const t=e.target.closest(`.${le}`),s=t&&t.querySelector("[href]");if(!s)return;const a=decodeURIComponent(s.getAttribute("href"));return a&&window.Calls&&window.Calls.showJoinPopup?window.Calls.showJoinPopup(a,T.CallStatSource.LINK_JOIN_SNIPPET):void 0}function Pa(e,t){const s=(0,u.getTab)(e,t);return!(0,u.isCommunityInterface)(e)&&!!s.can_start_call}function Ma(e,t){const s=(0,u.getTab)(e,t);return!(!s||!s.callInProgress)}function wa(e,t,s,a=!1,n){if(window.Calls&&window.Calls.call&&!window.Calls.isInActiveCall){const a=(0,u.getTab)(e,t);if(!(0,u.isChatActive)(a))return;window.Calls.joinOrStartCallModal(t,s,T.CallStatSource.VKCOM_MESSENGER)}}function Oa(e,t=void 0){const s=t?`&msgid=${t}`:"";return`/im?sel=${Tt(e)}${s}`}function Na(e,t){(0,b.showBox)("al_im.php",{act:"group_calls_onboarding_box"},{params:{hideButtons:!0,hideOnBGClick:!1,width:655,onHide:()=>{"group_calls"===nav.objLoc.promo&&(delete nav.objLoc.promo,nav.setLoc(nav.objLoc)),ajax.post("al_index.php",{act:"hide_feature_tt",hash:t,type:"group_calls"})}},containerClass:"GroupCallsOnboarding",onDone:t=>{const s=t.bodyNode,a=s.querySelector(".GroupCallsOnboarding__call-button"),n=s.querySelector(".GroupCallsOnboarding__skipButton"),i=s.querySelector(".GroupCallsOnboarding__closeButton"),o=(0,B.ge)("box_layer",t.bodyNode),r=function(){t.hide();const s=new ElementTooltip((0,B.geByClass1)("_im_create_call"),{content:U.getLang("mail_group_calls_im_search_tt"),forceSide:"bottom",cls:"feature_intro_tt feature_intro_blue_tt",autoShow:!1,appendTo:(0,B.geByClass1)("_im_dialogs_search"),width:250,offset:(0,u.isClassicInterface)(e)?[10,25]:[13,12],rightShift:30,onHide:function(){(0,v.removeEvent)(s._ttel,"click")}});s.show(),(0,v.addEvent)(s._ttel,"click",(()=>s.hide())),cur.destroy.push((()=>{(0,v.removeEvent)(s._ttel,"click"),s.destroy()}))};(0,v.addEvent)(a,"click",(()=>{t.hide(),Ra(e,null,!1,null,Ia)})),(0,v.addEvent)(n,"click",r),(0,v.addEvent)(i,"click",r);const l=e=>{e.target===o&&((0,v.removeEvent)(o,"click",l),r())};(0,v.addEvent)(o,"click",l),cur.destroy.push((()=>{(0,v.removeEvent)(n,"click"),(0,v.removeEvent)(i,"click"),(0,v.removeEvent)(a,"click"),(0,v.removeEvent)(o,"click",l),t.hide(),t.destroy()}))}})}function xa(e,t){cur.groupCallsTooltip||"im"!==cur.module||!(0,B.isVisible)("im_dialogs_search")||cur.introTooltipShow||setTimeout((function(){const s=()=>{cur.groupCallsTooltip&&cur.groupCallsTooltip.destroy(),ajax.post("al_index.php",{act:"hide_feature_tt",hash:t,type:"group_calls_new_year"})};cur.groupCallsTooltip=new ElementTooltip((0,B.geByClass1)("_im_create_call"),{content:U.getLang("mail_group_calls_im_search_new_year_tt"),forceSide:"bottom",cls:"feature_intro_tt feature_intro_blue_tt",autoShow:!1,appendTo:(0,B.geByClass1)("_im_dialogs_search"),width:200,offset:(0,u.isClassicInterface)(e)?[10,25]:[13,12],rightShift:30,onHide:function(){cur.groupCallsTooltip&&((0,v.removeEvent)(cur.groupCallsTooltip._ttel,"click",s),cur.groupCallsTooltip.destroy()),ajax.post("al_index.php",{act:"hide_feature_tt",hash:t,type:"group_calls_new_year"})}}),cur.groupCallsTooltip.show(),(0,v.addEvent)(cur.groupCallsTooltip._ttel,"click",s),cur.destroy.push((function(){cur.groupCallsTooltip&&((0,v.removeEvent)(cur.groupCallsTooltip._ttel,"click",s),cur.groupCallsTooltip.destroy())}))}),1e3)}function Da(e,t){let s=20;const a=document.querySelector("._im_aside_notice");return a&&(s+=a.offsetHeight),(0,u.isCommunityInterface)(e)?s+=268:(s+=120,e.get().hasContacts&&(s+=32),(0,u.existsIncomingMessageRequest)(e)&&(s+=32)),Math.floor((t-s)/32)}function Fa(e,t,s,a){const n=a?()=>a.removeDialog(e,t):null,i=()=>(0,u.isClassicInterface)(e)&&s().updateMenu(e);return((0,u.getTab)(e,t)?Promise.resolve():e.set((e=>(0,z.loadPeer)(e,t,0,!1,!1,"chatInvite")))).then((()=>{const s=(0,u.getTab)(e,t);return(0,u.tabIsMessageRequestToChat)(s)?Xs(e,{receiver_peer_id:t},O.leaveInvitation,!1,{updateList:n,updateMenu:i}):e.get().longpoll.push([(0,L.changePeer)(t,!1,!1,!1,"")])}))}function Ha(e,t){t?X.FlatButton.lock(e):X.FlatButton.unlock(e)}function Ba(e,t,s){const a=e.querySelector(`.${oe}_${t}`);return a?a.querySelector(`.${ne}[data-index="${s}"]`):null}function Ua(e){const t=e.target.closest(`.${xe}`);(0,v.cancelEvent)(e),t&&t.classList.toggle(Fe)}},894523:(e,t,s)=>{s.d(t,{getAuthorId:()=>o,getMessageTTL:()=>n.getMessageTTL,getUserId:()=>i,isAppAction:()=>n.isAppAction,isAudioMsg:()=>n.isAudioMsg,isCallMessage:()=>n.isCallMessage,isCasperMessage:()=>n.isCasperMessage,isExpiredCasperMessage:()=>n.isExpiredCasperMessage,isGift:()=>n.isGift,isGraffiti:()=>n.isGraffiti,isImportant:()=>n.isImportant,isMessageEmpty:()=>n.isMessageEmpty,isMessageToBlockedCommunity:()=>n.isMessageToBlockedCommunity,isMoney:()=>n.isMoney,isMoneyRequest:()=>n.isMoneyRequest,isOut:()=>n.isOutbound,isServiceMsg:()=>n.isServiceMsg,isSticker:()=>n.isSticker,isUnread:()=>n.isUnread,isVKPay:()=>n.isVKPay});var a=s(705758),n=s(783400);function i(e){return(0,n.isOutbound)(e)?vk.id:e.userId}function o(e,t){const s=(0,a.unpackStore)(e);return(0,n.isOutbound)(t)?s.id:t.userId}},523305:(e,t,s)=>{s.d(t,{applyPeerTagsFilterToTab:()=>Q,convertPeerTagsFilterToMask:()=>Y,createAdUrl:()=>D,initPeerTagsFilter:()=>B,isPeerTagsFolder:()=>K,onDialogPeerTagClick:()=>q,onPeerProfileTagsChangedEvent:()=>z,onPeerTagsChangeEvent:()=>W,onPeerTagsExtraHover:()=>N,onPeerTagsFilterCheckboxChange:()=>U,onPeerTagsFilterPaneItemClick:()=>j,renderPeerTags:()=>F,renderPeerTagsFilter:()=>H,renderPeerTagsFilterPane:()=>G,updateEmptyDialogsMargin:()=>J});var a=s(875610),n=s(82161),i=s(222009),o=s(165203),r=s(795558),l=s(29271),c=s(320422),d=s(659397),_=s(95638);const g="#e5ebf1",u=8,m=4,p=9,h=104,f=97,b=145,v=69,C="_im_dialog",T="_im_page_dialogs",L="_im_peer_tags_filter_control",E="PeerTagsFilter__control--hidden",I="_im_peer_tags_filter_tags",y="_im_peer_tags_filter_pane",S="PeerTagsFilterPane--active",A="_im_peer_tags_filter_pane_item",R="_im_right_menu",k="ui_rmenu_item_sel",P="_ui_item_all",M="im-page--dialogs-empty",w=5;function O(e,t){let s=0,a=[],n=[],i=!1;return e.forEach((e=>{e.width=e.width?e.width:function(e){return u+m+(0,d.decodeHTMLEntities)(e.name).length*p}(e),e.width+(i?0:v)>=t-s?(n.push(e),i||(s+=v,i=!0)):(a.push(e),s+=e.width)})),[a,n]}function N(e,t){const s=e.target,a=(0,r.gpeByClass)(C,s),o=parseInt((0,r.domData)(a,"peer")),l=t.get(),d=(0,i.getTab)(l,o),_=d.peerTagsMaxWidth;if(!_)return;const g=x(l,d),[,u]=O(g,_),m=u.reduce(((e,t)=>e+=(0,n.getTemplate)("sImPeerTagsExtraTooltipItem",{name:t.name,color:t.color})),"");(0,c.showTooltip)(s,{text:m,center:!0,dir:"bottom",className:"PeerTagsExtraTooltip",hasover:!0})}function x(e,t){let s=t.peer_tags&&t.peer_tags.ids.length?e.peer_profile_tags.filter((e=>t.peer_tags.ids.includes(e.id))):[];return t.ad_id&&s.unshift(function(e){let t,s;if(e.is_easy_promoted_market)t=l.getLang("mail_ad_tag_easy_promoted_market"),s=b;else{const a=e.is_mail_ru_ad?l.getLang("mail_ad_mail_ru_tag_text_prefix"):l.getLang("mail_ad_tag_text_prefix");t=e.has_ad_access?`${a} ${e.ad_id}`:l.getLang("mail_ad_tag_no_access_text"),s=e.has_ad_access?h:f}return{isAdTag:!0,adTagText:t,width:s,name:t,color:g}}(t)),s}const D=(e,t)=>e?`https://ads.vk.com/hq/dashboard/ads/${t}`:`ads?act=office&union_id=${t}&utm_medium=community_messages_ad_tag&utm_source=dialog`;function F(e,t,s,a){if(t<v)return void(e.innerHTML="");e.style.maxWidth=t+"px";const o=s.get(),r=(0,i.getTab)(o,a),c=x(o,r);if(!c.length)return void(e.innerHTML="");const[d,_]=O(c,t);let g=d.reduce(((e,t)=>{if(t.isAdTag){const s=D(r.is_mail_ru_ad,r.ad_id);e+=(0,n.getTemplate)("sImPeerTagsAdTag",{ad_tag_text:t.adTagText,url:s,mail_ad_tag_no_access_box_title:l.getLang("mail_ad_tag_no_access_box_title"),mail_ad_tag_no_access_box_text:l.getLang("mail_ad_tag_no_access_box_title"),extra_class:r.has_ad_access?"PeerTagsItem--hasAdAccess":""})}else e+=(0,n.getTemplate)("sImPeerTagsItem",{tag_id:t.id,name:t.name,color:t.color});return e}),"");const u=_.length,m=`+${l.getLang("mail_im_peer_profile_extra_tags",u)}`;u&&(g+=(0,n.getTemplate)("sImPeerTagsExtra",{text:m})),e.innerHTML=g}function H(e){const t=(0,r.geByClass1)(I),s=e.peer_profile_tags||[];s.length>0&&t&&(t.innerHTML=s.reduce(((t,s)=>t+=(0,n.getTemplate)("sImPeerTagsFilterItem",{tag_id:s.id,name:s.name,color:s.color,checked:e.peer_tags_filter.ids.includes(s.id)?"checked":"",count:s.uses})),""))}function B(e){const t=e.get(),s=(0,r.geByClass1)(L);if(s)if(!t.peer&&t.peer_profile_tags&&t.peer_profile_tags.length>0){(0,r.removeClass)(s,E);const n=V(t.peer_profile_tags,t.peer_tags_filter.mask);e.set((e=>(0,a.updatePeerTagsFilter)(n,e))).then((()=>$(e,n,!0)))}else(0,r.addClass)(s,E)}function U(e,t){const s=t.get(),n=e.target,i=parseInt(n.id.slice(9)),o=n.checked?[].concat(s.peer_tags_filter.ids,i):s.peer_tags_filter.ids.filter((e=>e!==i));t.set((e=>(0,a.updatePeerTagsFilter)(o,e))).then((()=>$(t,o)))}function j(e,t){const s=t.get(),n=(0,r.hasClass)(e.target,A)?e.target:(0,r.gpeByClass)(A,e.target),i=parseInt((0,r.domData)(n,"id")),o=s.peer_tags_filter.ids.filter((e=>e!==i));t.set((e=>(0,a.updatePeerTagsFilter)(o,e))).then((()=>$(t,o)))}function G(e){const t=e.peer_tags_filter.ids,s=t.length>0,a=(0,r.geByClass1)(y),i=function(){const e=(0,r.geByClass1)(T),t=(0,r.geByClass1)(y);return parseFloat(getComputedStyle(e)["padding-top"])-(t&&t.offsetHeight>0?t.offsetHeight+1:0)}();if(s&&a){const s=(e.peer_profile_tags||[]).filter((e=>t.includes(e.id))).sort(((e,s)=>t.indexOf(e.id)-t.indexOf(s.id)));a.innerHTML=s.reduce(((e,t)=>e+=(0,n.getTemplate)("sImPeerTagsFilterPaneItem",{tag_id:t.id,name:t.name,color:t.color})),"")}(0,r.toggleClass)(a,S,s),function(e,t){const s=(0,r.geByClass1)(T),a=(0,r.geByClass1)(y);if(e&&a){const e=t+(a.offsetHeight+1);s.style.paddingTop=`${e}px`}else s.style.paddingTop=`${t}px`}(s,i),J()}function $(e,t,s){const a=e.get();H(a),G(a),function(e){const t=(0,r.geByClass1)(R),s=(0,r.geByClass1)(k,t),a=(0,r.geByClass1)(P,t);(e.length>0||!s)&&uiRightMenu.switchMenu(a)}(t),s||a.longpoll.push([(0,_.changeTab)(t.length>0?o.FOLDER_PEER_TAGS:o.FOLDER_ALL)])}function q(e,t){const s=e.target,n=[parseInt((0,r.domData)(s,"id"))];t.set((e=>(0,a.updatePeerTagsFilter)(n,e))).then((()=>$(t,n)))}function K(e){return e.get().active_tab===o.FOLDER_PEER_TAGS}function V(e,t){if(!e||!e.length||!t)return[];const s=t.toString(2).split("").reverse().reduce(((e,t,s)=>("1"===t&&e.push(1<<s),e)),[]);return e.filter((e=>s.includes(e.mask))).map((e=>e.id))}function Y(e,t){return Number.isInteger(t)?t:e&&e.length&&t&&t.length?e.filter((e=>t.includes(e.id))).reduce(((e,t)=>e+=t.mask),0):null}function W(e,t,s){const{peerId:n,peerTagsMask:i}=s,o=e.get(),r=V(o.peer_profile_tags,i);e.set((e=>(0,a.updatePeerTags)(n,r,i,e))).then((()=>{H(e.get()),o.peer||(t.renderPeerTags(e,n),K(e)&&e.set(a.updatePeerTagsFilterFolder).then((()=>t.restoreDialogs(e))))}))}function z(e,t){e.set(a.updatePeerProfileTags).then((()=>{H(e.get()),e.get().peer||(t.restoreDialogs(e),t.renderPeerTags(e))}))}function Q(e,t){const s=e.peer_tags_filter.mask;return!(!s||!t.peer_tags)&&!!(s&t.peer_tags.mask)}function J(){const e=(0,r.geByClass1)(M);if(!e)return;const t=(0,r.geByClass1)(y),s=t&&t.offsetHeight>0?t.offsetHeight/2:w;e.style.marginTop=`${s}px`}},872306:(e,t,s)=>{s.d(t,{EXPIRED:()=>c,EXPIRING:()=>r,EXPIRING_SOON:()=>l,EXPIRING_SOON_TIME:()=>o,EXPIRING_TIME:()=>i,MAX_DEVIATION:()=>n,casperMessagesStore:()=>m});var a=s(894523);const n=2e3,i=6e4,o=1e4,r="expiring",l="expiring_soon",c="expired";let d=[],_={},g={},u=0;const m={add(e){const[t,s,a]=h(e),n=Math.max(t+s-i-a,0),d=Math.max(t+s-o-a,0),u=Math.max(t+s-a,0),m=setTimeout((()=>{p({type:r,message:e})}),n),f=setTimeout((()=>{p({type:l,message:e})}),d),b=setTimeout((()=>{p({type:c,message:e}),g[e.chat_local_id]=!0,delete _[e.chat_local_id]}),u);_[e.chat_local_id]={message:e,expiringTime:n,expiredTime:u,timers:[m,f,b]}},remove(e){if(this.has(e)){const{timers:t}=_[e];t.forEach(clearTimeout),delete _[e]}},setTimeshift(e){u=1e3*(e||0)},getTimings(e){if(!_[e])return[0,0,0];return h(_[e].message)},getExpireTime(e){if(!_[e])return 0;const t=_[e].message,[s,a,n]=h(t);return Math.max(Math.floor((s+a-n)/1e3),0)},isProcessed:e=>!!g[e],subscribe(e){d.push(e)},unsubscribe(e){d=d.filter((t=>t!==e))},has:e=>!!_[e],destroy(){_={},d=[],g={}}};function p(e){d.forEach((t=>t(e)))}function h(e){return[1e3*e.date+u,1e3*((0,a.getMessageTTL)(e)||0),Date.now()]}}}]);try{stManager.done("dist/2aead09ce491161446bab7106fe7892a.728d1f7479bd1311e5c3.js")}catch(e){}
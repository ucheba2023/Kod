"use strict";(self.webpackChunkvk=self.webpackChunkvk||[]).push([[70486],{136023:(t,e,i)=>{i.d(e,{MVK_WALL_ITEM_SELECTOR:()=>s,WEB_FEED_ITEM_SELECTOR:()=>o});const s=".wall_item, .post_item, .js-wall_item",o=".feed_row"},475400:(t,e,i)=>{var s;i.d(e,{BasicStatisticsEvents:()=>s,DEFAULT_BLOCK_LS_KEY_NAME:()=>o,MAX_RETRY_COUNT:()=>n}),function(t){t.ViewBlock="view_block",t.ViewTime="view_time",t.HideBlock="hide_block",t.OpenUser="open_user"}(s||(s={}));const o="block_stat",n=3},859483:(t,e,i)=>{i.d(e,{Stats:()=>l});var s=i(599809),o=i(531730),n=i(367431),r=i(321850),a=i(475400);const h=(0,n.makeSharedState)("block-stats",(()=>({blockStatsInstance:null})),{version:0});class l{static getInstance(){let t=h().blockStatsInstance;return t||(t=new l(a.DEFAULT_BLOCK_LS_KEY_NAME),h().blockStatsInstance=t),t}destroyInterval(){clearInterval(this._sendInterval),this.send()}destroyInstance(){h().blockStatsInstance=null}registerConsumer(t){this.consumerList.includes(t)||this.consumerList.push(t)}unRegisterConsumer(t){this.consumerList=this.consumerList.filter((e=>e!==t)),this.consumerList.length||this.destroyInterval()}pushLs(t,e){const i=o.multiAccountLs.get(null!=e?e:this._lsKeyName)||[];i.push(t),o.multiAccountLs.set(null!=e?e:this._lsKeyName,i)}log(t,e){this.pushLs(t,e)}setLs(t,e,i,s){const n=null!=i?i:this._lsKeyName,r=o.multiAccountLs.get(n)||{};s&&(Object.keys(r).forEach((t=>{var e;Date.now()-(null==(e=r[t])?void 0:e.date)>s&&delete r[t]})),window.setTimeout((()=>{const e=o.multiAccountLs.get(n)||{};delete e[t],Object.keys(e).length?o.multiAccountLs.set(n,e):o.multiAccountLs.remove(n)}),s)),r[t]=e,o.multiAccountLs.set(n,r)}send(t,e){const i=null!=e?e:o.multiAccountLs.get(null!=t?t:this._lsKeyName)||[];if(i.length){o.multiAccountLs.remove(null!=t?t:this._lsKeyName);try{l.request(JSON.stringify(i))}catch(e){this.log(i,null!=t?t:this._lsKeyName)}}}static request(t){(0,s.api)("stats.trackEvents",{events:t})}constructor(t){this._lsKeyName=a.DEFAULT_BLOCK_LS_KEY_NAME,this._DELAY_SEND=1500,this.consumerList=[],this.send=this.send.bind(this),this.destroyInstance=this.destroyInstance.bind(this),t&&(this._lsKeyName=t),this._sendInterval=setInterval(this.send,this._DELAY_SEND),(0,r.pushNavDestroy)((()=>{this.destroyInstance()}))}}},734462:(t,e,i)=>{i.d(e,{NO_POSITION:()=>o,feedItemSelector:()=>r,getBlockFeedPosition:()=>n});var s=i(136023);const o=-1,n=(t,{closestFeedItemSelector:e,validElemSelector:i}={validElemSelector:!1})=>{var s;const n=e?(r=e,t.closest(r)):t;var r;const a=null==(s=n)?void 0:s.parentNode;if(!n||!a)return o;const h=a.children;let l=0;for(let t=0;t<h.length;t++){const e=h[t];if("string"==typeof i&&!e.matches(i)&&(l+=1),e===n)return t-l}return o};function r(t){return t?s.MVK_WALL_ITEM_SELECTOR:s.WEB_FEED_ITEM_SELECTOR}},115979:(t,e,i)=>{i.d(e,{PhotoCarousel:()=>r});var s=i(795558),o=i(428518);const n="PhotoCarousel__arrowWrapper--hidden";class r{destroy(){this.deInitListeners()}initListeners(){this.leftArrowBtn&&this.leftArrowBtn.addEventListener("click",this.onLeftArrowClick),this.rightArrowBtn&&this.rightArrowBtn.addEventListener("click",this.onRightArrowClick)}deInitListeners(){this.leftArrowBtn&&this.leftArrowBtn.removeEventListener("click",this.onLeftArrowClick),this.rightArrowBtn&&this.rightArrowBtn.removeEventListener("click",this.onRightArrowClick)}next(){this.move(this.getActiveIdx()+1)}prev(){this.move(this.getActiveIdx()-1)}getActive(){return this.items[this.activeItemIdx]}getActiveIdx(){return this.activeItemIdx}getActiveItemIdxFromDOM(){return Number(this.carousel.dataset.idx)}move(t){var e;const i=this.getActiveIdx(),n=this.getActive(),r=this.items[t];if(!r)return;const a=r.getEl();if(!this.rightArrowBtn||!this.leftArrowBtn)return;const h=r.getPhotoRawId(),[l]=(0,s.getSize)(a),c=a.offsetLeft,d=Math.round(this.photoListWidth-this.carouselWidth);let g=c+l/2-this.carouselWidth/2;if(t>i)g=Math.min(g,d);else{if(!(t<i))return;g=Math.max(g,0)}g=Math.round(g),this.photoList.style.transform=`translateX(-${g}px)`;const u=(this.carouselWidth-l-12)/2,_=this.carouselWidth-l-20-6;g?(this.toggleLeftBtnDisabled(!1),this.leftArrowBtn.style.width=g===d?`${_}px`:`${u}px`):this.toggleLeftBtnDisabled(!0),g===d?this.toggleRightBtnDisabled(!0):(this.toggleRightBtnDisabled(!1),this.rightArrowBtn.style.width=g?`${u}px`:`${_}px`),n.setActive(!1),r.setActive(),this.activeItemIdx=t,this.items.slice(t,t+o.NUMBER_INITIALIZED_PHOTO).forEach((t=>t.init())),this.carousel.setAttribute("data-idx",String(t)),this.post.setAttribute("data-photo-raw-id",String(h)),(null==(e=this.options)?void 0:e.onChange)&&this.options.onChange()}toggleLeftBtnDisabled(t=!0){this.leftArrowBtn&&(t?(this.leftArrowBtn.classList.add(n),this.isLeftBtnDisabled=!0):(this.leftArrowBtn.classList.remove(n),this.isLeftBtnDisabled=!1))}toggleRightBtnDisabled(t=!0){this.rightArrowBtn&&(t?(this.rightArrowBtn.classList.add(n),this.isRightBtnDisabled=!0):(this.rightArrowBtn.classList.remove(n),this.isRightBtnDisabled=!1))}constructor(t,e,i){this.activeItemIdx=0,this.onLeftArrowClick=t=>{var e;this.isLeftBtnDisabled?t.stopPropagation():((null==(e=this.options)?void 0:e.onPrevClick)&&this.options.onPrevClick(t),this.prev())},this.onRightArrowClick=t=>{var e;if(this.isRightBtnDisabled)t.stopPropagation();else{var i;if(null==(e=this.options)?void 0:e.onNextClick)null==(i=this.options)||i.onNextClick(t);this.next()}},this.post=t,this.options=i,this.items=e;const o=t.querySelector(".PhotoCarousel"),r=t.querySelector(".PhotoCarousel__arrowWrapper--left"),a=t.querySelector(".PhotoCarousel__arrowWrapper--right"),h=t.querySelector(".PhotoCarousel__items");if(!o||!h)throw new Error("PhotoCarousel: incorrect arguments");const[l]=(0,s.getSize)(h),[c]=(0,s.getSize)(o);this.carousel=o,this.leftArrowBtn=r,this.rightArrowBtn=a,this.isLeftBtnDisabled=!r||r.classList.contains(n),this.isRightBtnDisabled=!a||a.classList.contains(n),this.photoList=h,this.photoListWidth=l,this.carouselWidth=c,this.activeItemIdx=this.getActiveItemIdxFromDOM(),this.initListeners()}}},509366:(t,e,i)=>{i.d(e,{PhotoCarouselItem:()=>n});var s=i(428518),o=i(265865);class n{setActive(t=!0){this.isActive=t,this.item.classList.toggle("PhotoCarouselItem--active",t)}init(){const t=this.item.getAttribute("data-photo-url");if(t){if(this.item.classList.contains(s.PHOTO_CAROUSEL_ITEM_NO_SIZE_CLASS)){const e=this.item.querySelector(`.${s.PHOTO_NO_SIZE_ELEMENT_CLASS}`);e&&(e.src=t)}else{const e=this.item.querySelector(`.${s.PHOTO_ELEMENT_CLASS}`);if(!e)return;e.style.backgroundImage=`url('${t}')`}this.item.removeAttribute("data-photo-url")}}getPhotoRawId(){return this.photoRawId}getOwnerId(){return this.ownerId}getEl(){return this.item}constructor(t){this.item=t;const e=t.querySelector(`.${s.PHOTO_ELEMENT_CLASS}`),i=t.dataset.photoViewOptions||"",n=t.dataset.photoContext,r=t.dataset.photoRawId,a=i&&(0,o.parseJSON)(i);if(!(a&&r&&n&&e))throw new Error("PhotoCarouselBlockItem: incorrect arguments");const[h,l]=r.split("_");this.ownerId=Number(h),this.photoId=Number(l),this.photoRawId=r,this.photoContext=n,this.photoViewOptions=a,this.photo=e,this.isActive=t.classList.contains("PhotoCarouselItem--active")}}},45203:(t,e,i)=>{i.d(e,{PhotoRecognizeBlock:()=>T});var s=i(428518),o=i(467472),n=i(115979),r=i(584356),a=i(795558),h=i(705758),l=i(976835),c=i(29271),d=i(953908),g=i(942418),u=i(859483),_=i(734462),m=i(475400),E=i(970978),p=i(531232);class T{initListeners(){var t;document.addEventListener(l.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationTags),document.addEventListener(l.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationTags),document.addEventListener(l.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),null==(t=this.helpHintPanelHideBtn)||t.addEventListener("click",this.hideHelpHintClick)}deInitListeners(){var t,e;null==(t=this.closeEl)||t.removeEventListener("click",this.removeBlock),null==(e=this.helpHintPanelHideBtn)||e.removeEventListener("click",this.hideHelpHintClick),document.removeEventListener(l.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationTags),document.removeEventListener(l.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationTags),document.removeEventListener(l.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags)}initFirstItems(){this.items.slice(0,s.NUMBER_INITIALIZED_PHOTO).forEach((t=>t.init()))}createItems(t){return Array.from(t.querySelectorAll(`.${s.PHOTO_CAROUSEL_ITEM_CLASS}`)).map((t=>new o.PhotoRecognizeBlockItem(t,this)))}nextWithDelay(){this.nextPhotoTimerId||(this.nextPhotoTimerId=setTimeout((()=>{this.nextPhotoTimerId=null,this.next()}),800))}incrementConfirmedCount(t=1){this.countConfirmedTags+=t}skipActiveItemTags(){this.carousel.getActive().skipTags()}showThanksNotification(){(0,r.showDoneBox)(c.getLang("photo_recognition_thanks_notification"))}showEndCard(){var t;const e=this.innerWrapperEl.parentElement;if(!e)return;const i=this.getEndCardData(),s=c.getLang("photo_recognition_viewed_photos",this.items.length),o=i.subtitle||"",n=i.button,r=(0,a.se)(`\n      <div class="PhotoRecognizeBlockEndCard">\n        <div class="PhotoRecognizeBlockEndCard__close"></div>\n        <div class="PhotoRecognizeBlockEndCard__title">${s}</div>\n        <div class="PhotoRecognizeBlockEndCard__subtitle">${o}</div>\n      </div>\n    `);if(n){const t=n.title,e=n.action.url,i=(0,a.se)(`<a href="${e}" class="PhotoRecognizeBlockEndCard__action flat_button secondary">${t}</a>`);r.appendChild(i)}this.closeEl=r.querySelector(".PhotoRecognizeBlockEndCard__close"),null==(t=this.closeEl)||t.addEventListener("click",this.removeBlock),e.appendChild(r),(0,a.hide)(this.innerWrapperEl),this.sendAnalytic("show_end_card")}getEndCardData(){const t=this.post.getAttribute("data-end-card");return t?(0,h.parseJSON)(t):{}}sendAnalytic(t,e={}){(0,g.sendAnalytic)(t,this.trackCode,e)}viewBlock(){if(!this.ref||!this.trackCode){const t=new Error(`Ref or track code is empty, ref: ${this.ref}, trackCode: ${this.trackCode}`);return void(0,E.logError)(t)}const t=(0,_.feedItemSelector)(!1),e=(0,_.getBlockFeedPosition)(this.post,{closestFeedItemSelector:t,validElemSelector:t}),i={e:m.BasicStatisticsEvents.ViewTime,type:this.blockType,position:e,time:Date.now(),track_code:this.trackCode,ref:this.ref};this.viewStatsLogger.log(i)}constructor(t){var e;this.isDestroyed=!1,this.countConfirmedTags=0,this.destroy=()=>{if(this.isDestroyed)return;this.nextPhotoTimerId&&(clearTimeout(this.nextPhotoTimerId),this.nextPhotoTimerId=null),this.deInitListeners(),this.carousel.destroy(),this.items.forEach((t=>t.destroy())),this.isDestroyed=!0,this.viewStatsLogger.unRegisterConsumer(Symbol.for(s.FEED_RECOGNIZE_PHOTO_POST_ID));const t=(0,p.recognizeBlockState)();t.block&&(t.block=null)},this.handleOutsideConfirmationTags=t=>{const e=t.detail.photoRawId,i=t.detail.tagIds;this.items.filter((t=>t.getPhotoRawId()===e)).forEach((t=>t.setConfirmedTagsByIds(i)))},this.handleOutsideDeclinationTags=t=>{const e=t.detail.photoRawId,i=t.detail.tagIds;this.items.filter((t=>t.getPhotoRawId()===e)).forEach((t=>t.setDeclinedTagsByIds(i)))},this.handleOutsideDeletingTags=t=>{const e=t.detail.photoRawId,i=t.detail.tagIds;this.items.filter((t=>t.getPhotoRawId()===e)).forEach((t=>t.setDeletedTagsByIds(i)))},this.next=()=>{this.nextPhotoTimerId&&(clearTimeout(this.nextPhotoTimerId),this.nextPhotoTimerId=null),this.carousel.getActiveIdx()!==this.items.length-1?this.carousel.next():this.countConfirmedTags?this.showEndCard():(this.removeBlock(),this.showThanksNotification())},this.removeBlock=()=>{this.destroy(),this.post.remove()},this.onPhotoChangeClick=()=>{this.nextPhotoTimerId&&(clearTimeout(this.nextPhotoTimerId),this.nextPhotoTimerId=null),this.skipActiveItemTags()},this.updateBlockTitle=()=>{if(!this.titleEl)return;const t=this.carousel.getActive().getTitle();t&&(this.titleEl.innerHTML=t)},this.hideHelpHintClick=t=>{this.hintHelpId&&this.hintHelpHash&&((0,d.cancelEvent)(t),window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:this.hintHelpId,hash:this.hintHelpHash},{onDone:()=>{var t;null==(t=this.hintHelpPanel)||t.remove()},onFail:()=>(console.error("something wrong with help hint"),!0)}))},this.post=t,this.titleEl=t.querySelector(".PhotoRecognizeBlock__title");const i=t.querySelector(".PhotoRecognizeBlock__inner");if(!i)throw new Error("PhotoRecognizeBlock: there is not inner");this.viewStatsLogger=u.Stats.getInstance(),this.viewStatsLogger.registerConsumer(Symbol.for(s.FEED_RECOGNIZE_PHOTO_POST_ID)),this.trackCode=t.dataset.trackCode||"",this.blockType=t.dataset.blockType||s.FEED_RECOGNIZE_PHOTO_DEFAULT_BLOCK_TYPE,this.ref=t.dataset.ref||"",this.hintHelpId=t.dataset.hintHelpId,this.hintHelpHash=t.dataset.hintHelpHash,this.innerWrapperEl=i,this.items=this.createItems(t),this.carousel=new n.PhotoCarousel(t,this.items,{onPrevClick:this.onPhotoChangeClick,onNextClick:this.onPhotoChangeClick,onChange:this.updateBlockTitle}),this.hintHelpPanel=t.querySelector(".PhotoRecognizeBlockHint"),this.helpHintPanelHideBtn=t.querySelector(".PhotoRecognizeBlockHint__hide"),this.initListeners(),this.initFirstItems(),null==(e=window.cur.destroy)||e.push(this.destroy),window.cur.pvOneSuggestHintId=t.dataset.hintAlertId,window.cur.pvOneSuggestHintHash=t.dataset.hintAlertHash,null==window.cur.pvNeedShowAlertForOneSuggest&&(window.cur.pvNeedShowAlertForOneSuggest=Boolean(Number(t.dataset.needShowAlert))),(0,p.recognizeBlockState)().block=this}}},531232:(t,e,i)=>{i.d(e,{recognizeBlockState:()=>s});const s=(0,i(367431).makeSharedState)("photo_recognize_block",(()=>({block:null})),{version:0})},467472:(t,e,i)=>{i.d(e,{PhotoRecognizeBlockItem:()=>p});var s,o=i(509366),n=i(906482),r=i(95432),a=i(795558),h=i(953908),l=i(970978),c=i(794507),d=i(428518),g=i(840123),u=i(29271),_=i(839470),m=i(942418),E=i(931917);!function(t){t[t.CONFIRMED=0]="CONFIRMED",t[t.DECLINED=1]="DECLINED",t[t.DELETED=2]="DELETED"}(s||(s={}));class p extends o.PhotoCarouselItem{destroy(){this.deInitListeners()}skipTags(){this.isSkipped||(this.isSkipped=!0,window.ajax.post("al_photos.php",{act:"skip_suggested_tags",tag_raw_ids:this.tagArea.getFullRawTagIdsStr(),photo_raw_id:this.getPhotoRawId(),track_code:this.trackCode,hash:this.skipHash},{onDone:()=>{},onFail:t=>(!!(0,_.partConfigEnabled)("recognize_mock_turn_off")&&t&&(0,l.logError)(t),!0)}))}initListeners(){var t,e,i,s,o;null==(t=this.confirmBtn)||t.addEventListener("click",this.onConfirmClick),null==(e=this.declineBtn)||e.addEventListener("click",this.onDeclineClick),null==(i=this.cancelBtn)||i.addEventListener("click",this.onDeclineClick),null==(s=this.showAllBtn)||s.addEventListener("click",this.onShowAllClick),null==(o=this.nextBtn)||o.addEventListener("click",this.onNextClick),this.photo.addEventListener("click",this.onPhotoClick)}deInitListeners(){var t,e,i,s,o;null==(t=this.confirmBtn)||t.removeEventListener("click",this.onConfirmClick),null==(e=this.declineBtn)||e.removeEventListener("click",this.onDeclineClick),null==(i=this.showAllBtn)||i.removeEventListener("click",this.onShowAllClick),null==(s=this.nextBtn)||s.removeEventListener("click",this.onNextClick),null==(o=this.cancelBtn)||o.removeEventListener("click",this.onCancelClick),this.photo.removeEventListener("click",this.onPhotoClick)}showPhoto(t){(0,r.showPhoto)(this.photoRawId,this.photoContext,this.photoViewOptions,t),this.updatePhotoviewCache()}updatePhotoviewCache(t=!1){this.photoViewOptions.noCache=t,t&&(0,g.dropPhotoCacheData)()}showResultPanel(t){var e;if(!this.description)return;const i=this.getResultText(t);this.resultPanel||this.createResultPanel();const s=null==(e=this.resultPanel)?void 0:e.querySelector(".PhotoRecognizeBlockItem__resultMessage");if(!s||!this.resultPanel)throw new Error("PhotoRecognizeBlockItem: can not get text element");this.resultPanel.classList.toggle("PhotoRecognizeBlockItem__resultPanel--confirmed",0===t),s.innerHTML=i,(0,a.hide)(this.description),(0,a.show)(this.resultPanel)}showSuggestPanel(){(0,a.hide)(this.resultPanel),(0,a.show)(this.description)}getResultText(t){const e=this.getOwnerId(),i=this.getConfirmedTags(),s=this.getTags()[0],o=s.getUserId(),r=s.getOwnerNameGenitive(),a=s.getUserNameAccusative();let h="";switch(t){case 0:this.type===n.RecognizeItemType.ME?e===o?h=u.getLang("photo_recognition_confirm_me_on_my_photo"):(h=E.Ranges.isUserIdTransitional(e)?u.getLang("photo_recognition_confirm_myself_on_photo"):u.getLang("photo_recognition_confirm_myself_on_photo_group"),h=h.replace("{name}",r)):this.type===n.RecognizeItemType.FRIEND?e===o?h=u.getLang("photo_recognition_confirm_on_photo").replace("{name}",r):(h=E.Ranges.isUserIdTransitional(e)?u.getLang("photo_recognition_confirm_friend_on_photo"):u.getLang("photo_recognition_confirm_friend_on_photo_group"),h=h.replace("{name1}",a),h=h.replace("{name2}",r)):this.type===n.RecognizeItemType.ALL&&(h=u.getLang("photo_recognition_confirm_n_friends_on_photo",i.length));break;case 1:this.type===n.RecognizeItemType.ALL?h=i.length?u.getLang("photo_recognition_confirm_n_friends_on_photo",i.length):u.getLang("photo_recognition_decline_n_friends_on_photo",i.length):(h=E.Ranges.isUserIdTransitional(e)?u.getLang("photo_recognition_decline_on_photo"):u.getLang("photo_recognition_decline_on_photo_group"),h=h.replace("{name}",r));break;default:h=u.getLang("photo_recognition_deleted_tag")}return h}createResultPanel(){this.resultPanel=document.createElement("div"),this.resultPanel.classList.add("PhotoRecognizeBlockItem__resultPanel");const t=document.createElement("span");t.classList.add("PhotoRecognizeBlockItem__resultMessage"),this.resultPanel.appendChild(t);const e=this.item.querySelector(".PhotoRecognizeBlockItem__footerWrapper");e&&e.appendChild(this.resultPanel)}setConfirmedTagsByIds(t){this.tagArea.setConfirmedTagsByIds(t)&&(this.showResultPanel(0),this.incrementConfirmedCount(t.length))}setDeclinedTagsByIds(t){this.tagArea.setDeclinedTagsByIds(t)&&this.showResultPanel(1)}setDeletedTagsByIds(t){this.tagArea.setDeclinedTagsByIds(t)&&this.showResultPanel(2)}reset(){this.tagArea.reset()}getTitle(){return this.title}getTags(){return this.tagArea.getTags()}getConfirmedTags(){return this.tagArea.getConfirmedTags()}incrementConfirmedCount(t=1){this.block.incrementConfirmedCount(t)}init(){const t=this.item.getAttribute("data-photo-url");t&&(super.init(),this.checkItemHasNoSizes()&&this.correctTagView(t))}checkItemHasNoSizes(){return this.item.classList.contains(d.PHOTO_CAROUSEL_ITEM_NO_SIZE_CLASS)}correctTagView(t){const e=new Image;e.onload=()=>{const i=e.width,s=e.height;if(i&&s){const e=this.item.querySelector(".PhotoRecognizeBlockItem__photoFrame");if(!e)return;const[o,n]=c.PhotoTagArea.calculateTagAreaSizes(e,i,s),r=this.item.querySelector(`.${d.PHOTO_ELEMENT_CLASS}`);if(!r)return;const a=this.item.querySelector(`.${d.PHOTO_NO_SIZE_ELEMENT_CLASS}`);a&&a.remove(),r.style.backgroundSize=`${o}px ${n}px`,r.style.backgroundImage=`url('${t}')`;const h=o+1,l=n+1;this.tagArea.setSizes(h,l),this.tagArea.show(),this.item.classList.remove(d.PHOTO_CAROUSEL_ITEM_NO_SIZE_CLASS)}},e.src=t}sendAnalytic(t,e={}){(0,m.sendAnalytic)(t,this.trackCode,e)}constructor(t,e){super(t),this.isLoading=!1,this.isSkipped=!1,this.onShowAllClick=t=>{this.showPhoto(t),this.sendAnalytic("show_tags")},this.onPhotoClick=t=>{t.ctrlKey||t.metaKey||(this.showPhoto(t),(0,h.cancelEvent)(t))},this.onConfirmClick=()=>{if(this.isLoading)return;const t=this.getTags();this.isLoading=!0,this.tagArea.confirmSuggestedTags(t,this,this.confirmBtn).then((()=>{this.updatePhotoviewCache(!0),this.incrementConfirmedCount(t.length),this.showResultPanel(0),this.block.nextWithDelay()}),(t=>{t&&(0,l.logError)(t)})).finally((()=>{this.isLoading=!1}))},this.onDeclineClick=()=>{this.isLoading||(this.isLoading=!0,this.tagArea.declineSuggestedTags(this.getTags(),this,this.declineBtn).then((()=>{this.updatePhotoviewCache(!0),this.showResultPanel(1),this.block.nextWithDelay()})).finally((()=>{this.isLoading=!1})))},this.onCancelClick=()=>{this.cancelBtn&&(this.reset(),this.showSuggestPanel())},this.onNextClick=()=>{this.skipTags(),this.block.next()};const i=t.dataset.tagHash||"";this.block=e,this.type=Number(t.dataset.recognizeType),this.title=t.dataset.title,this.trackCode=t.dataset.trackCode||"",this.skipHash=t.dataset.skipHash||"",this.confirmBtn=t.querySelector(".PhotoRecognizeBlockItem__btn--confirm"),this.declineBtn=t.querySelector(".PhotoRecognizeBlockItem__btn--decline"),this.showAllBtn=t.querySelector(".PhotoRecognizeBlockItem__btn--showTags"),this.nextBtn=t.querySelector(".PhotoRecognizeBlockItem__btn--next"),this.description=t.querySelector(".PhotoRecognizeBlockItem__description"),this.tagArea=new c.PhotoTagArea(this,i,this.trackCode),this.initListeners()}}},428518:(t,e,i)=>{i.d(e,{FEED_RECOGNIZE_PHOTO_DEFAULT_BLOCK_TYPE:()=>d,FEED_RECOGNIZE_PHOTO_POST_ID:()=>c,NUMBER_INITIALIZED_PHOTO:()=>g,PHOTO_CAROUSEL_AVATAR_CLASS:()=>h,PHOTO_CAROUSEL_CLASS:()=>s,PHOTO_CAROUSEL_HIDE_BTN_CLASS:()=>l,PHOTO_CAROUSEL_ITEM_CLASS:()=>o,PHOTO_CAROUSEL_ITEM_NO_SIZE_CLASS:()=>n,PHOTO_ELEMENT_CLASS:()=>r,PHOTO_NO_SIZE_ELEMENT_CLASS:()=>a});const s="PhotoCarousel",o="PhotoCarouselItem",n="PhotoCarouselItem--noSize",r="PhotoCarouselImage",a="PhotoCarouselItem__stub",h="PhotoCarouselBlockItem__avatar",l="PhotoCarousel__hidePost",c="tags_suggestions",d="tags_suggestions",g=4},942418:(t,e,i)=>{i.d(e,{sendAnalytic:()=>n});var s=i(434788),o=i(504867);function n(t,e="",i={}){const n=(0,s._)({event_type:t,track_code:e},i);(0,o.statlogsValueEvent)("photo_recognition_stat",n)}},906482:(t,e,i)=>{var s;i.d(e,{RecognizeItemType:()=>s}),function(t){t[t.ME=1]="ME",t[t.FRIEND=2]="FRIEND",t[t.ALL=3]="ALL"}(s||(s={}))},212046:(t,e,i)=>{var s;i.d(e,{PhotoTag:()=>o}),function(t){t[t.Initial=0]="Initial",t[t.Confirmed=1]="Confirmed",t[t.Declined=2]="Declined"}(s||(s={}));class o{decline(){this.tagEl.classList.remove("PhotoTag--confirm"),this.tagEl.classList.add("PhotoTag--decline"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=2}confirm(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.add("PhotoTag--confirm"),this.cutoutEl.classList.add("PhotoTagCutout--transparency"),this.state=1}reset(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.remove("PhotoTag--confirm"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=0}getFullRawId(){return`${this.tagArea.getPhotoRawId()}_${this.getId()}`}getId(){return this.id}getUserId(){return this.userId}getUserName(){return this.name}getUserNameGenitive(){return this.nameGenitive}getUserNameAccusative(){return this.nameAccusative}getOwnerNameGenitive(){return this.ownerNameGenitive}getPlacerNameGenitive(){return this.placerNameGenitive}isConfirmed(){return 1===this.state}getSex(){return this.sex}constructor(t,e){this.tagEl=t,this.tagArea=e;const i=t.getAttribute("data-item");if(!i)throw new Error("Tag: incorrect json data");const s=JSON.parse(i);this.id=Number(s.id),this.userId=s.userId,this.name=s.name,this.nameGenitive=s.nameGenitive,this.ownerNameGenitive=s.ownerNameGenitive,this.placerNameGenitive=s.placerNameGenitive,this.nameAccusative=s.nameAccusative,this.isSuggested=Boolean(s.isSuggested),this.sex=Number(s.sex),this.styles={top:s.top,left:s.left,width:s.width,height:s.height};let o=0;t.classList.contains("PhotoTag--confirm")?o=1:t.classList.contains("PhotoTag--decline")&&(o=2),this.state=o;const n=`tag_cutout${e.getPhotoRawId()}_${s.userId}`,r=document.getElementById(n);if(!r)throw new Error("Tag: incorrect data");this.cutoutEl=r}}},794507:(t,e,i)=>{i.d(e,{PhotoTagArea:()=>c});var s=i(212046),o=i(725296),n=i(839470),r=i(584356),a=i(29271),h=i(514986),l=i(155986);class c{showConfirmAlertBoxIfNeeded(t){const e=t[0];return new Promise(((t,i)=>{if(!window.cur.pvNeedShowAlertForOneSuggest||e.getUserId()===window.vk.id)return void t();const s=a.getLang("photo_recognition_one_tag_alert"),o=(0,a.langSex)(e.getSex(),a.getLang("photo_recognition_one_tag_alert_text","raw")).replace("{name}",e.getUserName()),n=(0,h.showFastBox)(s,o,a.getLang("photo_recognition_one_friend_submit_btn"),(()=>{this.hideHint(),n.hide(),t()}),a.getLang("global_cancel"),(()=>{n.hide(),i()}))}))}hideHint(){window.cur.pvNeedShowAlertForOneSuggest=!1;const t=window.cur.pvOneSuggestHintId,e=window.cur.pvOneSuggestHintHash;t&&e&&window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:t,hash:e},{onDone:()=>{},onFail:()=>(console.error("something wrong with help hint"),!0)})}decrementLeftMenuCounterIfNeeded(t){t.forEach((t=>{t.getUserId()===window.vk.id&&(0,l.decrementLeftMenuPhotoCounter)()}))}getFullRawTagIdsStr(t=this.tags){return t.reduce(((t,e,i)=>t+`${0===i?"":","}${e.getFullRawId()}`),"")}setConfirmedTagsByIds(t){const e=t.reduce(((t,e)=>(this.tagsMap[e]&&t.push(this.tagsMap[e]),t)),[]);return!!e.length&&(this.setConfirmedTags(e),!0)}setConfirmedTags(t){(t=t.filter((t=>this.tagsMap[t.getId()]))).length&&(t.forEach((t=>t.confirm())),this.tagArea.classList.add("PhotoTagArea--fade"))}setDeclinedTags(t){t.forEach((t=>t.decline()))}setDeclinedTagsByIds(t){const e=t.reduce(((t,e)=>(this.tagsMap[e]&&t.push(this.tagsMap[e]),t)),[]);return!!e.length&&(this.setDeclinedTags(e),!0)}reset(){this.tagArea.classList.remove("PhotoTagArea--fade"),this.tags.forEach((t=>t.reset()))}getPhotoRawId(){return this.photoEntity.getPhotoRawId()}getTags(){return this.tags}getConfirmedTags(){return this.tags.filter((t=>t.isConfirmed()))}setSizes(t,e){this.tagArea.style.width=`${t}px`,this.tagArea.style.height=`${e}px`}show(){this.tagArea.classList.remove("PhotoTagArea--hide")}static calculateTagAreaSizes(t,e,i){const s=t.offsetWidth,o=t.offsetHeight,n=e/i;let r,a,h=!0;return s/o>n&&(h=!1),h?(r=Math.round(Math.min(e,s)),a=Math.round(r/n)):(a=Math.round(Math.min(i,o)),r=Math.round(a*n)),[r,a]}constructor(t,e,i){this.confirmTag=(t,e,i)=>{i&&(0,o.lockButton)(i);const s=!(0,n.partConfigEnabled)("recognize_mock_turn_off");return new Promise(((n,h)=>{window.ajax.post("al_photos.php",{act:"confirm_tag",photo:e.getPhotoRawId(),tag:t.getId(),hash:this.tagHash},{onDone:()=>{this.setConfirmedTags([t]),this.decrementLeftMenuCounterIfNeeded([t]),n()},onFail:()=>s?(this.setConfirmedTags([t]),n(),!0):((0,r.showDoneBox)(a.getLang("global_unknown_error")),h(),!0),hideProgress:()=>{i&&(0,o.unlockButton)(i)}})}))},this.declineTag=(t,e,i)=>new Promise(((s,h)=>{i&&(0,o.lockButton)(i);const l=!(0,n.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"delete_tag",photo:e.getPhotoRawId(),tag:t.getId(),hash:this.tagHash},{onDone:()=>{this.setDeclinedTags([t]),this.decrementLeftMenuCounterIfNeeded([t]),s()},onFail:()=>l?(this.setDeclinedTags([t]),s(),!0):((0,r.showDoneBox)(a.getLang("global_unknown_error")),h(),!0),hideProgress:()=>{i&&(0,o.unlockButton)(i)}})})),this.confirmSuggestedTags=(t,e,i)=>this.showConfirmAlertBoxIfNeeded(t).then((()=>{i&&(0,o.lockButton)(i);const e=!(0,n.partConfigEnabled)("recognize_mock_turn_off");return new Promise(((s,n)=>{window.ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:this.getFullRawTagIdsStr(t),track_code:this.trackCode,hash:this.tagHash},{onDone:()=>{this.setConfirmedTags(t),this.decrementLeftMenuCounterIfNeeded(t),s()},onFail:()=>e?(this.setConfirmedTags(t),s(),!0):((0,r.showDoneBox)(a.getLang("global_unknown_error")),n(),!0),hideProgress:()=>{i&&(0,o.unlockButton)(i)}})}))})),this.declineSuggestedTags=(t,e,i)=>new Promise(((e,s)=>{i&&(0,o.lockButton)(i);const h=!(0,n.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:this.getFullRawTagIdsStr(t),track_code:this.trackCode,hash:this.tagHash},{onDone:()=>{this.setDeclinedTags(t),this.decrementLeftMenuCounterIfNeeded(t),e()},onFail:()=>h?(this.setDeclinedTags(t),e(),!0):((0,r.showDoneBox)(a.getLang("global_unknown_error")),s(),!0),hideProgress:()=>{i&&(0,o.unlockButton)(i)}})}));const h=t.getEl().querySelector(".PhotoTagArea");if(!h)throw new Error("error: there is not tag area el");if(!e)throw new Error("error: there is not tag hash");const l=Array.from(t.getEl().querySelectorAll(".PhotoTag"));this.trackCode=i,this.tagArea=h,this.tagHash=e,this.photoEntity=t,this.tags=l.map((t=>new s.PhotoTag(t,this))),this.tagsMap=this.tags.reduce(((t,e)=>(t[e.getId()]=e,t)),{})}}},155986:(t,e,i)=>{i.d(e,{decrementLeftMenuPhotoCounter:()=>h});var s=i(82161),o=i(970978),n=i(849222);const r="ph",a=`l_${r}`;function h(t=1){try{const e=function(){const t=document.getElementById(a);if(!t)throw new Error("There is not photo left menu item");const e=t.querySelector(".left_count");return e?(0,s.intval)(e.textContent):0}();(0,n.handlePageCount)(r,Math.max(e-t,0))}catch(t){console.error(t),(0,o.logError)(t)}}},976835:(t,e,i)=>{var s;i.d(e,{TagEventTypes:()=>s}),function(t){t.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",t.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",t.DECLINE_USER_TAG="DECLINE_USER_TAG",t.CONFIRM_USER_TAG="CONFIRM_USER_TAG",t.DELETE_TAG="DELETE_TAG"}(s||(s={}))}}]);try{stManager.done("dist/66073d32d1f9cb773520863232adb915.37b431178fc0bfaf74cd.js")}catch(t){}
"use strict";(self.webpackChunkvk=self.webpackChunkvk||[]).push([[86164],{402622:(e,t,r)=>{r.d(t,{Icon16Videocam:()=>o});var o=(0,r(28178).makeIcon)("Icon16Videocam","videocam_16","0 0 16 16",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" id="videocam_16"><path fill-rule="evenodd" d="M1.772 4.865C1.5 5.4 1.5 6.1 1.5 7.5v1c0 1.4 0 2.1.272 2.635a2.5 2.5 0 0 0 1.093 1.092C3.4 12.5 4.1 12.5 5.5 12.5h2c1.4 0 2.1 0 2.635-.273a2.5 2.5 0 0 0 1.092-1.092C11.5 10.6 11.5 9.9 11.5 8.5v-1c0-1.4 0-2.1-.273-2.635a2.5 2.5 0 0 0-1.092-1.093C9.6 3.5 8.9 3.5 7.5 3.5h-2c-1.4 0-2.1 0-2.635.272a2.5 2.5 0 0 0-1.093 1.093Zm10.95 1.487 1.876-1.25a.58.58 0 0 1 .902.482v4.832a.58.58 0 0 1-.902.483l-1.875-1.25a.5.5 0 0 1-.223-.417V6.768a.5.5 0 0 1 .223-.416Z" clip-rule="evenodd" /></symbol>',16,16,!1,void 0)},647605:(e,t,r)=>{r.d(t,{Icon24ErrorCircleOutline:()=>o});var o=(0,r(28178).makeIcon)("Icon24ErrorCircleOutline","error_circle_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" id="error_circle_outline_24"><path fill-rule="evenodd" d="M4.929 4.929A9.971 9.971 0 0 1 12 2a9.972 9.972 0 0 1 7.071 2.929A9.972 9.972 0 0 1 22 12a9.972 9.972 0 0 1-2.929 7.071A9.972 9.972 0 0 1 12 22a9.972 9.972 0 0 1-7.071-2.929A9.972 9.972 0 0 1 2 12a9.972 9.972 0 0 1 2.929-7.071ZM12 3.8a8.172 8.172 0 0 0-5.798 2.402A8.172 8.172 0 0 0 3.8 12a8.17 8.17 0 0 0 2.402 5.798A8.171 8.171 0 0 0 12 20.2a8.172 8.172 0 0 0 5.798-2.402A8.172 8.172 0 0 0 20.2 12a8.171 8.171 0 0 0-2.402-5.798A8.172 8.172 0 0 0 12 3.8ZM13 16a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-1-9a.9.9 0 0 1 .9.9v5.2a.9.9 0 0 1-1.8 0V7.9A.9.9 0 0 1 12 7Z" clip-rule="evenodd" /></symbol>',24,24,!1,void 0)},564444:(e,t,r)=>{r.d(t,{Icon24MenuOutline:()=>o});var o=(0,r(28178).makeIcon)("Icon24MenuOutline","menu_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="menu_outline_24"><path fill="currentColor" d="M21 11H3a1 1 0 1 0 0 2h18a1 1 0 1 0 0-2zm0-7H3a1 1 0 0 0 0 2h18a1 1 0 1 0 0-2zM3 20h18a1 1 0 1 0 0-2H3a1 1 0 1 0 0 2z" /></symbol>',24,24,!1,void 0)},432483:(e,t,r)=>{r.d(t,{Icon24MoreHorizontal:()=>o});var o=(0,r(28178).makeIcon)("Icon24MoreHorizontal","more_horizontal_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="more_horizontal_24"><g fill="none" fill-rule="evenodd"><path d="M24 0H0v24h24z" /><path fill="currentColor" d="M18 10c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2Zm-6 4c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2Zm-6 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2Z" /></g></symbol>',24,24,!1,void 0)},611695:(e,t,r)=>{r.d(t,{Icon24NarrativeActiveOutline:()=>o});var o=(0,r(28178).makeIcon)("Icon24NarrativeActiveOutline","narrative_active_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="narrative_active_outline_24"><path fill="currentColor" d="M14.298 1.435c.732.17 1.377.543 1.891 1.092.521.556.825 1.145 1.151 2.298l.79 2.944a1 1 0 1 1-1.931.518l-.72-2.69-.113-.401c-.215-.729-.377-1.024-.636-1.302a1.726 1.726 0 0 0-.887-.512c-.37-.086-.707-.078-1.445.1l-.405.104L6.866 4.96c-.854.228-1.254.394-1.51.583l-.06.047-.134.119c-.26.243-.43.539-.512.886-.093.4-.076.763.148 1.638l2.723 10.17.113.401c.215.729.377 1.024.636 1.302.244.26.54.43.887.512.401.093.745.076 1.607-.14a1 1 0 1 1 .487 1.94c-1.148.288-1.805.32-2.549.147a3.726 3.726 0 0 1-1.891-1.092c-.521-.556-.825-1.145-1.151-2.298L2.922 8.963c-.355-1.324-.405-2.027-.22-2.823a3.722 3.722 0 0 1 .93-1.728l.183-.182.179-.157c.496-.412 1.077-.685 2.091-.973l.263-.072 5.128-1.374c1.323-.355 2.026-.405 2.822-.22zM18.368 11c2 0 3.632 1.592 3.632 3.567 0 1.91-.772 2.851-3.78 5.134l-1.328 1.007c-.527.4-1.257.4-1.784 0l-1.328-1.007C10.772 17.418 10 16.476 10 14.567 10 12.592 11.631 11 13.632 11c.829 0 1.595.224 2.282.66l.086.057.086-.057a4.174 4.174 0 0 1 2.036-.653z" /></symbol>',24,24,!1,void 0)},752198:(e,t,r)=>{r.d(t,{Icon24Write:()=>o});var o=(0,r(28178).makeIcon)("Icon24Write","write_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="write_24"><g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z" /><path fill="currentColor" d="m14.188 6.273 3.54 3.54-8.624 8.622a6.674 6.674 0 0 1-2.77 1.664l-2.903.886a.334.334 0 0 1-.416-.416l.886-2.902a6.674 6.674 0 0 1 1.664-2.771l8.623-8.623Zm1.061-1.06 1.769-1.77a1.5 1.5 0 0 1 2.121 0l1.418 1.419a1.5 1.5 0 0 1 0 2.121L18.79 8.752l-3.54-3.54Z" /></g></symbol>',24,24,!1,void 0)},523087:(e,t,r)=>{r.d(t,{Icon36Add:()=>o});var o=(0,r(28178).makeIcon)("Icon36Add","add_36","0 0 36 36",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" id="add_36"><g fill="none" fill-rule="evenodd"><path d="M0 0h36v36H0z" /><path fill="currentColor" d="M19.5 19.5v9a1.5 1.5 0 0 1-3 0v-9h-9a1.5 1.5 0 0 1 0-3h9v-9a1.5 1.5 0 0 1 3 0v9h9a1.5 1.5 0 0 1 0 3h-9Z" /></g></symbol>',36,36,!1,void 0)},922574:(e,t,r)=>{var o;r.d(t,{BatchOperationType:()=>o}),function(e){e.Add="add",e.Delete="delete"}(o||(o={}))},693982:(e,t,r)=>{function o(e){const t=e.match(/^([a-z_]+)([0-9\-_]+)$/);if(!t)return null;const[,r,o]=t;return{objectType:r,objectId:o}}r.d(t,{getElementLikeButtonCount:()=>n,getElementLikeButtonIcon:()=>d,getElementLikeButtonLabel:()=>h,likePostObjectId:()=>i,likeReplyObjectId:()=>a,parseLikeObjectId:()=>o});const i=e=>`wall${e}`,a=e=>`wall_reply${e}`;var s;const n=e=>{var t;return null!=(s=null==(t=e)?void 0:t.querySelector(".like_button_count, ._like_button_count"))?s:void 0};var l;const d=e=>{var t;return null!=(l=null==(t=e)?void 0:t.querySelector(".like_button_icon, ._like_button_icon"))?l:void 0};var c;const h=e=>null!=(c=e.querySelector(".like_button_label, ._like_button_label"))?c:void 0},234514:(e,t,r)=>{r.d(t,{LikeButtonTypes:()=>o});const o={like:"like",share:"share",views:"views",comment:"comment"}},533919:(e,t,r)=>{r.d(t,{highlightModule:()=>c});var o=r(145637),i=r(10645),a=r(438221),s=r(795558),n=r(321850);let l,d;function c(e){const t=document.getElementById(e.module);if(!t||!t.classList.contains("module"))return;window.cur.__narrowBarForceNotFixed=!0;const r=e.speed?e.speed:300;(0,a.scrollToY)((0,s.getXY)(t)[1]-100,r);const c=()=>{l&&(l.hideTT(),(0,a.enableBodyScroll)(),delete window.cur.__narrowBarForceNotFixed,(0,i.updateNarrow)(),e.onClose&&e.onClose())};l=new o.default(t,e.text,{highlight:!0,width:250,offset:[0,-17],side:"bottom",withCloseButton:!0,onBGClick:c,onCloseButtonClick:c}),l.show(),(0,a.disableBodyScroll)(),e.autoCancelDelay&&(d=setTimeout((()=>{c(),d=null}),e.autoCancelDelay),(0,n.pushNavDestroy)((()=>{d&&clearTimeout(d)})))}},687437:(e,t,r)=>{r.d(t,{PROFILE_MEDIA_NARROW_BLOCK_ID:()=>o});const o="profile_media_narrow_block"},898298:(e,t,r)=>{r.d(t,{isIntentPreviewHidden:()=>l,isIntentPreviewInActionStatusBar:()=>n,isIntentPreviewUseCurrent:()=>d,isVariantHidden:()=>a,isVariantInActionStatusBar:()=>i,parsePreviewVariant:()=>h,previewVisibilityIntentForVariant:()=>c,previewVisibilityUseCurrent:()=>s});var o=r(580151);const i=e=>e===o.PreviewVariantActionStatusBar,a=e=>e===o.PreviewVariantHidden,s={kind:"useCurrent"},n=e=>e.kind===o.PreviewVariantActionStatusBar,l=e=>e.kind===o.PreviewVariantHidden,d=e=>"useCurrent"===e.kind,c=e=>e?{kind:e}:s,h=e=>o.PreviewVariants.includes(e)?e:void 0},580151:(e,t,r)=>{r.d(t,{PreviewVariantActionStatusBar:()=>o,PreviewVariantHidden:()=>i,PreviewVariants:()=>a});const o="action_status_bar",i="hidden",a=[o,i]},682951:(e,t,r)=>{r.d(t,{REACTIONS_COUNTS_RESPONSE_FIELD:()=>l,SIZE_128:()=>n,SIZE_32:()=>i,SIZE_40:()=>a,SIZE_96:()=>s,SUPPORTED_OBJECT_TYPES:()=>o,WK_SECTION_PREFIX_REACTIONS:()=>d});const o={wall:"wall",wall_reply:"wall_reply"},i={width:32,height:32},a={width:40,height:40},s={width:96,height:96},n={width:128,height:128},l="reactions_counts",d="reactions"},109454:(e,t,r)=>{r.d(t,{isReactionsFullUpdatePayload:()=>s,reactionsCountsOnlyUpdatePayload:()=>n,reactionsCountsUpdatePayload:()=>a});var o=r(434788),i=r(900641);const a=(e,t)=>(0,o._)({kind:i.PayloadKindFull},e,{reactionIdState:{reactionId:t.id}}),s=e=>e.kind===i.PayloadKindFull,n=e=>(0,o._)({kind:i.PayloadKindCountsOnly},e)},900641:(e,t,r)=>{r.d(t,{PayloadKindCountsOnly:()=>o,PayloadKindFull:()=>i});const o="counts_only",i="counts_with_current_reaction"},999237:(e,t,r)=>{r.d(t,{triggerReactionsUpdate:()=>n});var o=r(693982),i=r(682951),a=r(505426),s=r(109454);const n=(e,t,r,n)=>{const l=(0,o.parseLikeObjectId)(e);l&&l.objectType===i.SUPPORTED_OBJECT_TYPES.wall&&l.objectId?(0,a.emitEvent)(a.WallDataEvents.post_reactions_counts_update,function(e,t,r,o){var i,a,n;const l={counts:e,isFromWkLayer:null==(i=t)?void 0:i.isFromWkLayer,isPrimaryLikeButtonClick:null==(a=t)?void 0:a.isPrimaryLikeButtonClick,isQueueUpdate:null==(n=t)?void 0:n.isQueueUpdate,isUserAction:t.isUserAction,postFullId:r.objectId,previewVisibility:t.previewVisibility,reactionIdState:o?{reactionId:o.id}:void 0,suggestSubscribe:t.suggestSubscribe};return o?(0,s.reactionsCountsUpdatePayload)(l,o):(0,s.reactionsCountsOnlyUpdatePayload)(l)}(t,n,l,r)):l&&l.objectType===i.SUPPORTED_OBJECT_TYPES.wall_reply&&l.objectId?(0,a.emitEvent)(a.WallDataEvents.reply_reactions_counts_update,{counts:t,replyFullId:l.objectId,reactionIdState:r?{reactionId:r.id}:void 0}):console.warn("Unsupported reactions object update",e)}},386342:(e,t,r)=>{r.d(t,{NarrativeBox:()=>L});var o=r(785893),i=r(667294),a=r(29271),s=r(400469),n=r(10781),l=r(704703),d=r(444402),c=r(562329),h=r(630892),v=r(584356),u=r(664988),p=r(273192),g=r(95432),_=r(827652),m=r(247563),w=r(365035),y=r(432483),C=r(564444),S=r(858069),x=r(931917),N=r(816511),f=r(400856),k=r(126116),b=r(832550);class L extends i.Component{render(){const{narratives:e,onClose:t,boxData:r,title:s,showNarrativeNumber:n}=this.props,{isLoad:d,draggingNarrativeRawId:h}=this.state,v=e.length<r.count,u=this.canEdit(),{actionButtons:g,footerBefore:_}=this.getBoxActionButtons();return(0,o.jsxs)(N.ModalBox,{className:"NarrativeBox",children:[(0,o.jsx)(f.ModalHeader,{onClose:()=>t(),closeAriaLabel:a.getLang("global_close"),indicator:n&&r.count>0?r.count:void 0,children:s||a.getLang("stories_narratives_title")}),(0,o.jsx)("div",{className:"NarrativeBox__body",children:(0,o.jsx)("div",{className:"NarrativeBox__scrollContainer",ref:this.scrollContainerRef,children:(0,o.jsxs)("div",{className:"NarrativeBox__scrollInner",children:[(0,o.jsxs)("div",{className:"NarrativeBox__list",ref:this.gridRef,children:[u&&(0,o.jsxs)(i.Fragment,{children:[(0,o.jsx)(l.NarrativeRowCreation,{onClick:this.onCreateNarrativeClick},"create"),e.map((e=>(0,o.jsx)(m.NarrativeRow,{className:w.BOX_ITEM_DRAGGABLE_CLASS,narrative:e,onClick:t=>this.onNarrativeClick(t,e),aside:(0,o.jsxs)("div",{className:"NarrativeBox__aside",children:[e.rawId===h&&(0,o.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--more",children:(0,o.jsx)(y.Icon24MoreHorizontal,{})}),e.rawId!==h&&(0,o.jsx)(p.default,{position:"b",align:"center",trigger:"hover",data:this.getNarrativeItemActions(e),children:(0,o.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--more",children:(0,o.jsx)(y.Icon24MoreHorizontal,{})})}),(0,o.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--burger",children:(0,o.jsx)(C.Icon24MenuOutline,{})})]})},e.rawId)))]}),!u&&(0,o.jsx)(i.Fragment,{children:e.map((e=>(0,o.jsx)(m.NarrativeRow,{narrative:e,onClick:t=>this.onNarrativeClick(t,e),aside:(0,o.jsx)("div",{className:"NarrativeBox__aside",children:(0,o.jsx)(p.default,{position:"b",align:"right",trigger:"hover",data:this.getNarrativeItemActions(e),children:(0,o.jsx)("div",{className:"NarrativeBox__action NarrativeBox__action--more",children:(0,o.jsx)(y.Icon24MoreHorizontal,{})})})})},e.rawId)))})]}),d&&(0,o.jsx)("div",{className:"NarrativeBox__loader",children:(0,o.jsx)(c.default,{})},"loader"),v&&(0,o.jsx)("div",{className:"NarrativeBox__sentinel",ref:this.sentinelRef})]})})}),(0,o.jsx)(k.ModalFooter,{before:_,actionButtons:g})]})}canEdit(){const{type:e,onSave:t,onReorder:r,onRemove:o}=this.props;return e===s.BoxType.edit&&Boolean(t)&&Boolean(r)&&Boolean(o)}componentDidMount(){this.initSorter(),this.observeNarrativeScrollIfNeeded(),this.props.refreshCoordinates()}componentWillUnmount(){this.deInitSorter(),this.unObserveNarrativeScrollIfNeeded()}editNarrative(e){const{boxData:t}=this.props;(0,S.sendNarrativeAnalytic)(S.NarrativeAnalyticEventType.clickToEditNarrative,e,this.props.navScreen),x.Ranges.isUserId(t.ownerId)?this.openNarrativeEditorBox(e):window.open(`https://${location.hostname}${location.pathname}?act=narrative_edit&nid=${e.id}`)}shareNarrative(e){_.Likes.share(`narrative${e.rawId}`),(0,S.sendNarrativeAnalytic)(S.NarrativeAnalyticEventType.shareNarrative,e,this.props.navScreen)}bookmarkNarrative(e){const{onBookmark:t}=this.props;(0,g.bookmark)(e.ownerId,e.id,"narrative",e.bookmarkHash,e.isBookmarked),(0,S.sendNarrativeAnalytic)(S.NarrativeAnalyticEventType.addToBookmarks,e,this.props.navScreen),t(e)}removeNarrative(e){var t,r;null==(t=(r=this.props).onRemove)||t.call(r,e)}observeNarrativeScrollIfNeeded(){const{narratives:e,boxData:t}=this.props;if(e.length<t.count){const e=this.scrollContainerRef.current,t=this.sentinelRef.current;if(!t)return;this.observer=new IntersectionObserver((e=>{e.forEach((e=>{e.intersectionRatio>0&&this.loadViewers()}))}),{threshold:[0],root:e,rootMargin:"0px 0px 480px 0px"}),this.observer.observe(t)}}unObserveNarrativeScrollIfNeeded(){this.observer&&this.observer.disconnect()}loadViewers(){const{loadMore:e}=this.props,{isLoad:t}=this.state;t||(this.setState({isLoad:!0}),e().finally((()=>{this.setState({isLoad:!1})})))}initSorter(){var e,t;const{boxData:r}=this.props;if(!this.canEdit())return;const o=null==(e=this.scrollContainerRef)?void 0:e.current,i=null==(t=this.gridRef)?void 0:t.current;if(!i||!o)return;const a={dragThreshold:0,wrapNode:o,onDragFinish:()=>{this.setState({draggingNarrativeRawId:""})},onDragStart:e=>{const t=this.getNarrativeIdByEl(e);this.setState({draggingNarrativeRawId:`${r.ownerId}_${t}`})},onReorder:e=>{const t=this.getNarrativeIdByEl(e),r=Array.from(i.querySelectorAll(`.${w.BOX_ITEM_DRAGGABLE_CLASS}`));if(1===r.length)return;let o=0,a=0;const s=r.findIndex((e=>this.getNarrativeIdByEl(e)===t));r[s-1]&&(o=this.getNarrativeIdByEl(r[s-1])),r[s+1]&&(a=this.getNarrativeIdByEl(r[s+1])),this.saveReorder(t,a,o)}};this.sorter=new d.default(i,"",a)}saveReorder(e,t,r){const{boxData:o,onReorder:i}=this.props;if(!i)return;const s=o.ownerId;window.ajax.post("al_stories.php",{act:"narratives_reorder",narrative_id:e,before_narrative_id:t,after_narrative_id:r,hash:o.reorderHash,owner_id:s},{onDone:()=>{var t;const{narratives:r}=this.props,o=null==(t=this.gridRef)?void 0:t.current;if(!o)return;const a=Array.from(o.querySelectorAll(`.${w.BOX_ITEM_DRAGGABLE_CLASS}`)),n=[];a.forEach((e=>{const t=this.getNarrativeIdByEl(e),o=r.find((e=>e.id===t));o&&n.push(o)})),(0,S.sendNarrativeAnalytic)(S.NarrativeAnalyticEventType.changeSort,{ownerId:s,id:e},this.props.navScreen),i(n)},onFail:e=>((0,v.showDoneBox)(e||a.getLang("global_error")),!0)})}getNarrativeIdByEl(e){return(0,u.intval)(e.getAttribute("data-id"))}deInitSorter(){this.sorter&&this.sorter.destroy()}constructor(e){super(e),this.getBoxActionButtons=()=>{const{onClose:e,boxData:t,type:r}=this.props,i=[(0,o.jsx)(b.Button,{mode:"primary",size:"m",onClick:()=>e(),children:a.getLang("global_close")},"close")];let n;if(r===s.BoxType.edit&&t.userId===t.ownerId){const r=t.ownerDomain||`id${t.userId}`,i=()=>{e(),(0,g.showWiki)({w:"stories"})};n=(0,o.jsx)(b.Button,{size:"m",mode:"tertiary",href:`${r}?w=stories`,onClick:i,children:a.getLang("stories_archive")})}return{actionButtons:i,footerBefore:n}},this.onNarrativeClick=(e,t)=>{if(e.ctrlKey||e.metaKey)return;e.preventDefault(),e.stopPropagation();const r=this.props.list?this.props.list:`narrative${t.ownerId}_${t.id}`;(0,n.showNarrative)(t.ownerId,t.id,0,r,{trackCode:this.props.trackCode,source:this.props.source})},this.onCreateNarrativeClick=()=>{const{boxData:e,navScreen:t}=this.props,r=e.ownerId;if((0,S.sendNarrativeAnalytic)(S.NarrativeAnalyticEventType.createNarrative,{ownerId:r},t),x.Ranges.isUserId(r))return void this.openNarrativeEditorBox();const o=e.ownerDomain?e.ownerDomain:"club"+-r;window.open(`https://${location.hostname}/${o}?act=narrative_create`)},this.openNarrativeEditorBox=e=>{var t;const{onSave:r,boxData:o,onClose:i,navScreen:a}=this.props;if(!r)return;let s=[];(null==(t=e)?void 0:t.stories.length)&&(s=[...e.stories]);const n={narrative:e,selectedStories:s,publishHash:o.publishHash,onSave:e=>{r(e),i()},navScreen:a};(0,h.showNarrativeEditorBox)(o.ownerId,n)},this.getNarrativeItemActions=e=>{const t=[];if(this.canEdit())t.push({text:a.getLang("global_edit"),onClick:()=>this.editNarrative(e)}),t.push({text:a.getLang("stories_share"),onClick:()=>this.shareNarrative(e)}),t.push({separator:!0}),t.push({text:a.getLang("global_delete"),onClick:()=>this.removeNarrative(e)});else{const r=e.isBookmarked?a.getLang("global_remove_from_bookmarks"):a.getLang("global_add_to_bookmarks");t.push({text:r,onClick:()=>this.bookmarkNarrative(e)}),t.push({text:a.getLang("stories_share"),onClick:()=>this.shareNarrative(e)})}return t},this.state={isLoad:!1,draggingNarrativeRawId:""},this.scrollContainerRef=(0,i.createRef)(),this.gridRef=(0,i.createRef)(),this.sentinelRef=(0,i.createRef)()}}L.defaultProps={type:s.BoxType.view,showNarrativeNumber:!0}},400469:(e,t,r)=>{var o;r.d(t,{BoxType:()=>o}),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(o||(o={}))},24237:(e,t,r)=>{r.d(t,{NarrativeChooseBox:()=>S});var o=r(434788),i=r(785893),a=r(667294),s=r(816511),n=r(400856),l=r(126116),d=r(832550),c=r(29271),h=r(659397),v=r(758021),u=r(704703),p=r(247563),g=r(584356),_=r(630892),m=r(10781),w=r(922574),y=r(858069),C=r(931917);class S extends a.Component{getDoneText(e){const t=e.filter((e=>e.op===w.BatchOperationType.Add)).length;if(t>1)return c.getLang("stories_saved_in_narratives_text");if(1===t)return c.getLang("stories_saved_in_narrative_text");{const t=e.filter((e=>e.op===w.BatchOperationType.Delete)).length;if(t>1)return c.getLang("stories_deleted_in_narratives_text");if(1===t)return c.getLang("stories_deleted_in_narrative_text")}return c.getLang("stories_settings_saved")}getDiffOperations(e,t,r){const o=[];return Object.keys(t).forEach((t=>{r[t]||o.push({op:w.BatchOperationType.Add,story_id:e,narrative_id:Number(t)})})),Object.keys(r).forEach((r=>{t[r]||o.push({op:w.BatchOperationType.Delete,story_id:e,narrative_id:Number(r)})})),o}getSelectedNarrativeIdsMap(e,t){return t.reduce(((t,r)=>(r.stories.find((t=>t.id===e))&&(t[r.id]=!0),t)),{})}render(){const{onClose:e,narratives:t,boxData:r}=this.props,{selectedNarrativeIds:o}=this.state,a=t.length<r.count;return(0,i.jsxs)(s.ModalBox,{className:"NarrativeChooseBox",children:[(0,i.jsx)(n.ModalHeader,{onClose:e,closeAriaLabel:c.getLang("global_close"),children:c.getLang("stories_narrative_choosing")}),(0,i.jsx)("div",{className:"NarrativeChooseBox__body",children:(0,i.jsxs)(v.default,{className:"NarrativeChooseBox__list",itemHeight:80,loadMore:this.loadMore,hasMore:a,children:[(0,i.jsx)(u.NarrativeRowCreation,{onClick:this.onCreateNarrativeClick,clickable:!0,size:50},"create"),t.map((e=>(0,i.jsx)(p.NarrativeRow,{narrative:e,onClick:()=>this.onCheckboxClick(e),size:50,noBorder:!0,clickable:!0,aside:(0,i.jsx)("div",{className:(0,h.classNames)("NarrativeChooseBox__checkbox",{"NarrativeChooseBox__checkbox--checked":o[e.id]})})},e.rawId)))]})}),(0,i.jsx)(l.ModalFooter,{actionButtons:this.getBoxActionButtons()})]})}constructor(e){super(e),this.loadMore=()=>{const{loadMore:e,story:t}=this.props,{selectedNarrativeIds:r}=this.state;return e().then(((e=[])=>{this.setState({selectedNarrativeIds:(0,o._)({},r,this.getSelectedNarrativeIdsMap(t.id,e))})}))},this.onCheckboxClick=e=>{const{selectedNarrativeIds:t}=this.state,r=(0,o._)({},t);r[e.id]?delete r[e.id]:r[e.id]=!0,this.setState({selectedNarrativeIds:r})},this.getBoxActionButtons=()=>{const{onClose:e,story:t,narratives:r}=this.props,{isLoad:o,selectedNarrativeIds:a}=this.state,s=this.getSelectedNarrativeIdsMap(t.id,r),n=this.getDiffOperations(t.id,a,s);return[(0,i.jsx)(d.Button,{size:"m",mode:"tertiary",onClick:()=>e(),children:c.getLang("global_close")},"close"),(0,i.jsx)(d.Button,{mode:"primary",size:"m",disabled:!n.length,onClick:this.save,loading:o,children:c.getLang("global_save")},"save")]},this.save=()=>{const{story:e,narratives:t,boxData:r,onClose:o,onSave:i,navScreen:a}=this.props,{selectedNarrativeIds:s}=this.state,n=this.getSelectedNarrativeIdsMap(e.id,t),l=this.getDiffOperations(e.id,s,n),d=Boolean(Object.keys(s).length),h=r.ownerId;this.setState({isLoad:!0}),window.ajax.post("al_stories.php",{act:"batch_edit",owner_id:h,operations:JSON.stringify(l),hash:r.editHash},{onDone:()=>{i(d),o(),(0,y.sendNarrativeAnalytic)(y.NarrativeAnalyticEventType.addStoryToNarrative,{ownerId:h},a),(0,g.showDoneBox)(this.getDoneText(l))},onFail:e=>((0,g.showDoneBox)(e||c.getLang("global_error")),!0),hideProgress:()=>{this.setState({isLoad:!1})}})},this.onCreateNarrativeClick=()=>{const{story:e,narratives:t,onSave:r,onClose:o,boxData:i,navScreen:a}=this.props,s=i.ownerId;if(C.Ranges.isUserId(s)){const i=this.getSelectedNarrativeIdsMap(e.id,t);let n=Boolean(Object.keys(i).length);const l={selectedStories:[e],onSave:()=>{n=!0},onClose:()=>{r(n),o()},navScreen:a};return(0,_.showNarrativeEditorBox)(s,l),void(0,y.sendNarrativeAnalytic)(y.NarrativeAnalyticEventType.createNarrative,{ownerId:s},a)}const n=i.ownerDomain?i.ownerDomain:"club"+-i.ownerId;window.nav.go(`${n}?act=narrative_create&story_id=${e.id}`)},this.onNarrativeClick=(e,t)=>{e.ctrlKey||e.metaKey||((0,m.showNarrative)(t.ownerId,t.id,0,`narrative${t.ownerId}_${t.id}`),e.preventDefault(),e.stopPropagation())},this.state={isLoad:!1,selectedNarrativeIds:this.getSelectedNarrativeIdsMap(e.story.id,e.narratives)}}}},983647:(e,t,r)=>{r.d(t,{MAX_THUMB_HEIGHT:()=>p,MAX_THUMB_WIDTH:()=>g,NarrativeCoverCropper:()=>_});var o=r(785893),i=r(667294),a=r(29271),s=r(352699),n=r(514986),l=r(970978),d=r(230059),c=r(816511),h=r(400856),v=r(398310),u=r(832550);const p=604,g=468;class _ extends i.Component{getCropForTagger(e){const{coverWidth:t,coverHeight:r}=this.props;let o;if(e){let i=Math.round(e.width*t),a=Math.round(e.height*r);if(Math.abs(a-i)>1)return o;a=i,o={top:Math.round(e.y*r),left:Math.round(e.x*t),width:i,height:a}}return o}getCropForSaving(e){const{coverWidth:t,coverHeight:r}=this.props;return{y:e.top/r,x:e.left/t,width:e.width/t,height:e.height/r}}render(){const{onClose:e,coverUrl:t,coverHeight:r,coverWidth:i,thumbHeight:n,thumbWidth:l,crop:d}=this.props,{isLoading:p}=this.state;return(0,o.jsxs)(c.ModalBox,{className:"NarrativeCoverCropper",children:[(0,o.jsx)(h.ModalHeader,{onClose:e,closeAriaLabel:a.getLang("global_close"),children:a.getLang("stories_cover_cropper_title")}),(0,o.jsxs)("div",{className:"NarrativeCoverCropper__inner",children:[(0,o.jsxs)("div",{className:"NarrativeCoverCropper__info",children:[(0,o.jsx)("div",{children:a.getLang("stories_cover_cropper_info_1")}),(0,o.jsx)("div",{children:a.getLang("stories_cover_cropper_info_2")})]}),(0,o.jsx)("div",{className:"NarrativeCoverCropper__frame",children:(0,o.jsx)(s.PhotoAreaSelector,{className:"NarrativeCoverCropper__tagger",imgSrc:t,imgHeight:r,imgWidth:i,previewHeight:n,previewWidth:l,minHeight:75,minWidth:75,isSquare:!0,preview100:!0,cropRect:this.getCropForTagger(d),onCropUpdated:this.onCropUpdate})}),(0,o.jsxs)(v.ButtonLayout,{children:[(0,o.jsx)(u.Button,{loading:p,mode:"primary",size:"m",onClick:this.onSaveCrop,children:a.getLang("stories_cover_next")}),(0,o.jsx)(u.Button,{disabled:p,mode:"secondary",size:"m",onClick:e,children:a.getLang("stories_cover_back")})]})]})]})}constructor(e){super(e),this.onSaveCrop=()=>{const{onSave:e,onClose:t,coverUrl:r}=this.props,o=this.crop;o&&(this.setState({isLoading:!0}),(0,d.getCroppedImage)(r,o.left,o.top,o.width,o.height).then((t=>e(this.getCropForSaving(o),t.src))).then(t).catch((e=>{this.setState({isLoading:!1}),(0,n.showFastBox)(a.getLang("global_error"),e||a.getLang("global_unknown_error")),console.error(e),(0,l.logError)(new Error("error with onSaveCrop"+(e?`: ${e}`:"")))})))},this.onCropUpdate=e=>{this.crop=e},this.state={isLoading:!1}}}},16344:(e,t,r)=>{r.d(t,{NarrativeCreateLiteBox:()=>m});var o=r(785893),i=r(667294),a=r(29271),s=r(82161),n=r(365035),l=r(40138),d=r(535902),c=r(725296),h=r(816511),v=r(400856),u=r(629932),p=r(126116),g=r(832550),_=r(86894);class m extends i.Component{render(){var e;const{onClose:t,ownerName:r,stories:i}=this.props,{name:s,coverStory:c}=this.state,g=null==(e=c)?void 0:e.preview;return(0,o.jsxs)(h.ModalBox,{children:[(0,o.jsx)(v.ModalHeader,{onClose:t,closeAriaLabel:a.getLang("global_close"),children:a.getLang("stories_creating_narrative")}),(0,o.jsxs)("div",{className:"NarrativeCreateLiteBox__inner",children:[(0,o.jsx)("div",{className:"NarrativeCreateLiteBox__title",children:a.getLang("groups_edit_narrative_title")}),(0,o.jsx)(_.Input,{type:"text",value:s,onChange:this.onNameChange,placeholder:a.getLang("stories_enter_name"),maxLength:n.NARRATIVE_MAX_TITLE_LENGTH,getRef:this.nameInputRef,autoFocus:!0}),(0,o.jsx)("div",{className:"NarrativeCreateLiteBox__title",children:a.getLang("groups_edit_narrative_preview")}),(0,o.jsx)("div",{className:"NarrativeCreateLiteBox__text",children:a.getLang("groups_edit_narrative_pin_text")}),(0,o.jsxs)("div",{className:"NarrativeCreateLiteBox__previews",children:[(0,o.jsxs)("div",{className:"NarrativeCreateLiteBox__previewWrapper",children:[(0,o.jsx)("div",{className:"NarrativeCreateLiteBox__previewTitle",children:a.getLang("stories_narrative_preview_block_title")}),(0,o.jsxs)("div",{className:"NarrativeCreateLiteBox__smallPreview",children:[(0,o.jsx)(l.NarrativeItemPreviewCover,{cover:g}),(0,o.jsx)("span",{className:"NarrativeCreateLiteBox__smallPreviewName",children:(0,o.jsx)(u.TextClamp,{lines:2,children:s||a.getLang("stories_narrative_name_full")})})]})]}),(0,o.jsxs)("div",{className:"NarrativeCreateLiteBox__previewWrapper NarrativeCreateLiteBox__previewWrapper--snippet",children:[(0,o.jsx)("div",{className:"NarrativeCreateLiteBox__previewTitle",children:a.getLang("stories_narrative_preview_feed_title")}),(0,o.jsx)(d.NarrativeSnippet,{className:"NarrativeCreateLiteBox__snippet",ownerName:r,coverUrl:g,title:s,storyCount:i.length})]})]})]}),(0,o.jsx)(p.ModalFooter,{actionButtons:this.getBoxActionButtons()})]})}constructor(e){super(e),this.onNameChange=e=>{const t=e.target.value,r=(0,s.trim)(t)?t:"";this.setState({name:r})},this.getBoxActionButtons=()=>{const{isLoad:e}=this.state;return[(0,o.jsx)(g.Button,{size:"m",mode:"primary",onClick:this.save,loading:e,children:a.getLang("groups_edit_narrative_publish")},"publish")]},this.save=()=>{const{isLoad:e}=this.state;let{name:t=""}=this.state;e||(t=(0,s.trim)(t),t?(this.setState({isLoad:!0}),this.props.onSave(t).catch((()=>{this.setState({isLoad:!1})}))):(0,c.notaBene)(this.nameInputRef.current))},this.state={isLoad:!1,name:"",coverStory:e.stories[0]},this.nameInputRef=(0,i.createRef)()}}},378839:(e,t,r)=>{r.d(t,{NarrativeEditor:()=>C});var o=r(785893),i=r(667294),a=r(29271),s=r(399133),n=r(816511),l=r(400856),d=r(832550),c=r(725296),h=r(584356),v=r(382483),u=r(317130),p=r(82161),g=r(880660),_=r(90729),m=r(796822),w=r(858069),y=r(501977);class C extends i.Component{componentDidMount(){var e,t;null==(e=(t=this.props).refreshCoordinates)||e.call(t)}render(){const{appearance:e}=this.props;return e===s.EditorViewType.box?(0,o.jsx)(n.ModalBox,{children:(0,o.jsxs)("div",{className:"NarrativeEditor",children:[(0,o.jsx)(l.ModalHeader,{onClose:()=>this.close(),closeAriaLabel:a.getLang("global_close"),children:this.getBoxTitle()}),(0,o.jsx)("div",{className:"NarrativeEditor__modalBody",children:this.renderInner()})]})}):(0,o.jsx)("div",{className:"NarrativeEditor NarrativeEditor--page",children:this.renderInner()})}renderInner(){var e;const{storyIds:t,storyMap:r,onStoryLinkUpdate:i,isEditingLinksAvailable:a,linkData:n,appearance:l,loadMore:d,hasMore:c,coverUploadConfig:h,ownerId:p}=this.props,{name:g,selectedStoryIds:w,cover:y,section:C}=this.state,S=this.getSelectedStories(),x=(null==(e=y)?void 0:e.url)||"";return(0,o.jsxs)("div",{className:"NarrativeEditor__inner",children:[C===s.EditorSectionType.main&&(0,o.jsxs)(m.NarrativeEditorSection,{appearance:l,actionFooterButtons:this.getFooterButtons(),children:[(0,o.jsx)(u.NarrativeEditorDataPanel,{className:"NarrativeEditor__dataPanel",coverUrl:x,name:g,selectedStoriesCount:w.length,onNameChange:this.onNameChange,onSubmit:this.save,onCoverClick:this.openCoverSelection,ref:this.dataPanelRef}),(0,o.jsx)(v.NarrativeEditorStoriesTabPanel,{appearance:l,onSelectedStoriesUpdate:this.onSelectedStoriesUpdate,storyIds:t,loadMore:d,hasMore:c,selectedStoryIds:w,storyMap:r,linkData:n,isEditingLinksAvailable:a,onStoryLinkUpdate:i})]}),C===s.EditorSectionType.cover&&(0,o.jsx)(_.NarrativeEditorCoverSection,{ownerId:p,appearance:l,cover:y,stories:S,onSave:this.confirmCover,coverUploadConfig:h,storyMap:r})]})}getBoxTitle(){const{type:e}=this.props,{section:t}=this.state;return t===s.EditorSectionType.cover?a.getLang("stories_choose_cover_title"):e===s.EditorModeType.create?a.getLang("stories_creating_narrative"):a.getLang("stories_editing_narrative")}getPublishDoneHtml(e,t,r){const{getPublishDoneHTML:o}=this.props;if(o)return o(e,t,r);const[i,n]=e.split("_"),l=`if (!event.metaKey && !event.ctrlKey) { showNarrative(${Number(i)}, ${Number(n)}, 0, 'narrative${e}'); return false; }`;return`\n      <div class="top_result_header">\n        ${(r===s.EditorModeType.create?a.getLang("stories_narrative_created"):a.getLang("stories_narrative_edited")).replace("{name}",`<a href="/narrative${e}" onclick="${l}">${(0,p.clean)(t)}</a>`)}\n      </div>\n      <a href="#" class="link" onclick="window.Likes.share('narrative${e}'); return false;">${a.getLang("stories_manage_share_narrative")}</a>\n    `}getSelectedStories(){return this.state.selectedStoryIds.map((e=>this.props.storyMap[e]))}componentWillUnmount(){this.revokeCustomUrls()}revokeCustomUrls(){const{cover:e}=this.state;e&&(0,y.isCustomCover)(e)&&[e.url,e.customPhotoOriginalUrl].forEach((e=>{var t;(null==(t=e)?void 0:t.startsWith("blob:"))&&URL.revokeObjectURL(e)}))}constructor(e){super(e),this.onSelectedStoriesUpdate=(e=[])=>{var t,r;const{storyMap:o}=this.props,{cover:i}=this.state,a=null==(t=i)?void 0:t.coverStoryId,s={selectedStoryIds:e};if((null==(r=i)?void 0:r.customPhotoId)||a&&e.includes(a))e.length||(s.cover=null);else{const t=e[0];e[0]?s.cover={url:o[t].preview,coverStoryId:t}:s.cover=null}this.setState(s)},this.openCoverSelection=()=>{var e,t;const{cover:r}=this.state;((null==(e=r)?void 0:e.coverStoryId)||(null==(t=r)?void 0:t.customPhotoId))&&this.setState({section:s.EditorSectionType.cover})},this.confirmCover=e=>{const{cover:t}=this.state;this.setState({cover:e||t,section:s.EditorSectionType.main})},this.onNameChange=e=>{const t=e.target.value,r=(0,p.trim)(t)?t:"";this.setState({name:r})},this.close=(e,t)=>{const{ownerId:r,narrativeRawId:o,navScreen:i}=this.props;if(!e){let e="";o&&([,e]=o.split("_")),(0,w.sendNarrativeAnalytic)(w.NarrativeAnalyticEventType.close,{ownerId:r,id:Number(e)},i)}this.props.close(t)},this.onSave=e=>{this.props.onSave(e)},this.getFooterButtons=()=>{const{type:e}=this.props,{selectedStoryIds:t,loading:r}=this.state;return[(0,o.jsx)(d.Button,{size:"m",mode:"tertiary",onClick:()=>this.close(!1),disabled:r,children:a.getLang("global_cancel")},"close"),(0,o.jsx)(d.Button,{loading:r,size:"m",mode:"primary",onClick:this.save,disabled:0===t.length,children:e===s.EditorModeType.edit?a.getLang("global_save"):a.getLang("stories_create_narrative")},"save")]},this.save=()=>{var e,t;const{publishHash:r,editHash:o,type:i,navScreen:n,ownerId:l}=this.props,{cover:d,loading:v}=this.state,u=this.getSelectedStories();let{name:_=""}=this.state,{narrativeRawId:m}=this.props;if(v)return;if(_=(0,p.trim)(_),!_)return void(this.dataPanelRef.current&&(0,c.notaBene)(this.dataPanelRef.current.getInputEl()));if(!(null==(e=d)?void 0:e.coverStoryId)&&!(null==(t=d)?void 0:t.customPhotoId))return;let y="publish_narrative",C=r;i===s.EditorModeType.edit&&(y="edit_narrative",C=o);const S={act:y,owner_id:l,title:_,hash:C,story_ids:(0,g.prepareStoriesForPublishing)(u)};if(m){const[,e]=m.split("_");S.narrative_id=e}d.customPhotoId&&(S.custom_cover_photo_id=d.customPhotoId),d.coverStoryId&&(S.cover_story_id=d.coverStoryId),d.crop&&(S.crop_y=d.crop.y,S.crop_x=d.crop.x,S.crop_height=d.crop.height,S.crop_width=d.crop.width),window.ajax.post("al_stories.php",S,{onDone:e=>{m||(m=`${l}_${e}`);const t=this.getPublishDoneHtml(m,_,i);this.onSave(m),this.close(!0,(()=>(0,h.showDoneBox)(t))),(0,w.sendNarrativeAnalytic)(i===s.EditorModeType.edit?w.NarrativeAnalyticEventType.editNarrative:w.NarrativeAnalyticEventType.publishNarrative,{ownerId:Number(l),id:Number(e)},n)},onFail:e=>((0,h.showDoneBox)(e||a.getLang("global_error")),!0),hideProgress:()=>{this.setState({loading:!1})}}),this.setState({loading:!0})};let t=e.cover,r=e.selectedStoryIds[0];!t&&r&&(t={url:e.storyMap[r].preview,coverStoryId:r}),this.state={tabKey:e.activeTabKey,name:e.name,selectedStoryIds:e.selectedStoryIds,cover:t,loading:!1,section:s.EditorSectionType.main},this.dataPanelRef=(0,i.createRef)()}}C.defaultProps={name:"",type:s.EditorModeType.create,activeTabKey:s.EditorTabKey.selected,isEditingLinksAvailable:!1,appearance:s.EditorViewType.page}},399133:(e,t,r)=>{var o,i,a,s;r.d(t,{EditorModeType:()=>o,EditorSectionType:()=>s,EditorTabKey:()=>i,EditorViewType:()=>a}),function(e){e[e.create=0]="create",e[e.edit=1]="edit"}(o||(o={})),function(e){e.all="all",e.selected="selected"}(i||(i={})),function(e){e.box="box",e.page="page"}(a||(a={})),function(e){e.main="main",e.cover="cover"}(s||(s={}))},969420:(e,t,r)=>{r.d(t,{NarrativeEditorAllTab:()=>v});var o=r(785893),i=r(667294),a=r(399133),s=r(450443),n=r(278980),l=r(365035),d=r(659397),c=r(970978),h=r(562329);class v extends i.Component{render(){const{stories:e,selectedStoriesMap:t,className:r,onToggleCheck:i,isEditingLinksAvailable:a,onStoryLinkUpdate:l,linkData:c}=this.props,{isLoading:v}=this.state;let u;return(0,o.jsxs)("div",{className:(0,d.classNames)("NarrativeEditorAllTab ScrollContainer",r),ref:this.tabRef,children:[(0,o.jsx)(s.StoryArchivePreviewGrid,{className:"NarrativeEditorAllTab__grid",children:e.map((e=>{let r=!1;const s=new Date(1e3*e.time).toDateString();return u&&s===u||(u=s,r=!0),(0,o.jsx)("div",{className:"NarrativeEditorAllTab__story",children:(0,o.jsx)(n.StoryArchivePreview,{story:e,checked:!!t[e.id],selectable:this.isSelectable(e),onToggleCheck:i,onStoryLinkUpdate:l,isEditingLinksAvailable:a,linkData:c,needShowDate:r})},e.rawId)}))}),v&&(0,o.jsx)("div",{className:"NarrativeEditorAllTab__loader",children:(0,o.jsx)(h.default,{})})]})}isSelectable(e){const{selectedStoriesMap:t}=this.props,r=Object.keys(t).length;return!e.isUnavailable&&!!(r<l.MAX_NARRATIVE_STORIES||t[e.id])}componentDidMount(){this.isMount=!0,this.initScrollListener()}componentWillUnmount(){this.isMount=!1,this.deInitScrollContainer()}initScrollListener(){const e=this.getScrollContainer(),t=this.getTabEl();e&&t&&e.addEventListener("scroll",this.onScroll,!0)}deInitScrollContainer(){var e;null==(e=this.getScrollContainer())||e.removeEventListener("scroll",this.onScroll)}getScrollContainer(){const{appearance:e}=this.props;return e===a.EditorViewType.box?this.getTabEl():window}getTabEl(){var e;return null==(e=this.tabRef)?void 0:e.current}constructor(e){super(e),this.tabRef=(0,i.createRef)(),this.onScroll=()=>{const{hasMore:e}=this.props;e&&this.checkLoading()},this.checkLoading=(0,d.throttle)((()=>{const{loadMore:e,hasMore:t}=this.props,{isLoading:r}=this.state,o=this.getScrollContainer(),i=this.getTabEl();if(!t||!i)return;if(r||!this.isMount)return;let a;a=o instanceof HTMLElement?i.scrollTop+i.clientHeight>=i.scrollHeight-l.SCROLL_LOADING_MORE_GAP:window.innerHeight+l.SCROLL_LOADING_MORE_GAP>=i.getBoundingClientRect().bottom,a&&(this.setState({isLoading:!0}),e().catch((e=>{console.error(e),(0,c.logError)(e)})).finally((()=>{this.setState({isLoading:!1})})))}),l.SCROLL_THROTTLE_DELAY),this.state={isLoading:!1}}}v.defaultProps={isEditingLinksAvailable:!1,hasMore:!1}},90729:(e,t,r)=>{r.d(t,{NarrativeEditorCoverSection:()=>k});var o=r(434788),i=r(785893),a=r(667294),s=r(399133),n=r(659397),l=r(450443),d=r(278980),c=r(29271),h=r(832550),v=r(796822),u=r(641185),p=r(953908),g=r(377992),_=r(445706),m=r(481665),w=r(729838),y=r(514986),C=r(630892),S=r(404145),x=r(970978),N=r(983647),f=r(501977);class k extends a.Component{render(){const{className:e,appearance:t,stories:r}=this.props,{customCover:o,checkedCoverId:a,showDropArea:h,isModalOpen:p}=this.state;return(0,i.jsxs)(v.NarrativeEditorSection,{className:(0,n.classNames)("NarrativeEditorCoverSection",e),appearance:t,actionFooterButtons:this.getFooterButtons(),children:[(0,i.jsxs)("div",{className:"ScrollContainer",ref:this.scrollContainerRef,children:[(0,i.jsx)("div",{className:"NarrativeEditorCoverSection__hint StoryGridHint",children:c.getLang("stories_choose_cover_hint")}),(0,i.jsxs)(l.StoryArchivePreviewGrid,{className:"NarrativeEditorCoverSection__grid",children:[(0,i.jsx)("div",{className:"NarrativeEditorCoverSection__create",children:(0,i.jsx)(u.StoryLoadFile,{text:c.getLang("stories_upload_narrative_cover"),onFilesLoad:this.onFilesLoad})}),o&&(0,i.jsx)(m.StoryCustomCoverPreview,{uploadingStatus:o.status,coverUrl:o.customPhotoOriginalUrl,checked:o.id===a,uploadingPercent:o.percent,onToggleCheck:this.selectCustomCover,retryUpload:this.uploadCover}),r.map((e=>(0,i.jsx)("div",{className:"NarrativeEditorCoverSection__story",children:(0,i.jsx)(d.StoryArchivePreview,{story:e,checked:a===e.rawId,selectable:!0,onToggleCheck:this.toggleCheck})},e.rawId)))]})]}),h&&!p&&t===s.EditorViewType.box&&(0,i.jsx)(g.UploadDropBoxArea,{}),h&&!p&&t===s.EditorViewType.page&&(0,i.jsx)(_.UploadDropPageArea,{})]})}getThumbSizes(e,t){const r=e/t;let o,i;return e>=t?(o=Math.min(e,N.MAX_THUMB_WIDTH),i=Math.floor(o/r),i>N.MAX_THUMB_HEIGHT&&(i=N.MAX_THUMB_HEIGHT,o=Math.floor(i*r))):(i=Math.min(t,N.MAX_THUMB_HEIGHT),o=Math.floor(i*r),o>N.MAX_THUMB_WIDTH&&(o=N.MAX_THUMB_WIDTH,i=Math.floor(o/r))),[o,i]}saveCustomPhotoIfNeeded(){const{ownerId:e,coverUploadConfig:t}=this.props,{checkedCoverId:r}=this.state,i=this.getCoverById(r);return i?(0,f.needSavePhoto)(i)?new Promise(((r,a)=>{window.ajax.post("al_stories.php",{act:"save_narrative_cover",owner_id:e,upload_response:i.uploadResponse,hash:t.hash},{onDone:e=>{const{customCover:t}=this.state;if(!this.isMount||!t)return void a();const i=(0,o._)({},t,{customPhotoId:e});r(i)},onFail:e=>(console.error(e),a(e),!0)})})):Promise.resolve(i):Promise.reject()}componentDidMount(){this.isMount=!0;const e=this.getDragAndDropContainer();e&&(e.addEventListener("drop",this.onDragDrop),e.addEventListener("dragenter",this.onDragEnter),e.addEventListener("dragover",this.onDragEnter),e.addEventListener("dragleave",this.onDragLeave))}componentWillUnmount(){this.isMount=!1,null!=this.dragLeaveTimeout&&clearTimeout(this.dragLeaveTimeout);const e=this.getDragAndDropContainer();e&&(e.removeEventListener("drop",this.onDragDrop),e.removeEventListener("dragenter",this.onDragEnter),e.removeEventListener("dragover",this.onDragEnter),e.removeEventListener("dragleave",this.onDragLeave))}getDragAndDropContainer(){return this.props.appearance===s.EditorViewType.box?window.boxLayerWrap:document.body}getScrollContainer(){return this.props.appearance===s.EditorViewType.box?this.scrollContainerRef.current:document.documentElement}buildCovers(e){const{cover:t,stories:r}=e;let i;t&&(0,f.isCustomCover)(t)&&(i=(0,o._)({id:f.CustomCoverId},t));return[r.map((e=>{var r;return(null==(r=t)?void 0:r.coverStoryId)===e.id?(0,o._)({id:e.rawId},t):{id:e.rawId,url:e.preview,coverStoryId:e.id}})),i]}getCoverById(e){return e===f.CustomCoverId?this.state.customCover:this.state.covers.find((t=>t.id===e))}getCoverOriginalUrl(e){const{storyMap:t}=this.props;let r="";if((0,f.isSelectableCustomCover)(e))r=e.customPhotoOriginalUrl;else if(e.coverStoryId){var o;r=null==(o=t[e.coverStoryId])?void 0:o.originalPreviewUrl}return r}constructor(e){var t;super(e),this.scrollContainerRef=(0,a.createRef)(),this.isMount=!1,this.isCropSubmitted=!1,this.onFilesLoad=e=>{this.file=e[0],this.file&&this.uploadCover()},this.uploadCover=()=>{if(!this.file)return;const e=this.file,{coverUploadConfig:t}=this.props,r=new w.UploadPhoto(t,this.onUploadCoverProgress);r.validate(e).then((()=>{if(!this.isMount)return;const t=URL.createObjectURL(e),i={id:f.CustomCoverId,url:t,customPhotoOriginalUrl:t,percent:0,status:f.CoverUploadStatus.uploading};return this.setState({customCover:i}),r.upload(e).then((e=>{if(!this.isMount)return;const t=JSON.stringify(e);this.setState({customCover:(0,o._)({},i,{percent:100,status:f.CoverUploadStatus.uploaded,uploadResponse:t}),checkedCoverId:f.CustomCoverId})}))})).catch((e=>{if(!this.isMount)return;let t=this.state.customCover;t&&(t=(0,o._)({},t,{percent:0,status:f.CoverUploadStatus.failed})),console.error(e),e=(0,n.isObject)(e)?e.text:String(e),(0,y.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),(0,x.logError)(new Error("error with uploadCover"+(e?`: ${e}`:""))),this.setState({customCover:t})}))},this.onUploadCoverProgress=(e,t)=>{const r=Math.min(e/t*100,90);this.setState((e=>{let t=e.customCover;return t?{customCover:(0,o._)({},t,{percent:r})}:null}))},this.selectCustomCover=()=>{this.setState({checkedCoverId:f.CustomCoverId})},this.toggleCheck=e=>{this.setState({checkedCoverId:e.rawId})},this.openCropper=()=>{const{checkedCoverId:e}=this.state,t=this.getCoverById(e);if(!t)return;const r=this.getCoverOriginalUrl(t);r&&(0,S.loadImage)(r).then((e=>{if(!this.isMount)return;const o=e.width,i=e.height,[a,s]=this.getThumbSizes(o,i);this.setState({isModalOpen:!0}),(0,C.showNarrativeCropCoverBox)({coverUrl:r,coverHeight:i,coverWidth:o,thumbHeight:s,thumbWidth:a,crop:t.crop,onSave:this.onCropSave,onClose:this.onCropClose})})).catch((e=>{console.error(e),e=String(e),(0,y.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),(0,x.logError)(new Error("error with cover openCropper"+(e?`: ${e}`:"")))}))},this.onCropSave=(e,t)=>this.saveCustomPhotoIfNeeded().then((r=>{this.isCropSubmitted=!0;const{covers:i}=this.state;(0,f.isSelectableCustomCover)(r)?this.setState({customCover:(0,o._)({},r,{url:t,crop:e})}):this.setState({covers:i.map((i=>i.id===r.id?(0,o._)({},r,{url:t,crop:e}):i))})})),this.onCropClose=()=>{const{onSave:e}=this.props,{checkedCoverId:t}=this.state;this.setState({isModalOpen:!1});const r=this.getCoverById(t);r&&this.isCropSubmitted&&e({url:r.url,coverStoryId:r.coverStoryId,customPhotoOriginalUrl:r.customPhotoOriginalUrl,customPhotoId:r.customPhotoId,crop:r.crop})},this.getFooterButtons=()=>{var e;const{onSave:t}=this.props,{customCover:r}=this.state;return[(0,i.jsx)(h.Button,{size:"m",mode:"tertiary",onClick:()=>t(),children:c.getLang("global_cancel")},"close"),(0,i.jsx)(h.Button,{size:"m",mode:"primary",onClick:this.openCropper,disabled:(null==(e=r)?void 0:e.status)===f.CoverUploadStatus.uploading,children:c.getLang("stories_narrative_cover_next_step")},"save")]},this.onDragEnter=e=>{var t,r,o,i,a,s;("file"===(null==(o=e)||null==(r=o.dataTransfer)||null==(t=r.items[0])?void 0:t.kind)||(null==(s=e)||null==(a=s.dataTransfer)||null==(i=a.types)?void 0:i.includes("Files")))&&(clearTimeout(this.dragLeaveTimeout),delete this.dragLeaveTimeout,this.setState({showDropArea:!0})),(0,p.cancelEvent)(e)},this.onDragLeave=e=>{clearTimeout(this.dragLeaveTimeout),this.dragLeaveTimeout=setTimeout((()=>{delete this.dragLeaveTimeout,this.setState({showDropArea:!1})}),100),(0,p.cancelEvent)(e)},this.onDragDrop=e=>{var t,r,o;this.onDragLeave(e),(null==(o=e)||null==(r=o.dataTransfer)||null==(t=r.files)?void 0:t.length)&&this.onFilesLoad(Array.from(e.dataTransfer.files));const i=this.getScrollContainer();i&&i.scrollTo({top:0,behavior:"smooth"}),(0,p.cancelEvent)(e)};const[r,s]=this.buildCovers(e);let l=null==(t=r[0])?void 0:t.id;if(e.cover){const t=e.cover.customPhotoId,r=e.cover.coverStoryId;l=t?f.CustomCoverId:r?e.storyMap[r].rawId:e.stories[0].rawId}this.state={showDropArea:!1,covers:r,customCover:s,checkedCoverId:l,isModalOpen:!1}}}},501977:(e,t,r)=>{var o;function i(e){return Boolean(e.customPhotoId||e.uploadResponse)}function a(e){return Boolean(e.customPhotoId)}function s(e){return e.uploadResponse&&!e.customPhotoId}function n(e){const t={url:e.coverUrl,crop:e.coverCrop};return e.customCover?(t.customPhotoId=e.customCover.photoId,t.customPhotoOriginalUrl=e.customCover.originalPhotoUrl):t.coverStoryId=e.coverStoryId,t}r.d(t,{CoverUploadStatus:()=>o,CustomCoverId:()=>l,getPreparedCover:()=>n,isCustomCover:()=>a,isSelectableCustomCover:()=>i,needSavePhoto:()=>s}),function(e){e[e.uploaded=0]="uploaded",e[e.uploading=1]="uploading",e[e.failed=2]="failed"}(o||(o={}));const l="custom"},317130:(e,t,r)=>{r.d(t,{NarrativeEditorDataPanel:()=>v});var o=r(785893),i=r(667294),a=r(29271),s=r(659397),n=r(40138),l=r(365035),d=r(953908),c=r(301230),h=r(752198);class v extends i.Component{render(){const{name:e,onNameChange:t,selectedStoriesCount:r,coverUrl:i,onCoverClick:d,className:c}=this.props,v=0===r;let u="";return v||(u=a.getLang("stories_choose_cover")),(0,o.jsxs)("div",{className:(0,s.classNames)("NarrativeEditorDataPanel",c),children:[(0,o.jsxs)("div",{className:"NarrativeEditorDataPanel__preview",children:[(0,o.jsx)(n.NarrativeItemPreviewCover,{className:(0,s.classNames)("NarrativeEditorDataPanel__cover",{"NarrativeEditorDataPanel__cover--active":!v}),onClick:d,cover:i,title:u,extra:!v&&(0,o.jsx)("div",{className:"NarrativeEditorDataPanel__pencil",children:(0,o.jsx)(h.Icon24Write,{})})}),(0,o.jsx)("span",{className:(0,s.classNames)("NarrativeEditorDataPanel__name",{"NarrativeEditorDataPanel__name--empty":!e}),children:e||a.getLang("stories_narrative_name_full")})]}),(0,o.jsxs)("div",{className:"NarrativeEditorDataPanel__form",children:[(0,o.jsx)("span",{className:"NarrativeEditorDataPanel__nameLabel",children:a.getLang("stories_narrative_name")}),(0,o.jsx)("input",{className:"NarrativeEditorDataPanel__nameInput",value:e,onChange:t,onKeyDown:this.onKeyDown,type:"text",placeholder:a.getLang("stories_enter_name"),maxLength:l.NARRATIVE_MAX_TITLE_LENGTH,ref:this.nameInputRef,autoFocus:!0}),r>0&&(0,o.jsx)("span",{className:"NarrativeEditorDataPanel__selectedStoryCount",children:a.getLang("stories_selected_count",r)})]})]})}constructor(e){super(e),this.getInputEl=()=>this.nameInputRef&&this.nameInputRef.current,this.onKeyDown=e=>{e.keyCode===d.KEY.ENTER&&(e.ctrlKey||e.metaKey&&c.browser.mac)&&this.props.onSubmit()},this.nameInputRef=(0,i.createRef)()}}},893445:(e,t,r)=>{r.d(t,{NarrativeEditorFooter:()=>s});var o=r(785893),i=r(659397),a=r(126116);const s=({appearance:e,actionButtons:t})=>(0,o.jsx)("div",{className:(0,i.classNames)("NarrativeEditorFooter",`NarrativeEditorFooter--${e}`),children:(0,o.jsx)(a.ModalFooter,{actionButtons:t})})},796822:(e,t,r)=>{r.d(t,{NarrativeEditorSection:()=>n});var o=r(785893),i=r(667294),a=r(893445),s=r(682615);class n extends i.Component{render(){const{className:e,children:t,appearance:r,actionFooterButtons:i}=this.props;return(0,o.jsxs)("div",{className:(0,s.classNames)("NarrativeEditorSection",e),ref:this.scrollContainerRef,children:[(0,o.jsx)("div",{className:"NarrativeEditorSection__body",children:t}),Boolean(i)&&(0,o.jsx)(a.NarrativeEditorFooter,{appearance:r,actionButtons:i})]})}getSectionEl(){var e;return null==(e=this.scrollContainerRef)?void 0:e.current}constructor(...e){super(...e),this.scrollContainerRef=(0,i.createRef)()}}},468706:(e,t,r)=>{r.d(t,{NarrativeEditorSelectedTab:()=>v});var o=r(785893),i=r(667294),a=r(399133),s=r(450443),n=r(278980),l=r(682615),d=r(365035),c=r(444402);const h="NarrativeEditorSelectedTab__storyPreview";class v extends i.Component{render(){const{stories:e,selectedStoriesMap:t,className:r,isEditingLinksAvailable:i,onStoryLinkUpdate:a,linkData:d,onToggleCheck:c}=this.props,{draggingStoryRawId:v}=this.state;return(0,o.jsx)("div",{className:(0,l.classNames)("NarrativeEditorSelectedTab ScrollContainer",r),ref:this.tabRef,children:(0,o.jsx)(s.StoryArchivePreviewGrid,{ref:this.gridContainerRef,children:e.map((e=>(0,o.jsx)("div",{className:"NarrativeEditorSelectedTab__story",children:(0,o.jsx)(n.StoryArchivePreview,{className:h,story:e,draggable:!0,isDragged:e.rawId===v,checked:!!t[e.id],selectable:this.isSelectable(e),onToggleCheck:c,onStoryLinkUpdate:a,isEditingLinksAvailable:i,linkData:d})},e.rawId)))})})}isSelectable(e){const{selectedStoriesMap:t}=this.props,r=Object.keys(t).length;return!e.isUnavailable&&!!(r<d.MAX_NARRATIVE_STORIES||t[e.rawId])}componentDidMount(){const{onReorder:e,appearance:t}=this.props,r=this.getGridContainer(),o={dragThreshold:0,onDragFinish:()=>{this.setState({draggingStoryRawId:""})},onDragStart:e=>{const t=e.querySelector(`.${h}`);if(!t)return;const r=t.dataset.id;this.setState({draggingStoryRawId:r})},onReorder:()=>{const{stories:t}=this.props,r=document.querySelectorAll(`.${h}`),o=[];r.forEach((e=>{const r=e.getAttribute("data-id"),i=t.find((e=>e.rawId===r));i&&o.push(i.id)})),e(o)}};r&&(t===a.EditorViewType.box&&(o.wrapNode=this.getTabEl()),this.sorter=new c.default(r,"",o))}componentWillUnmount(){this.sorter&&this.sorter.destroy()}getTabEl(){var e;return null==(e=this.tabRef)?void 0:e.current}getGridContainer(){var e,t;return null==(t=this.gridContainerRef)||null==(e=t.current)?void 0:e.getGridContainer()}constructor(e){super(e),this.gridContainerRef=(0,i.createRef)(),this.tabRef=(0,i.createRef)(),this.state={draggingStoryRawId:""}}}},382483:(e,t,r)=>{r.d(t,{NarrativeEditorStoriesTabPanel:()=>u});var o=r(434788),i=r(785893),a=r(667294),s=r(399133),n=r(29271),l=r(425308),d=r(468706),c=r(969420),h=r(682615),v=r(365035);class u extends a.Component{render(){const{selectedStoryIds:e,appearance:t,isEditingLinksAvailable:r,linkData:o,onStoryLinkUpdate:a,loadMore:v,hasMore:u}=this.props,{tabKey:p}=this.state,g=this.getSelectedStoriesMap(),_=this.getAllStories();return(0,i.jsxs)("div",{className:"NarrativeEditorStoriesTabPanel",children:[(0,i.jsxs)(l.default,{className:"NarrativeEditorStoriesTabPanel__tabs",onTabClick:this.onTabClick,active:p,disabledTabMap:{[s.EditorTabKey.selected]:!e.length},children:[(0,i.jsxs)("span",{children:[n.getLang("stories_narrative_editor_selected_tab"),e.length>0&&(0,i.jsx)("span",{className:"Tabs__desc",children:e.length})]},s.EditorTabKey.selected),(0,i.jsx)("span",{children:n.getLang("stories_narrative_editor_all_tab")},s.EditorTabKey.all)]}),p===s.EditorTabKey.selected&&(0,i.jsx)(d.NarrativeEditorSelectedTab,{className:(0,h.classNames)("NarrativeEditorSelectPanel__grid",`NarrativeEditorSelectPanel__grid--${t}`),appearance:t,stories:this.getSelectedTabStories(),onReorder:this.onReorder,onToggleCheck:this.onStorySelectToggle,selectedStoriesMap:g,onStoryLinkUpdate:a,isEditingLinksAvailable:r,linkData:o}),p===s.EditorTabKey.all&&(0,i.jsx)(c.NarrativeEditorAllTab,{className:(0,h.classNames)("NarrativeEditorSelectPanel__grid",`NarrativeEditorSelectPanel__grid--${t}`),appearance:t,stories:_,loadMore:v,hasMore:u,onToggleCheck:this.onStorySelectToggle,selectedStoriesMap:g,onStoryLinkUpdate:a,isEditingLinksAvailable:r,linkData:o})]})}getSelectedTabStories(){return this.state.selectedTabStoryIds.map((e=>this.props.storyMap[e]))}getAllStories(){return this.props.storyIds.map((e=>this.props.storyMap[e]))}getSelectedStoriesMap(){return this.props.selectedStoryIds.reduce(((e,t)=>(e[t]=this.props.storyMap[t],e)),{})}constructor(e){super(e),this.onTabClick=(e,t)=>{this.setState({tabKey:t,selectedTabStoryIds:[...this.props.selectedStoryIds]})},this.onReorder=e=>{const{onSelectedStoriesUpdate:t}=this.props,r=this.getSelectedStoriesMap(),o=e.filter((e=>r[e]));this.setState({selectedTabStoryIds:e}),t(o)},this.onStorySelectToggle=e=>{const{selectedStoryIds:t,onSelectedStoriesUpdate:r}=this.props,{tabKey:i,selectedTabStoryIds:a}=this.state,n=this.getSelectedStoriesMap();if(!(Object.keys(n).length>=v.MAX_NARRATIVE_STORIES)||n[e.id]){if(!a.length)return this.setState({selectedTabStoryIds:[e.id]}),void r([e.id]);if(n[e.id]){r(t.filter((t=>t!==e.id)))}else{let t=[];const l=(0,o._)({},n,{[e.id]:e});if(i===s.EditorTabKey.selected)t=a.filter((e=>l[e]));else if(i===s.EditorTabKey.all){if(a.includes(e.id))t=a.filter((e=>l[e]));else{t=[...a,e.id].filter((e=>l[e])),this.setState({selectedTabStoryIds:[...a,e.id]})}}r(t)}}},this.state={tabKey:e.selectedStoryIds.length?s.EditorTabKey.selected:s.EditorTabKey.all,selectedTabStoryIds:[...e.selectedStoryIds]}}}u.defaultProps={isEditingLinksAvailable:!1}},40138:(e,t,r)=>{r.d(t,{NarrativeItemPreviewCover:()=>s});var o=r(785893),i=r(667294),a=r(682615);const s=(0,i.memo)((({title:e,onClick:t,cover:r,href:s,className:n="",extra:l,noBorder:d=!1,isDraft:c=!1,size:h=58})=>{const v=r?{backgroundImage:`url(${r})`}:{},u=(0,a.classNames)("NarrativeItemPreviewCover",`NarrativeItemPreviewCover--size${h}`,n,{"NarrativeItemPreviewCover--noBorder":d,"NarrativeItemPreviewCover--isDraft":c}),p=(0,o.jsx)("div",{className:"NarrativeItemPreviewCover__image",style:v,title:e||void 0,children:l});return(0,o.jsxs)(i.Fragment,{children:[s&&(0,o.jsx)("a",{href:s,className:u,onClick:t,children:p}),!s&&(0,o.jsx)("div",{className:u,onClick:t,children:p})]})}))},247563:(e,t,r)=>{r.d(t,{NarrativeRow:()=>c});var o=r(785893),i=r(667294),a=r(40138),s=r(222122),n=r(659397),l=r(29271),d=r(611695);const c=(0,i.memo)((({narrative:e,aside:t,onClick:r,className:c,clickable:h,size:v,noBorder:u})=>{const p=!e.storiesCount,g=p?"":`/narrative${e.ownerId}_${e.id}`;let _,m,w,y;return p?(_=(0,o.jsx)(a.NarrativeItemPreviewCover,{isDraft:!0,extra:(0,o.jsx)(d.Icon24NarrativeActiveOutline,{}),size:v}),m=(0,o.jsxs)(i.Fragment,{children:[l.getLang("groups_narrative_box_stories_count",e.storiesCount),(0,o.jsx)("span",{className:"dvd"}),(0,o.jsx)("span",{children:l.getLang("stories_narratives_draft")})]})):(_=(0,o.jsx)(a.NarrativeItemPreviewCover,{onClick:r,size:v,cover:e.coverUrl,href:g,noBorder:u}),m=(0,o.jsx)("span",{children:l.getLang("groups_narrative_box_stories_count",e.storiesCount)})),h?w=r:p||(y=r),(0,o.jsx)("div",{className:(0,n.classNames)("NarrativeRow NarrativeListItem",c,{"NarrativeRow--clickable":h}),"data-id":e.id,onClick:w,children:(0,o.jsx)(s.NarrativeRowBase,{className:"NarrativeRow__inner",href:g,onClick:y,preview:_,id:e.id,title:e.title,subtitle:m,size:v,aside:t})})}))},222122:(e,t,r)=>{r.d(t,{NarrativeRowBase:()=>l});var o=r(434788),i=r(820224),a=r(785893),s=r(667294),n=r(659397);const l=(0,s.memo)((e=>{var{id:t,title:r,subtitle:s,preview:l,aside:d,href:c,onClick:h,className:v="",size:u=58}=e,p=(0,i._)(e,["id","title","subtitle","preview","aside","href","onClick","className","size"]);const g=Boolean(h||c);let _;return r=(0,n.decodeHTMLEntities)(r),_=c?(0,a.jsx)("a",{href:c,className:"NarrativeRowBase__title",onClick:h,children:r}):(0,a.jsx)("span",{className:"NarrativeRowBase__title",onClick:h,children:r}),(0,a.jsxs)("div",(0,o._)({className:(0,n.classNames)("NarrativeRowBase",`NarrativeRowBase--previewSize${u}`,v,{"NarrativeRowBase--clickable":g})},p,{children:[(0,a.jsx)("div",{className:"NarrativeRowBase__preview",children:l}),(0,a.jsxs)("div",{className:"NarrativeRowBase__inner",children:[(0,a.jsxs)("div",{className:"NarrativeRowBase__main",children:[(0,a.jsx)("div",{className:"NarrativeRowBase__title",children:_}),s&&(0,a.jsx)("div",{className:"NarrativeRowBase__subtitle",children:s})]}),d&&(0,a.jsx)("div",{className:"NarrativeRowBase__aside",children:d})]})]}))}))},704703:(e,t,r)=>{r.d(t,{NarrativeRowCreation:()=>c});var o=r(434788),i=r(785893),a=r(667294),s=r(222122),n=r(29271),l=r(659397),d=r(376175);const c=(0,a.memo)((({onClick:e,clickable:t=!1,size:r=58})=>{const a=n.getLang("stories_create_new_narrative"),c=(0,i.jsx)("div",{className:(0,l.classNames)("NarrativeRowCreation__preview",`NarrativeRowCreation__preview--size${r}`),children:(0,i.jsx)(d.Icon28AddOutline,{})});return(0,i.jsx)("div",(0,o._)({className:(0,l.classNames)("NarrativeRowCreation NarrativeListItem",{"NarrativeRowCreation--clickable":t})},{nodrag:"true"},{children:(0,i.jsx)(s.NarrativeRowBase,{className:"NarrativeRowCreation__inner",title:a,onClick:e,preview:c,size:r})}))}))},535902:(e,t,r)=>{r.d(t,{NarrativeSnippet:()=>s});var o=r(785893),i=r(29271),a=r(659397);const s=e=>{const{className:t,coverUrl:r,title:s,ownerName:n,storyCount:l}=e;return(0,o.jsx)("div",{className:(0,a.classNames)("NarrativeSnippet",t),children:(0,o.jsxs)("div",{className:"NarrativeSnippet__inner",children:[(0,o.jsx)("div",{className:"NarrativeSnippet__cover",children:(0,o.jsx)("div",{className:"NarrativeSnippet__image",style:{backgroundImage:`url(${r})`}})}),(0,o.jsxs)("div",{className:"NarrativeSnippet__info",children:[(0,o.jsx)("div",{className:(0,a.classNames)("NarrativeSnippet__title",{"NarrativeSnippet__title--empty":!s}),children:s||i.getLang("stories_narrative_name_full")}),(0,o.jsx)("span",{className:"NarrativeSnippet__author",children:n}),(0,o.jsxs)("span",{className:"NarrativeSnippet__description",children:[(0,o.jsx)("span",{children:i.getLang("global_type_narrative")}),(0,o.jsx)("span",{className:"dvd"}),(0,o.jsx)("span",{children:i.getLang("global_narrative_stories_count",l)})]})]})]})})}},278980:(e,t,r)=>{r.d(t,{StoryArchivePreview:()=>u});var o=r(785893),i=r(667294),a=r(682615),s=r(29271),n=r(630892),l=r(970978),d=r(672948),c=r(331533),h=r(402622),v=r(562329);class u extends i.PureComponent{componentDidUpdate(e,t){const{story:r,isDragged:o}=this.props,{isHovered:i}=this.state;r.videoUrl&&(o||(!t.isHovered&&i?this.playVideo():t.isHovered&&!i&&this.pauseVideo()),!e.isDragged&&o&&this.pauseVideo(),e.isDragged&&!o&&i&&this.playVideo())}componentWillUnmount(){this.cleanVideoPlayTimeout(),this.cleanVideoPauseTimeout(),this.cleanVideoLoaderTimeout()}playVideo(e=!1){null!=this.videoPauseDelayTimeout&&this.cleanVideoPauseTimeout();const t=()=>{delete this.videoPlayDelayTimeout,this.videoRef.current&&(this.videoRef.current.muted=!0,this.videoRef.current.play().then((()=>{var e;if(this.hideLoader(),this.setState({canPlayVideo:!0}),this.needPauseAfterLoading)return null==(e=this.videoRef.current)||e.pause(),void(this.needPauseAfterLoading=!1)})).catch((e=>{this.hideLoader(),console.error(e),(0,l.logError)(e)})))};e?t():null==this.videoPlayDelayTimeout&&(this.videoLoaderTimeout=setTimeout((()=>{this.setState({isLoading:!0})}),800),this.setState({preloadVideo:!0}),this.videoPlayDelayTimeout=setTimeout((()=>{t()}),200))}pauseVideo(e=!1){null!=this.videoPlayDelayTimeout&&this.cleanVideoPlayTimeout();const t=()=>{if(delete this.videoPauseDelayTimeout,this.hideLoader(),this.state.canPlayVideo){var e,t;null==(t=null==(e=this.videoRef)?void 0:e.current)||t.pause()}else this.needPauseAfterLoading=!0};e?t():null==this.videoPauseDelayTimeout&&(this.videoPauseDelayTimeout=setTimeout((()=>{t()}),200))}cleanVideoPlayTimeout(){this.videoPlayDelayTimeout&&(clearTimeout(this.videoPlayDelayTimeout),delete this.videoPlayDelayTimeout)}cleanVideoPauseTimeout(){this.videoPauseDelayTimeout&&(clearTimeout(this.videoPauseDelayTimeout),delete this.videoPauseDelayTimeout)}cleanVideoLoaderTimeout(){this.videoLoaderTimeout&&(clearTimeout(this.videoLoaderTimeout),delete this.videoLoaderTimeout)}hideLoader(){this.state.isLoading&&this.setState({isLoading:!1}),this.cleanVideoLoaderTimeout()}render(){const{story:e,checked:t,selectable:r,draggable:i,className:n,isEditingLinksAvailable:l,needShowDate:u}=this.props,{preloadVideo:p,canPlayVideo:g,isLoading:_}=this.state,m=Boolean(e.videoUrl),w=new Date(1e3*e.time);return(0,o.jsx)("div",{className:(0,a.classNames)("StoryArchivePreview","StoryPreviewContainer",n,{"StoryArchivePreview--video":m,"StoryArchivePreview--checked":t}),onClick:this.onToggleCheck,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,"data-id":e.rawId,children:(0,o.jsxs)("div",{className:"StoryArchivePreview__wrapper",children:[m&&(0,o.jsxs)(o.Fragment,{children:[p&&(0,o.jsx)("video",{className:(0,a.classNames)("StoryArchivePreview__media",{"StoryArchivePreview__media--hidden":!g}),src:e.videoUrl,ref:this.videoRef,controls:!1,preload:"metadata",loop:!0,playsInline:!0}),!g&&(0,o.jsx)("img",{className:"StoryArchivePreview__media",src:e.preview,alt:""})]}),!m&&(0,o.jsx)("img",{className:"StoryArchivePreview__media",src:e.preview,alt:""}),u&&(0,o.jsxs)("div",{className:"StoryArchivePreview__date",children:[(0,o.jsx)("div",{className:"StoryArchivePreview__day",children:w.getDate()}),(0,o.jsx)("div",{className:"StoryArchivePreview__month",children:(0,o.jsx)(c.InnerHTML,{children:s.getLang("months_sm_of")[w.getMonth()+1]})})]}),i&&!u&&(0,o.jsx)("div",{className:"StoryArchivePreview__draggableIcon"}),r&&(0,o.jsx)("div",{className:(0,a.classNames)("StoryArchivePreview__select",{"StoryArchivePreview__select--on":t})}),(l||e.videoUrl)&&(0,o.jsx)("div",{className:"StoryArchivePreview__footer",children:(0,o.jsxs)("div",{className:"StoryArchivePreview__footerInner",children:[e.videoUrl&&(0,o.jsxs)("div",{className:"StoryArchivePreview__play",children:[(0,o.jsx)(h.Icon16Videocam,{}),(0,o.jsx)("span",{className:"StoryArchivePreview__playTime",children:(0,d.formatTime)(e.duration||0)})]}),l&&(0,o.jsx)("div",{className:"StoryArchivePreview__linkBtn",onClick:e=>this.onLinkButtonClick(e),children:e.linkUrl?s.getLang("stories_edit_link"):s.getLang("stories_add_link")})]})}),_&&(0,o.jsx)("div",{className:"StoryArchivePreview__loader",children:(0,o.jsx)(v.default,{size:24,strokeWidth:3,color:"#fff"})})]})})}constructor(e){super(e),this.videoRef=(0,i.createRef)(),this.needPauseAfterLoading=!1,this.onLinkButtonClick=e=>{const{story:t,onStoryLinkUpdate:r,linkData:o,isDragged:i}=this.props;i||((0,n.showStoryLinkEditorBox)({story:t,onStoryLinkUpdate:r,linkData:o}),e.stopPropagation())},this.onMouseEnter=()=>{this.setState({isHovered:!0})},this.onMouseLeave=()=>{this.setState({isHovered:!1})},this.onToggleCheck=()=>{const{onToggleCheck:e,story:t,isDragged:r}=this.props;!r&&e&&e(t)},this.state={isHovered:!1,preloadVideo:!1,canPlayVideo:!1,isLoading:!1}}}u.defaultProps={checked:!1,selectable:!1,draggable:!1,isDragged:!1,className:"",isEditingLinksAvailable:!1,onToggleCheck:()=>{},onStoryLinkUpdate:()=>{},linkData:[]}},450443:(e,t,r)=>{r.d(t,{StoryArchivePreviewGrid:()=>s});var o=r(785893),i=r(667294),a=r(682615);class s extends i.Component{getGridContainer(){return this.gridContainerRef.current}render(){const{className:e,children:t,isScrolling:r}=this.props;return(0,o.jsx)("div",{className:(0,a.classNames)("StoryArchivePreviewGrid",e,{"StoryArchivePreviewGrid--scrolling":r}),children:(0,o.jsx)("div",{className:"StoryArchivePreviewGrid__inner",ref:this.gridContainerRef,children:t})})}constructor(...e){super(...e),this.gridContainerRef=(0,i.createRef)()}}s.defaultProps={className:""}},481665:(e,t,r)=>{r.d(t,{StoryCustomCoverPreview:()=>c});var o=r(785893),i=r(667294),a=r(659397),s=r(230601),n=r(647605),l=r(29271),d=r(501977);class c extends i.PureComponent{render(){const{checked:e,coverUrl:t,onToggleCheck:r,uploadingStatus:i,uploadingPercent:c,retryUpload:h}=this.props,v=i===d.CoverUploadStatus.uploaded,u=i===d.CoverUploadStatus.uploading,p=i===d.CoverUploadStatus.failed,g=v;return(0,o.jsxs)("div",{className:(0,a.classNames)("StoryCustomCoverPreview StoryPreviewContainer",{"StoryCustomCoverPreview--empty":u||p}),onClick:()=>{g&&r()},children:[v&&(0,o.jsx)("div",{className:"StoryCustomCoverPreview__coverFrame",children:(0,o.jsx)("div",{className:"StoryCustomCoverPreview__coverWrap",children:(0,o.jsx)("img",{src:t,className:"StoryCustomCoverPreview__cover",alt:""})})}),u&&(0,o.jsx)(s.StoryProgressSpinner,{percent:c}),p&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.Icon24ErrorCircleOutline,{}),(0,o.jsx)("span",{className:"StoryCustomCoverPreview__errorText",children:l.getLang("stories_upload_error_text")}),(0,o.jsx)("div",{className:"StoryCustomCoverPreview__repeat",onClick:h,children:l.getLang("stories_upload_repeat")})]}),g&&(0,o.jsx)("div",{className:(0,a.classNames)("StoryCustomCoverPreview__select",{"StoryCustomCoverPreview__select--on":e})})]})}constructor(e){super(e)}}c.defaultProps={uploadingStatus:d.CoverUploadStatus.uploaded}},783412:(e,t,r)=>{r.d(t,{StoryLinkEditorBox:()=>y});var o=r(785893),i=r(667294),a=r(29271),s=r(82161),n=r(514986),l=r(725296),d=r(970978),c=r(584356),h=r(816511),v=r(400856),u=r(685371),p=r(833314),g=r(622284),_=r(126116),m=r(832550),w=r(86894);class y extends i.Component{componentDidUpdate(e,t){t.needErrorStatus!==this.state.needErrorStatus&&this.state.needErrorStatus&&setTimeout((()=>{this.setState({needErrorStatus:!1})}),3e3)}render(){const{onClose:e,linkData:t}=this.props,{linkType:r,link:i,needShowHint:s,needErrorStatus:n,isSaving:l,isDeleting:d}=this.state,c=this.isEditMode()?a.getLang("stories_edit_link_title"):a.getLang("stories_add_link_title");return(0,o.jsxs)(h.ModalBox,{children:[(0,o.jsx)(v.ModalHeader,{onClose:e,closeAriaLabel:a.getLang("global_close"),children:c}),(0,o.jsxs)(u.ModalBody,{insetLevel:1,children:[(0,o.jsx)(p.FormItem,{mode:"horizontal",topAlign:"right",topWidth:"s",top:a.getLang("stories_link_label_url"),status:n?"error":"default",children:(0,o.jsx)(g.TextTooltip,{text:a.getLang("stories_upload_link_format"),placement:"top",appearance:"neutral",shown:s,width:200,children:(0,o.jsx)(w.Input,{value:i,onChange:this.onChangeLink,onKeyUp:this.onKeyUpLink,autoFocus:!0,getRef:this.inputRef})})}),(0,o.jsx)(p.FormItem,{mode:"horizontal",topAlign:"right",topWidth:"s",top:a.getLang("stories_link_label_text"),children:(0,o.jsx)(w.Select,{options:t.items,value:r,onChange:this.onChangeLinkType})})]}),(0,o.jsx)(_.ModalFooter,{before:this.isEditMode()?(0,o.jsx)(m.Button,{loading:d,mode:"tertiary",size:"m",onClick:this.onDelete,children:a.getLang("stories_delete_link")},"delete"):void 0,actionButtons:[(0,o.jsx)(m.Button,{mode:"tertiary",size:"m",onClick:()=>e(),children:a.getLang("global_cancel")},"close"),(0,o.jsx)(m.Button,{loading:l,mode:"primary",size:"m",onClick:this.onSave,children:this.isEditMode()?a.getLang("global_save"):a.getLang("stories_add_link")},"save")]})]})}isEditMode(){return Boolean(this.props.story.linkUrl)}isLinkValid(e){if(e.length<2)return!1;if(!e.startsWith("http://")&&!e.startsWith("https://"))return!1;if(!e.match(/^[a-z0-9\/\-._:%=?&@#]+$/i))return!1;try{new URL(e)}catch(e){return!1}return!0}edit(e="",t="",r=!0,o){const{onStoryLinkUpdate:i,onClose:s,story:n,linkData:h}=this.props;window.ajax.post("al_stories.php",{act:"edit_link",story_raw_id:n.rawId,link_url:e,link_text:t,hash:h.editHash},{onDone:()=>{s(),i(n.rawId,e,t)},onFail:e=>{(0,c.showDoneBox)(e||a.getLang("global_unknown_error"));const t="Link saving error in StoryLinkEditor"+(e?": "+e:"");return(0,d.logError)(new Error(t)),!0},showProgress:()=>{r?this.setState({isSaving:!0}):this.setState({isDeleting:!0}),(0,l.lockButton)(o)},hideProgress:()=>{var e;o&&(null==(e=(0,c.curBox)())||e.hide(),(0,l.unlockButton)(o));r?this.setState({isSaving:!1}):this.setState({isDeleting:!1})}})}delete(e){this.edit("","",!1,e)}constructor(e){super(e),this.inputRef=(0,i.createRef)(),this.onChangeLink=e=>{let t=(0,s.trim)(e.target.value);this.setState({link:t,needShowHint:!this.isLinkValid(t)})},this.onKeyUpLink=()=>{const{link:e}=this.state;this.setState({needShowHint:!this.isLinkValid(e)})},this.onChangeLinkType=e=>{this.setState({linkType:String(e.target.value)})},this.onSave=()=>{const{linkData:e}=this.props,{linkType:t}=this.state;let{link:r}=this.state;var o,i;if(r=(0,s.trim)(r),!this.isLinkValid(r))return null==(i=this.inputRef)||null==(o=i.current)||o.focus(),void this.setState({needShowHint:!0,needErrorStatus:!0});e.needShowHint?(0,n.showFastBox)(a.getLang("stories_saving_link"),a.getLang("stories_link_editing_warning"),a.getLang("global_save"),(e=>{this.edit(r,t,!0,e)}),a.getLang("global_cancel")):this.edit(r,t)},this.onDelete=()=>{const{linkData:e}=this.props;e.needShowHint?(0,n.showFastBox)(a.getLang("stories_deleting_link"),a.getLang("stories_link_deleting_warning"),a.getLang("global_delete"),(e=>{this.delete(e)}),a.getLang("global_cancel")):this.delete()},this.state={link:e.story.linkUrl||"",linkType:e.story.linkType||e.linkData.items[0].value,needShowHint:!1,needErrorStatus:!1,isSaving:!1,isDeleting:!1}}}},641185:(e,t,r)=>{r.d(t,{StoryLoadFile:()=>a});var o=r(785893),i=r(523087);const a=({text:e,multiple:t=!1,onFilesLoad:r})=>(0,o.jsxs)("div",{className:"StoryLoadFile StoryPreviewContainer",children:[(0,o.jsx)(i.Icon36Add,{}),(0,o.jsx)("span",{className:"StoryLoadFile__text",children:e}),(0,o.jsx)("input",{type:"file",className:"StoryLoadFile__input",multiple:t,onChange:e=>{const t=e.currentTarget.files;t&&r(Array.from(t))}})]})},230601:(e,t,r)=>{r.d(t,{StoryProgressSpinner:()=>n});var o=r(785893),i=r(667294);const a=3,s=2*Math.PI*22,n=(0,i.memo)((({percent:e=60,width:t=24,height:r=24})=>{const i=(s-a)*e/100+a;return(0,o.jsx)("svg",{className:"StoryProgressSpinner",width:t,height:r,viewBox:"0 0 50 50",children:(0,o.jsx)("circle",{cx:"25",cy:"25",r:22,stroke:"#fff",fill:"none",strokeWidth:"6",strokeMiterlimit:"10",strokeDashoffset:"0",strokeDasharray:`${i},${s}`,strokeLinecap:"round"})})}))},377992:(e,t,r)=>{r.d(t,{UploadDropBoxArea:()=>a});var o=r(785893),i=r(29271);const a=()=>(0,o.jsx)("div",{className:"UploadDropBoxArea",children:(0,o.jsx)("div",{className:"UploadDropBoxArea__inner",children:(0,o.jsx)("div",{className:"UploadDropBoxArea__text",children:i.getLang("stories_narrative_cover_drop_hint")})})})},445706:(e,t,r)=>{r.d(t,{UploadDropPageArea:()=>s});var o=r(785893),i=r(29271),a=r(120773);const s=()=>(0,o.jsx)(a.WithPortal,{children:(0,o.jsx)("div",{className:"UploadDropPageArea",children:(0,o.jsxs)("div",{className:"UploadDropPageArea__inner",children:[(0,o.jsx)("div",{className:"UploadDropPageArea__image"}),(0,o.jsx)("div",{className:"UploadDropPageArea__text",children:i.getLang("stories_drop_page_area_label")})]})})})},365035:(e,t,r)=>{r.d(t,{ADMIN_STORY_VIEW_MODULE:()=>a,BOX_ITEM_DRAGGABLE_CLASS:()=>u,EMOJI_REACTIONS_ARR:()=>n,INIT_MAX_FEEDBACK_STORIES_COUNT:()=>c,LONG_PRESS_DELAY_MS:()=>i,MAX_FEEDBACK_STORIES_SLICE_COUNT:()=>d,MAX_NARRATIVE_STORIES:()=>h,NARRATIVE_MAX_TITLE_LENGTH:()=>v,QUESTION_SELECT_MODE:()=>l,SCROLL_LOADING_MORE_GAP:()=>g,SCROLL_THROTTLE_DELAY:()=>p,STORIES_MANAGE_MODULE:()=>o,StickerTypes:()=>s});const o="stories_manage",i=200,a="admin_story_view",s={hashtag:1,mention:2,question:3,place:4,music:5,storyReply:6,owner:7,link:8,marketItem:9,post:10,poll:11,sticker:12,app:13,situationalTheme:14,playlist:15,videoButton:16},n=[{code:"f09f9882",name:"face_with_tears_of_happiness"},{code:"f09f988d",name:"smiling_face_with_heart_eyes"},{code:"f09f918df09f8fbf",name:"thumbs_up"},{code:"f09f98ad",name:"loud_crying_face"},{code:"f09f98b1",name:"face_screaming_in_fear"},{code:"e298ba",name:"smiling_face"}],l={PUBLIC:0,AUTHOR_ONLY:1,ANONYMOUS:3},d=50,c=10,h=100,v=23,u="NarrativeBox__draggable",p=34,g=400},880660:(e,t,r)=>{r.d(t,{highlightNarrativeBlock:()=>_,prepareStoriesForPublishing:()=>p,updateNarrativeBlock:()=>g,updateNarrativeSnippetsFromQueueByPost:()=>m});var o=r(795558),i=r(584356),a=r(533919),s=r(29271),n=r(664988),l=r(687437),d=r(964262),c=r(970978),h=r(839470),v=r(931917);const u="NarrativeSnippet";function p(e){return e.map((e=>e.id)).join(",")}function g(e=!1){const t=(0,n.intval)(window.cur.oid);if(window.cur.narrativeBlock)window.ajax.post("al_stories.php",{act:"get_narrative_block",owner_id:t},{onDone:e=>{const t=(0,n.intval)(window.cur.oid),r=document.getElementById(`narratives_module${t}_wrapper`);if(r)if(e)(0,o.domReplaceEl)(r,e),window.cur.narrativeBlock&&window.cur.narrativeBlock.destroy(),window.NarrativeBlock&&(window.cur.narrativeBlock=new window.NarrativeBlock);else{var i,a;const e=r.parentElement;var s;if((null==(i=e)?void 0:i.children.length)&&(null==(a=e)?void 0:a.children.length)>1)r.remove();else null==(s=e)||s.remove();window.cur.narrativeBlock&&window.cur.narrativeBlock.destroy(),delete window.cur.narrativeBlock}(0,d.removeStoryList)(`narratives${t}`)}});else if(v.Ranges.isUserId(t)&&"profile"===window.cur.module){const e=document.getElementById(l.PROFILE_MEDIA_NARROW_BLOCK_ID),r=!e;window.ajax.post("al_stories.php",{act:"get_narrative_block",owner_id:t,need_wrap_block:(0,n.intval)(r)},{onDone:r=>{if(e)e.insertAdjacentHTML("afterbegin",r);else{const e=document.getElementById("narrow_column");if(!e)return;e.insertAdjacentHTML("beforeend",r)}window.cur.narrativeBlock&&window.cur.narrativeBlock.destroy(),window.NarrativeBlock&&(window.cur.narrativeBlock=new window.NarrativeBlock,window.cur.narrativeBlock.showOnboardTooltipIfNeeded()),(0,d.removeStoryList)(`narratives${t}`)}})}else e&&function(e){window.boxQueue.hideAll();const t=document.querySelector("#box_layer_wrap"),r=document.querySelector("#box_loader");window.nav.reload({onDone:()=>{e&&e()},showProgress:()=>{(0,o.show)(t),(0,o.show)(r),(0,i.boxRefreshCoords)(r)},hideProgress:()=>{(0,o.hide)(t),(0,o.hide)(r)}})}((()=>{window.cur.needNarrativeOnboard=!0}))}function _(e){if(!e)return;const t=`narratives_module${window.vk.id}`;(0,a.highlightModule)({module:t,text:s.getLang("stories_narrative_block_onboarding_text"),onClose:()=>{delete window.cur.needNarrativeOnboard,window.ajax.post("al_index.php",{act:"hide_feature_tt",hash:e,type:"profile_narrative"})},autoCancelDelay:1e4,speed:600})}function m(e){if(!window.vk.id)return;if(!(0,h.partConfigEnabled)("update_private_snippets_by_queue"))return;const t=Array.from(e.querySelectorAll(`.${u}`));if(!t.length)return;const r=[];t.forEach((e=>{if(!window.vk.id||!e.dataset.needUpdate)return;const t=e.dataset.narrativeRawId;t&&r.push({narrative_raw_id:t,snippet_type:e.dataset.snippetType,from:e.dataset.from})})),r.length&&window.ajax.post("al_stories.php",{act:"get_narrative_snippets",narrative_snippets:JSON.stringify(r)},{onDone:e=>{t.forEach((t=>{t.dataset.narrativeRawId&&e[t.dataset.narrativeRawId]&&(t.outerHTML=e[t.dataset.narrativeRawId])}))},onFail:()=>((0,c.logError)(new Error("Fail: updateNarrativeSnippetFromQueueByPost")),!0)})}},516091:(e,t,r)=>{function o(e,t=!1){return new Promise(((r,o)=>{window.ajax.post("al_stories.php",{act:e.boxAct,owner_id:e.ownerId,start_from:e.startFrom,track_code:e.trackCode},{loader:!e.narratives.length&&!t,onDone:(e,t,o)=>{r([e,t,o])},onFail:e=>(o(e),!0)})}))}function i(e){return o(e).then((([t,,r])=>{var o;return e.narratives=(null==(o=e.narratives)?void 0:o.concat(t))||t,e.startFrom=r,t}))}function a(e={}){return o(s(e),!0)}function s(e={}){return{narratives:e.narratives?e.narratives:[],boxData:e.boxData,boxAct:"get_recommended_narratives",trackCode:e.trackCode,list:e.list,source:e.source}}function n(e){return window.stManager.add(e)}r.d(t,{addStatic:()=>n,fetchRecommendedNarrativesBoxData:()=>a,getRecommendedNarrativesStore:()=>s,load:()=>o,loadMoreNarratives:()=>i})},833723:(e,t,r)=>{r.d(t,{SIMPLE_BOX_WIDTH:()=>o,SMALL_BOX_WIDTH:()=>a,WIDE_BOX_WIDTH:()=>i});const o=560,i=638,a=450},630892:(e,t,r)=>{r.r(t),r.d(t,{fetchRecommendedNarrativesBoxData:()=>c.fetchRecommendedNarrativesBoxData,showNarrativeBox:()=>o.showNarrativeBox,showNarrativeChooseBox:()=>i.showNarrativeChooseBox,showNarrativeCreateLiteBox:()=>a.showNarrativeCreateLiteBox,showNarrativeCropCoverBox:()=>s.showNarrativeCropCoverBox,showNarrativeEditorBox:()=>n.showNarrativeEditorBox,showRecommendedNarrativesBox:()=>l.showRecommendedNarrativesBox,showStoryLinkEditorBox:()=>d.showStoryLinkEditorBox});var o=r(583396),i=r(412504),a=r(207094),s=r(378734),n=r(278212),l=r(373697),d=r(844553),c=r(516091)},583396:(e,t,r)=>{r.d(t,{showNarrativeBox:()=>w});var o=r(434788),i=r(785893),a=r(386342),s=r(400469),n=r(584356),l=r(29271),d=r(725296),c=r(514986),h=r(858069),v=r(516091),u=r(833723),p=r(359639),g=r(667294),_=r(659397);function m({options:e,onClose:t,refreshCoordinates:r,onWasPublishChange:u}){const[_,m]=(0,g.useState)((()=>({narratives:[],ownerId:e.ownerId,boxAct:"get_narrative_box_data"})));(0,g.useEffect)((()=>{(0,v.load)(_,!0).then((([e,t,r])=>{m((i=>(0,o._)({},i,{narratives:e,boxData:t,startFrom:r})))})).catch((r=>{var o,i;(0,n.showDoneBox)(r||l.getLang("global_error")),t(),null==(o=(i=e).onClose)||o.call(i)}))}),[]);const{boxData:w}=_;if(!w)return(0,i.jsx)(p.MessageBoxModalLoader,{refreshCoordinates:r});const y=w.canEdit?s.BoxType.edit:s.BoxType.view;return(0,i.jsx)(a.NarrativeBox,{type:y,boxData:w,narratives:_.narratives,onClose:t,onSave:t=>{var r,o;null==(r=(o=e).onSave)||r.call(o,t),u(!0)},onRemove:t=>{const r={title:l.getLang("global_warning")};(0,c.showFastBox)(r,l.getLang("stories_narrative_remove_warning"),l.getLang("stories_remove_confirm"),(r=>{const i=_.boxData;i&&window.ajax.post("al_stories.php",{act:"remove_narrative",narrative_raw:t.rawId,hash:i.removeHash},{onDone:()=>{var r,i;(0,h.sendNarrativeAnalytic)(h.NarrativeAnalyticEventType.deleteNarrative,t,e.navScreen),m((e=>e.boxData?(0,o._)({},e,{boxData:(0,o._)({},e.boxData,{count:e.boxData.count-1}),narratives:e.narratives.filter((e=>e.rawId!==t.rawId))}):e)),(0,n.showDoneBox)(l.getLang("stories_deleted_narrative")),null==(r=(i=e).onRemove)||r.call(i)},onFail:e=>((0,n.showDoneBox)(e||l.getLang("global_error")),!0),showProgress:()=>(0,d.lockButton)(r),hideProgress:()=>{(0,n.curBox)().hide(),(0,d.unlockButton)(r)}})}),l.getLang("global_cancel"))},onBookmark:e=>{e.isBookmarked=!e.isBookmarked,m((e=>(0,o._)({},e)))},onReorder:t=>{var r,i;m((e=>(0,o._)({},e,{narratives:t}))),null==(r=(i=e).onReorder)||r.call(i)},loadMore:()=>(0,v.loadMoreNarratives)(_).then((()=>{m((e=>(0,o._)({},e)))})).catch((e=>{(0,n.showDoneBox)(e||l.getLang("global_error"))})),navScreen:e.navScreen,refreshCoordinates:r})}function w(e){const t={current:!1},r={current:_.noop};(0,p.showMessageBoxModal)((a=>(r.current=a.onClose,(0,i.jsx)(m,(0,o._)({},a,{options:e,onWasPublishChange:e=>{t.current=e}})))),{width:u.SIMPLE_BOX_WIDTH,onShow:()=>{t.current&&r.current()},onDestroy:e.onClose})}},412504:(e,t,r)=>{r.d(t,{showNarrativeChooseBox:()=>p});var o=r(434788),i=r(785893),a=r(584356),s=r(29271),n=r(24237),l=r(516091),d=r(833723),c=r(359639),h=r(667294),v=r(659397);function u({onClose:e,refreshCoordinates:t,options:r,onAfterSavingChange:d}){const[v,u]=(0,h.useState)((()=>({narratives:[],ownerId:r.ownerId,boxAct:"get_narrative_choose_box_data"})));(0,h.useEffect)((()=>{(0,l.load)(v,!0).then((([e,t,r])=>{u((i=>(0,o._)({},i,{narratives:e,boxData:t,startFrom:r})))})).catch((t=>{(0,a.showDoneBox)(t||s.getLang("global_error")),e()}))}),[]);const{boxData:p}=v;return p?(0,i.jsx)(n.NarrativeChooseBox,{story:r.story,narratives:v.narratives,onClose:e,onSave:e=>{var t,o;d(!0),null==(t=(o=r).onSave)||t.call(o,e)},boxData:p,loadMore:()=>(0,l.loadMoreNarratives)(v).then((e=>(u((e=>(0,o._)({},e))),e))).catch((e=>((0,a.showDoneBox)(e||s.getLang("global_error")),[]))),navScreen:r.navScreen}):(0,i.jsx)(c.MessageBoxModalLoader,{refreshCoordinates:t})}function p(e){const t={current:!1},r={current:v.noop};(0,c.showMessageBoxModal)((a=>(r.current=a.onClose,(0,i.jsx)(u,(0,o._)({},a,{options:e,onAfterSavingChange:e=>{t.current=e}})))),{width:d.SIMPLE_BOX_WIDTH,onShow:()=>{t.current&&r.current()},onDestroy:()=>{var r,o;null==(r=(o=e).onClose)||r.call(o,t.current)}})}},207094:(e,t,r)=>{r.d(t,{showNarrativeCreateLiteBox:()=>l});var o=r(434788),i=r(785893),a=r(16344),s=r(359639),n=r(833723);function l(e){const{onSave:t,onClose:r,ownerId:l,ownerName:d,stories:c,publishNarrativeHash:h}=e;(0,s.showMessageBoxModal)((e=>(0,i.jsx)(a.NarrativeCreateLiteBox,(0,o._)({},e,{stories:c,ownerId:l,ownerName:d,publishNarrativeHash:h,onSave:t}))),{width:n.SIMPLE_BOX_WIDTH,onDestroy:r})}},378734:(e,t,r)=>{r.d(t,{showNarrativeCropCoverBox:()=>l});var o=r(434788),i=r(785893),a=r(983647),s=r(359639),n=r(833723);function l(e){const{coverUrl:t,coverHeight:r,coverWidth:l,thumbHeight:d,thumbWidth:c,onClose:h,onSave:v,crop:u}=e;(0,s.showMessageBoxModal)((e=>(0,i.jsx)(a.NarrativeCoverCropper,(0,o._)({},e,{coverUrl:t,coverHeight:r,coverWidth:l,thumbHeight:d,thumbWidth:c,onSave:v,crop:u}))),{width:n.WIDE_BOX_WIDTH,onDestroy:h})}},278212:(e,t,r)=>{r.d(t,{showNarrativeEditorBox:()=>m});var o=r(434788),i=r(785893),a=r(399133),s=r(659397),n=r(584356),l=r(29271),d=r(970978),c=r(378839),h=r(501977),v=r(833723),u=r(516091),p=r(359639),g=r(667294);function _({ownerId:e,options:t,onClose:r,refreshCoordinates:v,onAfterSavingChange:u}){var _,m,w;const{narrative:y}=t,[C,S]=(0,g.useState)(t.stories),[x,N]=(0,g.useState)(t.selectedStories||[]),[f,k]=(0,g.useState)(t.storiesCount),[b,L]=(0,g.useState)(t.publishHash),[B,I]=(0,g.useState)(t.editHash),[T,E]=(0,g.useState)(t.linkData),[j,D]=(0,g.useState)(t.isEditingLinksAvailable),[P,A]=(0,g.useState)(t.coverUploadConfig);(0,g.useEffect)((()=>{C&&b&&B&&f&&P||new Promise(((t,r)=>{window.ajax.post("al_stories.php",{act:"get_narrative_editor_data",owner_id:e},{loader:!0,onDone:e=>{S(e.stories),k(e.storiesCount),L(e.publishHash),I(e.editHash),E(e.linkData),D(e.isEditingLinksAvailable),A(e.coverUploadConfig),t(void 0)},onFail:e=>(r(e),!0)})})).catch((e=>{(0,n.showDoneBox)(e||l.getLang("global_error")),(0,d.logError)(e),r()}))}),[]);if(!((null==(_=C)?void 0:_.length)&&b&&B&&f&&P))return(0,i.jsx)(p.MessageBoxModalLoader,{refreshCoordinates:v});let M=C.reduce(((e,t)=>(e[t.id]=t,e)),{});M=x.reduce(((e,t)=>(e[t.id]=t,e)),M);const R=C.map((e=>e.id)),O=x.map((e=>e.id)),U=y?a.EditorModeType.edit:a.EditorModeType.create,H=(null==(m=y)?void 0:m.title)?(0,s.decodeHTMLEntities)(y.title):"",F=f>C.length,W=y?(0,h.getPreparedCover)(y):void 0;return(0,i.jsx)(c.NarrativeEditor,{ownerId:e,type:U,name:H,narrativeRawId:null==(w=y)?void 0:w.rawId,cover:W,selectedStoryIds:O,storyIds:R,hasMore:F,storyMap:M,close:r,loadMore:()=>{var t;return(null==(t=C)?void 0:t.length)?new Promise(((t,r)=>{var o;if(!(null==(o=C)?void 0:o.length))return r("empty stories");window.ajax.post("al_stories.php",{act:"get_archive_stories",owner_id:e,offset:C.length},{onDone:(e,o)=>{if(!C)return void r("empty stories after loading");S((t=>[...null!=t?t:[],...e])),k(o);const i=o>C.length;t(i)},onFail:e=>(r(e),!0)})})):Promise.reject("empty stories")},onSave:e=>{var r,o;null==(r=(o=t).onSave)||r.call(o,e),u(!0)},publishHash:b,editHash:B,linkData:T,isEditingLinksAvailable:j,onStoryLinkUpdate:(e,t,r)=>{var i;if(!(null==(i=C)?void 0:i.length))return;const a=i=>i.map((i=>i.rawId===e?(0,o._)({},i,{linkUrl:t,linkType:r}):i));S((e=>a(null!=e?e:[]))),N((e=>a(null!=e?e:[])))},appearance:a.EditorViewType.box,navScreen:t.navScreen,coverUploadConfig:P,getPublishDoneHTML:t.getPublishDoneHTML,refreshCoordinates:v})}function m(e,t={}){const r={current:!1};(0,u.addStatic)(["NarrativeEditor.css"]).then((()=>{(0,p.showMessageBoxModal)((a=>(0,i.jsx)(_,(0,o._)({},a,{ownerId:e,options:t,onAfterSavingChange:e=>{r.current=e}}))),{width:v.WIDE_BOX_WIDTH,onDestroy:()=>{var e,o;return null==(e=(o=t).onClose)?void 0:e.call(o,r.current)}})})).catch((e=>{console.error(e),(0,d.logError)(e)}))}},373697:(e,t,r)=>{r.d(t,{showRecommendedNarrativesBox:()=>u});var o=r(434788),i=r(785893),a=r(584356),s=r(29271),n=r(386342),l=r(516091),d=r(833723),c=r(359639),h=r(667294);function v({onClose:e,refreshCoordinates:t,options:r}){var d;const[v,u]=(0,h.useState)((()=>(0,l.getRecommendedNarrativesStore)(r))),{narratives:p,boxData:g}=v,_=(null==(d=p)?void 0:d.length)&&null!=g;(0,h.useEffect)((()=>{_||(0,l.load)(v).then((([e,t])=>{u((r=>(0,o._)({},r,{narratives:e,boxData:t})))})).catch((t=>{(0,a.showDoneBox)(t||s.getLang("global_error")),e()}))}),[]);const m=()=>{u((e=>(0,o._)({},e)))};if(!_)return(0,i.jsx)(c.MessageBoxModalLoader,{refreshCoordinates:t});return(0,i.jsx)(n.NarrativeBox,{title:s.getLang("news_fb_block_recommend_narratives"),showNarrativeNumber:!1,boxData:g,narratives:p,loadMore:()=>(0,l.loadMoreNarratives)(v).then((()=>{m()})).catch((e=>{(0,a.showDoneBox)(e||s.getLang("global_error"))})),onClose:e,onBookmark:e=>{e.isBookmarked=!e.isBookmarked,m()},trackCode:v.trackCode,list:v.list,source:v.source,refreshCoordinates:t})}function u(e={}){(0,c.showMessageBoxModal)((t=>(0,i.jsx)(v,(0,o._)({},t,{options:e}))),{width:d.SIMPLE_BOX_WIDTH})}},844553:(e,t,r)=>{r.d(t,{showStoryLinkEditorBox:()=>d});var o=r(434788),i=r(785893),a=r(659397),s=r(783412),n=r(359639),l=r(833723);function d(e){const{story:t,onClose:r,onStoryLinkUpdate:d}=e;let{linkData:c}=e;if(t.linkType&&t.linkText){c.items.find((e=>e.value===t.linkType))||(c=(0,o._)({},c,{items:[...c.items,{value:t.linkType,label:t.linkText}]}))}(0,n.showMessageBoxModal)((e=>(0,i.jsx)(s.StoryLinkEditorBox,(0,o._)({},e,{story:t,onStoryLinkUpdate:d,linkData:(0,a.decodeHTMLEntitiesDeep)(c)}))),{width:l.SMALL_BOX_WIDTH,onDestroy:r})}},505426:(e,t,r)=>{r.d(t,{WallDataEvents:()=>s,emitEvent:()=>h,registerNonGlobalNonUniqueListener:()=>c,registerUniqueListener:()=>d});var o=r(434788),i=r(980602),a=r(367431);const s={post_reactions_counts_update:"wall/post_reactions_counts_update",reply_reactions_counts_update:"wall/reply_reactions_counts_update",post_subscribe_update:"wall/post_subscribe_update"},n=(0,a.makeSharedState)("wall-data",(()=>({emitter:new i.default,keyedListeners:Object.create(null)})),{version:0}),l=(e,t,r)=>{var i,a;const s=n(),l=null==(a=s.keyedListeners)||null==(i=a[e])?void 0:i[t];return l&&s.emitter.removeListener(e,l),((e,t,r)=>{const i=n();return i.emitter.addListener(e,r),i.keyedListeners[e]=(0,o._)({},i.keyedListeners[e],{[t]:r}),()=>{var o,a;i.emitter.removeListener(e,r),(null==(o=i.keyedListeners[e])?void 0:o[t])===r&&(null==(a=i.keyedListeners[e])||delete a[t])}})(e,t,r)},d=(e,t,r)=>l(t,e,r),c=(e,t)=>((e,t)=>{const r=n();return r.emitter.addListener(e,t),()=>{r.emitter.removeListener(e,t)}})(e,t),h=(e,t)=>{n().emitter.emit(e,t)}},228411:(e,t,r)=>{r.d(t,{updateAriaLabelCounter:()=>a});var o=r(29271),i=r(234514);const a=(e,t,r)=>{if(!("number"==typeof t&&e instanceof HTMLElement&&e.classList.contains("PostBottomAction")))return;const a=(e=>{let t;switch(e){case i.LikeButtonTypes.comment:t=o.getLang("likes_comments_N_aria_short","raw");break;case i.LikeButtonTypes.like:t=o.getLang("likes_likes_N_aria_short","raw");break;case i.LikeButtonTypes.share:t=o.getLang("likes_shares_N_aria_short","raw")}return t})(r);if(!a)return;const s=(0,o.langNumeric)(t,a,!1);e.setAttribute("aria-label",s)}},145637:(e,t,r)=>{r.d(t,{ON_BOARDING_BG_RECT_ID:()=>l,default:()=>h});var o=r(795558),i=r(953908),a=r(438221),s=r(23087),n=r(84543);const l="onboarding_bg_rect",d="page_header_cont",c="onboarding";class h{initOnboardingBG(){if(!window.onboardingBG){let e='\n<div id="onboarding_layout">\n  <svg id="onboarding_bg_header" width="100%" height="49px">\n    <rect id="onboarding_bg_rect" class="GroupOnboardingBg" x="0" y="0" width="100%" height="100%" fill-opacity="0.8" fill="#000"></rect>\n  </svg>\n  <svg id="onboarding_bg" width="100%" height="100%">\n  <defs>\n    <mask id="mask" x="0" y="0" width="100%" height="100%">\n      <rect x="0" y="0" width="100%" height="100%" fill="#fff"></rect>\n      <rect id="onboarding_bg_clip" class="GroupOnboardingBgClip" x="0" y="0" width="0" height="0" fill="#000" rx="8" ry="8"></rect>\n    </mask>\n  </defs>\n  <rect id="onboarding_bg_rect" class="GroupOnboardingBg" x="0" y="42" width="100%" height="100%" mask="url(#mask)" fill-opacity="0.8"></rect>\n  </svg>\n</div>\n      ',t=(0,o.se)(e);(0,o.domInsertBefore)(t,window.layerBG),window.onboardingBGHeader=(0,o.ge)("onboarding_bg_header"),window.onboardingBG=(0,o.ge)("onboarding_bg"),window.onboardingBGRect=(0,o.ge)(l),window.onboardingBGClip=(0,o.ge)("onboarding_bg_clip"),window.cur.destroy.push((()=>{(0,o.hide)(window.onboardingBG),(0,o.hide)(window.onboardingBGHeader),(0,o.removeClass)((0,o.ge)(d),c),this.hideDarkness=!0,this.hideTT(),delete window.onboardingBG,delete window.onboardingBGHeader,delete window.onboardingBGRect,delete window.onboardingBGClip,this.opts.onBGClick&&(0,i.removeEvent)(window.onboardingBG,"click",this.opts.onBGClick)}))}this.opts.onBGClick&&(0,i.addEvent)(window.onboardingBG,"click",this.opts.onBGClick)}showTT(){const[,e]=(0,o.getXY)(this.el);this.tt=new n.ElementTooltip(this.el,this.ttParams),this.opts.highlight&&(this.addDarkness(),this.addHighlight()),this.tt.show();const t=this.tt.getContent();(0,s.isElementInViewport)(this.el)&&(0,s.isElementInViewport)(t)||(0,a.scrollToY)(e-42-this.ttParams.scrollOffset)}hideTT(){this.tt&&(this.tt.destroy(),this.removeDarkens(),this.hideDarkness&&((0,i.removeEvent)(window,"scroll"),(0,i.removeEvent)(window,"resize")),this.opts.onBGClick&&window.onboardingBG&&(0,i.removeEvent)(window.onboardingBG,"click",this.opts.onBGClick),this.opts.onHide&&this.opts.onHide())}addHighlight(){window.onboardingBGClip&&(this.highlightElement(),(0,i.addEvent)(window,"scroll",this.onScrollTT.bind(this)),(0,i.addEvent)(window,"resize",this.onResizeTT.bind(this)))}highlightElement(){let e=this.el.offsetWidth,t=this.el.offsetHeight,r=(0,o.getXY)(this.el);(0,o.attr)(window.onboardingBGClip,"width",e+this.border[1]+this.border[3]),(0,o.attr)(window.onboardingBGClip,"height",t+this.border[0]+this.border[2]),(0,o.attr)(window.onboardingBGClip,"x",r[0]-this.border[1]),(0,o.attr)(window.onboardingBGClip,"y",r[1]-this.border[0])}onResizeTT(){this.setDartToFullWidth(),this.highlightElement()}onScrollTT(){let e=this.getPageHeight();window.onboardingBG.height!=e&&this.setDartToFullHeight()}setDartToFullHeight(){(0,o.attr)(window.onboardingBG,"height",this.getPageHeight())}setDartToFullWidth(){(0,o.attr)(window.onboardingBG,"width",this.getPageWidth()),(0,o.attr)(window.onboardingBGHeader,"width",this.getPageWidth())}addDarkness(){(0,o.isVisible)(window.onboardingBG)||(this.setDartToFullHeight(),this.setDartToFullWidth(),(0,o.show)(window.onboardingBG),(0,o.isVisible)(window.onboardingBGHeader)||((0,o.show)(window.onboardingBGHeader),(0,o.addClass)((0,o.ge)(d),c)))}removeDarkens(){this.hideDarkness&&((0,o.hide)(window.onboardingBG),(0,o.hide)(window.onboardingBGHeader),(0,o.removeClass)((0,o.ge)(d),c))}ttOnHide(){this.hideTT()}show(){setTimeout(this.showTT.bind(this),1e3)}getPageWidth(){const e=document.documentElement,t=document.body;return Math.max(t.scrollWidth,e.scrollWidth,t.offsetWidth,e.offsetWidth,t.clientWidth,e.clientWidth)}getPageHeight(){const e=document.documentElement,t=document.body;return Math.max(t.scrollHeight,e.scrollHeight,t.offsetHeight,e.offsetHeight,t.clientHeight,e.clientHeight)}constructor(e,t,r={}){this.el=e,this.text=t,this.hideDarkness=!0,this.oldColor=!1;var o;let i={autoShow:!1,noAutoHideOnWindowClick:null==(o=r.noAutoHideOnWindowClick)||o,content:t instanceof HTMLElement?t:`${t}`,cls:`feature_intro_tt tutorial_tip_tt ${(()=>{var e;const t=null!=(e=r.class)?e:"";return r.tooltipWhite?t:t+" feature_intro_blue_tt"})()}`,appendToParent:!0,onHide:this.ttOnHide.bind(this),scrollOffset:r.scrollOffset||0,align:r.align||n.ElementTooltip.ALIGN_CENTER};r.side&&(i.forceSide=r.side),r.offset&&(i.offset=r.offset),r.width&&(i.width=r.width),r.shift&&(i.centerShift=r.shift),r.border?this.border=r.border:this.border=[10,10,10,10],r.ttOnHide&&(i.onHide=r.ttOnHide),r.withCloseButton&&(i.withCloseButton=r.withCloseButton,i.onCloseButtonClick=r.onCloseButtonClick),r.align&&(i.align=r.align),this.ttParams=i,this.opts=r,this.initOnboardingBG()}}},23087:(e,t,r)=>{function o(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}r.d(t,{isElementInViewport:()=>o})},827652:(e,t,r)=>{r.d(t,{Likes:()=>x});var o=r(434788),i=r(795558),a=r(953908),s=r(320422),n=r(82161),l=r(893106),d=r(95432),c=r(664988),h=r(514986),v=r(29271),u=r(693982),p=r(234514),g=r(682951),_=r(898298),m=r(999237),w=r(878021),y=r(228411),C=r(362246),S=r(809053);const x={toggle(e,t,r,o){if((0,a.cancelEvent)(t),(0,c.isObject)(window.cur)&&(0,c.isFunction)(cur.viewAsBox))return cur.viewAsBox();if(vk.widget&&!vk.id)return window.Widgets.oauth();const s=(0,i.hasClass)(e,"active");(0,i.addClass)(e,"animate"),this.clientUpdate(r,p.LikeButtonTypes.like,s?-1:1,!s);const n=r.match(/^(video)(?!(_comment))(.*)/)?(0,C.getVideoTrackCode)():void 0,l={act:s?"a_do_unlike":"a_do_like",object:r,hash:o,list:cur.pvListId,wall:2,from:this._getReference(r),from_widget:vk.widget?1:0,track_code:n},d=()=>((0,i.toggleClass)(e,"active",s),this.clientUpdate(r,p.LikeButtonTypes.like,s?1:-1,s),!1);window.ajax.post("like.php",l,{onDone:t=>{if(t.unauth_action_box)return d(),void w.UnauthActionBox.show(t.unauth_action_box);this.update(r,t);const o=r.match(/^(wall|market)(.*)/);o&&cur.onLike&&cur.onLike(e,o[1],o[2],s)},onFail:d});(0,c.intval)((0,i.domData)(e,"count"))>0?x.showLikes(e,r,{fast:!0}):e.tt&&e.tt.destroy&&e.tt.destroy()},_getReference:e=>cur.pvShown?"photo_viewer":e===cur.wallLayer?"wkview":window.mvcur&&window.mvcur.mvShown?"videoview":cur.wallType?"feed"===cur.wallType?"news"===cur.section?`feed_${cur.subsection?cur.subsection:cur.section}`:"recommended"===cur.section?"feed_recommended"+("recent"!==cur.subsection?"_"+cur.subsection:""):(0,n.inArray)(cur.section,["friends","groups","videos","photos"])?"feed_"+(cur.subsection?"_"+cur.subsection:""):`feed_${cur.section}`:"top"===cur.wallType?"wall_top":"wall_"+(cur.onepost?"one":(cur.wallType||"").indexOf("full_")?"page":"full"):cur.module,share(e,t={},r=void 0){if(vk.widget&&!vk.id)return window.Widgets.oauth();if((0,c.isObject)(window.cur)&&(0,c.isFunction)(cur.viewAsBox))return cur.viewAsBox();if(window.cur){const e=(0,S.getTrackCodeFromPost)(r);window.cur.shareButtonTrackCode=e}const{objectType:i,objectId:a}=(0,u.parseLikeObjectId)(e);(vk.widget?window.showBox:h.showBox)("like.php",(0,o._)({act:"publish_box",object:e,from_widget:vk.widget?1:0},t),{onDone:(e,t)=>{t.unauth_action_box&&(e.hide(),w.UnauthActionBox.show(t.unauth_action_box))},stat:[window.jsc("web/page.js"),"page.css",window.jsc("web/wide_dd.js"),"wide_dd.css",window.jsc("web/sharebox.js")]}),"wall"===i&&window.Wall&&window.Wall.triggerAdPostStat(a,"share_post"),cur.RpcMethods&&(cur.RpcMethods.likeFullUpdate=t=>x.update(e,window.cleanObj(t)))},clientUpdate(e,t,r,o){const a=this._getButtonsByType(e,t);if(!a.length)return;const s=(0,c.intval)((0,i.domData)(a[0],"count"))+r;this._updateDom(e,t,s,o),this.updateExternalIndex(e,{type:t,count:s,isActive:o})},update(e,t){if(!isNaN(parseInt(t.like_num))){const r=(0,c.isUndefined)(t.like_my)?void 0:!!(0,c.intval)(t.like_my);this._updateDom(e,p.LikeButtonTypes.like,t.like_num,r,t.like_title),this.updateExternalIndex(e,{type:p.LikeButtonTypes.like,count:t.like_num,isActive:r})}if(!isNaN(parseInt(t.share_num))){const r=(0,c.isUndefined)(t.share_my)?void 0:!!(0,c.intval)(t.share_my);this._updateDom(e,p.LikeButtonTypes.share,t.share_num,r,t.share_title),this.updateExternalIndex(e,{type:p.LikeButtonTypes.share,count:t.share_num})}if((0,n.isNumeric)(t.views_num)&&this._updateDom(e,p.LikeButtonTypes.views,t.views_num,void 0,t.views_title),(0,n.isNumeric)(t.comment_num)&&this._updateDom(e,p.LikeButtonTypes.comment,t.comment_num),t[g.REACTIONS_COUNTS_RESPONSE_FIELD]){const r=!!t.isQueueUpdate;(0,m.triggerReactionsUpdate)(e,t[g.REACTIONS_COUNTS_RESPONSE_FIELD],void 0,{isQueueUpdate:r,isUserAction:!1,previewVisibility:_.previewVisibilityUseCurrent})}},updateComments(e,t){this.update(e,{comment_num:t})},_updateDom(e,t,r,o,a){var s;const d=this._getButtonsByType(e,t),h=t===p.LikeButtonTypes.views;if(!(null==(s=d)?void 0:s.length))return;let g="";h?g=r:r>0&&(g=vk.widget?(0,n.formatCount)(r):(0,v.langNumeric)(r,"%s",!0)),h||(r=(0,c.intval)(r));for(let e=0;e<d.length;e++){const s=d[e];if((0,i.hasClass)(s,"no_counter"))continue;const n=h?d[e]:(0,u.getElementLikeButtonCount)(d[e]);var _,m,w;if((0,l.animateCount)(n,g,{str:"auto",noWrapWidth:!h,noSpaceIfEmpty:!0}),(0,i.toggleClass)(s,"empty",r<=0),"boolean"==typeof o&&(0,i.toggleClass)(s,"active",o),(0,i.attr)(d[e],"data-count",r),(0,y.updateAriaLabelCounter)(s,r,t),h)null==(w=s)||null==(m=w.closest)||null==(_=m.call(w,".like_views"))||_.setAttribute("title",a||"");const v=d[e].tt;if(v){const e=(0,i.domByClass)(v.container,"_content"),n=(0,i.domByClass)(v.container,"_value"),l=(0,i.domByClass)(v.container,"_title"),d=(0,c.intval)((0,i.val)(n));(0,i.val)(n,r),a&&(0,i.val)(l,a),(0,c.isObject)(v)&&(v.likeInvalidated=!0),(d!==r&&d<7||!1===a)&&(t===p.LikeButtonTypes.like?s.needReinitLikesTT=!0:t===p.LikeButtonTypes.share&&(s.needReinitShareTT=!0)),t===p.LikeButtonTypes.like&&(0,i.toggleClass)(e,"me_hidden",!o),!1===a&&v.destroy&&v.destroy()}}},_getButtonsByType:(e,t)=>(0,i.domQuery)(`._like_${e} ._${t}, ._like_${e} [data-like-button-type="${t}"]`),showLikes(e,t,r={}){var o;if(!e||!(e instanceof HTMLElement)||e.postDontShowLikes)return;if(vk.widget&&vk.show_external_auth_box)return;let a=r.views?{views:1}:r.share?{published:1}:{};r.listId&&(a.list=r.listId),r.like_hash&&(a.like_hash=r.like_hash),r.like_stats_params&&Object.assign(a,r.like_stats_params);const l=!!(0,i.geByClass1)("share",(0,i.gpeByClass)("like_wrap",e));let d=document.body,h=!1;const v=getComputedStyle(e),p=(0,c.intval)(v.getPropertyValue("padding-left").replace("px","")),g=(0,c.intval)(v.getPropertyValue("padding-top").replace("px","")),_=(0,u.getElementLikeButtonIcon)(e);let m=40;"wpost"===r.from&&(m=24);const w=[m-(0,i.getSize)(_)[0]/2-p,10-g];let y=r.cl||"";if(r.share)y+="likes_tt_share";else if(y+="likes_tt_like","widget_community"===r.from)w[0]=6;else if("wcomments"===r.from||"widget_comments"===cur.wallType){const t=16,r=10;w[0]=(0,i.getSize)(e)[0]+t-(0,i.getSize)(_)[0]/2-r}else"photo_carousel"===r.from&&(w[1]=10);if(!!(null==(o=r)?void 0:o.isFromReactionsPreview)){const t=e.querySelector("._ReactionsPreview__itemsContainer");if(t){const e=t.querySelector(".ReactionsPreviewItem"),r=(0,i.getXYRect)(e,!1),o=(r.width||0)/2;let a=o;d=t;r.left+r.width/2>window.innerWidth/2&&(h=!0,a=t.offsetWidth-o),w[0]=-a+m}}let C,S;r.share?(C="needReinitLikesTT",S="resetLikesTTTimer"):(C="needReinitShareTT",S="resetShareTTTimer"),clearTimeout(e[S]),(0,s.showTooltip)(e,{url:"/like.php",params:(0,n.extend)({act:"a_get_stats",object:t,has_share:l?1:""},a),appendEl:d,slide:15,shift:w,ajaxdt:r.fast?0:100,showdt:r.fast?0:400,hidedt:200,dir:"auto",checkLeft:!0,needLeft:h,reverseOffset:80,noZIndex:!0,hasover:!0,tip:{over:()=>{x.showLikes(e,t,r)}},typeClass:"like_tt",className:y,onHide:()=>{clearTimeout(e[S]),e[C]&&(e[S]=setTimeout((()=>{delete e[C],e.tt&&e.tt.destroy&&e.tt.destroy()}),200))}})},showShare:function(e,t,r){x.showLikes(e,t,(0,n.extend)(r,{share:1}))},updateViews:(e,t)=>{vk.widget&&vk.show_external_auth_box||window.ajax.post("like.php",{act:"a_get_stats",object:e,views:1},{cache:1,onDone(t,r){const o=(0,i.ce)("div",{innerHTML:r});x._updateDom(e,p.LikeButtonTypes.views,t,void 0,o.innerText||o.textContent)}})},makeTemplate(e,t){if(!e)return"";(t=(0,n.extend)({buttons_prepend:"",object_raw:"",likes_count:"",liked:!1,share_count:"",shared:"",views_count:"",share_opts:{},like_opts:{},class_name:"",like_cont_class:"",like_class_name:"",[g.REACTIONS_COUNTS_RESPONSE_FIELD]:"",reactions_class_name:""},t)).like_active=t.liked?"active":"",t.share_active=t.shared?"active":"",t.comment_active="",t.likes_formatted_count=t.likes_count>0?(0,v.langNumeric)(t.likes_count,"%s",!0):"",t.share_formatted_count=t.share_count>0?(0,v.langNumeric)(t.share_count,"%s",!0):"",t.share_opts=this._convertOptsToString(t.share_opts),t.like_opts=this._convertOptsToString(t.like_opts),t.like_class_name+=t.likes_count>0?"":" empty",t.share_class_name=t.share_count>0?"":"empty";const r=t[g.REACTIONS_COUNTS_RESPONSE_FIELD],o=!!r&&Object.values(r).some((e=>!!e));return t.reactions_class_name+=o?"":" PostBottomAction--empty",(0,i.rs)(e,t)},_convertOptsToString:e=>JSON.stringify(e).replace(/\"/g,"'"),updateExternalIndex(e,t={}){const{objectType:r,objectId:o}=(0,u.parseLikeObjectId)(e);switch(r){case"photo":if(!cur.pvShown||!cur.pvCurPhoto||cur.pvCurPhoto.id!==o)return;const e=cur.pvListId,r=cur.pvIndex,i=cur.pvData[e][r];t.type===p.LikeButtonTypes.like?(i.likes=t.count,i.liked=t.isActive,cur.pvCommsLikes[i.id][1]=t.count):t.type===p.LikeButtonTypes.share&&(i.shares=t.count);break;case"video":if(window.mvcur&&window.mvcur.mvShown&&window.mvcur.videoRaw===o&&t.type===p.LikeButtonTypes.like){const e=window.Videoview.getMvData();e.likes=t.count,void 0!==t.isActive&&(e.liked=t.isActive,window.Videoview.playerOnLiked(t.isActive),window.Videoview.recache())}break;case"clip":t.type===p.LikeButtonTypes.like&&window.Videoview.playerOnLiked(t.isActive)}},showLikesList(e,t){cur.viewAsBox||(0,i.hasClass)((0,i.gpeByClass)("like_btn",e),"no_counter")||(0,d.showWiki)({w:"likes/"+(0,n.clean)(t)},!1,!1,{queue:1})},showSharesList(e,t){cur.viewAsBox||(0,i.hasClass)((0,i.gpeByClass)("like_btn",e),"no_counter")||(0,d.showWiki)({w:"shares/"+(0,n.clean)(t)},!1,!1,{queue:1})}}}}]);try{stManager.done("dist/042057405aa14bdcd56cdbc164d834ff.a7ababb1e928cc7df203.js")}catch(e){}